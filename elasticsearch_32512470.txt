32512470
geo_bounding_box filter parse error Expected [FIELD_NAME] under a [START_OBJECT]
<p>I am trying to filter a geohash aggregation with a bounding box filter. But I have a strange error : <code>Parse Failure [Expected [FIELD_NAME] under a [START_OBJECT], but got a [START_OBJECT] in [traces]]];</code></p>&#xA;&#xA;<p>When I don't use this filter, my request works fine.</p>&#xA;&#xA;<p>Here is my request</p>&#xA;&#xA;<pre><code>POST /traces/_search?search_type=count&amp;pretty&#xA;{&#xA;    "aggregations": {&#xA;        "traces": {&#xA;            "filter": {&#xA;                "or": [{&#xA;                    "and": [&#xA;                      {"term": {"geoip": true}},&#xA;                      {"term": {"trackerId": "RG-000000003-1"}}]&#xA;                }],&#xA;                "geo_bounding_box" : {&#xA;                  "loc.coordinates" : {&#xA;                      "top_left" : {&#xA;                        "lat": 49.109837790524416,&#xA;                        "lon": 14.326171874999998&#xA;                      },&#xA;                      "bottom_right" : {&#xA;                          "lat": 44.05601169578525,&#xA;                          "lon": -9.404296875&#xA;                      }&#xA;                  }&#xA;              }&#xA;            },&#xA;            "aggregations": {&#xA;                "trackerId": {&#xA;                    "terms": {&#xA;                        "field": "trackerId",&#xA;                        "size": 0&#xA;                    },&#xA;                    "aggregations": {&#xA;                        "heatmap": {&#xA;                            "geohash_grid": {&#xA;                                "field": "loc.coordinates",&#xA;                                "precision": 1&#xA;&#xA;                            }&#xA;                        }&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here is a part of my mapping where you can see the location.</p>&#xA;&#xA;<pre><code>collections: [ {&#xA;    name: 'traces',&#xA;    index: 'traces',&#xA;    type: 'trace',&#xA;    mappings: {&#xA;        'trace': {&#xA;            'properties': {&#xA;                'loc': {&#xA;                    'type': 'object',&#xA;                    'properties': {&#xA;                        'type': {&#xA;                            'type': 'string'&#xA;                        },&#xA;                        'coordinates':{&#xA;                            'type': 'geo_point',&#xA;                            'geohash':true,&#xA;                            'geohash_prefix':true,&#xA;                            'lat_lon':true,&#xA;                            'fielddata' : {&#xA;                                'format' : 'compressed',&#xA;                                'precision' : '1cm'&#xA;                            }&#xA;                        }&#xA;                    }&#xA;                }, .....&#xA;</code></pre>&#xA;&#xA;<p>What is wrong with my request ?</p>&#xA;
<p>The problem is your <code>geo_bounding_box</code> filter which lies outside the <code>or</code> filter. Simply rewrite your query like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "aggregations": {&#xA;    "traces": {&#xA;      "filter": {&#xA;        "or": [&#xA;          {&#xA;            "and": [&#xA;              {&#xA;                "term": {&#xA;                  "geoip": true&#xA;                }&#xA;              },&#xA;              {&#xA;                "term": {&#xA;                  "trackerId": "RG-000000003-1"&#xA;                }&#xA;              }&#xA;            ]&#xA;          },&#xA;          {&#xA;            "geo_bounding_box": {      &lt;--- this need to go inside the "or" array&#xA;              "loc.coordinates": {&#xA;                "top_left": {&#xA;                  "lat": 49.109837790524416,&#xA;                  "lon": 14.326171874999998&#xA;                },&#xA;                "bottom_right": {&#xA;                  "lat": 44.05601169578525,&#xA;                  "lon": -9.404296875&#xA;                }&#xA;              }&#xA;            }&#xA;          }&#xA;        ]&#xA;      },&#xA;      "aggregations": {&#xA;        "trackerId": {&#xA;          "terms": {&#xA;            "field": "trackerId",&#xA;            "size": 0&#xA;          },&#xA;          "aggregations": {&#xA;            "heatmap": {&#xA;              "geohash_grid": {&#xA;                "field": "loc.coordinates",&#xA;                "precision": 1&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;