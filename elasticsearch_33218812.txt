33218812
Documents are automatically getting deleted in Elasticsearch after insertion
<p>I created an index in Elasticsearch with the following settings. After inserting data into the index using Bulk API, the <code>docs.deleted</code> count is continuously increasing. Does this mean the documents are automatically getting deleted, if so what did i do wrong ?</p>&#xA;&#xA;<pre><code>PUT /inc_index/&#xA;{&#xA;  "mappings": {&#xA;    "store": {&#xA;      "properties": {&#xA;        "title": {&#xA;          "type": "string",&#xA;          "term_vector": "with_positions_offsets_payloads",&#xA;          "store" : true,&#xA;          "index_analyzer" : "fulltext_analyzer"&#xA;         },&#xA;         "description": {&#xA;          "type": "string",&#xA;          "term_vector": "with_positions_offsets_payloads",&#xA;          "store" : true,&#xA;          "index_analyzer" : "fulltext_analyzer"&#xA;        },&#xA;        "category": {&#xA;          "type": "string"&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "settings" : {&#xA;    "index" : {&#xA;      "number_of_shards" : 5,&#xA;      "number_of_replicas" : 1&#xA;    },&#xA;    "analysis": {&#xA;      "analyzer": {&#xA;        "fulltext_analyzer": {&#xA;          "type": "custom",&#xA;          "tokenizer": "whitespace",&#xA;          "filter": [&#xA;            "lowercase",&#xA;            "type_as_payload"&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The output of <code>"GET /_cat/indices?v"</code> is as shown below, the <code>"docs.deleted"</code> is continuously increasing:</p>&#xA;&#xA;<pre><code>health status index    pri rep docs.count docs.deleted store.size pri.store.size  &#xA;green  open   inc_index  5   1   2009877       584438      6.8gb          3.6gb&#xA;</code></pre>&#xA;
<p>If your bulk operations also include updates to existing documents (insert/update to documents with the same ID), then this is normal. In Elasticsearch, an update is a combo of delete+insert operations: <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/update-doc.html" rel="noreferrer">https://www.elastic.co/guide/en/elasticsearch/guide/current/update-doc.html</a></p>&#xA;&#xA;<p>And the deleted documents you see there are documents <em>marked</em> as deleted. When the Lucene segments merging happens, the deleted documents will be physically removed from disk.</p>&#xA;
<p>ElasticSearch indexes have been composed of “segments”. Since segments have a policy of "write once", when we delete/update any document from ElasticSearch, it is not actually deleted, only marked as deleted and increases the count in "doc.deleted". </p>&#xA;&#xA;<p>The more segments means slower searches and more memory used. Elasticsearch solves this problem by merging segments in the background. Small segments are merged into bigger segments, which, in turn, are merged into even bigger segments...while merging those segments if there are any documents which are marked as deleted, it doesn't copy that doc in the bigger segment. And Once merging has finished, the old segments are deleted. That's why there is further decrease in "doc.deleted" value.</p>&#xA;