32947478
python http request to elasticsearch
<p>I have method make http request. I use this to update docs in es with update_ by_query api of elasticsearch. &#xA;Here is the code:&#xA;import httplib</p>&#xA;&#xA;<pre><code>def http(method, path, data,HOST):&#xA;    conn = httplib.HTTPConnection(HOST)&#xA;    conn.request(method, path, data)&#xA;    return conn.getresponse()&#xA;&#xA;updateDsl ="""{&#xA;                      \"query\": {&#xA;                        \"filtered\": {&#xA;                          \"filter\": {&#xA;                            \"bool\": {&#xA;                              \"must\": [&#xA;                                {&#xA;                                  \"term\": {&#xA;                                    \"heroname\": \"king\"&#xA;                                  }&#xA;                                },&#xA;                                {&#xA;                                  \"missing\": {&#xA;                                    \"field\": \"category\"&#xA;                                  }&#xA;                                }&#xA;                              ]&#xA;                            }&#xA;                          }&#xA;                        }&#xA;                      },&#xA;                      \"script\" : \"ctx._source.category = \\"27"\\"\"&#xA;                    }"""&#xA;try:&#xA;    result = http("POST","dota2/_update_by_query",updateDsl,"localhost:9200")&#xA;except Exception as ex:&#xA;    ex.message()&#xA;</code></pre>&#xA;&#xA;<p>I expect this works because I run same dsl query in marvel and check docs see it works fine.. also debug python ,and check response code is 'OK'&#xA;But docs not change.. </p>&#xA;&#xA;<p>here is the dsl result after run update_by_query command(under _search) in marvel:&#xA;<a href="https://i.stack.imgur.com/VLp0d.png" rel="nofollow noreferrer"><img src="https://i.stack.imgur.com/VLp0d.png" alt="enter image description here"></a></p>&#xA;
<p>I post it in a loop and check the response from elastisearch, here how it works:</p>&#xA;&#xA;<pre><code>for name in clientInfo:&#xA;            myDoc = """{  \"query\": {    \"filtered\": {      \"filter\": {        \"and\": [            {              \"term\": {                \"clientip\": \"%s\"              }            }, {              \"missing\": {                \"field\": \"clientname\"              }            }          ]      }    }  },  \"script\" : \"ctx._source.clientname = \\"%s\\"\"}"""%(name,clientInfo[name])&#xA;            result = self.http("POST","/"+self.elastic_index+"/_update_by_query",myDoc,self.elastic_con_string)&#xA;&#xA;status = json.loads(result.read())&#xA;&#xA;if not status['ok'] == True:&#xA;    raise ValueError("There is an error ocurred during update document")&#xA;</code></pre>&#xA;