29488650
Why is this percolator query invalid?
<p>Elasticsearch version:</p>&#xA;&#xA;<pre><code>$ curl http://localhost:8086/?pretty&#xA;{&#xA;  "status" : 200,&#xA;  "name" : "Selene",&#xA;  "cluster_name" : "elasticsearch",&#xA;  "version" : {&#xA;    "number" : "1.5.0",&#xA;    "build_hash" : "544816042d40151d3ce4ba4f95399d7860dc2e92",&#xA;    "build_timestamp" : "2015-03-23T14:30:58Z",&#xA;    "build_snapshot" : false,&#xA;    "lucene_version" : "4.10.4"&#xA;  },&#xA;  "tagline" : "You Know, for Search"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>With this mapping:</p>&#xA;&#xA;<pre><code>$ curl http://localhost:8086/watches/watches/_mapping?pretty&#xA;{&#xA;  "watches" : {&#xA;    "mappings" : {&#xA;      "watches" : {&#xA;        "properties" : {&#xA;          "location" : {&#xA;            "type" : "geo_shape",&#xA;            "tree_levels" : 5&#xA;          },&#xA;          "name" : {&#xA;            "type" : "string"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>A regular query is fine:</p>&#xA;&#xA;<pre><code>$ curl -XGET -d '&#xA;&gt; {&#xA;&gt;     "query": {&#xA;&gt;         "filtered": {&#xA;&gt;             "filter": {&#xA;&gt;                 "and": [&#xA;&gt;                     {&#xA;&gt;                         "geo_shape": {&#xA;&gt;                             "location": {&#xA;&gt;                                 "shape": {&#xA;&gt;                                     "type": "envelope",&#xA;&gt;                                     "coordinates": [[-180, 90], [180, -90]]&#xA;&gt;                                 }&#xA;&gt;                             }&#xA;&gt;                         }&#xA;&gt;                     }&#xA;&gt;                 ]&#xA;&gt;             }&#xA;&gt;         }&#xA;&gt;     }&#xA;&gt; }&#xA;&gt; ' 'http://localhost:8086/watches/watches/_search?pretty'&#xA;{&#xA;  "took" : 1,&#xA;  "timed_out" : false,&#xA;  "_shards" : {&#xA;    "total" : 1,&#xA;    "successful" : 1,&#xA;    "failed" : 0&#xA;  },&#xA;  "hits" : {&#xA;    "total" : 1,&#xA;    "max_score" : 1.0,&#xA;    "hits" : [ {&#xA;      "_index" : "watches",&#xA;      "_type" : "watches",&#xA;      "_id" : "berlin",&#xA;      "_score" : 1.0,&#xA;      "_source":&#xA;{&#xA;    "name": "Wind &amp; Wetter, Berlin, Germany",&#xA;    "location": {&#xA;        "type": "Point",&#xA;        "coordinates": [13.400544, 52.530286]&#xA;    }&#xA;}&#xA;&#xA;    } ]&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Put registering a similar percolator query fails:</p>&#xA;&#xA;<pre><code>$ curl -XPUT -d '&#xA;&gt; {&#xA;&gt;     "query": {&#xA;&gt;         "filtered": {&#xA;&gt;             "filter": {&#xA;&gt;                 "and": [&#xA;&gt;                     {&#xA;&gt;                         "geo_shape": {&#xA;&gt;                             "location": {&#xA;&gt;                                 "shape": {&#xA;&gt;                                     "type": "envelope",&#xA;&gt;                                     "coordinates": [[-180, 90], [180, -90]]&#xA;&gt;                                 }&#xA;&gt;                             }&#xA;&gt;                         }&#xA;&gt;                     }&#xA;&gt;                 ]&#xA;&gt;             }&#xA;&gt;         }&#xA;&gt;     }&#xA;&gt; }&#xA;&gt; ' 'http://localhost:8086/watches/.percolator/mypercolatorquery?pretty'&#xA;{&#xA;  "error" : "PercolatorException[[watches] failed to parse query [mypercolatorquery]]; nested: QueryParsingException[[watches] Field [location] is not a geo_shape]; ",&#xA;  "status" : 500&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Why and how can I register my query against the percolator?</p>&#xA;
<p>It turns out to be a bug in Elasticsearch triggered by the option <code>index.percolator.map_unmapped_fields_as_string: true</code></p>&#xA;&#xA;<p>See issue <a href="https://github.com/elastic/elasticsearch/issues/10500" rel="nofollow">https://github.com/elastic/elasticsearch/issues/10500</a></p>&#xA;