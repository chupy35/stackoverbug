29546816
How to combine a pattern analyzer and char_filter in elasticsearch
<p>I have a keyword field that I would like to tokenize (split on commas), but it may also contain values with "+" characters. For example:</p>&#xA;&#xA;<pre><code>query_string.keywords = Living,Music,+concerts+and+live+bands,News,Portland&#xA;</code></pre>&#xA;&#xA;<p>When creating the index the following does a nice job of splitting the keywords on commas:</p>&#xA;&#xA;<pre><code>{&#xA;    "settings": {&#xA;        "number_of_shards": 5,&#xA;        "analysis": {&#xA;            "analyzer": {&#xA;                "happy_tokens": {&#xA;                    "type":      "pattern",&#xA;                    "pattern":   "([,]+)"&#xA;                }&#xA;            }&#xA;        }&#xA;    },&#xA;    "mappings": {&#xA;        "post" : {&#xA;            "properties" : {&#xA;                "query_string.keywords" : {&#xA;                    "type": "string",&#xA;                    "analyzer" : "happy_tokens"&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>How can I add a char_filter (see below) to this to change the +'s to spaces or empty strings? </p>&#xA;&#xA;<pre><code>        "char_filter": {&#xA;            "kill_pluses": {&#xA;                "type": "pattern_replace",&#xA;                "pattern": "+",&#xA;                "replace": ""&#xA;            }&#xA;        }&#xA;</code></pre>&#xA;
<p>You need to escape your "+", as "+" has a <a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.x/query-dsl-regexp-query.html#regexp-syntax" rel="nofollow">special meaning</a> in regular expressions.</p>&#xA;&#xA;<pre><code>    "char_filter": {&#xA;        "kill_pluses": {&#xA;            "type": "pattern_replace",&#xA;            "pattern": "\+",&#xA;            "replace": ""&#xA;        }&#xA;    }&#xA;</code></pre>&#xA;
<p>I discovered the "mapping" <code>char_filter</code> that can take my plus characters to spaces. After tokenizing I was able to <code>trim</code> the tokens to remove white space.</p>&#xA;&#xA;<p>The <a href="http://www.elastic.co/guide/en/elasticsearch/guide/master/custom-analyzers.html" rel="nofollow">custom analyzers page in the elasticsearch guide</a> was a big help.</p>&#xA;&#xA;<p>My working example is below:</p>&#xA;&#xA;<pre><code>{&#xA;    "settings": {&#xA;        "number_of_shards": 5,&#xA;        "index": {&#xA;            "analysis": {&#xA;                "char_filter": {&#xA;                    "plus_to_space": {&#xA;                        "type": "mapping",&#xA;                        "mappings": ["+=&gt;\\u0020"]&#xA;                    }&#xA;                },&#xA;                "tokenizer": {&#xA;                    "split_on_comma": {&#xA;                        "type": "pattern",&#xA;                        "pattern": "([,]+)"&#xA;                    }&#xA;                },&#xA;                "analyzer": {&#xA;                    "happy_tokens": {&#xA;                        "type": "custom",&#xA;                        "char_filter": ["plus_to_space"],&#xA;                        "tokenizer": "split_on_comma",&#xA;                        "filter": ["trim"]&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    },&#xA;    "mappings": {&#xA;        "post" : {&#xA;            "properties" : {&#xA;                "query_string.keywords" : {&#xA;                    "type": "string",&#xA;                    "analyzer" : "happy_tokens"&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;