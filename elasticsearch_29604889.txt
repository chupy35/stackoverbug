29604889
How can I write this complex query in elasticsearch
<p>How can I get the following complex query written in elasticsearch</p>&#xA;&#xA;<pre><code>select username, count(id), &#xA;  concat(YEAR(postedtime),'-',MONTH(postedtime),'-',DAY(postedtime),' ',HOUR(postedtime)) &#xA;from table &#xA;where username in ("user1", "user2", "user3") &#xA;group by username, &#xA;  concat(YEAR(postedtime),'-',MONTH(postedtime),'-',DAY(postedtime),' ',HOUR(postedtime));&#xA;</code></pre>&#xA;
<p>Below is a query which should get you started - some notes:</p>&#xA;&#xA;<ul>&#xA;<li>Counts are returned automatically and don't need to be explicitly&#xA;requested. </li>&#xA;<li>The <code>"size":0</code> prevents the documents being returned -&#xA;you'll only see the aggregation. </li>&#xA;<li>The dates returned will be in epoch&#xA;format. </li>&#xA;<li>You could replace the <code>query_string</code> with a <code>terms</code> query or&#xA;even use a filter instead - it will depend on your requirements.</li>&#xA;<li>there are 2 levels of aggregation, the first by username the 2nd by date buckets.</li>&#xA;</ul>&#xA;&#xA;<p>the code:</p>&#xA;&#xA;<pre><code>curl -XGET 'http://localhost:9200/myindex/table/_search?pretty' -d '{&#xA; "size": 0,&#xA; "query":{&#xA;    "query_string": { "query":"user1 OR user2 OR user3", "fields": ["username"]}&#xA;   },&#xA; "aggs" : {&#xA;    "username_agg" : {&#xA;      "terms": {"field" : "username"},&#xA;      "aggs" : {&#xA;          "date_agg": { &#xA;            "date_histogram" : { "field" : "postedtime", "interval" : "hour" } &#xA;          }&#xA;       }&#xA;    }&#xA;  }&#xA;}'&#xA;</code></pre>&#xA;