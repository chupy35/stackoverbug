32158077
Elasticsearch terms aggregate duplicates
<p>I have a field using a ngram analyzer and trying to use a terms aggregate on the field to return unique documents by the field.  The returned keys in the aggregates don't match the documents fields being returned and I'm getting duplicate fields.</p>&#xA;&#xA;<pre><code>"analysis" : {&#xA;   "filter" : {&#xA;     "autocomplete_filter" : {&#xA;        "type" : "edge_ngram",&#xA;         "min_gram" : "1",&#xA;         "max_gram" : "20"&#xA;      }&#xA;    },&#xA;    "analyzer" : {&#xA;      "autocomplete" : {&#xA;        "type" : "custom",&#xA;        "filter" : [ "lowercase", "autocomplete_filter" ],&#xA;        "tokenizer" : "standard"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;&#xA;"name" : {&#xA;  "type" : "string",&#xA;  "analyzer" : "autocomplete",&#xA;  "fields" : {&#xA;    "raw" : {&#xA;      "type" : "string",&#xA;      "index" : "not_analyzed"&#xA;    }&#xA;  }&#xA;}&#xA;&#xA;{&#xA;  "query": {&#xA;    "query_string": {&#xA;      "query":"bra",&#xA;      "fields":["name"],&#xA;      "use_dis_max":true&#xA;     }&#xA;  },&#xA;  "aggs": {&#xA;    "group_by_name": {&#xA;      "terms": { "field":"name.raw" }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I'm getting back the following names and keys.</p>&#xA;&#xA;<pre><code>Braingeyser, Brainstorm, Braingeyser, Brainstorm, Brainstorm, Brainstorm, Bramblecrush, Brainwash, Brainwash, Braingeyser&#xA;&#xA;{"key":"Bog Wraith","doc_count":18}&#xA;{"key":"Birds of Paradise","doc_count":15}&#xA;{"key":"Circle of Protection: Black","doc_count":15}&#xA;{"key":"Lightning Bolt","doc_count":15}&#xA;{"key":"Grizzly Bears","doc_count":14}&#xA;{"key":"Black Knight","doc_count":13}&#xA;{"key":"Bad Moon","doc_count":12}&#xA;{"key":"Boomerang","doc_count":12}&#xA;{"key":"Wall of Bone","doc_count":12}&#xA;{"key":"Balance","doc_count":11}&#xA;</code></pre>&#xA;&#xA;<p>How can I get elasticsearch to only return unique fields from the aggregate?</p>&#xA;
<p>To remove duplicates being returned in your aggregate you can try:</p>&#xA;&#xA;<pre><code>"aggs": {&#xA;  "group_by_name": {&#xA;    "terms": { "field":"name.raw" },&#xA;    "aggs": {&#xA;      "remove_dups": {&#xA;        "top_hits": {&#xA;          "size": 1,&#xA;          "_source": false&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;