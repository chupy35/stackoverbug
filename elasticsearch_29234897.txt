29234897
Elastic(search): How to structure nested queries correctly?
<p>I'm currently quite confuse about the structuring of queries in elastic. Let me explain what I mean with the following template that works fine for me:</p>&#xA;&#xA;<pre><code>{&#xA;"template" : {&#xA;    "query" : {&#xA;        "filtered" : {&#xA;            "query" : {&#xA;                "bool" : {&#xA;                    "must" : [&#xA;                        { "match" : {&#xA;                            "user"  : "{{param_user}}"&#xA;                        } },&#xA;                        { "match" : {&#xA;                            "session" : "{{param_session}}"&#xA;                        } },&#xA;                        { "range" : {&#xA;                            "date" : {&#xA;                                "gte" : "{{param_from}}",&#xA;                                "lte" : "{{param_to}}"&#xA;                            }&#xA;                        } }&#xA;                    ]&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Ok so I want to get entries of a specific session of a user in a certain time period. Now if you take a llok at this link <a href="http://www.elastic.co/guide/en/elasticsearch/guide/current/combining-filters.html" rel="nofollow">http://www.elastic.co/guide/en/elasticsearch/guide/current/combining-filters.html</a> you can find the following query: </p>&#xA;&#xA;<pre><code>{&#xA;"query" : {&#xA;  "filtered" : { &#xA;     "filter" : {&#xA;        "bool" : {&#xA;          "should" : [&#xA;             { "term" : {"price" : 20}}, &#xA;             { "term" : {"productID" : "XHDK-A-1293-#fJ3"}} &#xA;          ],&#xA;          "must_not" : {&#xA;             "term" : {"price" : 30} &#xA;          }&#xA;       }&#xA;     }&#xA;  }&#xA;}&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>In this example we have right after the <code>"filtered"</code> the <code>"filter"</code> keyword. However if I exchange my second <code>"query"</code> with a <code>"filter"</code> as in the example , my template won't work anymore. This is really counterintuitive and I payed alot of time to figure this out. A̶l̶s̶o̶ ̶I̶ ̶d̶o̶n̶'̶t̶ ̶u̶n̶d̶e̶r̶s̶t̶a̶n̶d̶ ̶w̶h̶y̶ ̶w̶e̶ ̶n̶e̶e̶d̶ ̶t̶o̶ ̶p̶u̶t̶ ̶e̶v̶e̶r̶y̶ ̶f̶i̶l̶t̶e̶r̶ ̶i̶n̶ ̶s̶e̶p̶a̶r̶a̶t̶e̶ ̶<code>̶{̶ ̶}̶</code>̶ ̶e̶v̶e̶n̶ ̶t̶h̶o̶u̶g̶h̶ ̶t̶h̶e̶y̶ ̶a̶r̶e̶ ̶a̶l̶r̶e̶a̶d̶y̶ ̶s̶e̶p̶a̶r̶a̶t̶e̶d̶ ̶b̶y̶ ̶t̶h̶e̶ ̶a̶r̶r̶a̶y̶ ̶s̶y̶n̶t̶a̶x̶.̶</p>&#xA;&#xA;<p>Another issue I had was that I suggested to match several fields I can just type smth like:</p>&#xA;&#xA;<pre><code>{&#xA;"query" : {&#xA;    "match" : {&#xA;        "user"  : "{{param_user}}",&#xA;        "session" : "{{param_session}}"&#xA;    }&#xA;}&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>but it seemed that I have to use a bool query which I didn't know of, so I searched for 'elastic multi match' but got something completely different. </p>&#xA;&#xA;<p>My question: where can I find how to structure a query properly (smth like a PEG)? The documentation only give basic examples but doesn't state what we can actually do and how.</p>&#xA;&#xA;<p>Best regards,&#xA;Jan</p>&#xA;&#xA;<p><strong>Edit:</strong> Ok I just found by accident that I cannot exchange <code>"query"</code> with <code>"filter"</code> as <code>"match"</code> is a query and not a filter. But then again what about <code>"range"</code>? It seems to be a query as well as a filter... Is there a summary of keywords specifying in which context they can be used?</p>&#xA;
<blockquote>&#xA;  <p>Is there a summary of keywords specifying in which context they can be used?</p>&#xA;</blockquote>&#xA;&#xA;<p>I wouldn't consider that as <code>keywords</code>. It's just there are both queries and filters with the same names (but not all of them). </p>&#xA;&#xA;<p><a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.x/query-dsl.html" rel="nofollow">Here</a> is everything you need. For example there are both <code>range</code> query and filter. All you need is to understand the difference between filters and queries. </p>&#xA;&#xA;<p>For example, if you want to move <code>range</code> section from query to filter, you can do that like shown in the code below (not tested). Since your code already contains <code>filtered</code> type of query, you can just create <code>filter</code> section right after <code>query</code> section.</p>&#xA;&#xA;<pre><code>{&#xA;    "template": {&#xA;        "query": {&#xA;            "filtered": {&#xA;                "query": {&#xA;                    "bool": {&#xA;                        "must": [&#xA;                            {&#xA;                                "match": {&#xA;                                    "user": "{{param_user}}"&#xA;                                }&#xA;                            },&#xA;                            {&#xA;                                "match": {&#xA;                                    "session": "{{param_session}}"&#xA;                                }&#xA;                            }&#xA;                        ]&#xA;                    }&#xA;                },&#xA;                "filter": {&#xA;                    "range": {&#xA;                        "date": {&#xA;                            "gte": "{{param_from}}",&#xA;                            "lte": "{{param_to}}"&#xA;                        }&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Just remember that you can filter only <strong>not</strong> analyzed fields.</p>&#xA;