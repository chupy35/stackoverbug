33178227
Elasticsearch score with subdocuments count
<p>I have these 3 objects (3 users with photos, and every photo has a category id)</p>&#xA;&#xA;<pre><code>{&#xA;    "id": 1,&#xA;    "name": "User1",&#xA;    "photos":[&#xA;        {&#xA;            "id": 1,&#xA;            "cat": 1&#xA;        },&#xA;        {&#xA;            "id": 2,&#xA;            "cat": 1&#xA;        },&#xA;        {&#xA;            "id": 3,&#xA;            "cat": 2&#xA;        }&#xA;    ]&#xA;}&#xA;{&#xA;    "id": 2,&#xA;    "name": "User2",&#xA;    "photos":[&#xA;        {&#xA;            "id": 4,&#xA;            "cat": 1&#xA;        },&#xA;        {&#xA;            "id": 5,&#xA;            "cat": 2&#xA;        },&#xA;        {&#xA;            "id": 6,&#xA;            "cat": 2&#xA;        }&#xA;    ]&#xA;}&#xA;{&#xA;    "id": 3,&#xA;    "name": "User3",&#xA;    "photos":[&#xA;        {&#xA;            "id": 7,&#xA;            "cat": 2&#xA;        },&#xA;        {&#xA;            "id": 8,&#xA;            "cat": 3&#xA;        },&#xA;        {&#xA;            "id": 9,&#xA;            "cat": 3&#xA;        }&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I want to give a score (max score: 10) to these documents depending on how many photos they have with cat = 1</p>&#xA;&#xA;<pre><code>Object1 : 2 objects with cat = 1&#xA;Object2 : 1 objects with cat = 1&#xA;Object3 : 0 objects with cat = 1&#xA;</code></pre>&#xA;&#xA;<p>So the score will be Object1 = 10, Object2 = 5, Object3 = 0</p>&#xA;
<p>Either what @eemp said or if you cannot modify the way documents are indexed and/or if you cannot modify the mappings, then one solution would be to leverage a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html" rel="nofollow"><code>function_score</code> query</a> with a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-script-score" rel="nofollow"><code>script_score</code></a> component in which we access the <code>photos</code> array and multiply by 5 the number of elements having <code>cat == 1</code> .</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "function_score": {&#xA;      "query": {&#xA;        "match_all": {}&#xA;      },&#xA;      "functions": [&#xA;        {&#xA;          "script_score": {&#xA;            "script": "_source.photos.findAll{return it.cat == 1}.size() * 5"&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>You'll get the scores you expect, i.e.</p>&#xA;&#xA;<ul>&#xA;<li>10 for object 1</li>&#xA;<li>5 for object 2</li>&#xA;<li>0 for object 3</li>&#xA;</ul>&#xA;