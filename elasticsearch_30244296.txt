30244296
Elasticsearch long GC
<p>Running 1.5.2</p>&#xA;&#xA;<p>Per Server specs: 2x8 (Hyperthreaded) 32 cores, 128GB RAM, 5.2TB SSDS, Windows 2008</p>&#xA;&#xA;<p>Running 4 node cluster Elasticsearch default settings except where noted.</p>&#xA;&#xA;<pre><code>#Since day 1 configured to use 30gb, using doc values but expect quite a bit of sorting.&#xA;ES_HEAP_SIZE=30gb&#xA;&#xA;#Not really starting multiple nodes on same machine forgot to turn this off.&#xA;cluster.routing.allocation.same_shard.host: true&#xA;discovery.zen.minimum_master_nodes: 3&#xA;discovery.zen.ping.timeout: 6s&#xA;discovery.zen.ping.multicast.enabled: true&#xA;&#xA;#Configured the below setting to allow better bulking. Looked at marvel stats, the 512 bulk pool was initially configured since we where bulking into multiple indexes at same time which is no longer the case. It isn't really needed will probably reduce it but I doubt it's the root cause. Now only bulking into single index per bulk request.&#xA;{&#xA;   "persistent": {&#xA;      "threadpool": {&#xA;         "bulk": {&#xA;            "size": "512",&#xA;            "queue_size": "512"&#xA;         }&#xA;      },&#xA;      "indices": {&#xA;         "store": {&#xA;            "throttle": {&#xA;               "max_bytes_per_sec": "200mb"&#xA;            }&#xA;         }&#xA;      }&#xA;   },&#xA;   "transient": {&#xA;      "cluster": {&#xA;         "routing": {&#xA;            "allocation": {&#xA;               "cluster_concurrent_rebalance": "8",&#xA;               "node_concurrent_recoveries": "8",&#xA;               "node_initial_primaries_recoveries": "16",&#xA;               "enable": "all"&#xA;            }&#xA;         }&#xA;      },&#xA;      "indices": {&#xA;         "recovery": {&#xA;            "concurrent_streams": "9",&#xA;            "max_bytes_per_sec": "80mb"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;&#xA;Index refresh rate is set to 30s and translog threashold to 1000mb&#xA;</code></pre>&#xA;&#xA;<p>With the above settings we were able to bulk index 3500 documents/sec for 2.5 days straight we reached 400 million documents verry stable cluster and running some searches. We are not using field data, we are configured for doc_values though we do expect to do quite a bit of sorting in searches.</p>&#xA;&#xA;<p>At the time of the long GC, we where only doing bulk, no specific searches, nothing else, except marvel open in a browser. Was away not testing searches.</p>&#xA;&#xA;<p>Field data size is about 20mb per node and 150mb for filter cache per node.</p>&#xA;&#xA;<p>Then this hapenned on a single node:</p>&#xA;&#xA;<pre><code>[2015-05-14 10:21:43,607][WARN ][monitor.jvm              ] [xxx.xxx.xxx.xxx] [gc][old][301536][3170] duration [6.2m], collections [4]/[6.2m], total [6.2m]/[2.1h], memory [28.2gb]-&gt;[28.3gb]/[29.8gb], all_pools {[young] [480.3mb]-&gt;[406.4mb]/[1.4gb]}{[survivor] [0b]-&gt;[191.3mb]/[191.3mb]}{[old] [27.7gb]-&gt;[27.8gb]/[28.1gb]}&#xA;</code></pre>&#xA;&#xA;<p>Now the cluster is in Yellow state and balancing the shards.</p>&#xA;&#xA;<p>The latest VM stats:</p>&#xA;&#xA;<pre><code>{&#xA;   "cluster_name": "xxxx",&#xA;   "nodes": {&#xA;      "RYl4XN03TNuXFkKfUgm3fQ": {&#xA;         "timestamp": 1431626086373,&#xA;         "name": "xxxx (10.0.0.xxxx)",&#xA;         "transport_address": "inet[/10.0.0.xxxx:9300]",&#xA;         "host": "xxxx",&#xA;         "ip": [&#xA;            "inet[/10.0.0.xxxx:9300]",&#xA;            "NONE"&#xA;         ],&#xA;         "jvm": {&#xA;            "timestamp": 1431626085671,&#xA;            "uptime_in_millis": 326261959,&#xA;            "mem": {&#xA;               "heap_used_in_bytes": 27794721128,&#xA;               "heap_used_percent": 86,&#xA;               "heap_committed_in_bytes": 32011649024,&#xA;               "heap_max_in_bytes": 32011649024,&#xA;               "non_heap_used_in_bytes": 129160952,&#xA;               "non_heap_committed_in_bytes": 131510272,&#xA;               "pools": {&#xA;                   "young": {&#xA;                     "used_in_bytes": 1285037736,&#xA;                     "max_in_bytes": 1605304320,&#xA;                     "peak_used_in_bytes": 1605304320,&#xA;                     "peak_max_in_bytes": 1605304320&#xA;                  },&#xA;                  "survivor": {&#xA;                     "used_in_bytes": 6206720,&#xA;                     "max_in_bytes": 200605696,&#xA;                     "peak_used_in_bytes": 200605696,&#xA;                     "peak_max_in_bytes": 200605696&#xA;                  },&#xA;                  "old": {&#xA;                     "used_in_bytes": 26503476672,&#xA;                     "max_in_bytes": 30205739008,&#xA;                     "peak_used_in_bytes": 30202301920,&#xA;                     "peak_max_in_bytes": 30205739008&#xA;                  }&#xA;               }&#xA;            },&#xA;            "threads": {&#xA;               "count": 872,&#xA;               "peak_count": 4152&#xA;            },&#xA;            "gc": {&#xA;                "collectors": {&#xA;                  "young": {&#xA;                     "collection_count": 133741,&#xA;                     "collection_time_in_millis": 14345888&#xA;                  },&#xA;                  "old": {&#xA;                     "collection_count": 3801,&#xA;                     "collection_time_in_millis": 5671656&#xA;                  }&#xA;               }&#xA;            },&#xA;            "buffer_pools": {&#xA;               "direct": {&#xA;                  "count": 2270,&#xA;                  "used_in_bytes": 135625370,&#xA;                  "total_capacity_in_bytes": 135625370&#xA;               },&#xA;               "mapped": {&#xA;                  "count": 28033,&#xA;                  "used_in_bytes": 1222266447033,&#xA;                  "total_capacity_in_bytes": 1222266447033&#xA;               }&#xA;            }&#xA;         }&#xA;      },&#xA;      "GIGmBll-RsO0CIeiRol19Q": {&#xA;         "timestamp": 1431626086313,&#xA;         "name": "xxxx (10.0.0.xxxx)",&#xA;         "transport_address": "inet[/10.0.0.xxxx:9300]",&#xA;         "host": "xxxx",&#xA;         "ip": [&#xA;            "inet[/10.0.0.xxxx:9300]",&#xA;            "NONE"&#xA;         ],&#xA;         "jvm": {&#xA;            "timestamp": 1431626086313,&#xA;            "uptime_in_millis": 326247220,&#xA;            "mem": {&#xA;               "heap_used_in_bytes": 26759522704,&#xA;               "heap_used_percent": 83,&#xA;               "heap_committed_in_bytes": 32011649024,&#xA;               "heap_max_in_bytes": 32011649024,&#xA;               "non_heap_used_in_bytes": 130322080,&#xA;               "non_heap_committed_in_bytes": 132616192,&#xA;               "pools": {&#xA;                  "young": {&#xA;                     "used_in_bytes": 207756720,&#xA;                     "max_in_bytes": 1605304320,&#xA;                     "peak_used_in_bytes": 1605304320,&#xA;                     "peak_max_in_bytes": 1605304320&#xA;                  },&#xA;                  "survivor": {&#xA;                     "used_in_bytes": 34069744,&#xA;                     "max_in_bytes": 200605696,&#xA;                     "peak_used_in_bytes": 200605696,&#xA;                     "peak_max_in_bytes": 200605696&#xA;                  },&#xA;                  "old": {&#xA;                     "used_in_bytes": 26517696240,&#xA;                     "max_in_bytes": 30205739008,&#xA;                     "peak_used_in_bytes": 30201611848,&#xA;                     "peak_max_in_bytes": 30205739008&#xA;                  }&#xA;               }&#xA;            },&#xA;            "threads": {&#xA;               "count": 884,&#xA;               "peak_count": 2855&#xA;            },&#xA;            "gc": {&#xA;               "collectors": {&#xA;                  "young": {&#xA;                     "collection_count": 132317,&#xA;                     "collection_time_in_millis": 14532604&#xA;                  },&#xA;                  "old": {&#xA;                     "collection_count": 3728,&#xA;                     "collection_time_in_millis": 6390133&#xA;                  }&#xA;               }&#xA;            },&#xA;            "buffer_pools": {&#xA;               "direct": {&#xA;                  "count": 2301,&#xA;                  "used_in_bytes": 136604011,&#xA;                  "total_capacity_in_bytes": 136604011&#xA;               },&#xA;               "mapped": {&#xA;                  "count": 28077,&#xA;                  "used_in_bytes": 1226500757758,&#xA;                  "total_capacity_in_bytes": 1226500757758&#xA;               }&#xA;            }&#xA;         }&#xA;      },&#xA;      "JNcxaYFTSv20iqAmgpBm2Q": {&#xA;         "timestamp": 1431626086599,&#xA;         "name": "xxxx (10.0.0.xxxx)",&#xA;         "transport_address": "inet[xxxx/10.0.0.xxxx:9300]",&#xA;         "host": "xxxx",&#xA;         "ip": [&#xA;            "inet[xxxx/10.0.0.xxxx:9300]",&#xA;            "NONE"&#xA;         ],&#xA;         "jvm": {&#xA;            "timestamp": 1431626086599,&#xA;            "uptime_in_millis": 326274817,&#xA;            "mem": {&#xA;               "heap_used_in_bytes": 12784591992,&#xA;               "heap_used_percent": 39,&#xA;               "heap_committed_in_bytes": 32011649024,&#xA;               "heap_max_in_bytes": 32011649024,&#xA;               "non_heap_used_in_bytes": 133812080,&#xA;               "non_heap_committed_in_bytes": 135835648,&#xA;               "pools": {&#xA;                  "young": {&#xA;                     "used_in_bytes": 398354208,&#xA;                     "max_in_bytes": 1605304320,&#xA;                     "peak_used_in_bytes": 1605304320,&#xA;                     "peak_max_in_bytes": 1605304320&#xA;                  },&#xA;                  "survivor": {&#xA;                     "used_in_bytes": 84894616,&#xA;                     "max_in_bytes": 200605696,&#xA;                     "peak_used_in_bytes": 200605696,&#xA;                     "peak_max_in_bytes": 200605696&#xA;                  },&#xA;                  "old": {&#xA;                     "used_in_bytes": 12301347344,&#xA;                     "max_in_bytes": 30205739008,&#xA;                     "peak_used_in_bytes": 30200356360,&#xA;                     "peak_max_in_bytes": 30205739008&#xA;                  }&#xA;               }&#xA;            },&#xA;            "threads": {&#xA;               "count": 897,&#xA;               "peak_count": 2319&#xA;            },&#xA;            "gc": {&#xA;               "collectors": {&#xA;                  "young": {&#xA;                     "collection_count": 132882,&#xA;                     "collection_time_in_millis": 14076027&#xA;                  },&#xA;                  "old": {&#xA;                     "collection_count": 3175,&#xA;                     "collection_time_in_millis": 7975099&#xA;                  }&#xA;               }&#xA;            },&#xA;            "buffer_pools": {&#xA;               "direct": {&#xA;                  "count": 3094,&#xA;                  "used_in_bytes": 165837901,&#xA;                  "total_capacity_in_bytes": 165837901&#xA;               },&#xA;               "mapped": {&#xA;                  "count": 16336,&#xA;                  "used_in_bytes": 716955739746,&#xA;                  "total_capacity_in_bytes": 716955739746&#xA;               }&#xA;            }&#xA;          }&#xA;      },&#xA;      "BXb5Ek48TTeD87WOM3wqXg": {&#xA;         "timestamp": 1431626086497,&#xA;         "name": "xxxx (10.0.0.xxxx)",&#xA;         "transport_address": "inet[/10.0.0.xxxx:9300]",&#xA;         "host": "xxxx",&#xA;         "ip": [&#xA;            "inet[/10.0.0.xxxx:9300]",&#xA;            "NONE"&#xA;         ],&#xA;         "jvm": {&#xA;            "timestamp": 1431626086497,&#xA;            "uptime_in_millis": 326255802,&#xA;            "mem": {&#xA;               "heap_used_in_bytes": 26938475512,&#xA;               "heap_used_percent": 84,&#xA;               "heap_committed_in_bytes": 32011649024,&#xA;               "heap_max_in_bytes": 32011649024,&#xA;               "non_heap_used_in_bytes": 137921040,&#xA;               "non_heap_committed_in_bytes": 139923456,&#xA;               "pools": {&#xA;                  "young": {&#xA;                     "used_in_bytes": 1469836080,&#xA;                     "max_in_bytes": 1605304320,&#xA;                     "peak_used_in_bytes": 1605304320,&#xA;                     "peak_max_in_bytes": 1605304320&#xA;                  },&#xA;                  "survivor": {&#xA;                     "used_in_bytes": 34356752,&#xA;                     "max_in_bytes": 200605696,&#xA;                     "peak_used_in_bytes": 200605696,&#xA;                     "peak_max_in_bytes": 200605696&#xA;                  },&#xA;                  "old": {&#xA;                     "used_in_bytes": 25434282680,&#xA;                     "max_in_bytes": 30205739008,&#xA;                     "peak_used_in_bytes": 30201487944,&#xA;                     "peak_max_in_bytes": 30205739008&#xA;                  }&#xA;               }&#xA;            },&#xA;            "threads": {&#xA;               "count": 909,&#xA;               "peak_count": 1414&#xA;            },&#xA;            "gc": {&#xA;               "collectors": {&#xA;                  "young": {&#xA;                      "collection_count": 128613,&#xA;                      "collection_time_in_millis": 13985910&#xA;                  },&#xA;                  "old": {&#xA;                     "collection_count": 3582,&#xA;                     "collection_time_in_millis": 6905669&#xA;                  }&#xA;               }&#xA;            },&#xA;            "buffer_pools": {&#xA;               "direct": {&#xA;                  "count": 2419,&#xA;                  "used_in_bytes": 141681639,&#xA;                  "total_capacity_in_bytes": 141681639&#xA;               },&#xA;               "mapped": {&#xA;                  "count": 27785,&#xA;                  "used_in_bytes": 1220079289372,&#xA;                  "total_capacity_in_bytes": 1220079289372&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;