29361395
Elasticsearch inner hits on grandchildren
<p>I some troubles with the new <code>inner_hits</code> feature.&#xA;When used on parent/child it works, but if i try to use it on a grandchild, it doesn't seem to work.</p>&#xA;&#xA;<p>This is my mapping</p>&#xA;&#xA;<pre><code>{&#xA;    "test": {&#xA;        "template": "test",&#xA;        "settings": {&#xA;            "index": {&#xA;                "number_of_replicas": 0&#xA;            }&#xA;        },&#xA;        "mappings": {&#xA;            "parents": {&#xA;                "dynamic": "strict",&#xA;                "_routing": {&#xA;                    "required": true&#xA;                },&#xA;                "properties": {&#xA;                    "parent_value": {&#xA;                        "type": "string"&#xA;                    }&#xA;                }&#xA;            },&#xA;            "children": {&#xA;                "dynamic": "strict",&#xA;                "_routing": {&#xA;                    "required": true&#xA;                },&#xA;                "_parent": {&#xA;                    "type": "parents"&#xA;                },&#xA;                "properties": {&#xA;                    "parent_id": {&#xA;                        "type": "string",&#xA;                        "index": "not_analyzed"&#xA;                    },&#xA;                    "child_value": {&#xA;                        "type": "string"&#xA;                    }&#xA;                }&#xA;            },&#xA;            "grandchildren": {&#xA;                "dynamic": "strict",&#xA;                "_routing": {&#xA;                    "required": true&#xA;                },&#xA;                "_parent": {&#xA;                    "type": "children"&#xA;                },&#xA;                "properties": {&#xA;                    "children_id": {&#xA;                        "type": "string",&#xA;                        "index": "not_analyzed"&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I insert data via Sense</p>&#xA;&#xA;<pre><code>PUT test/parents/parent_id?routing=1&#xA;{&#xA;    "parent_value": "PARENT VALUE"&#xA;}&#xA;&#xA;PUT test/children/child_id?routing=1&amp;parent=parent_id&#xA;{&#xA;    "parent_id": "parent_id",&#xA;    "child_value": "CHILD VALUE"&#xA;}&#xA;&#xA;PUT test/grandchildren/grandchild_id?routing=1&amp;parent=child_id&#xA;{&#xA;    "children_id": "child_id"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>This works perfect</p>&#xA;&#xA;<pre><code>GET test/children/_search?routing=1&#xA;{&#xA;   "post_filter": {&#xA;      "bool": {&#xA;         "must": [&#xA;            {&#xA;               "has_parent": {&#xA;                  "parent_type": "parents",&#xA;                  "filter": {&#xA;                     "bool": {&#xA;                        "must": [&#xA;                           {&#xA;                              "ids": {&#xA;                                  "values": ["parent_id"]&#xA;                              }&#xA;                           }&#xA;                        ]&#xA;                     }&#xA;                  },&#xA;                  "inner_hits": {&#xA;                  }&#xA;               }&#xA;            }&#xA;         ]&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Yay!</p>&#xA;&#xA;<p>But if i try this, it finds a document, but the <code>inner_hits</code> is empty.</p>&#xA;&#xA;<pre><code>GET test/grandchildren/_search?routing=1&#xA;{&#xA;   "post_filter": {&#xA;      "bool": {&#xA;         "must": [&#xA;            {&#xA;               "has_parent": {&#xA;                  "parent_type": "children",&#xA;                  "filter": {&#xA;                     "bool": {&#xA;                        "must": [&#xA;                           {&#xA;                              "ids": {&#xA;                                  "values": ["child_id"]&#xA;                              }&#xA;                           }&#xA;                        ]&#xA;                     }&#xA;                  },&#xA;                  "inner_hits": {&#xA;                  }&#xA;               }&#xA;            }&#xA;         ]&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>What am i doing wrong..?</p>&#xA;
<p>It's a known <a href="https://github.com/elastic/elasticsearch/issues/11118" rel="nofollow">issue.</a> The <a href="https://github.com/elastic/elasticsearch/issues/13064" rel="nofollow">workaround</a> is to duplicate your query for all levels of <code>inner hits</code> branch:</p>&#xA;&#xA;<pre><code>curl -XGET "http://localhost:9200/_search" -d'&#xA;{&#xA;  "query": {&#xA;    "nested": {&#xA;      "path": "cars",&#xA;      "query": {&#xA;        "nested": {&#xA;          "path": "cars.manufacturers",&#xA;          "query": {&#xA;            "match": {&#xA;              "cars.manufacturers.country": "Japan"&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "inner_hits": {&#xA;    "cars": {&#xA;      "path": {&#xA;        "cars": {&#xA;          "query": {&#xA;            "nested": {&#xA;              "path": "cars.manufacturers",&#xA;              "query": {&#xA;                "match": {&#xA;                  "cars.manufacturers.country": "Japan"&#xA;                }&#xA;              }&#xA;            }&#xA;          },&#xA;          "inner_hits": {&#xA;            "manufacturers": {&#xA;              "path": {&#xA;                "cars.manufacturers": {&#xA;                  "query": {&#xA;                    "match": {&#xA;                      "cars.manufacturers.country": "Japan"&#xA;                    }&#xA;                  }&#xA;                }&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}'&#xA;</code></pre>&#xA;