33630013
Ignoring records marked as deleted in Elasticsearch
<p>I'm trying to process records only if <code>deleted_at</code> is <em>null</em> or <em>empty</em>. I modified my original query as shown below but for some reason the result won't change. I'm still getting deleted records.</p>&#xA;&#xA;<p>I went thru similar SO questions and read up on <a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.4/query-dsl-exists-filter.html" rel="nofollow">Exists Filter</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.4/query-dsl-missing-filter.html#query-dsl-missing-filter" rel="nofollow">Missing Filter</a> and <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_dealing_with_null_values.html" rel="nofollow">Dealing with Null Values</a> but failed to implement one.</p>&#xA;&#xA;<p><strong>Analyser and the Mapping</strong></p>&#xA;&#xA;<pre><code>'settings' =&gt; [&#xA;    'index' =&gt; [&#xA;        'analysis' =&gt; [&#xA;            'analyzer' =&gt; [&#xA;                'snowball_analyzer' =&gt; [&#xA;                    'type' =&gt; 'snowball',&#xA;                    'language' =&gt; 'English',&#xA;                ],&#xA;            ],&#xA;        ],&#xA;    ],&#xA;],&#xA;'types' =&gt; [&#xA;    'mappings' =&gt; [&#xA;            'deleted_at' =&gt; ['type' =&gt; 'date'],&#xA;    ],&#xA;],&#xA;</code></pre>&#xA;&#xA;<p><strong>ORIGINAL QUERY</strong></p>&#xA;&#xA;<pre><code>{&#xA;  "sort": {&#xA;    "_score": "desc"&#xA;  },&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "term": {&#xA;                "user_id": "35ee78ea"&#xA;              }&#xA;            },&#xA;            {&#xA;              "term": {&#xA;                "age": "44"&#xA;              }&#xA;            }&#xA;          ],&#xA;          "minimum_should_match": 1&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<blockquote>&#xA;  <p>The <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_dealing_with_null_values.html#_missing_filter" rel="nofollow">missing filter</a> is essentially the inverse of exists: it returns&#xA;  documents where there is no value for a particular field</p>&#xA;</blockquote>&#xA;&#xA;<p><strong>MY INEFFECTIVE MODIFICATION 1</strong></p>&#xA;&#xA;<pre><code>{&#xA;  "sort": {&#xA;    "_score": "desc"&#xA;  },&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "term": {&#xA;                "user_id": "35ee78ea"&#xA;              }&#xA;            },&#xA;            {&#xA;              "term": {&#xA;                "age": "44"&#xA;              }&#xA;            }&#xA;          ],&#xA;          "minimum_should_match": 1&#xA;        }&#xA;      },&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "missing": {&#xA;                "field": "deleted_at"&#xA;              }&#xA;            }&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p><strong>MY INEFFECTIVE MODIFICATION 2</strong></p>&#xA;&#xA;<pre><code>{&#xA;  "sort": {&#xA;    "_score": "desc"&#xA;  },&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "term": {&#xA;                "user_id": "35ee78ea"&#xA;              }&#xA;            },&#xA;            {&#xA;              "term": {&#xA;                "age": "44"&#xA;              }&#xA;            }&#xA;          ],&#xA;          "minimum_should_match": 1&#xA;        }&#xA;      },&#xA;      "filter": [&#xA;        {&#xA;          "missing": {&#xA;            "field": "deleted_at"&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;