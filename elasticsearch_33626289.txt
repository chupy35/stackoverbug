33626289
elasticsearch filter array data with aggs
<p>I use elasticsearch to store my biological data.</p>&#xA;&#xA;<p>I try to make a query with filtered aggs but the returned data are not what I want.&#xA;The problem come from the fact that I have for each specimens a "d_" attribute who is an array. I need to make aggs on only some elements of this array but I fail to filter them.</p>&#xA;&#xA;<p>// I EDIT manually the data to make more easier to understand so maybe some typo errors</p>&#xA;&#xA;<p>Example of my data :</p>&#xA;&#xA;<pre><code>   [    {&#xA;        "_index": "botanique",&#xA;        "_type": "specimens",&#xA;        "_id": "227CB8A3E2834AAEB50B1ECF6B672180",&#xA;        "_score": 1,&#xA;        "_source": {&#xA;            ....&#xA;            "d_": [&#xA;                {     // -------------- dont want this&#xA;                    "taxonid": "BB7C33A3126648D095BEDDABB0BD2758",&#xA;                    "scientificname": "Lastreopsis effusa",&#xA;                    "scientificnameauthorship": "(Sw.) Tindale"&#xA;                },&#xA;                {    // -------------- want this&#xA;                    "taxonid": "704FC303D7F74C02912D0FEB5C6FC55D",&#xA;                    "scientificname": "Parapolystichum effusum",&#xA;                    "scientificnameauthorship": "(sw.) copel."&#xA;                }&#xA;            ]&#xA;        }&#xA;    } , {&#xA;        "_index": "botanique",&#xA;        "_type": "specimens",&#xA;        "_id": "11A22DE8E4AD45BBAC7783E508079DCD",&#xA;        "_score": 1,&#xA;        "_source": {&#xA;            ....&#xA;            "d_": [&#xA;                {     // -------------- want this&#xA;                    "taxonid": "A94D243348DF4CAD926B6C3965D948A3",&#xA;                    "scientificname": "Parapolystichum effusum",&#xA;                    "scientificnameauthorship": "(Sw.) Ching",&#xA;                }                   ,&#xA;                {    // -------------- dont want this&#xA;                    "taxonid": "B01A89AA961A46F2984722C311DC2BDD",&#xA;                    "scientificname": "Lastreopsis effusa",&#xA;                    "scientificnameauthorship": "(willd. ex schkuhr) proctor"&#xA;                }&#xA;            ]&#xA;        }&#xA;    },{&#xA;        "_index": "botanique",&#xA;        "_type": "specimens",&#xA;        "_id": "1647F5E23D304EFAAB9D3E3BE80FD3CE",&#xA;        "_score": 1,&#xA;        "_source": {&#xA;            ...&#xA;            "d_": [&#xA;                {    // -------------- want this&#xA;                    "taxonid": "D70C4478D2B0437AA940994E98D696C5",&#xA;                    "scientificname": "Parapolystichum effusum",&#xA;                    "scientificnameauthorship": "(Sw.) Ching"&#xA;                } ,&#xA;                {    // -------------- dont want this&#xA;                    "taxonid": "011E5DA526FC4098953DBD1F9E5F4424",&#xA;                    "scientificname": "Lastreopsis effusa",&#xA;                    "scientificnameauthorship": "(Sw.) Tindale",&#xA;                }&#xA;            ]&#xA;        }&#xA;    }&#xA;]&#xA;</code></pre>&#xA;&#xA;<p>For example I want an aggs on all the "d_.scientificnameauthorship" and "d_.taxonid" where "d_.scientificname" equal "parapolystichum effusum".&#xA;So i should (hope) get for "scientificnameauthorship" : "(sw.) copel." , "(Sw.) Ching" but not "(willd. ex schkuhr) proctor". I FAIL doing this...</p>&#xA;&#xA;<p>My query :</p>&#xA;&#xA;<pre><code>{&#xA;  "_source": ["d_" ],&#xA;  "size": 3,&#xA;  "query": {&#xA;    "filtered": {"filter": {"bool": {"must": [{"term": {&#xA;                "d_.scientificname": "parapolystichum effusum"&#xA;    }}] } }}&#xA;  },&#xA;  "aggs": {&#xA;    "scientificname": {&#xA;      "terms": {&#xA;        "field": "d_.scientificname",&#xA;        "size": 1,&#xA;        "include": {&#xA;          "pattern": "parapolystichum effusum",&#xA;          "flags": "CANON_EQ|CASE_INSENSITIVE"&#xA;        }&#xA;      },&#xA;      "aggs": {&#xA;        "scientificnameauthorship": {&#xA;          "terms": {&#xA;            "field": "d_.scientificnameauthorship",&#xA;            "size": 10&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The returned data include all the "scientificnameauthorship" of the specimens  </p>&#xA;&#xA;<pre><code>{&#xA;    "aggregations": {&#xA;        "scientificname": {&#xA;            "buckets": [{&#xA;                "key": "parapolystichum effusum",&#xA;                "doc_count": 269,&#xA;                "scientificnameauthorship": {&#xA;                    "buckets": [&#xA;                        {   // ------ want this &#xA;                            "key": "(sw.) ching",&#xA;                            "doc_count": 269&#xA;                        }                        ,&#xA;                        {   // ------ want this &#xA;                            "key": "(sw.) copel.",&#xA;                            "doc_count": 34&#xA;                        }                        , &#xA;                        {   // ------ dont want this &#xA;                            "key": "(sw.) tindale",&#xA;                            "doc_count": 262&#xA;                        }                        ,&#xA;                        {   // ------ dont want this &#xA;                            "key": "(willd. ex schkuhr) proctor",&#xA;                            "doc_count": 7&#xA;                        }                        ,&#xA;                        {   // ------ dont want this &#xA;                            "key": "f√©e",&#xA;                            "doc_count": 2&#xA;                        }&#xA;                    ]&#xA;                }&#xA;            }]&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<ol>&#xA;<li><strong>how to edit in the aggs query  ?</strong></li>&#xA;<li><strong>how to get only on item of the array in hits ?</strong></li>&#xA;</ol>&#xA;&#xA;<p>Get this : </p>&#xA;&#xA;<pre><code>{   &#xA;    "hits": {&#xA;        "total": 269,&#xA;        "max_score": 1,&#xA;        "hits": [&#xA;            {&#xA;                "_index": "botanique",&#xA;                "_type": "specimens",&#xA;                "_id": "1647F5E23D304EFAAB9D3E3BE80FD3CE",&#xA;                "_score": 1,&#xA;                "_source": {&#xA;                    ...&#xA;                    "d_": [{    // -------------- want this&#xA;                            "taxonid": "D70C4478D2B0437AA940994E98D696C5",&#xA;                            "scientificname": "Parapolystichum effusum",&#xA;                            "scientificnameauthorship": "(Sw.) Ching"&#xA;                        }]&#xA;                }                       &#xA;            }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Instead of this :</p>&#xA;&#xA;<pre><code>{   &#xA;    "hits": {&#xA;        "total": 269,&#xA;        "max_score": 1,&#xA;        "hits": [&#xA;            {&#xA;                "_index": "botanique",&#xA;                "_type": "specimens",&#xA;                "_id": "1647F5E23D304EFAAB9D3E3BE80FD3CE",&#xA;                "_score": 1,&#xA;                "_source": {&#xA;                    ...&#xA;                    "d_": [&#xA;                        {    // -------------- want this&#xA;                            "taxonid": "D70C4478D2B0437AA940994E98D696C5",&#xA;                            "scientificname": "Parapolystichum effusum",&#xA;                            "scientificnameauthorship": "(Sw.) Ching"&#xA;                        } ,&#xA;                        {    // -------------- dont want this&#xA;                            "taxonid": "011E5DA526FC4098953DBD1F9E5F4424",&#xA;                            "scientificname": "Lastreopsis effusa",&#xA;                            "scientificnameauthorship": "(Sw.) Tindale",&#xA;                        }&#xA;                    ]&#xA;                }&#xA;            }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>thank you very much</p>&#xA;&#xA;<p>// <strong>EDIT 1</strong> </p>&#xA;&#xA;<p>I also try to put a filter in the aggs like this but don't work :</p>&#xA;&#xA;<pre><code>{&#xA;    "query": {&#xA;        "filtered": {"filter": {"bool": {"must": [{"term": {&#xA;                    "d_.scientificname": "parapolystichum effusum"&#xA;        }}] } }}&#xA;    },&#xA;    "aggs" : {&#xA;        "scientificname" : {&#xA;            "filter" : {"term": {&#xA;                    "d_.scientificname": "parapolystichum effusum"&#xA;            }},&#xA;            "aggs": {&#xA;                "scientificnameauthorship": {&#xA;                  "terms": {&#xA;                    "field": "d_.scientificnameauthorship",&#xA;                    "size": 10&#xA;                  }&#xA;                }&#xA;              }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;
<p>You can use nested aggs as parent aggregator.Then inside the parent aggregator make a new filter aggregator to filter the array(list data) and append with another child aggregator for term aggregations.&#xA;<a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.4/search-aggregations-bucket-nested-aggregation.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/1.4/search-aggregations-bucket-nested-aggregation.html</a>&#xA;Sample Query</p>&#xA;&#xA;<pre><code>"filteredaggs" : {&#xA;          "nested" : {&#xA;            "path" : "D_"&#xA;          },&#xA;          "aggs" : {&#xA;            "maxdays" : {&#xA;              "filter" : {&#xA;                "terms" : {&#xA;                  "scientificname" : ["xyz", "pqr"]&#xA;                }&#xA;              },&#xA;              "aggs" : {&#xA;                "myfinalaggregator" : {&#xA;                  "terms" : {&#xA;                    "field" : "scientificnameauthorship"&#xA;                  }&#xA;                }&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;</code></pre>&#xA;&#xA;<p>Hope this will work for you.</p>&#xA;
<p>Finally found the answer, thanks to user3775217 for pointing the "nested" : </p>&#xA;&#xA;<pre><code>{&#xA;    "_source" : false,&#xA;    "size" : 0,&#xA;    "query" : {&#xA;        "filtered" : {&#xA;            "filter" : {&#xA;                "bool" : {&#xA;                    "must" : [{&#xA;                            "nested" : {&#xA;                                "path" : "d_",&#xA;                                "query" : {&#xA;                                    "bool" : {&#xA;                                        "must" : [{&#xA;                                                "wildcard" : {&#xA;                                                    "d_.scientificname" : {&#xA;                                                        "value" : "parapolystichum effusum*"&#xA;                                                    }&#xA;                                                }&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                            }&#xA;                        }&#xA;                    ]&#xA;                }&#xA;            }&#xA;        }&#xA;    },&#xA;    "aggs" : {&#xA;        "general" : {&#xA;            "nested" : {"path" : "d_"},&#xA;            "aggs" : {&#xA;                "scientificname" : {&#xA;                    "terms" : {&#xA;                        "field" : "d_.scientificname",&#xA;                        "size" : 20,&#xA;                        "include" : {&#xA;                            "pattern" : "parapolystichum effusum*",&#xA;                            "flags" : "CANON_EQ|CASE_INSENSITIVE"&#xA;                        }&#xA;                    },&#xA;                    "aggs" : {&#xA;                        "scientificnameauthorship" : {&#xA;                            "terms" : {&#xA;                                "field" : "d_.scientificnameauthorship",&#xA;                                "size" : 10&#xA;                            }&#xA;                        }&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Any suggestion are welcome specially a shorter working answer.</p>&#xA;