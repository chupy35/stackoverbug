28942314
Use aggregation metric as a filter in Elasticsearch
<p>I have a database containing logs about script runs. Some of these logs have StartTime and EndTime fields.</p>&#xA;&#xA;<p>For each kind of scripts (id), I would like to query for those that have the above mentioned fields, and their run time (EndTime - StartTime) is beyond the 97.7 percentile of their kind (id).</p>&#xA;&#xA;<p>I managed to return the duration corresponding to the 97.7th percentile for each script id with the following query:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "and": [&#xA;          { "exists": { "field": "StartTime"} },&#xA;          { "exists": { "field": "EndTime"} }&#xA;        ]&#xA;      } &#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "script_run_percentiles": {&#xA;      "terms": {&#xA;        "field":"ID"&#xA;      },&#xA;      "aggs": {&#xA;        "duration_percentiles": {&#xA;          "percentiles": {&#xA;            "script": "doc['EndTime'] - doc['StartTime']",&#xA;            "percents": ["97.7"]&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }  &#xA;}&#xA;</code></pre>&#xA;&#xA;<p>How can I extend this query to return those script runs that are above this percentile? I think this have to be done using a filter, but I'm wondering if metrics can be filtered upon?</p>&#xA;