33881709
Summing nested documents in Elasticsearch
<p>I'm doing a query that returns a bunch of documents. One of the fields in those documents is an array of dictionaries called <code>hourly_values</code>. I want to return the sum of the seconds field in that array of dictionaries, but I can't figure out how to get into the array and sum the values of all the seconds keys in each dictionary. </p>&#xA;&#xA;<p>Here is what is stored in elasticsearch, and returned from a simple query:</p>&#xA;&#xA;<pre><code>{&#xA;  "took": 21,&#xA;  "timed_out": false,&#xA;  "_shards": {&#xA;    "total": 5,&#xA;    "successful": 5,&#xA;    "failed": 0&#xA;  },&#xA;  "hits": {&#xA;    "total": 1,&#xA;    "max_score": 1,&#xA;    "hits": [&#xA;      {&#xA;        "_index": "searchdb",&#xA;        "_type": "profile",&#xA;        "_id": "915",&#xA;        "_score": 1,&#xA;        "_source": {&#xA;          "id": 915,&#xA;          "market": "Chicago",&#xA;          "latitude": "41.1234",&#xA;          "longitude": "-87.5678",&#xA;          "structure_type": "Digital Display",&#xA;          "zip": 60654,&#xA;          "city": "Chicago",&#xA;          "player_id": 1234,&#xA;          "geo_location": {&#xA;            "lat": 41.1234,&#xA;            "lon": -87.5678&#xA;          },&#xA;          "hourly_values": [&#xA;            {&#xA;              "datetime": "2015-11-18T20:02:04Z",&#xA;              "seconds": 800&#xA;            },&#xA;            {&#xA;              "datetime": "2015-11-18T21:08:29Z",&#xA;              "seconds": 800&#xA;            },&#xA;            {&#xA;              "datetime": "2015-11-18T21:37:29Z",&#xA;              "seconds": 6400&#xA;            }&#xA;          ]&#xA;        }&#xA;      }&#xA;    ]&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>and here is the query I'm trying to build:</p>&#xA;&#xA;<pre><code>{&#xA;    "size":0,&#xA;    "aggregations": {&#xA;        "seconds_agg": {&#xA;            "geo_distance": {&#xA;                "field": "geo_location",&#xA;                "origin":"41.893371,-87.628329",&#xA;                "unit":"km",&#xA;                "ranges":[&#xA;                    {&#xA;                        "from":0,&#xA;                        "to":20&#xA;                    }&#xA;                ]&#xA;            },&#xA;            "aggregations":{&#xA;                "ring_seconds_sum": {&#xA;                    "sum":{&#xA;                        "hourly_values":{&#xA;                            something goes here    &#xA;                        }       &#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I can't figure out what to put in the <code>something goes here</code> section of the query. Any ideas?</p>&#xA;
<p>Try this (I changed <code>"to":20</code> to <code>"to":200</code> so it would match the document you posted):</p>&#xA;&#xA;<pre><code>POST /test_index/_search&#xA;{&#xA;   "size": 0,&#xA;   "aggregations": {&#xA;      "seconds_agg": {&#xA;         "geo_distance": {&#xA;            "field": "geo_location",&#xA;            "origin": "41.893371,-87.628329",&#xA;            "unit": "km",&#xA;            "ranges": [&#xA;               {&#xA;                  "from": 0,&#xA;                  "to": 200&#xA;               }&#xA;            ]&#xA;         },&#xA;         "aggregations": {&#xA;            "ring_seconds_sum": {&#xA;               "sum": {&#xA;                  "field": "hourly_values.seconds"&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here's some code I used to test it:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/02942c5753f6555dfab4571bf8f64bbc1dea74df" rel="nofollow">http://sense.qbox.io/gist/02942c5753f6555dfab4571bf8f64bbc1dea74df</a></p>&#xA;