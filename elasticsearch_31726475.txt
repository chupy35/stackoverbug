31726475
Elasticsearch query that counts points in geo_shapes
<p>I have indexed a lot of geo_shapes that are the borders of various countries. The mapping is like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "mappings": {&#xA;    "country": {&#xA;      "properties": {&#xA;        "border": {&#xA;          "type": "geo_shape"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I also have a lot of points indexed that are mapped like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "mappings": {&#xA;    "point": {&#xA;      "properties": {&#xA;        "location": {&#xA;          "type": "geo_shape"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>An example for a point would be like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "location": {&#xA;    "type": "point",&#xA;    "coordinates": [30.706049, 6.264897]&#xA;  },&#xA;  "a": "a"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The <code>"a"</code> is just for counting because I wasn't able to use value_count aggregations to count <code>"location"</code>.</p>&#xA;&#xA;<p>I know that I can count the points in a country like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "size": 0, &#xA;  "query": {&#xA;    "geo_shape": {&#xA;      "location": {&#xA;        "relation": "within",&#xA;        "indexed_shape": {&#xA;          "index": "geo",&#xA;          "type": "country",&#xA;          "id": "Austria",&#xA;          "path": "border"&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "Austria": {&#xA;      "value_count": {&#xA;        "field": "a"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Is there a way to make a query that takes all the points, matches them with the country and then counts the points per country or do I have do make separate requests for every country?</p>&#xA;