34588870
Nested Child Aggregation returns "wrong" Parent doc_count
<p>I have been trying for quite a while but cannot see the Problem. I would be very pleased if someone with more experience in ES can hint me in the right direction. I have have a parent type (College) and a child type (course). Courses have a 3 level nested aggregations (Subjectgroup). Now I am trying to show how many Colleges exists that offer Courses with the individual Subjectgroups within a College query. </p>&#xA;&#xA;<p>Here is my mapping:</p>&#xA;&#xA;<pre><code>indexes:&#xA;    studiengaenge:&#xA;        index_name: studiengaenge_dev&#xA;        settings:&#xA;            index:&#xA;                analysis:&#xA;                    analyzer:&#xA;                        lc_term:&#xA;                            type: custom&#xA;                            tokenizer: keyword&#xA;                            filter: lowercase&#xA;        types:&#xA;            college:&#xA;                mappings:&#xA;                    id: ~&#xA;            course:&#xA;                mappings:&#xA;                    id: ~&#xA;                    name: ~&#xA;                    subjectgroups:&#xA;                        type: "nested"&#xA;                        properties:&#xA;                            name: { "type": "string", "index": "analyzed", "analyzer": "lc_term" }&#xA;                            area:&#xA;                                type: "nested"&#xA;                                properties:&#xA;                                    name: { "type": "string", "index": "analyzed", "analyzer": "lc_term" }&#xA;                                    field:&#xA;                                        type: "nested"&#xA;                                        properties:&#xA;                                            name: { "type": "string", "index": "analyzed", "analyzer": "lc_term" }&#xA;                _parent:&#xA;                    type: "college"&#xA;</code></pre>&#xA;&#xA;<p>The query:</p>&#xA;&#xA;<p><div class="snippet" data-lang="js" data-hide="false">&#xD;&#xA;<div class="snippet-code">&#xD;&#xA;<pre class="snippet-code-js lang-js prettyprint-override"><code>GET college/_search?search_type=count&#xD;&#xA;{&#xD;&#xA;  "query": {&#xD;&#xA;    "has_child": {&#xD;&#xA;      "type": "course",&#xD;&#xA;      "query": {&#xD;&#xA;        "filtered": {&#xD;&#xA;          "query": {&#xD;&#xA;            "match_all": {}&#xD;&#xA;          },&#xD;&#xA;          "filter": {&#xD;&#xA;            "bool": {&#xD;&#xA;              "must": [&#xD;&#xA;                {&#xD;&#xA;                  "nested": {&#xD;&#xA;                    "path": "subjectgroups",&#xD;&#xA;                    "filter": {&#xD;&#xA;                      "terms": {&#xD;&#xA;                        "subjectgroups.name": [&#xD;&#xA;                          "lehramt"&#xD;&#xA;                        ]&#xD;&#xA;                      }&#xD;&#xA;                    }&#xD;&#xA;                  }&#xD;&#xA;                }&#xD;&#xA;              ]&#xD;&#xA;            }&#xD;&#xA;          }&#xD;&#xA;        }&#xD;&#xA;      }&#xD;&#xA;    }&#xD;&#xA;  },&#xD;&#xA;  "aggs": {&#xD;&#xA;    "children": {&#xD;&#xA;      "children": {&#xD;&#xA;        "type": "course"&#xD;&#xA;      },&#xD;&#xA;      "aggs": {&#xD;&#xA;        "fachgruppen": {&#xD;&#xA;          "nested": {&#xD;&#xA;            "path": "course.subjectgroups"&#xD;&#xA;          },&#xD;&#xA;          "aggs": {&#xD;&#xA;            "filtered": {&#xD;&#xA;              "filter": {&#xD;&#xA;                "terms": {&#xD;&#xA;                  "subjectgroups.name": [&#xD;&#xA;                    "lehramt"&#xD;&#xA;                  ]&#xD;&#xA;                }&#xD;&#xA;              },&#xD;&#xA;              "aggs": {&#xD;&#xA;                "fachgruppe": {&#xD;&#xA;                  "terms": {&#xD;&#xA;                    "field": "subjectgroups.name"&#xD;&#xA;                  },&#xD;&#xA;                  "aggs": {&#xD;&#xA;                    "reverse_nested": {&#xD;&#xA;                      "reverse_nested": {},&#xD;&#xA;                      "aggs": {&#xD;&#xA;                        "doc_count_college": {&#xD;&#xA;                          "cardinality": {&#xD;&#xA;                            "field": "_parent"&#xD;&#xA;                          }&#xD;&#xA;                        }&#xD;&#xA;                      }&#xD;&#xA;                    },&#xD;&#xA;                    "studienbereich": {&#xD;&#xA;                      "nested": {&#xD;&#xA;                        "path": "course.subjectgroups.area"&#xD;&#xA;                      },&#xD;&#xA;                      "aggs": {&#xD;&#xA;                        "studienbereich": {&#xD;&#xA;                          "terms": {&#xD;&#xA;                            "field": "subjectgroups.area.name"&#xD;&#xA;                          },&#xD;&#xA;                          "aggs": {&#xD;&#xA;                            "reverse_nested": {&#xD;&#xA;                              "reverse_nested": {},&#xD;&#xA;                              "aggs": {&#xD;&#xA;                                "doc_count_college": {&#xD;&#xA;                                  "cardinality": {&#xD;&#xA;                                    "field": "_parent"&#xD;&#xA;                                  }&#xD;&#xA;                                }&#xD;&#xA;                              }&#xD;&#xA;                            }&#xD;&#xA;                          }&#xD;&#xA;                        }&#xD;&#xA;                      }&#xD;&#xA;                    }&#xD;&#xA;                  }&#xD;&#xA;                }&#xD;&#xA;              }&#xD;&#xA;            }&#xD;&#xA;          }&#xD;&#xA;        }&#xD;&#xA;      }&#xD;&#xA;    }&#xD;&#xA;  }&#xD;&#xA;}</code></pre>&#xD;&#xA;</div>&#xD;&#xA;</div>&#xD;&#xA;</p>&#xA;&#xA;<p>The result:</p>&#xA;&#xA;<p><div class="snippet" data-lang="js" data-hide="false">&#xD;&#xA;<div class="snippet-code">&#xD;&#xA;<pre class="snippet-code-js lang-js prettyprint-override"><code>{&#xD;&#xA;   "took": 7,&#xD;&#xA;   "timed_out": false,&#xD;&#xA;   "_shards": {&#xD;&#xA;      "total": 1,&#xD;&#xA;      "successful": 1,&#xD;&#xA;      "failed": 0&#xD;&#xA;   },&#xD;&#xA;   "hits": {&#xD;&#xA;      "total": 123,&#xD;&#xA;      "max_score": 0,&#xD;&#xA;      "hits": []&#xD;&#xA;   },&#xD;&#xA;   "aggregations": {&#xD;&#xA;      "children": {&#xD;&#xA;         "doc_count": 12289,&#xD;&#xA;         "fachgruppen": {&#xD;&#xA;            "doc_count": 15029,&#xD;&#xA;            "filtered": {&#xD;&#xA;               "doc_count": 4582,&#xD;&#xA;               "fachgruppe": {&#xD;&#xA;                  "doc_count_error_upper_bound": 0,&#xD;&#xA;                  "sum_other_doc_count": 0,&#xD;&#xA;                  "buckets": [&#xD;&#xA;                     {&#xD;&#xA;                        "key": "lehramt",&#xD;&#xA;                        "doc_count": 4582,&#xD;&#xA;                        "reverse_nested": {&#xD;&#xA;                           "doc_count": 3786,&#xD;&#xA;                           "doc_count_college": {&#xD;&#xA;                              "value": 124&#xD;&#xA;                           }&#xD;&#xA;                        },&#xD;&#xA;                        "studienbereich": {&#xD;&#xA;                           "doc_count": 4582,&#xD;&#xA;                           "studienbereich": {&#xD;&#xA;                              "doc_count_error_upper_bound": 0,&#xD;&#xA;                              "sum_other_doc_count": 0,&#xD;&#xA;                              "buckets": [&#xD;&#xA;                                 {&#xD;&#xA;                                    "key": "schulische f채cher",&#xD;&#xA;                                    "doc_count": 3938,&#xD;&#xA;                                    "reverse_nested": {&#xD;&#xA;                                       "doc_count": 3399,&#xD;&#xA;                                       "doc_count_college": {&#xD;&#xA;                                          "value": 130&#xD;&#xA;                                       }&#xD;&#xA;                                    }&#xD;&#xA;                                 },&#xD;&#xA;                                 {&#xD;&#xA;                                    "key": "berufliche fachrichtungen",&#xD;&#xA;                                    "doc_count": 357,&#xD;&#xA;                                    "reverse_nested": {&#xD;&#xA;                                       "doc_count": 315,&#xD;&#xA;                                       "doc_count_college": {&#xD;&#xA;                                          "value": 105&#xD;&#xA;                                       }&#xD;&#xA;                                    }&#xD;&#xA;                                 },&#xD;&#xA;                                 {&#xD;&#xA;                                    "key": "sonderp채dagogik, inklusive p채dagogik",&#xD;&#xA;                                    "doc_count": 287,&#xD;&#xA;                                    "reverse_nested": {&#xD;&#xA;                                       "doc_count": 287,&#xD;&#xA;                                       "doc_count_college": {&#xD;&#xA;                                          "value": 32&#xD;&#xA;                                       }&#xD;&#xA;                                    }&#xD;&#xA;                                 }&#xD;&#xA;                              ]&#xD;&#xA;                           }&#xD;&#xA;                        }&#xD;&#xA;                     }&#xD;&#xA;                  ]&#xD;&#xA;               }&#xD;&#xA;            }&#xD;&#xA;         }&#xD;&#xA;      }&#xD;&#xA;   }&#xD;&#xA;}</code></pre>&#xD;&#xA;</div>&#xD;&#xA;</div>&#xD;&#xA;</p>&#xA;&#xA;<p>The problem is that even though there are only 123 Results (Colleges), the Aggregation of the 2nd level subjectgroup tells me that there are 130 Colleges "key": "schulische f채cher". &#xA;Any help is greatly appreciated. Thanks, Hannes</p>&#xA;
<p>The problem in this case is that elasticsearch is not necessarily exact on aggregation counts. Elasticsearch might disregard a shard altogether if it thinks that the results of an aggregation will not be influenced greatly by the results that this specific shard might return. </p>&#xA;&#xA;<p>This will lead to only approximate results of aggregations. Try setting the index parameters in a way that there is only one shard for your data. Then the results will probably be different and possibly exact. This however is not a solution, because if you have a lot of data you'll need to spread it over different shards.</p>&#xA;&#xA;<p>This properties of elasticsearch are drawback for the otherwise unparalleled speed when it comes to aggregations and other operations. </p>&#xA;