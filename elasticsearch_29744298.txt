29744298
Combining aggregations in Elastic Search
<p>I have objects of which some are grouped by a 'masterID'. I need an aggregation/query that shows me as result the object with the highest 'relevance' per object group by 'masterID'.</p>&#xA;&#xA;<p>With aggregation of term 'masterID' I can get buckets for each 'masterID'. But how do I get the highest 'relevance' object within each bucket?</p>&#xA;&#xA;<p>The queries so far are:</p>&#xA;&#xA;<pre><code>curl -XGET 'http://localhost:9200/pwo/_search?search_type=count&amp;size=0&amp;pretty=true' -d '{&#xA;  "aggregations": {&#xA;    "masterIDs": {&#xA;      "terms": {&#xA;        "field": "masterID",&#xA;        "size": 0&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;'&#xA;</code></pre>&#xA;&#xA;<p>and</p>&#xA;&#xA;<pre><code>curl -XGET 'http://localhost:9200/pwo/_search?size=0&amp;pretty=true' -d '{&#xA;  "aggregations": {&#xA;    "relevance": {&#xA;      "max": {&#xA;        "field": "relevance"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;'&#xA;</code></pre>&#xA;&#xA;<p>Is there a way to solve this with a single query? </p>&#xA;
<p>You can add the relevance aggregation block in the masterIDs block like following :</p>&#xA;&#xA;<pre><code>curl -XGET 'http://localhost:9200/pwo/_search?size=0&amp;pretty=true' -d '{&#xA;  "aggregations": {&#xA;    "masterIDs": {&#xA;      "terms": {&#xA;        "field": "masterID",&#xA;        "size": 0&#xA;      },&#xA;      "aggregations": {&#xA;        "relevance": {&#xA;          "max": { "field" : "relevance" }&#xA;        },&#xA;        "aggregations": {&#xA;          "top_hits": {&#xA;            "size": 1&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;'&#xA;</code></pre>&#xA;