30276510
How to query by nested data correctly for params.name='width' and params.value=30
<p>I have product items indexed in Elasticsearch where common information contains some parameters list (the list varies from 3 to 20 params based on specific product). Params has been indexed as nested values see products JSON example below. </p>&#xA;&#xA;<pre><code>{&#xA;"sku": "asd8574fdf",&#xA;"title": "Test product",&#xA;"params": [&#xA;    {&#xA;        "unit": "mm",&#xA;        "value": 100,&#xA;        "name": "width"&#xA;    }&#xA;    ,&#xA;    {&#xA;        "unit": "mm",&#xA;        "value": 60,&#xA;        "name": "height"&#xA;    }&#xA;  ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Now I dont know how to query product items properly based on params. For example how to query products with  'width = 60' .  When I do query like below this will find any item that has any param with name 'width' and value=60 but in even other params than width. Is there any way how to do it properly or index params in some other way?</p>&#xA;&#xA;<pre><code>"bool": {&#xA;    "must": [&#xA;        {&#xA;            "term": {&#xA;                "product.params.name": "width"&#xA;            }&#xA;        }&#xA;        ,&#xA;        {&#xA;            "term": {&#xA;                "product.params.value": "60"&#xA;            }&#xA;        }&#xA;    ],&#xA;}&#xA;</code></pre>&#xA;&#xA;<p><strong>EDIT #1</strong></p>&#xA;&#xA;<p>I have nested mapping defined correctly but problem is that query above still finds product item as the above, because it finds item with name 'width' but match value=600 for 'height' param. The query like this cant say that value=60 must be for the param  with name 'width'. So it searches values across all params.</p>&#xA;
<p>Make sure your mapping contains <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-nested-type.html#_mapping" rel="nofollow"><code>"type": "nested"</code></a>, and then you can set up your query with a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-nested-query.html" rel="nofollow">nested query</a> or <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-nested-filter.html" rel="nofollow">nested filter</a>. Be careful that you have the <code>"path"</code> parameter and field names set correctly. That trips a lot of people up.</p>&#xA;&#xA;<p>To test, I set up an index with a mapping appropriate for what you posted here, and three docs, each of which have a nested doc with <code>"name": "width"</code> and a nested doc with <code>"value": 60</code>, but only one that should match your query:</p>&#xA;&#xA;<pre><code>PUT /test_index&#xA;{&#xA;   "settings": {&#xA;      "number_of_shards": 1&#xA;   },&#xA;   "mappings": {&#xA;      "doc": {&#xA;         "properties": {&#xA;            "params": {&#xA;               "type": "nested",&#xA;               "properties": {&#xA;                  "name": {&#xA;                     "type": "string"&#xA;                  },&#xA;                  "unit": {&#xA;                     "type": "string"&#xA;                  },&#xA;                  "value": {&#xA;                     "type": "long"&#xA;                  }&#xA;               }&#xA;            },&#xA;            "sku": {&#xA;               "type": "string"&#xA;            },&#xA;            "title": {&#xA;               "type": "string"&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;&#xA;PUT /test_index/doc/1&#xA;{&#xA;"sku": "asd8574fdf",&#xA;"title": "Test product 1",&#xA;"params": [&#xA;    {&#xA;        "unit": "mm",&#xA;        "value": 100,&#xA;        "name": "width"&#xA;    }&#xA;    ,&#xA;    {&#xA;        "unit": "mm",&#xA;        "value": 60,&#xA;        "name": "height"&#xA;    }&#xA;  ]&#xA;}&#xA;&#xA;PUT /test_index/doc/2&#xA;{&#xA;"sku": "asd8574ghg",&#xA;"title": "Test product 2",&#xA;"params": [&#xA;    {&#xA;        "unit": "mm",&#xA;        "value": 100,&#xA;        "name": "width"&#xA;    }&#xA;    ,&#xA;    {&#xA;        "unit": "mm",&#xA;        "value": 60,&#xA;        "name": "depth"&#xA;    }&#xA;  ]&#xA;}&#xA;&#xA;PUT /test_index/doc/3&#xA;{&#xA;"sku": "asd8574ghg",&#xA;"title": "Test product 3",&#xA;"params": [&#xA;    {&#xA;        "unit": "mm",&#xA;        "value": 60,&#xA;        "name": "width"&#xA;    }&#xA;    ,&#xA;    {&#xA;        "unit": "mm",&#xA;        "value": 10,&#xA;        "name": "height"&#xA;    }&#xA;  ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Then I can get back the correct document with this query:</p>&#xA;&#xA;<pre><code>POST /test_index/_search&#xA;{&#xA;   "query": {&#xA;      "filtered": {&#xA;         "query": {&#xA;            "match_all": {}&#xA;         },&#xA;         "filter": {&#xA;            "nested": {&#xA;               "path": "params",&#xA;               "query": {&#xA;                  "bool": {&#xA;                     "must": [&#xA;                        {&#xA;                           "term": {&#xA;                              "params.name": "width"&#xA;                           }&#xA;                        },&#xA;                        {&#xA;                           "term": {&#xA;                              "params.value": 60&#xA;                           }&#xA;                        }&#xA;                     ]&#xA;                  }&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "took": 4,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 1,&#xA;      "max_score": 1,&#xA;      "hits": [&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "doc",&#xA;            "_id": "3",&#xA;            "_score": 1,&#xA;            "_source": {&#xA;               "sku": "asd8574ghg",&#xA;               "title": "Test product 3",&#xA;               "params": [&#xA;                  {&#xA;                     "unit": "mm",&#xA;                     "value": 60,&#xA;                     "name": "width"&#xA;                  },&#xA;                  {&#xA;                     "unit": "mm",&#xA;                     "value": 10,&#xA;                     "name": "height"&#xA;                  }&#xA;               ]&#xA;            }&#xA;         }&#xA;      ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here is all the code I used:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/2a299224da805e64932a2fec6990f2e173820b3b" rel="nofollow">http://sense.qbox.io/gist/2a299224da805e64932a2fec6990f2e173820b3b</a></p>&#xA;