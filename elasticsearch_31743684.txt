31743684
Concurrent update elastic index by java client and some update lost
<p>When concurrent execute update elastic index by java client, at final it seems lost some update. For example I hava an index {"count":0} at first, then there are 10 thread to incremnt count by 1, at final I expecte the count is 10, but actually I found  it less than 10. My demo code is :</p>&#xA;&#xA;<pre><code>ExecutorService service = Executors.newFixedThreadPool(10);&#xA;// create index&#xA;client.prepareIndex(index, type, id)&#xA;.setSource(XContentFactory.jsonBuilder().startObject().field("count", 0).endObject())&#xA;.execute().get();&#xA;&#xA;// multi thread update&#xA;int count = 10;&#xA;CountDownLatch latch = new CountDownLatch(count);&#xA;for (int i = 0; i &lt; count; i++) {&#xA;service.execute(new Runnable() {&#xA;&#xA;@Override&#xA;public void run() {&#xA;   try {&#xA;       client.prepareUpdate(index, type, id)&#xA;        .setScript("ctx._source.count += 1", ScriptService.ScriptType.INLINE).execute();&#xA;&#xA;     } catch (Exception e) {&#xA;        e.printStackTrace();&#xA;    } finally {&#xA;        latch.countDown();&#xA;    }&#xA;}&#xA;});&#xA;}&#xA;&#xA;// check result&#xA;latch.await();&#xA;service.shutdown();&#xA;GetResponse getResponse = client.prepareGet(index, type, id).execute().get();&#xA;&#xA;System.out.println(getResponse.getSourceAsString());&#xA;</code></pre>&#xA;&#xA;<p>So where these lost update?</p>&#xA;&#xA;<p>========================================================</p>&#xA;&#xA;<p>Information supplementary</p>&#xA;&#xA;<p>Actually don't need make concurrent in client side, actually sequential execute also can have the same effect, </p>&#xA;&#xA;<pre><code>for (int i = 0; i &lt; count; i++) {&#xA;  client.prepareUpdate(index, type, id)&#xA;      .setScript("ctx._source.count += 1", ScriptService.ScriptType.INLINE).execute();&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>By wireshark I found there are exception of version conflict happend.</p>&#xA;&#xA;<p><a href="https://i.stack.imgur.com/JsN8C.png" rel="nofollow noreferrer"><img src="https://i.stack.imgur.com/JsN8C.png" alt="enter image description here"></a></p>&#xA;&#xA;<p>So now I am very confused of how server side process client reuqest? Why in sequential situation still cannot get right result?</p>&#xA;
<p>By default, every <code>*RequestBuilder</code> has a timeout which is the time to wait if the index/update/delete operation can't be performed immediately. </p>&#xA;&#xA;<p>So theoretically it's possible that some of your updates are still pending and were not executed. Try to force refresh the index with the following method:</p>&#xA;&#xA;<pre><code>client.prepareUpdate(index, type, id)&#xA;   .setScript("ctx._source.count += 1", ScriptService.ScriptType.INLINE)&#xA;   .setRefresh(true)&#xA;   .execute()&#xA;   .actionGet();&#xA;</code></pre>&#xA;