28880737
Elasticsearch: how to extract possible pattern over multiple events with same session id
<p><strong>Summary:</strong></p>&#xA;&#xA;<p>I use elasticsearch for my weblogs. I want to get an anwser to the question: how many clients requested page A and page B within one session?</p>&#xA;&#xA;<p><strong>Details:</strong></p>&#xA;&#xA;<p>My Elasticsearch node contains the events that are logged on my website. Each event contains amongst others timestamp, url, referrer and session id. At this moment I know how to find e.g. how many sessions requested url xyz. But I don't know how to find if there are cases that within a session both page A and page B are requested. And of course not that page A or B is part of the referrer.&#xA;Is this something that is somehow supported within elasticsearch?</p>&#xA;
<p>The query should look something like this (assuming your <code>url</code> and <code>session_id</code> are <code>not_analyzed</code>):</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "term": {&#xA;                "url": "[Page A URL]"&#xA;              }&#xA;            },&#xA;            {&#xA;              "term": {&#xA;                "url": "[Page B URL]"&#xA;              }&#xA;            }&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "requested_both_pages": {&#xA;      "terms": {&#xA;        "field": "session_id"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The <code>doc_count</code> in the response will be the number you're looking for.</p>&#xA;&#xA;<p>Keep in mind that if your url is analyzed and you need to do fuzzy matching then you'll have to use a <code>match</code> query instead of the <code>terms</code> filter. I generally wouldn't recommend an analyzed referrer. Instead I would break it down into its parts and create a nested url object with each string <code>not_analyzed</code> and then use a <code>terms</code> filter. You can do a <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-wildcard-query.html" rel="nofollow">wildcard query</a> with <code>not_analyzed</code> fields still if you need some fuzziness.</p>&#xA;
<p>I figured out a query that at least returns how many times url A and url B are requested per session. I was not aware that I could use this style of aggregation. Still not the perfect solution as it can return sessions where url A has counts and url B has no counts. So I will not mark the anwser as solved. Unless some expert can tell me that my request is just not possible at all.</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "bool": {&#xA;          "should": [&#xA;            {&#xA;              "term": {&#xA;                "Url": "[Page A URL]"&#xA;              }&#xA;            },&#xA;            {  &#xA;              "term": {&#xA;                "Url": "[Page B URL]"&#xA;              }&#xA;            }&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "sessions_all": {&#xA;      "terms": {&#xA;        "field": "session_id",&#xA;        "size": 100&#xA;      },&#xA;      "aggs": {&#xA;        "Page_A_URL": {&#xA;          "filter": {&#xA;            "term": {&#xA;              "Url": "[Page A URL]"&#xA;            }&#xA;          }&#xA;        },&#xA;        "Page_B_URL": {&#xA;          "filter": {&#xA;            "term": {&#xA;              "Url": "[Page A URL]"&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;