31003651
How to compute the scores based on field data in elasticsearch
<p>I have the following fields in documents</p>&#xA;&#xA;<pre><code>{&#xA;name: "Pearl",&#xA;age : 43,&#xA;weight: 54,&#xA;bodyWeight : 103,&#xA;height : 1.8&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Now i want to get scores for the documents based on the bodyWeight to height ratio of the documents. How to do that?</p>&#xA;
<p>Elasticsearch provides custom scoring via the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html" rel="nofollow">function score query</a>. In your case, you can score documents with a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#_script_score" rel="nofollow">custom script scoring</a>:</p>&#xA;&#xA;<pre><code>"script_score" : {&#xA;    "script" : "doc['bodyWeight'].value / doc['height'].value"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>While this seems like a fast and easy solution, it has two problems:&#xA;* scoring will have an interesting behavior in case the value of <code>height</code> is 0: Infinity?&#xA;* script scoring is slow</p>&#xA;&#xA;<p>A solution could be to index the weight in your document</p>&#xA;&#xA;<pre><code>{&#xA;  name: "Pearl",&#xA;  age : 43,&#xA;  weight: 54,&#xA;  bodyWeight : 103,&#xA;  height : 1.8&#xA;  ratio: 57.2&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>and subsequently <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#_field_value_factor" rel="nofollow">score by field</a></p>&#xA;&#xA;<pre><code>"field_value_factor": {&#xA;  "field": "ratio"&#xA;}&#xA;</code></pre>&#xA;
<p>You can achieve this by using scripting. Try the script below:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "function_score": {&#xA;      "functions": [&#xA;        {&#xA;          "script_score": {&#xA;            "script": "_score * doc['bodyWeight'].value / doc['height'].value"&#xA;          }&#xA;        }&#xA;      ],&#xA;      "score_mode": "sum",&#xA;      "boost_mode": "replace"&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Like wise you can compute score using field data. For more reference in scoring you can visit <a href="http://blog.qbox.io/scoring-using-elasticsearch-scripts-part1" rel="nofollow">here</a></p>&#xA;