29016271
How to get latest values for each group with an Elasticsearch query?
<p>I have some documents indexed on Elasticsearch, looking like these samples:</p>&#xA;&#xA;<pre><code>{'country': 'France', 'collected': '2015-03-12', 'value': 20}&#xA;{'country': 'Canada', 'collected': '2015-03-12', 'value': 21}&#xA;{'country': 'Brazil', 'collected': '2015-03-12', 'value': 33}&#xA;{'country': 'France', 'collected': '2015-02-01', 'value': 10}&#xA;{'country': 'Canada', 'collected': '2015-02-01', 'value': 11}&#xA;{'country': 'Mexico', 'collected': '2015-02-01', 'value': 9}&#xA;...&#xA;</code></pre>&#xA;&#xA;<p>I want to build a query that gets one result per country, getting only the ones with <code>max(collected)</code>.</p>&#xA;&#xA;<p>So, for the examples shown above, the results would be something like:</p>&#xA;&#xA;<pre><code>{'country': 'France', 'collected': '2015-03-12', 'value': 20}&#xA;{'country': 'Canada', 'collected': '2015-03-12', 'value': 21}&#xA;{'country': 'Brazil', 'collected': '2015-03-12', 'value': 33}&#xA;{'country': 'Mexico', 'collected': '2015-02-01', 'value': 9}&#xA;</code></pre>&#xA;&#xA;<p>I realized I need to do aggregation on <code>country</code>, but I'm failing to understand how to limit the results on <code>max(collected)</code>.</p>&#xA;&#xA;<p>Any ideas?</p>&#xA;
<p>You can use a <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-top-hits-aggregation.html"><code>top_hits</code></a> aggregation that groups on the <code>country</code> field, returns 1 doc per group, and orders the docs by the collected date descending:</p>&#xA;&#xA;<pre><code>POST /test/_search?search_type=count&#xA;{&#xA;    "aggs": {&#xA;        "group": {&#xA;            "terms": {&#xA;                "field": "country"&#xA;            },&#xA;            "aggs": {&#xA;                "group_docs": {&#xA;                    "top_hits": {&#xA;                        "size": 1,&#xA;                        "sort": [&#xA;                            {&#xA;                                "collected": {&#xA;                                    "order": "desc"&#xA;                                }&#xA;                            }&#xA;                        ]&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;
<p>For those like <a href="https://stackoverflow.com/users/1892775/user1892775">user1892775</a> who run into "Fielddata is disabled on text fields by default...", you can create a multi field (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/multi-fields.html" rel="nofollow noreferrer">https://www.elastic.co/guide/en/elasticsearch/reference/current/multi-fields.html</a>). So you might have mapping like:</p>&#xA;&#xA;<pre><code>"mapping": {&#xA;    "properties": {&#xA;      "country": {"type": "string", "fields": {"raw": {"type": "string", "index": "not_analyzed"}}}&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Then your query would look like </p>&#xA;&#xA;<pre><code>POST /test/_search?search_type=count&#xA;{&#xA;    "aggs": {&#xA;    "group": {&#xA;        "terms": {&#xA;            "field": "country.raw"&#xA;        },&#xA;        "aggs": {&#xA;            "group_docs": {&#xA;                "top_hits": {&#xA;                    "size": 1,&#xA;                    "sort": [&#xA;                        {&#xA;                            "collected": {&#xA;                                "order": "desc"&#xA;                            }&#xA;                        }&#xA;                    ]&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>(Note the use of country.<strong>raw</strong>)</p>&#xA;