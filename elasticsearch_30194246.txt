30194246
percolate returns empty matches under heavy load during elasticsearch cluster resizing
<p>We have an elasticsearch cluster dynamically re-sizing in respect to percolate message count in a rabbitmq queue.</p>&#xA;&#xA;<p>We have a single shard and ~18K query in our index, and we use auto_expand_replicas: "0-all" at index settings to copy single shard to all nodes when a node becomes available.</p>&#xA;&#xA;<p>But during heavy load and cluster re-sizing, some requests produces unexpected empty matches.</p>&#xA;&#xA;<p>We send ~1M percolate request daily and we were losing ~1K content. We added a cluster status control to our code, if cluster status is not green before and after percolate request we're waiting for green status and re-sending percolate request, we were able to reduce lost content count from 1K to ~100 in this way. We do not live this problem in a cluster with fixed node size.</p>&#xA;&#xA;<p>Unfortunately any loss is not acceptable in our scenario, and we don't want to give up auto scaling, we need to find a workaround for this problem.</p>&#xA;&#xA;<p>To repeat problem, you can use following bash script:</p>&#xA;&#xA;<p><a href="https://gist.github.com/ekesken/de41598a1e7e54c6f33c" rel="nofollow">https://gist.github.com/ekesken/de41598a1e7e54c6f33c</a></p>&#xA;&#xA;<p>This script will download and install elasticsearch 1.5.2 on your current directory, create a cluster with 10 nodes on your local and create index and percolation queries and will start testing.</p>&#xA;&#xA;<p>Normally we expect following output for single percolate request:</p>&#xA;&#xA;<pre class="lang-sh prettyprint-override"><code>curl -XGET 'localhost:9200/my-index/my-type/_percolate' -d '{  &#xA;         "doc" : { &#xA;             "message" : "A new bonsai tree in the office" &#xA;         }   &#xA;     }'  &#xA;{"took":95,"_shards":{"total":1,"successful":1,"failed":0},"total":1,"matches":[{"_index":"my-index","_id":"tree"}]}&#xA;</code></pre>&#xA;&#xA;<p>After running script, if you see all shards in all nodes are started at <a href="http://localhost:9200/_cat/shards" rel="nofollow">http://localhost:9200/_cat/shards</a> response and test script is still running, that means you couldn't reproduce problem, try increasing node count which was 10 by default:</p>&#xA;&#xA;<pre class="lang-sh prettyprint-override"><code>./repeat_percolation_loss.sh 15 test-only&#xA;</code></pre>&#xA;&#xA;<p>When you reproduce problem, script will exit with following output:</p>&#xA;&#xA;<pre class="lang-sh prettyprint-override"><code>{"took":209,"_shards":{"total":1,"successful":1,"failed":0},"total":0,"matches":[]}&#xA;Problem repeated! Congratulations.&#xA;</code></pre>&#xA;&#xA;<p>You can shutdown all servers and clean all directory and files created via script with command:</p>&#xA;&#xA;<pre class="lang-sh prettyprint-override"><code>./repeat_percolation_loss.sh 15 clean&#xA;</code></pre>&#xA;&#xA;<p>Change node count above with latest node count you've tried.</p>&#xA;