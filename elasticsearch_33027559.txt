33027559
Add a filter to a query with a date_histogram and aggregation in elasticsearch
<p>I need to display a table of units sold this year by month by category.<br>&#xA;For example:</p>&#xA;&#xA;<pre><code>2015      Jan  Feb  Mar  Apr May  Jun  Jul  Aug&#xA;category1  19   25   30   51  12   10    0    0&#xA;category2 105  110  125  131 209  233  310   80&#xA;category3  33   35   37    0   0    0    0    0&#xA;</code></pre>&#xA;&#xA;<p>Here's my query.  Note that I'm missing the "this year" requirement.  How do I add it?  Adding a filter as the first child of "doc" gives an error: Found two aggregation type definitions in [doc]</p>&#xA;&#xA;<pre><code>{&#xA;    "doc": {&#xA;        "date_histogram": {&#xA;            "field": "sale_createdDateTime",&#xA;            "interval": "month",&#xA;            "format": "yyyy-MM-dd",&#xA;            "min_doc_count": 0,&#xA;            "extended_bounds": {&#xA;                 "min": "2015-01-01",&#xA;                 "max": "2015-12-31"&#xA;             }&#xA;        },&#xA;        "aggs": {&#xA;            "per_category": {&#xA;                "terms": {&#xA;                    "field": "product_category"&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;
<p>You need to wrap your current aggregation within the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.0/search-aggregations-bucket-filter-aggregation.html" rel="nofollow">filter Aggregation</a>. So the filter is not the first child of <code>doc</code>, but the first child of <code>aggs</code>. then, you have a nested <code>aggs</code> with your current aggregation. The result should be somewhat similar to :</p>&#xA;&#xA;<pre><code>{&#xA;    "aggs": {&#xA;        "per_category": {&#xA;            "filtered_agg": {&#xA;                "filter": {&#xA;                    /*YEAR FILTER HERE*/&#xA;                },&#xA;                "aggs": {&#xA;                    "nested_terms_agg": {&#xA;                        "terms": {&#xA;                            "field": "product_category"&#xA;                        }&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>(<strong>NOTE:</strong> <code>filtered_agg</code> and <code>nested_terms_agg</code> are just names I chose)</p>&#xA;