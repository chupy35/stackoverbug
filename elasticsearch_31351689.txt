31351689
elastic search top_hits aggregation with lucene expression
<p>I want to do a field collapse top hits aggregation, exactly as documented here:</p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-top-hits-aggregation.html#_field_collapse_example" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-top-hits-aggregation.html#_field_collapse_example</a></p>&#xA;&#xA;<p>In particular, this segment is a problem:</p>&#xA;&#xA;<pre><code>"top_hit": {&#xA;    "max": {&#xA;        "script": "_score"&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Because the production environment is configured with:</p>&#xA;&#xA;<pre><code>script.disable_dynamic: sandbox&#xA;</code></pre>&#xA;&#xA;<p>Which means I can't use groovy scripts, without getting an error along these lines:</p>&#xA;&#xA;<pre><code>nested: ScriptException[dynamic scripting for [groovy] disabled];&#xA;</code></pre>&#xA;&#xA;<p>If I change the query like so:</p>&#xA;&#xA;<pre><code>"top_hit": {&#xA;    "max": {&#xA;        "lang": "expression",&#xA;        "script": "_score"&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I get a different type of error:</p>&#xA;&#xA;<pre><code>nested: IllegalStateException[Expressions referencing the score can only be used for sorting];&#xA;</code></pre>&#xA;&#xA;<p>The elastic search version is 1.5.2. Is there a way to do what I want (with lucene expressions)?</p>&#xA;
<p>I found the answer after a little bit of googling. This was a known issue which was fixed.</p>&#xA;&#xA;<p><a href="https://github.com/elastic/elasticsearch/issues/10091" rel="nofollow">https://github.com/elastic/elasticsearch/issues/10091</a></p>&#xA;&#xA;<p>It's unclear which version it is fixed in, however.</p>&#xA;