34091495
Filter specific key value aggregations
<p>We are currently using Elasticsearch to power a product list on a website. The filtering is also managed by Elasticsearch, and we are running into a problem with a key value aggregation and filtering. </p>&#xA;&#xA;<p><strong>TL;DR:</strong>&#xA;Doing an aggregation on key / value field "features" with filter applied:</p>&#xA;&#xA;<pre><code>{&#xA;  "features": {&#xA;    "global": {},&#xA;    "aggregations": {&#xA;      "features": {&#xA;        "filter": {&#xA;          "bool": {&#xA;            "must": [&#xA;              {&#xA;                "nested": {&#xA;                  "path": "features",&#xA;                  "query": {&#xA;                    "bool": {&#xA;                      "minimum_should_match": "1",&#xA;                      "must": [&#xA;                        {&#xA;                          "term": {&#xA;                            "features.code": "brand"&#xA;                          }&#xA;                        }&#xA;                      ],&#xA;                      "should": [&#xA;                        {&#xA;                          "term": {&#xA;                            "features.value.code": "CKJ"&#xA;                          }&#xA;                        }&#xA;                      ]&#xA;                    }&#xA;                  }&#xA;                }&#xA;              }&#xA;            ]&#xA;          }&#xA;        },&#xA;        "aggregations": {&#xA;          "features": {&#xA;            "nested": {&#xA;              "path": "features"&#xA;            },&#xA;            "aggregations": {&#xA;              "key": {&#xA;                "terms": {&#xA;                  "field": "features.code",&#xA;                  "min_doc_count": 1,&#xA;                  "size": 50,&#xA;                  "order": {&#xA;                    "_term": "asc"&#xA;                  }&#xA;                },&#xA;                "aggregations": {&#xA;                  "value": {&#xA;                    "terms": {&#xA;                      "size": 50,&#xA;                      "order": {&#xA;                        "_term": "asc"&#xA;                      },&#xA;                      "min_doc_count": 1,&#xA;                      "field": "features.value.descriptions.description.NL"&#xA;                    },&#xA;                    "aggregations": {&#xA;                      "code": {&#xA;                        "terms": {&#xA;                          "field": "features.value.code"&#xA;                        }&#xA;                      }&#xA;                    }&#xA;                  }&#xA;                }&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Question: Can we write this so we can choose which key gets the filter (instead of all keys). </p>&#xA;&#xA;<p><strong>Long version:</strong></p>&#xA;&#xA;<p>This is how our data looks:</p>&#xA;&#xA;<pre><code>       { &#xA;     "price": 59.95,&#xA;    "id": "123456789",&#xA;    "colours": [&#xA;        {&#xA;            "id": 39672,&#xA;            "description": {&#xA;                "EN": "Multi colour",&#xA;                "NL": "Multi kleur",&#xA;                "FR": "Multi couleur",&#xA;                "DE": "Multi colour"&#xA;            },&#xA;            "images": [ ],&#xA;            "primaryimage": "4055157573965.jpg",&#xA;            "swatch": "4055157573965.jpg"&#xA;        }&#xA;        ,&#xA;        {&#xA;            "id": 40383,&#xA;            "description": {&#xA;                "EN": "Multi colour",&#xA;                "NL": "Multi kleur",&#xA;                "FR": "Multi couleur",&#xA;                "DE": "Multi colour"&#xA;            },&#xA;            "images": [ ],&#xA;            "primaryimage": "4055157573637.jpg",&#xA;            "swatch": "4055157573637.jpg"&#xA;        }&#xA;    ],&#xA;    "size": [&#xA;        "36"&#xA;    ],&#xA;    "features": [&#xA;        {&#xA;            "id": null,&#xA;            "code": "brand",&#xA;            "key": {&#xA;                "NL": "Merk",&#xA;                "FR": "Marque",&#xA;                "DE": "Marke",&#xA;                "EN": "Brand"&#xA;            },&#xA;            "value": {&#xA;                "descriptions": [&#xA;                    {&#xA;                        "description": {&#xA;                            "DE": "BRAND"&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "description": {&#xA;                            "NL": "BRAND"&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "description": {&#xA;                            "EN": "BRAND"&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "description": {&#xA;                            "FR": "BRAND"&#xA;                        }&#xA;                    }&#xA;                ],&#xA;                "code": "brand"&#xA;            }&#xA;        }&#xA;        ,&#xA;        {&#xA;            "id": null,&#xA;            "code": "gender",&#xA;            "key": {&#xA;                "FR": "Genre",&#xA;                "DE": "Geschlecht",&#xA;                "EN": "Gender",&#xA;                "NL": "Geslacht"&#xA;            },&#xA;            "value": {&#xA;                "descriptions": [&#xA;                    {&#xA;                        "description": {&#xA;                            "FR": "Dames"&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "description": {&#xA;                            "NL": "Dames"&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "description": {&#xA;                            "EN": "Dames"&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "description": {&#xA;                            "DE": "Dames"&#xA;                        }&#xA;                    }&#xA;                ],&#xA;                "code": "1"&#xA;            }&#xA;        }&#xA;        ,&#xA;        {&#xA;            "id": null,&#xA;            "code": "groupLevel1",&#xA;            "key": {&#xA;                "DE": "GroupLevel1",&#xA;                "FR": "GroupLevel1",&#xA;                "NL": "GroupLevel1",&#xA;                "EN": "GroupLevel1"&#xA;            },&#xA;            "value": {&#xA;                "descriptions": [&#xA;                    {&#xA;                        "description": {&#xA;                            "EN": "Level1"&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "description": {&#xA;                            "FR": "Level1s"&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "description": {&#xA;                            "NL": "Level1"&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "description": {&#xA;                            "DE": "Level1"&#xA;                        }&#xA;                    }&#xA;                ],&#xA;                "code": "119D"&#xA;            }&#xA;        }&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>This is (a simplified) query we are running on the data:</p>&#xA;&#xA;<pre><code>{&#xA;  "from": 0,&#xA;  "size": "18",&#xA;  "sort": [&#xA;    "_score"&#xA;  ],&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "term": {&#xA;                "online": 1&#xA;              }&#xA;            },&#xA;            {&#xA;              "term": {&#xA;                "visible": true&#xA;              }&#xA;            },&#xA;            {&#xA;              "term": {&#xA;                "web_product.user": 111&#xA;              }&#xA;            },&#xA;            {&#xA;              "term": {&#xA;                "id_navigation": "281"&#xA;              }&#xA;            },&#xA;            {&#xA;              "nested": {&#xA;                "path": "features",&#xA;                "query": {&#xA;                  "bool": {&#xA;                    "minimum_should_match": "1",&#xA;                    "must": [&#xA;                      {&#xA;                        "term": {&#xA;                          "features.code": "brand"&#xA;                        }&#xA;                      }&#xA;                    ],&#xA;                    "should": [&#xA;                      {&#xA;                        "term": {&#xA;                          "features.value.code": "CKJ"&#xA;                        }&#xA;                      }&#xA;                    ]&#xA;                  }&#xA;                }&#xA;              }&#xA;            }&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "_source": {&#xA;    "include": [&#xA;      "*.NL",&#xA;      "id_product",&#xA;      "product_code",&#xA;      "colours.id",&#xA;      "colours.primaryimage",&#xA;      "colours.swatch",&#xA;      "price"&#xA;    ]&#xA;  },&#xA;  "aggregations": {&#xA;"colours": {&#xA;  "filter": {&#xA;    "bool": {&#xA;      "must": [&#xA;        {&#xA;          "term": {&#xA;            "id_navigation": "281"&#xA;          }&#xA;        },&#xA;        {&#xA;          "term": {&#xA;            "online": 1&#xA;          }&#xA;        },&#xA;        {&#xA;          "term": {&#xA;            "visible": true&#xA;          }&#xA;        },&#xA;        {&#xA;          "term": {&#xA;            "web_product.id_tenant": 115&#xA;          }&#xA;        },&#xA;        {&#xA;          "nested": {&#xA;            "path": "features",&#xA;            "query": {&#xA;              "bool": {&#xA;                "minimum_should_match": "1",&#xA;                "must": [&#xA;                  {&#xA;                    "term": {&#xA;                      "features.code": "brand"&#xA;                    }&#xA;                  }&#xA;                ],&#xA;                "should": [&#xA;                  {&#xA;                    "term": {&#xA;                      "features.value.code": "CKJ"&#xA;                    }&#xA;                  }&#xA;                ]&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  },&#xA;  "aggregations": {&#xA;    "colours": {&#xA;      "terms": {&#xA;        "field": "colours.description.NL.facet",&#xA;        "min_doc_count": 1,&#xA;        "size": 50,&#xA;        "order": {&#xA;          "_term": "asc"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;},&#xA;    "features": {&#xA;      "global": {},&#xA;      "aggregations": {&#xA;        "features": {&#xA;          "filter": {&#xA;            "bool": {&#xA;              "must": [&#xA;                {&#xA;                  "term": {&#xA;                    "id_navigation": "281"&#xA;                  }&#xA;                },&#xA;                {&#xA;                  "term": {&#xA;                    "online": 1&#xA;                  }&#xA;                },&#xA;                {&#xA;                  "term": {&#xA;                    "visible": true&#xA;                  }&#xA;                },&#xA;                {&#xA;                  "term": {&#xA;                    "web_product.user": 111&#xA;                  }&#xA;                },&#xA;                {&#xA;                  "nested": {&#xA;                    "path": "features",&#xA;                    "query": {&#xA;                      "bool": {&#xA;                        "minimum_should_match": "1",&#xA;                        "must": [&#xA;                          {&#xA;                            "term": {&#xA;                              "features.code": "brand"&#xA;                            }&#xA;                          }&#xA;                        ],&#xA;                        "should": [&#xA;                          {&#xA;                            "term": {&#xA;                              "features.value.code": "CKJ"&#xA;                            }&#xA;                          }&#xA;                        ]&#xA;                      }&#xA;                    }&#xA;                  }&#xA;                }&#xA;              ]&#xA;            }&#xA;          },&#xA;          "aggregations": {&#xA;            "features": {&#xA;              "nested": {&#xA;                "path": "features"&#xA;              },&#xA;              "aggregations": {&#xA;                "key": {&#xA;                  "terms": {&#xA;                    "field": "features.code",&#xA;                    "min_doc_count": 1,&#xA;                    "size": 50,&#xA;                    "order": {&#xA;                      "_term": "asc"&#xA;                    }&#xA;                  },&#xA;                  "aggregations": {&#xA;                    "value": {&#xA;                      "terms": {&#xA;                        "size": 50,&#xA;                        "order": {&#xA;                          "_term": "asc"&#xA;                        },&#xA;                        "min_doc_count": 1,&#xA;                        "field": "features.value.descriptions.description.NL"&#xA;                      },&#xA;                      "aggregations": {&#xA;                        "code": {&#xA;                          "terms": {&#xA;                            "field": "features.value.code"&#xA;                          }&#xA;                        }&#xA;                      }&#xA;                    }&#xA;                  }&#xA;                }&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>This query works perfectly and filters the data and aggregations nicely. &#xA;Important in this example are the 2 aggregations: "colours" and "features". Both aggregations are filtered to show the corresponding facets to the query. &#xA;We are working with multiselects though, so if we filter on colours, we will not filter the aggregation to show all other available colours. This is all working fine for all of our aggregations except the features aggregation. </p>&#xA;&#xA;<p>The features aggregation is a key value aggregation, and will return multiple facets:</p>&#xA;&#xA;<pre><code>    "features": {&#xA;&#xA;    "doc_count": 2327,&#xA;    "features": {&#xA;        "doc_count": 11,&#xA;        "features": {&#xA;            "doc_count": 66,&#xA;            "key": {&#xA;                "doc_count_error_upper_bound": 0,&#xA;                "sum_other_doc_count": 0,&#xA;                "buckets": [&#xA;                    {&#xA;                        "key": "brand",&#xA;                        "doc_count": 11,&#xA;                        "value": {&#xA;                            "doc_count_error_upper_bound": 0,&#xA;                            "sum_other_doc_count": 0,&#xA;                            "buckets": [&#xA;                                {&#xA;                                    "key": "Calvin Klein",&#xA;                                    "doc_count": 11,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "CKJ",&#xA;                                                "doc_count": 11&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                            ]&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "key": "gender",&#xA;                        "doc_count": 11,&#xA;                        "value": {&#xA;                            "doc_count_error_upper_bound": 0,&#xA;                            "sum_other_doc_count": 0,&#xA;                            "buckets": [&#xA;                                {&#xA;                                    "key": "WOMEN",&#xA;                                    "doc_count": 11,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "WOMEN",&#xA;                                                "doc_count": 11&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                            ]&#xA;                        }&#xA;                    }&#xA;                    ,&#xA;                    {&#xA;                        "key": "groupLevel1",&#xA;                        "doc_count": 11,&#xA;                        "value": {&#xA;                            "doc_count_error_upper_bound": 0,&#xA;                            "sum_other_doc_count": 0,&#xA;                            "buckets": [&#xA;                                {&#xA;                                    "key": "BLAZERS",&#xA;                                    "doc_count": 1,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "520300",&#xA;                                                "doc_count": 1&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                                ,&#xA;                                {&#xA;                                    "key": "CARDIGANS",&#xA;                                    "doc_count": 1,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "540200",&#xA;                                                "doc_count": 1&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                                ,&#xA;                                {&#xA;                                    "key": "HEMDEN KORTE MOUWEN",&#xA;                                    "doc_count": 1,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "510000",&#xA;                                                "doc_count": 1&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                                ,&#xA;                                {&#xA;                                    "key": "HEMDEN LANGE MOUWEN",&#xA;                                    "doc_count": 1,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "510100",&#xA;                                                "doc_count": 1&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                                ,&#xA;                                {&#xA;                                    "key": "JURKEN",&#xA;                                    "doc_count": 1,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "560100",&#xA;                                                "doc_count": 1&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                                ,&#xA;                                {&#xA;                                    "key": "ROKKEN",&#xA;                                    "doc_count": 1,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "560000",&#xA;                                                "doc_count": 1&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                                ,&#xA;                                {&#xA;                                    "key": "SJAALS",&#xA;                                    "doc_count": 1,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "590700",&#xA;                                                "doc_count": 1&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                                ,&#xA;                                {&#xA;                                    "key": "SWEATERS",&#xA;                                    "doc_count": 2,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "540000",&#xA;                                                "doc_count": 2&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                                ,&#xA;                                {&#xA;                                    "key": "T-SHIRTS LANGE MOUWEN",&#xA;                                    "doc_count": 1,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "530100",&#xA;                                                "doc_count": 1&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                                ,&#xA;                                {&#xA;                                    "key": "TRUIEN",&#xA;                                    "doc_count": 1,&#xA;                                    "code": {&#xA;                                        "doc_count_error_upper_bound": 0,&#xA;                                        "sum_other_doc_count": 0,&#xA;                                        "buckets": [&#xA;                                            {&#xA;                                                "key": "540100",&#xA;                                                "doc_count": 1&#xA;                                            }&#xA;                                        ]&#xA;                                    }&#xA;                                }&#xA;                            ]&#xA;                        }&#xA;                    }&#xA;&#xA;                ]&#xA;            }&#xA;        }&#xA;    }&#xA;&#xA;},&#xA;"colours": {&#xA;&#xA;    "doc_count": 11,&#xA;    "colours": {&#xA;        "doc_count_error_upper_bound": 0,&#xA;        "sum_other_doc_count": 0,&#xA;        "buckets": [&#xA;            {&#xA;                "key": "Blauw",&#xA;                "doc_count": 1&#xA;            }&#xA;            ,&#xA;            {&#xA;                "key": "Grijs",&#xA;                "doc_count": 4&#xA;            }&#xA;        ]&#xA;    }&#xA;&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Colours filter added for comparison. </p>&#xA;&#xA;<p>Now when we select an feature facet on the frontend, we of course want to have multiselect too. However when we apply the filter to the features aggregation all keys are filtered, resulting in a not-multi-selectable facet. If we remove the filter on the features aggregation, the other keys are not filtered resulting in an incorrect facet selection. </p>&#xA;&#xA;<p>So my question after all of this is: can we filter a value/key aggregation based on the key? Logic would go like this: if key == brand then do not filter else filter</p>&#xA;&#xA;<p>If more examples are needed I can add them. </p>&#xA;&#xA;<p>Thanks in advance.</p>&#xA;