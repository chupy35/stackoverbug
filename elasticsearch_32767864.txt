32767864
Find all elasticsearch documents with a field that is an array
<p>I have a document with a field ('fieldA') that can contain either a string or an array of strings. Actually, I'd prefer it only ever contain strings, but the elasticsearch mapping doesn't work that way. Anyway, now I need to find every document where this field is an array. How can I do that?</p>&#xA;
<p>How about this: </p>&#xA;&#xA;<pre><code>{&#xA;    "query" : {&#xA;        "filtered" : {&#xA;            "filter" :{&#xA;                "script" : {&#xA;                    "script" : "_source.fieldA.getClass() != String"&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I had to turn on a particular Elasticsearch setting to use the script in a newer version of Elasticsearch.</p>&#xA;&#xA;<pre><code>script.engine.groovy.inline.search: on&#xA;</code></pre>&#xA;&#xA;<p>Here is the script I ran to create a sample index and try that out:</p>&#xA;&#xA;<pre><code>curl -w "\n" -XDELETE localhost:9200/scrap&#xA;&#xA;curl -w "\n" -XPUT localhost:9200/scrap/ -d '&#xA;index :&#xA;    number_of_replicas : 0&#xA;'&#xA;&#xA;curl -w "\n" -XPUT localhost:9200/scrap/script-demo/1?refresh=1 -d '{&#xA;    "fieldA" : "test string 1"&#xA;}'&#xA;&#xA;curl -w "\n" -XPUT localhost:9200/scrap/script-demo/2?refresh=1 -d '{&#xA;    "fieldA" : [&#xA;        "test string 1",&#xA;        "test string 2"&#xA;    ]&#xA;}'&#xA;&#xA;curl -w "\n" -XPUT localhost:9200/scrap/script-demo/3?refresh=1 -d '{&#xA;    "fieldA" : [&#xA;        "test string 1"&#xA;    ]&#xA;}'&#xA;&#xA;curl -w "\n" -XPOST localhost:9200/scrap/script-demo/_search -d '{&#xA;    "query" : {&#xA;        "filtered" : {&#xA;            "filter" :{&#xA;                "script" : {&#xA;                    "script" : "_source.fieldA.getClass() != String"&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}' | python -m json.tool&#xA;&#xA;# curl -w "\n" -XDELETE localhost:9200/scrap&#xA;</code></pre>&#xA;&#xA;<p>Of course, I am making assumptions about the analyzer you might have on the field and details like that might come into play.</p>&#xA;&#xA;<p>Here are some resources on scripts:</p>&#xA;&#xA;<ul>&#xA;<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html</a></li>&#xA;<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.6/query-dsl-script-filter.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/1.6/query-dsl-script-filter.html</a></li>&#xA;</ul>&#xA;&#xA;<p>It looks like the script filter was replaced in v2.0.</p>&#xA;