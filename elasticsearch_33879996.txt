33879996
Unsure how to structure ElasticSearch Range Query with nested properties
<p>My object in ES looks like:</p>&#xA;&#xA;<pre><code>{&#xA;  "_index": "myIndex",&#xA;  "_type": "myType",&#xA;  "_id": "75fd98d2-eca7-4a94-9dd8-1cc2c9b1fbbf",&#xA;  "_version": 2,&#xA;  "found": true,&#xA;  "_source": {&#xA;    "account_id": "100",&#xA;    "import_ids": [&#xA;      "4f4eef42-5493-464e-ac08-68a3a25a01fb"&#xA;    ],&#xA;    "accept": "html",&#xA;    "deleted_at": null,&#xA;    "signup_form_ids": [&#xA;      {&#xA;        "timestamp": "2015-11-23T20:08:11.604000",&#xA;        "signup_form_id": "1234"&#xA;      }&#xA;    ],&#xA;    "mailing_status": "active",&#xA;    "group_ids": [&#xA;      "0eddd2c0-ce70-4eb7-bcd8-9e41e41ac0b3"&#xA;    ],&#xA;    "confirmed_opt_in_at": null,&#xA;    "fields": [&#xA;      {&#xA;        "text_value": "My Company",&#xA;        "name": "company"&#xA;      },&#xA;      {&#xA;        "text_value": "Foo",&#xA;        "name": "first-name"&#xA;      },&#xA;      {&#xA;        "text_value": "Bar",&#xA;        "name": "last_name"&#xA;      },&#xA;      {&#xA;        "text_value": "555-555-5555",&#xA;        "name": "phone"&#xA;      }&#xA;    ],&#xA;    "created_at": "2015-11-23T19:20:15.889000",&#xA;    "last_modified_at": "2015-11-23T20:08:11.604000",&#xA;    "bounce_count": 0,&#xA;    "opted_out_at": null,&#xA;    "archived_at": null,&#xA;    "email": "example@example.com",&#xA;    "opt_out_mailing_id": "None"&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I am trying to run write a query that gives me all hits where the <code>signup_form_ids.timestamp</code> are <code>lte now-7d/d</code>. I'm looking at <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html#ranges-on-dates" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html#ranges-on-dates</a> but unsure how to structure the query</p>&#xA;&#xA;<p>This is what I have so far:</p>&#xA;&#xA;<pre><code>{&#xA;    "query": {&#xA;        "nested": {&#xA;            "path": "signup_form_ids",&#xA;            "bool": {&#xA;                "must": [&#xA;                    {&#xA;                        "range": {&#xA;                            "timestamp" {&#xA;                                "lte": "now-7d/d"&#xA;                            }&#xA;                        }&#xA;                    }&#xA;                ]&#xA;            }&#xA;        },&#xA;        "bool": {&#xA;            "must": [&#xA;                {&#xA;                    "bool": {&#xA;                        "must": []&#xA;                    }&#xA;                },&#xA;                {&#xA;                    "match": {&#xA;                        "account_id": "100"&#xA;                    }&#xA;                },&#xA;                {&#xA;                    "filtered": {&#xA;                        "filter": {&#xA;                            "missing": {&#xA;                                "field": "deleted_at"&#xA;                            }&#xA;                        }&#xA;                    }&#xA;                }&#xA;            ]&#xA;        }&#xA;    },&#xA;    "size": 500,&#xA;    "from": 0&#xA;}&#xA;</code></pre>&#xA;
<p>There are several things wrong here, and it's not entirely obvious which ones are artifacts of you adjusting your query to post here.</p>&#xA;&#xA;<p>First, you're missing a colon after <code>"timestamp"</code> in your query. Also, you have an empty inner <code>"bool"</code>. And your <code>"range"</code> query is inside a needless <code>"bool"</code>. Also your <code>"filtered"</code> clause is redundant and you can just use the <code>"filter"</code> inside it.</p>&#xA;&#xA;<p>But the main problems are that 1) your <code>"nested"</code> query needs to be inside your <code>"bool"</code> if you want all the conditions to apply, 2) your <code>"nested"</code> <code>"range"</code> filter needs to specify the full path to <code>"timestamp"</code> and 3) the <code>"bool"</code> inside your <code>"nested"</code> clause needs to be in a <code>"filter"</code>.</p>&#xA;&#xA;<p>So, making minimal adjustments to make the query work, the following query returns the document you posted (I changed the <code>"lte"</code> to <code>"gte"</code> so the document you posted would be returned, otherwise it doesn't match the query, yet):</p>&#xA;&#xA;<pre><code>POST /test_index/_search&#xA;{&#xA;   "query": {&#xA;      "bool": {&#xA;         "must": [&#xA;            {&#xA;               "bool": {&#xA;                  "must": []&#xA;               }&#xA;            },&#xA;            {&#xA;               "match": {&#xA;                  "account_id": "100"&#xA;               }&#xA;            },&#xA;            {&#xA;               "filtered": {&#xA;                  "filter": {&#xA;                     "missing": {&#xA;                        "field": "deleted_at"&#xA;                     }&#xA;                  }&#xA;               }&#xA;            },&#xA;            {&#xA;               "nested": {&#xA;                  "path": "signup_form_ids",&#xA;                  "filter": {&#xA;                     "bool": {&#xA;                        "must": [&#xA;                           {&#xA;                              "range": {&#xA;                                 "signup_form_ids.timestamp": {&#xA;                                    "gte": "now-7d/d"&#xA;                                 }&#xA;                              }&#xA;                           }&#xA;                        ]&#xA;                     }&#xA;                  }&#xA;               }&#xA;            }&#xA;         ]&#xA;      }&#xA;   },&#xA;   "size": 500,&#xA;   "from": 0&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>If I clean it up to remove all the redundancies, I end up with:</p>&#xA;&#xA;<pre><code>POST /test_index/_search&#xA;{&#xA;   "query": {&#xA;      "bool": {&#xA;         "must": [&#xA;            {&#xA;               "match": {&#xA;                  "account_id": "100"&#xA;               }&#xA;            },&#xA;            {&#xA;               "missing": {&#xA;                  "field": "deleted_at"&#xA;               }&#xA;            },&#xA;            {&#xA;               "nested": {&#xA;                  "path": "signup_form_ids",&#xA;                  "filter": {&#xA;                     "range": {&#xA;                        "signup_form_ids.timestamp": {&#xA;                           "gte": "now-7d/d"&#xA;                        }&#xA;                     }&#xA;                  }&#xA;               }&#xA;            }&#xA;         ]&#xA;      }&#xA;   },&#xA;   "size": 500,&#xA;   "from": 0&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here is some code I used to play around with it:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/ee96042c0505dfb07199b919d134b2a20c5a66fd" rel="nofollow">http://sense.qbox.io/gist/ee96042c0505dfb07199b919d134b2a20c5a66fd</a></p>&#xA;