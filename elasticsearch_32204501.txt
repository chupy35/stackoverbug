32204501
Complex nested filter in ElasticSearch
<p>I have this data:</p>&#xA;&#xA;<pre><code>{&#xA;    "someKey1" : "someValue1",&#xA;    "someKey2" : "someValue2",&#xA;    "someKey3" : "someValue3",&#xA;    "someKey4" : "someValue4",&#xA;    "projectParticipants" : [&#xA;        {&#xA;            "participant_id" : 1,&#xA;            "role_id" : 1&#xA;        },&#xA;        {&#xA;            "participant_id" : 4,&#xA;            "role_id" : 2&#xA;        },&#xA;        {&#xA;            "participant_id" : 5,&#xA;            "role_id" : 3&#xA;        }&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I need to find items, that contains some project participants on some roles. For example I want to find item, where <strong>man 1 on role 1</strong> and <strong>man 4 on role 2</strong>.</p>&#xA;&#xA;<p>How can i do this?</p>&#xA;
<p>You need to use nested mapping and query for this.&#xA;You can read more on nested type <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-nested-type.html" rel="nofollow">here</a>.</p>&#xA;&#xA;<p>Once that is done you can do a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-nested-query.html" rel="nofollow">nested query</a>.</p>&#xA;&#xA;<p>So after declaring projectParticipants as nested in the mapping ,a query like below should suffice - </p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "bool": {&#xA;      "must": [&#xA;        {&#xA;          "nested": {&#xA;            "path": "projectParticipants",&#xA;            "score_mode": "avg",&#xA;            "query": {&#xA;              "bool": {&#xA;                "must": [&#xA;                  {&#xA;                    "match": {&#xA;                      "projectParticipants.participant_id": 1&#xA;                    }&#xA;                  },&#xA;                  {&#xA;                    "match": {&#xA;                      "projectParticipants.role_id": 1&#xA;                    }&#xA;                  }&#xA;                ]&#xA;              }&#xA;            }&#xA;          }&#xA;        },&#xA;        {&#xA;          "nested": {&#xA;            "path": "projectParticipants",&#xA;            "score_mode": "avg",&#xA;            "query": {&#xA;              "bool": {&#xA;                "must": [&#xA;                  {&#xA;                    "match": {&#xA;                      "projectParticipants.participant_id": 4&#xA;                    }&#xA;                  },&#xA;                  {&#xA;                    "match": {&#xA;                      "projectParticipants.role_id": 2&#xA;                    }&#xA;                  }&#xA;                ]&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;