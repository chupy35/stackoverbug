33494528
Using inner_hits inside an aggregation
<p>I have a collection of documents which all contain an array of nested objects with important data. I want do to an aggregation on these which returns me the first document, last document, and all of the nested objects in that group. I can achieve everything in that list except for the nested objects.</p>&#xA;&#xA;<p>Mapping:</p>&#xA;&#xA;<pre><code>"instances": {&#xA;"properties": {&#xA;   "aggField": {&#xA;      "type": "string",&#xA;      "index": "not_analyzed"&#xA;   },&#xA;   "id": {&#xA;      "type": "integer"&#xA;   },&#xA;   "nestedObjs": {&#xA;      "type": "nested",&#xA;      "properties": {&#xA;         "key": {&#xA;            "type": "string",&#xA;            "index": "not_analyzed"&#xA;         },&#xA;         "value": {&#xA;            "type": "integer"&#xA;         }&#xA;      }&#xA;   },&#xA;   "timestamp": {&#xA;      "type": "date",&#xA;      "format": "dateOptionalTime"&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>}</p>&#xA;&#xA;<p>Query:</p>&#xA;&#xA;<pre><code>{&#xA;"size" : 0,&#xA;"aggs" : {&#xA;    "agg-buckets" : {&#xA;        "terms" : {&#xA;            "field" : "aggField",&#xA;            "size" : 10&#xA;        },&#xA;        "aggs": {&#xA;            "last-report": {&#xA;                "top_hits": {&#xA;                    "sort": [&#xA;                        {&#xA;                            "timestamp": {&#xA;                                "order": "desc"&#xA;                            }&#xA;                        }&#xA;                    ],&#xA;                    "size": 1&#xA;                }&#xA;            },&#xA;            "first-report": {&#xA;                "top_hits": {&#xA;                    "sort": [&#xA;                        {&#xA;                            "timestamp": {&#xA;                                "order": "asc"&#xA;                            }&#xA;                        }&#xA;                    ],&#xA;                    "size": 1&#xA;                }&#xA;            },&#xA;            "nested-objs": {&#xA;                "nested": {&#xA;                    "path": "nestedObjs",&#xA;                    "inner_hits": {}&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>But this fails with: </p>&#xA;&#xA;<p>Parse Failure [Unexpected token START_OBJECT in [nested-objs].]</p>&#xA;&#xA;<p>If I remove the "inner_hits" field it works ok. But it just gives me the document count and not the documents themselves.</p>&#xA;&#xA;<p>What am I doing wrong?</p>&#xA;&#xA;<p>E: I'm using ES version 1.7.1</p>&#xA;
<p>Are you sure that <code>inner_hits</code> is allowed in a <code>nested</code> aggregation (as opposed to a <code>nested</code> query)? I suspect that's what's causing the error.</p>&#xA;