32226079
ElasticSearch Aggregations Query
<p>I already spent way too much time on this.  I have this aggregation that I can't get to work like it should.</p>&#xA;&#xA;<p>I have a ton of documents with a structure like this (I've ommited some of the parts that aren't relevant for this agg):</p>&#xA;&#xA;<pre><code> {&#xA;     "url": "THE_URL",&#xA;         "url_params": {},&#xA;         "title": "Het Nieuwsblad",&#xA;     "referrer": null,&#xA;     "time": "2015-08-25T08:35:15.729Z",&#xA;     "referrerHost": null,&#xA;     "timeOnSite": 16,&#xA;     "blocks": [{&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "gentenaar__gentenaar-header"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "gentenaar__gentenaar-headline"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "gentenaar__gentenaar-top"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "gentenaar__gentenaar-top-left"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "gentenaar__gentenaar-top-right"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "gentenaar__gentenaar-right"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "gentenaar__gentenaar-sidebar"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "gentenaar__gentenaar-footer"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 1,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-1"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-2"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-3"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-4"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-5"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-6"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-7"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-sidebar-1"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-sidebar-2-left"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-sidebar-2-right"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-sidebar-3"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__breaking-news-footer"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-headline"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-head-1"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-head-2"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-head-3"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-head-4"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-head-5"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-head-6"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-1"&#xA; }, {&#xA;     "viewTime": 0,&#xA;         "click": 0,&#xA;         "view": 0,&#xA;         "block": "news__fast-news-2-left"&#xA; }, {&#xA;     "viewTime": 0,&#xA;         "click": 0,&#xA;         "view": 0,&#xA;         "block": "news__fast-news-2-right"&#xA; }, {&#xA;     "viewTime": 0,&#xA;         "click": 0,&#xA;         "view": 0,&#xA;         "block": "news__fast-news-3"&#xA; }, {&#xA;     "viewTime": 0,&#xA;         "click": 0,&#xA;         "view": 0,&#xA;         "block": "news__fast-news-4-left"&#xA; }, {&#xA;     "viewTime": 0,&#xA;         "click": 0,&#xA;         "view": 0,&#xA;         "block": "news__fast-news-4-right"&#xA; }, {&#xA;     "viewTime": 0,&#xA;         "click": 0,&#xA;         "view": 0,&#xA;         "block": "news__fast-news-5"&#xA; }, {&#xA;     "viewTime": 0,&#xA;         "click": 0,&#xA;         "view": 0,&#xA;         "block": "news__fast-news-6-left"&#xA; }, {&#xA;     "viewTime": 0,&#xA;         "click": 0,&#xA;         "view": 0,&#xA;         "block": "news__fast-news-6-right"&#xA; }, {&#xA;     "viewTime": 1,&#xA;         "click": 1,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-right"&#xA; }, {&#xA;     "viewTime": 0,&#xA;         "click": 0,&#xA;         "view": 0,&#xA;         "block": "news__fast-news-bottom"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-sidebar-1"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-sidebar-2-left"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-sidebar-2-right"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-sidebar-3"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-sidebar-4-left"&#xA; }, {&#xA;     "viewTime": 11,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-sidebar-4-right"&#xA; }, {&#xA;     "viewTime": 1,&#xA;         "click": 0,&#xA;         "view": 1,&#xA;         "block": "news__fast-news-sidebar-5"&#xA; }, {&#xA;     "viewTime": 0,&#xA;         "click": 0,&#xA;         "view": 0,&#xA;         "block": "news__fast-news-sidebar-6-left"&#xA; }, ...],&#xA;     "activeAds": [{&#xA;     "viewed": 1,&#xA;         "clicked": 0,&#xA;         "type": "button",&#xA;         "width": 317,&#xA;         "height": 75,&#xA;         "timeViewed": 10&#xA; }, {&#xA;     "viewed": 1,&#xA;         "clicked": 0,&#xA;         "type": "xlleaderboard",&#xA;         "width": 990,&#xA;         "height": 122,&#xA;         "timeViewed": 10&#xA;     }, ...]...&#xA; }&#xA;</code></pre>&#xA;&#xA;<p>It's the blocks array that I'm having problems with.  I want to know per block the sum of clicks, views and viewTime.</p>&#xA;&#xA;<p>I'm trying to use this query:</p>&#xA;&#xA;<pre><code>{&#xA;  "size": 0,&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "match_all": {}&#xA;      },&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "range": {&#xA;                "dt": {&#xA;                  "from": "2015-08-25T00:00:00+00:00",&#xA;                  "to": "2015-08-26T23:59:59+00:00"&#xA;                 }&#xA;               }&#xA;            },&#xA;            {&#xA;              "term": {&#xA;                 "url": "http://www.nieuwsblad.be/"&#xA;              }&#xA;             }&#xA;           ]&#xA;        }&#xA;      }&#xA;     }&#xA;   },&#xA;  "aggs": {&#xA;    "per_block": {&#xA;      "term": {&#xA;        "field": "blocks.blocks"&#xA;      },&#xA;      "aggs": {&#xA;        "clicks": {&#xA;          "sum": {&#xA;            "field": "blocks.click"&#xA;           }&#xA;         }&#xA;      }&#xA;     }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>For the activeAds, I'm using nearly identical code but there it's working perfectly:</p>&#xA;&#xA;<pre><code>{&#xA;  "size": 0,&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "match_all": {}&#xA;      },&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "range": {&#xA;                "dt": {&#xA;                  "from": "2015-08-25T00:00:00+00:00",&#xA;                  "to": "2015-08-26T23:59:59+00:00"&#xA;                }&#xA;              }&#xA;            },&#xA;            {&#xA;              "terms": {&#xA;                "page.page_type": [&#xA;                  "home"&#xA;                ]&#xA;              }&#xA;            }&#xA;          ],&#xA;          "must_not": {&#xA;            "term": {&#xA;              "activeAds.timeViewed": 0&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "per_ad": {&#xA;      "terms": {&#xA;        "field": "activeAds.type"&#xA;      },&#xA;      "aggs": {&#xA;        "clicks": {&#xA;          "sum": {&#xA;            "field": "activeAds.clicked"&#xA;           }&#xA;        },&#xA;         "views": {&#xA;          "sum": {&#xA;            "field": "activeAds.viewed"&#xA;          }&#xA;        },&#xA;        "total_time_viewed": {&#xA;          "sum": {&#xA;            "field": "activeAds.timeViewed"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Anyone have any idea on what I'm doing wrong?</p>&#xA;