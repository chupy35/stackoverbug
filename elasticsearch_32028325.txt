32028325
Elasticsearch: match_phrase then regexp ("short-circuit") (slow regex)
<p>I want to match_phrase then then regexp. The match_phrase happens quick and narrows down the result substantially and thus I would only like to regex on those results. How can I do do this? I have tried a few things, but I'm currently I'm looking at:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "constantScore": {&#xA;      "filter": {&#xA;        "and": [&#xA;          {&#xA;            "query": {&#xA;              "match_phrase": {&#xA;                "myfield1": "something something something"&#xA;              }&#xA;            }&#xA;          },&#xA;          {&#xA;            "regexp": {"myfield2": ".*soemthingelsesomethingelse.*"}&#xA;          }&#xA;        ]&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The thing is, I know that the <code>match_phrase</code> on its own takes about 10 seconds and will for example, return a single document, but then when I add the regex in and the time hits 30 seconds, and still only returns a single document. Clearly it is not working as I would think it would. Clearly it is regexing on more than a single document. It does not take 20 seconds to regex on a single doc!</p>&#xA;&#xA;<p>myfield2 is not analysed. I require full regexing ability on it as if it were simply text. Hence why it is very important to only regex on it if match_phrase is true.</p>&#xA;&#xA;<p>Thanks!</p>&#xA;&#xA;<p>edit: I believe I am looking to "short-circuit" on the match_phrase</p>&#xA;&#xA;<p>edit2: Another try</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "bool": {&#xA;      "must": [&#xA;        {&#xA;          "match_phrase": {&#xA;            "myfield1": "something something something"&#xA;          }&#xA;        },&#xA;        {&#xA;          "regexp": {&#xA;            "myfield2": ".*soemthingelsesomethingelse.*"&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Edit3: This sort of proves that something isn't right, because this is slow</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "ids": {&#xA;      "type": "aaa",&#xA;      "values": [&#xA;        "AU8wgJipa1wkLOvkEVEL"&#xA;      ]&#xA;    }&#xA;  },&#xA;    "post_filter": {&#xA;    "regexp": {&#xA;      "field2": ".*somethingelse.*"&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>This I would have thought would for sure be doing a regex on one document. If this were a grep on the same document in .txt format it would be instant.</p>&#xA;