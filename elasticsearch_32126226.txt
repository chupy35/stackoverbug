32126226
Multiword Synonyms and Phrase Queries
<p>Is there a mistake in the Elastic documentation?</p>&#xA;&#xA;<p>Given the following index mapping:</p>&#xA;&#xA;<pre><code>PUT /my_index&#xA;{&#xA;  "settings": {&#xA;    "analysis": {&#xA;      "filter": {&#xA;        "my_synonym_filter": {&#xA;          "type": "synonym",&#xA;          "synonyms": [&#xA;            "usa,united states,u s a,united states of america"&#xA;          ]&#xA;        }&#xA;      },&#xA;      "analyzer": {&#xA;        "my_synonyms": {&#xA;          "tokenizer": "standard",&#xA;          "filter": [&#xA;            "lowercase",&#xA;            "my_synonym_filter"&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Given this document:</p>&#xA;&#xA;<pre><code>put /my_index/country/1&#xA;{&#xA;  "title" : "The United States is wealthy"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>In the documentation it states:</p>&#xA;&#xA;<p>These phrases would not match:</p>&#xA;&#xA;<p>The usa is wealthy</p>&#xA;&#xA;<p>The united states of america is wealthy</p>&#xA;&#xA;<p>The U.S.A. is wealthy</p>&#xA;&#xA;<p>However, these phrases would:</p>&#xA;&#xA;<p>United states is wealthy</p>&#xA;&#xA;<p>Usa states of wealthy</p>&#xA;&#xA;<p>The U.S. of wealthy</p>&#xA;&#xA;<p>U.S. is america</p>&#xA;&#xA;<p>However this does not seem to be the case -  the phrases that should match aren't matching at all! Here is the query I am running (without synonym expansion at query time as per the <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/multi-word-synonyms.html" rel="nofollow">documentation</a>):</p>&#xA;&#xA;<pre><code>GET /my_index/country/_search&#xA;{&#xA;&#xA;    "query" : {&#xA;        "match_phrase" : {&#xA;            "title" : {&#xA;               "query" : "United States is wealthy",&#xA;               "analyzer": "standard"&#xA;            }&#xA;&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>What am I missing here?</p>&#xA;
<p>The example in documentation works for me.</p>&#xA;&#xA;<p>Probably you forgot to set the analyzer for <code>title</code> field in the mapping.</p>&#xA;&#xA;<p>Example:</p>&#xA;&#xA;<p>1) Create Index</p>&#xA;&#xA;<pre><code>PUT /my_index&#xA;{&#xA;  "settings": {&#xA;    "analysis": {&#xA;      "filter": {&#xA;        "my_synonym_filter": {&#xA;          "type": "synonym",&#xA;          "synonyms": [&#xA;            "usa,united states,u s a,united states of america"&#xA;          ]&#xA;        }&#xA;      },&#xA;      "analyzer": {&#xA;        "my_synonyms": {&#xA;          "tokenizer": "standard",&#xA;          "filter": [&#xA;            "lowercase",&#xA;            "my_synonym_filter"&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>2) Add Mapping </p>&#xA;&#xA;<pre><code>PUT my_index/country/_mapping&#xA;{&#xA;    "properties" : {&#xA;        "title" : {"type" : "string","analyzer" : "my_synonyms"}&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>3) Index Document</p>&#xA;&#xA;<pre><code>PUT /my_index/country/1&#xA;{&#xA;  "title" : "The United States is wealthy"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>4) Query</p>&#xA;&#xA;<pre><code>GET /my_index/country/_search&#xA;{&#xA;&#xA;    "query" : {&#xA;        "match_phrase" : {&#xA;            "title" : {&#xA;               "query" : "United States is wealthy",&#xA;               "analyzer": "standard"&#xA;            }&#xA;&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>5) Response :</p>&#xA;&#xA;<pre><code>{&#xA;   "took": 8,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 5,&#xA;      "successful": 5,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 1,&#xA;      "max_score": 0.75942194,&#xA;      "hits": [&#xA;         {&#xA;            "_index": "my_index",&#xA;            "_type": "country",&#xA;            "_id": "1",&#xA;            "_score": 0.75942194,&#xA;            "_source": {&#xA;               "title": "The United States is wealthy"&#xA;            }&#xA;         }&#xA;      ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;
<p>So close, you missed one thing!</p>&#xA;&#xA;<p>In your query, you should change the analyzer! You have to run your query text against the <code>my_synonym</code> analyzer to be able to match the synonyms. Currently, you have the query using the <code>standard</code> analyzer, which simply tokenizes your text as <code>united</code>, <code>states</code>,<code>is</code>,<code>wealthy</code>, instead of also using all of your synonyms.</p>&#xA;&#xA;<p>Change this:</p>&#xA;&#xA;<pre><code>GET /my_index/country/_search&#xA;{&#xA;&#xA;    "query" : {&#xA;        "match_phrase" : {&#xA;            "title" : {&#xA;               "query" : "United States is wealthy",&#xA;               "analyzer": "standard"&#xA;            }&#xA;&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>To this:</p>&#xA;&#xA;<pre><code>GET /my_index/country/_search&#xA;{&#xA;&#xA;    "query" : {&#xA;        "match_phrase" : {&#xA;            "title" : {&#xA;               "query" : "United States is wealthy",&#xA;               "analyzer": "my_synonyms"&#xA;            }&#xA;&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Now, when you query, the text <code>United States</code> will properly get tokenized to <code>usa</code></p>&#xA;