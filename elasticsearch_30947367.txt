30947367
Primary/Replica Inconsistent Scoring
<p>We have a cluster with 3 primary shards and 2 replicas per primary.  The total doc count is the same for the primary/replica shards; however, we're getting 3 distinct scores for the same query/document.  When we add <code>preference = primary</code> as a query parameter, we get consistent scores each time.</p>&#xA;&#xA;<p>The only explanation we can think of is different DF counts between the primary/replicas.  Where is the inconsistency between the primary/replica shards, and how does one go about fixing this?  We're using 1.4.2.</p>&#xA;&#xA;<p><strong>EDIT:</strong>&#xA;We just reindexed the doctype we were querying, but there's <em>still</em> inconsistent scoring.</p>&#xA;
<p>Primary and replica shards have a different "path" when it comes to segment merging. Meaning, the number and size of the segments can differ between them. Each shared takes care of its own segments independent from other shards.</p>&#xA;&#xA;<p>Why this matters when it comes to calculating score, is because merging is the moment when the documents that were deleted are actually deleted. Until then, deleted documents are only marked as deleted (and taken out from the query results after the query already ran). So, this means it can influence the algorithm by which the score is calculated.</p>&#xA;&#xA;<p>To be more specific - total number of docs in a shard is used for the [IDF calculation](<a href="http://lucene.apache.org/core/4_3_0/core/org/apache/lucene/search/similarities/DefaultSimilarity.html#idf(long" rel="nofollow">http://lucene.apache.org/core/4_3_0/core/org/apache/lucene/search/similarities/DefaultSimilarity.html#idf(long</a>, long)) and for document frequency (<code>docFreq</code>):</p>&#xA;&#xA;&#xA;&#xA;<pre><code>return (float)(Math.log(numDocs/(double)(docFreq+1)) + 1.0)&#xA;</code></pre>&#xA;&#xA;<p>And this number of docs include the deleted (marked as deleted, to be more precise) documents. Take, also, a look at <a href="https://github.com/elastic/elasticsearch/issues/3578#issuecomment-23325899" rel="nofollow">this github issue and Simon's comments</a> regarding the same subject.</p>&#xA;