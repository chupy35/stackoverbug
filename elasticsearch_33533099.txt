33533099
How to query for inner_hits against grandparents in multi-generational setup
<p>So I've set up my Elasticsearch store according to this: <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/grandparents.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/guide/current/grandparents.html</a></p>&#xA;&#xA;<pre><code>PUT /company&#xA;{&#xA;  "mappings": {&#xA;    "country": {},&#xA;    "branch": {&#xA;      "_parent": {&#xA;        "type": "country" &#xA;      }&#xA;    },&#xA;    "employee": {&#xA;      "_parent": {&#xA;        "type": "branch" &#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;POST /company/country/_bulk&#xA;{ "index": { "_id": "uk" }}&#xA;{ "name": "UK" }&#xA;{ "index": { "_id": "france" }}&#xA;{ "name": "France" }&#xA;&#xA;POST /company/branch/_bulk&#xA;{ "index": { "_id": "london", "parent": "uk" }}&#xA;{ "name": "London Westmintster" }&#xA;{ "index": { "_id": "liverpool", "parent": "uk" }}&#xA;{ "name": "Liverpool Central" }&#xA;{ "index": { "_id": "paris", "parent": "france" }}&#xA;{ "name": "Champs Élysées" }&#xA;&#xA;PUT /company/employee/1?parent=london&amp;routing=uk &#xA;{&#xA;  "name":  "Alice Smith",&#xA;  "dob":   "1970-10-24",&#xA;  "hobby": "hiking"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>This query works fine and returns Alice as expected, but no inner_hits:</p>&#xA;&#xA;<pre><code>POST /company/employee/_search&#xA;{&#xA;    "query": {&#xA;        "has_parent": {&#xA;            "type": "branch",&#xA;            "query": {&#xA;                "term": {"_id": "london"}&#xA;            },&#xA;            "inner_hits": {}&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>But this query doesn't return any inner_hits:</p>&#xA;&#xA;<pre><code>POST /company/employee/_search&#xA;{&#xA;    "query": {&#xA;        "has_parent": {&#xA;            "type": "branch",&#xA;            "query": {&#xA;                "has_parent": {&#xA;                    "type": "country",&#xA;                    "query": {&#xA;                        "term": {"_id": "uk"}&#xA;                    }&#xA;                },&#xA;                "inner_hits": {}&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I thought it would return Alice, but it doesn't. How do I find all employees whose country is <code>uk</code>?</p>&#xA;&#xA;<p>Note that the example query on elastic.co doesn't return any inner_hits either. Here's the query:</p>&#xA;&#xA;<pre><code>GET /company/country/_search&#xA;{&#xA;  "query": {&#xA;    "has_child": {&#xA;      "type": "branch",&#xA;      "query": {&#xA;        "has_child": {&#xA;          "type": "employee",&#xA;          "query": {&#xA;            "match": {&#xA;              "hobby": "hiking"&#xA;            }&#xA;          },&#xA;          "inner_hits": {}&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I got zero inner_hits.</p>&#xA;
<p>This is currently an outstanding with <code>inner_hits</code>.</p>&#xA;&#xA;<p>You can add on the issue here: <a href="https://github.com/elastic/elasticsearch/issues/11118" rel="nofollow">https://github.com/elastic/elasticsearch/issues/11118</a></p>&#xA;