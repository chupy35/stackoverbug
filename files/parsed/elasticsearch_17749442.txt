17749442 How can I identify missing documents in ElasticSearch?

**Background** :

In my ElasticSearch index, I have two types of documents that can be
identified as 'bvi_ship' and 'bvi_notify'. Each document that is identified as
'bvi_ship' should also have a corresponding document identified as
'bvi_notify'.

**Question** :

What is an appropriate way of identifying the 'bvi_ship' documents that don't
have a 'bvi_notify' document?

**Using Facet** :

I've been able to identify the necessary documents using the following faceted
code:

    
    
    {
       "size":0,
       "query":{
          "filtered":{
             "query":{
                "query_string":{
                   "default_operator":"OR",
                   "default_field":"_all",
                   "query":"@fields.action:\"bv_ship\" OR @fields.action:\"bvi_notify\""
                }
             }
          }
       },
       "facets":{
          "terms":{
             "terms":{
                "field":[
                   "@fields.object"
                ],
                "size":1000
             }
          }
       }
    }
    

Which returns results that look like this:

    
    
    {
      "took" : 147,
      ...
      },
      "hits" : {
        ...
      },
      "facets" : {
        "terms" : {
          ...
          "terms" : [ {
            "term" : "xml",
            "count" : 1443
          }, {
            "term" : "content_ff47d2d096ea4510ac0895941666e507",
            "count" : 2
          }, {
            "term" : "content_fa525becb2724b7682df278c02fed308",
            "count" : 2
          },
            ... THOUSANDS OF RECORDS WITH COUNT of 2
          }, {
            "term" : "content_f1ff2f7440534a08bad4c62b92165949",
            "count" : 1
          } ]
        }
      }
    }
    

This _could_ work well, but I obviously don't want to return thousands of
records that have a count of 2 when I am really only interested in the records
that have a count of 1.

Is there a way to limit the faceted search so that it only returns the records
with a count of 1?

**Using Filter** :

I'm guessing I should be able to be more specific in my query and simply
select the appropriate records using a combination of Queries and Filters,
though my ElasticSearch Kung-Fu is being handicapped by my Relational Database
Karate.

I think the best way to do it is to index records with 'bvi_notify' objects as
children of records with 'bvi_ship' objects. Then you will be able to use
[has_child](http://www.elasticsearch.org/guide/reference/query-dsl/has-child-
filter/) filter in `must_not` clause of a `bool` filter to find all 'bvi_ship'
documents that don't have corresponding 'bvi_notify' objects.

To answer your original question, there is no way to limit term facets to only
terms with a count of 1, but you can sort facets using `reverse_count` order,
which will bring all terms with count of 1 to the top of the list. However, I
should also mention that if you have more than 1 shard, the counts that you
get in your facets [might be
incorrect](https://github.com/elasticsearch/elasticsearch/issues/1305). This
is another reason why I would recommend going with parent/child solution
instead of facets.

