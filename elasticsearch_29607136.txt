29607136
How to sort parents by number of children in Elasticsearch
<p>I have <code>parent</code>/<code>child</code>-related documents in my index and want to get list of parents sorted by number of children. Is it any way to do it? I'm using <code>Elasticsearch</code> 1.5.1</p>&#xA;&#xA;<p>Right now I can easily get number of children documents together with parent query results by using <a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.5/search-request-inner-hits.html" rel="nofollow"><code>inner_hits</code></a> feature, but it seems no way to access <code>inner_hits.{child_type_name}.hits.total</code> value from the script or search/score function. Any ideas?</p>&#xA;
<p>Well, I found answer myself, finally. Thanks to hints from @doctorcal on <a href="https://webchat.freenode.net/#elasticsearch" rel="noreferrer">#elasticsearch</a> IRC</p>&#xA;&#xA;<p>As I mentioned in the question, we can get list of children together with each parent using <a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.5/search-request-inner-hits.html" rel="noreferrer">inner_hits</a> in <code>Elasticsearch</code> 1.5.</p>&#xA;&#xA;<p>To be able to sort parents by number of their children we need to use a small trick - put number of children into the parent's score (which is used to sort by default). For that, we just use the score mode <code>sum</code> for <a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.4/query-dsl-has-child-query.html" rel="noreferrer">has_child</a> query:</p>&#xA;&#xA;<pre><code>{&#xA;    "query": {&#xA;        "has_child": {&#xA;            "type": "comment",&#xA;            "score_mode": "sum",&#xA;            "query": {&#xA;                "match_all": {}&#xA;            },&#xA;            "inner_hits": {}&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>NOTE: this query has a limitation - it seems you can't keep information about initial scores (relevance scores for the query), since we replace them with number of children.</p>&#xA;