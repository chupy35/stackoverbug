29431709
Why is this elastic search query with must clause not returning any documents?
<p>I'm having trouble getting this elastic search query to return the data I'd expect it to return. This is my query:</p>&#xA;&#xA;<pre><code>curl -XGET '0.0.0.0:9200/local/candidate/_search?routing=company_1_candidates&amp;pretty' -d '&#xA;{&#xA;    "query":{&#xA;        "filtered": {&#xA;            "query": {&#xA;                "multi_match": {&#xA;                    "fields": [&#xA;                        "candidate_name",&#xA;                        "candidate_city",&#xA;                        "candidate_country"&#xA;                    ],&#xA;                    "query": "j",&#xA;                    "type": "phrase_prefix"&#xA;                }&#xA;            },&#xA;            "filter": {&#xA;                "bool": {&#xA;                    "must": [&#xA;                        {&#xA;                            "term": {&#xA;                                "company_id": 1&#xA;                            }&#xA;                        },&#xA;                        {&#xA;                            "term": {&#xA;                                "candidate_city": "Rotterdam"&#xA;                            }&#xA;                        }&#xA;                    ]&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}'&#xA;</code></pre>&#xA;&#xA;<p>When I run this query with only the <code>company_id</code> term in the must clause, I'm finding this record:</p>&#xA;&#xA;<pre><code>{"candidate_name":"J Kennis","candidate_id":2,"candidate_tags":[],"candidate_city":"Rotterdam","candidate_country":"Nederland","company_id":1}&#xA;</code></pre>&#xA;&#xA;<p>But when I include the <code>"candidate_city": "Rotterdam"</code> bit in the query, it returns zero results. Am I missing something here?</p>&#xA;
<p>Probably because the candidate_city field is being indexed with an analyzer that includes the token analyzer "lower", but the term filter is un-analyzed.</p>&#xA;&#xA;<p>If you change your filter to&#xA;<code>&#xA;  "term": {"candidate_city": "rotterdam"}&#xA;</code>&#xA;or&#xA;<code>&#xA;  "match": {"candidate_city": "Rotterdam"}&#xA;</code>&#xA;you'll probably get the document back.</p>&#xA;