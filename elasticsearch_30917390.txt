30917390
Elastic and aggregations performance
<p>We have an index with approximately 1 million documents each representing a product for an e-commerce store. We are using aggregations to calculate buckets representing attribute values for each attribute of the product. If we do a search, which limits the resultset to say 2000 products, performance is great (Elastic returns the result in less than 10 milliseconds). However, if we do a matchall query to get all products and their corresponding aggregations, elastic takes more than 3 seconds to return a result. If we disable the aggregations, performance is blazing again. Thus, it seems as though performance, when using aggregations, is very dependent the size of the resultset (With a matchall query we get around 1000 buckets). Is there anything special we need to be aware of in Elastic, in order to have a matchall query performing similarly to a query, which returns 2000 products?</p>&#xA;&#xA;<p>Before we started using Elastic, we have worked with Lucene, and built our own facet abstraction on top of Lucene to be able to handle the above scenario. In this case, we pre-calculated facets on index startup and represented each facet as a term with a corresponding bitset. When doing searches, we retrieved a bitset for the query in question and “AND’ed” it with the precalculated bitset for each facet we wanted to show in the given scenario. With this implementation the speed at which we were able to calculate facet results did not differ depending on the size of the resultset of a given query. Only the number of documents and the number of facets influenced the speed. With this implementation, we were able to calculate more than 10.000 facets (buckets) at each search request with an index of 1 million documents and still get the resultset and facet results in less than 100 milliseconds.</p>&#xA;&#xA;<p>Can anyone tell if this will be possible to achieve with Elastic and any pointers to what we are doing wrong (We are currently running tests on a setup at found.no with 1 cluster having 4 2,5Ghz cores and 1GB ram. The Elastic index takes up around 3,5GB of disk space</p>&#xA;&#xA;<p>Example query (we can save about 1/3 of the query time by not using nested aggregations):</p>&#xA;&#xA;<pre><code>{&#xA;   "query": {&#xA;      "match_all": {}&#xA;   },&#xA;   "aggs": {&#xA;       "nested_aggs": {&#xA;           "nested": {&#xA;               "path": "specs"&#xA;           },&#xA;           "aggs": {&#xA;               "combined": {&#xA;                   "filter": {&#xA;                     "match_all": { }  &#xA;                   },&#xA;                   "aggs": {&#xA;                       "ul1": {&#xA;                            "terms": {&#xA;                                "field": "unspscNameLevel1",&#xA;                                "size": 50&#xA;                            }    ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;&#xA;                       },&#xA;                       "ul2": {&#xA;                            "terms": {&#xA;                                "field": "unspscNameLevel2",&#xA;                                "size": 50&#xA;                            }       ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "ul3": {&#xA;                            "terms": {&#xA;                                "field": "unspscNameLevel3",&#xA;                                "size": 50&#xA;                            }       ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "ul4": {&#xA;                            "terms": {&#xA;                                "field": "unspscNameLevel4",&#xA;                                "size": 50&#xA;                            }       ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "rl1": {&#xA;                            "terms": {&#xA;                                "field": "requirementSpecificationNameLevel1",&#xA;                                "size": 50&#xA;                            }   ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "rl2": {&#xA;                            "terms": {&#xA;                                "field": "requirementSpecificationNameLevel2",&#xA;                                "size": 50&#xA;                            }   ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "rl3": {&#xA;                            "terms": {&#xA;                                "field": "requirementSpecificationNameLevel3",&#xA;                                "size": 50&#xA;                            }   ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "t1": {&#xA;                            "terms": {&#xA;                                "field": "tilslutningskrav",&#xA;                                "size": 50&#xA;                            }   &#xA;                       },&#xA;                       "t2": {&#xA;                            "terms": {&#xA;                                "field": "tildelingsform",&#xA;                                "size": 50&#xA;                            }   &#xA;                       },&#xA;                       "t3": {&#xA;                            "terms": {&#xA;                                "field": "tildelingskriterie",&#xA;                                "size": 50&#xA;                            }   &#xA;                       }&#xA;                   }&#xA;               }&#xA;           }&#xA;       },&#xA;       "nested_aggs2": {&#xA;           "nested": {&#xA;               "path": "specs.attributes"&#xA;           },&#xA;           "aggs": {&#xA;               "combined": {&#xA;                   "filter": {&#xA;                     "match_all": { }  &#xA;                   },&#xA;                   "aggs": {&#xA;                       "n4": {&#xA;                            "terms": {&#xA;                                "field": "4. niv. kategori",&#xA;                                "size": 50&#xA;                            }     ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "ffv": {&#xA;                            "terms": {&#xA;                                "field": "form forvaltningsopgave",&#xA;                                "size": 50&#xA;                            }     ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "fh": {&#xA;                            "terms": {&#xA;                                "field": "form hovedområde",&#xA;                                "size": 50&#xA;                            }   ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "fo": {&#xA;                            "terms": {&#xA;                                "field": "form opgaveområde",&#xA;                                "size": 50&#xA;                            }  ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "fs": {&#xA;                            "terms": {&#xA;                                "field": "form serviceområde",&#xA;                                "size": 50&#xA;                            }    ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       },&#xA;                       "s": {&#xA;                            "terms": {&#xA;                                "field": "styresystem",&#xA;                                "size": 50&#xA;                            }     ,&#xA;                            "aggs": {&#xA;                                "parent_count": {&#xA;                                  "reverse_nested": {}&#xA;                                }&#xA;                            }&#xA;                       }&#xA;                   }&#xA;               }&#xA;           }&#xA;       },&#xA;       "supplierCategory": {&#xA;           "filter": {&#xA;             "match_all": { }  &#xA;           },&#xA;           "aggs": {&#xA;               "sc": {&#xA;                    "terms": {&#xA;                        "field": "supplierCategory.raw",&#xA;                        "size": 50&#xA;                    }   &#xA;               },&#xA;               "on": {&#xA;                    "terms": {&#xA;                        "field": "organisationName.raw",&#xA;                        "size": 50&#xA;                    }   &#xA;               },&#xA;               "mn": {&#xA;                    "terms": {&#xA;                        "field": "manufacturerName.raw",&#xA;                        "size": 50&#xA;                    }   &#xA;               }&#xA;           } &#xA;       }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;