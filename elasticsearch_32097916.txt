32097916
Filtering children by parent value in elasticsearch
<p>I have an index with three document types:</p>&#xA;&#xA;<ul>&#xA;<li>Lead - have and id and type (child of Account)</li>&#xA;<li>Account - have an id</li>&#xA;<li>Payment - have and id, type and account_id (child of Account)</li>&#xA;</ul>&#xA;&#xA;<p>They all are in parent-child relationship.&#xA;I want to get statistics about which lead types do i have (group by type) and then count how many payments of this certain type do i have.</p>&#xA;&#xA;<p>I came to this query, but i'm unable to filter child aggregation by parent's type.&#xA;Query to <code>Lead</code> type</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "match_all": {}&#xA;  },&#xA;  "aggs": {&#xA;    "by_type": {&#xA;      "terms": {&#xA;        "field": "type"&#xA;      },&#xA;      "aggs": {&#xA;        "payments_count": {&#xA;          "filter": {&#xA;            "and": [&#xA;              {&#xA;                "has_parent": {&#xA;                  "type": "account",&#xA;                  "query": {&#xA;                    "filtered": {&#xA;                      "query": {&#xA;                        "match_all": {}&#xA;                      },&#xA;                      "filter": {&#xA;                        "and": [&#xA;                          {&#xA;                            "has_child": {&#xA;                              "type": "payment",&#xA;                              "query": {&#xA;                                "filtered": {&#xA;                                  "query": {&#xA;                                    "match_all": {}&#xA;                                  },&#xA;                                  "filter": {&#xA;                                    "and": [&#xA;                                      {&#xA;                                        "term": {&#xA;                                          "type": ?????????&#xA;                                        }&#xA;                                      }&#xA;                                    ]&#xA;                                  }&#xA;                                }&#xA;                              }&#xA;                            }&#xA;                          }&#xA;                        ]&#xA;                      }&#xA;                    }&#xA;                  }&#xA;                }&#xA;              }&#xA;            ]&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>In the last has_child filter i want to know how to filter children by <code>lead.type</code> of it's parent, something like this:</p>&#xA;&#xA;<pre><code>"filter": {&#xA;    "and": [&#xA;      {&#xA;        "term": {&#xA;          "type": "$lead.type"&#xA;        }&#xA;      }&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Also, i can't inverse this query due to another aggregations going on <code>lead</code> type.</p>&#xA;&#xA;<p>Any help would be much appreciated</p>&#xA;
<p>You are running your query against type "lead" , so if you want to filter on "lead.type", you should do it as the first filter aggregation before stepping into its parent.</p>&#xA;&#xA;<p>&#xA;</p>&#xA;&#xA;<pre><code>"payments_count": {&#xA;  "filter": {&#xA;    "and": [&#xA;     {&#xA;        "term": {&#xA;          "type": "$lead.type"&#xA;        }&#xA;     },&#xA;     {&#xA;       "has_parent": {&#xA;       ...&#xA;</code></pre>&#xA;&#xA;&#xA;&#xA;<p>Maybe my query also helps as it is a little similar: <a href="https://stackoverflow.com/questions/36573853/filter-aggregation-returns-0-where-it-should-be-1">Term Filter on a nested field called id does not work as expected</a></p>&#xA;