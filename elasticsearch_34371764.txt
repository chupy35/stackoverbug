34371764
ElasticSearch Nested Filter and Aggregation
<p>So I have this mapping:</p>&#xA;&#xA;<pre><code>"employee": {&#xA;  "properties": {&#xA;     "DaysOff": {&#xA;        "type": "nested",&#xA;        "properties": {&#xA;           "Date": {&#xA;              "type": "date",&#xA;              "format": "strict_date_optional_time||epoch_millis"&#xA;           },&#xA;           "Days": {&#xA;              "type": "double"&#xA;           },&#xA;           "ID": {&#xA;              "type": "long"&#xA;           }&#xA;        }&#xA;     }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>So basically a employee can have days off. Each day off they have is stored in an array under the property <code>DaysOff</code>. <code>Days</code> can be a fraction of a day, so if an employee took half a day off then it would be <code>0.5</code>.</p>&#xA;&#xA;<p>So I have this search:</p>&#xA;&#xA;<pre><code>{&#xA;   "size": 45,&#xA;   "filter": {&#xA;      "nested": {&#xA;         "path": "DaysOff",&#xA;         "filter": {&#xA;            "range": {&#xA;               "DaysOff.Date": {&#xA;                  "from": "now-2M",&#xA;                  "to": "now"&#xA;               }&#xA;            }&#xA;         }&#xA;      }  &#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>which brings me back 45 documents. which is correct. I'm just can't figure out how to now apply an aggregation to these documents in order to get back the sum of all the days that have been taken. </p>&#xA;&#xA;<p>Using this <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/nested-aggregation.html" rel="nofollow">resource</a> I tried this <code>aggs</code> but didn't get me the correct result:</p>&#xA;&#xA;<pre><code>{&#xA;   "size": 45,&#xA;   "filter": {&#xA;      "nested": {&#xA;         "path": "DaysOff",&#xA;         "filter": {&#xA;            "range": {&#xA;               "DaysOff.Date": {&#xA;                  "from": "now-2M",&#xA;                  "to": "now"&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   },&#xA;   "aggs": {&#xA;      "sum_docs": {&#xA;         "nested": {&#xA;            "path": "DaysOff"&#xA;         },&#xA;         "aggs": {&#xA;            "stepped_down": {&#xA;               "sum": {&#xA;                  "field": "DaysOff.Days"&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;
<p>You need to <a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.0/search-aggregations-bucket-filter-aggregation.html" rel="nofollow"><strong>filter</strong></a> on those <code>nested documents</code> to get the correct results, From the docs</p>&#xA;&#xA;<blockquote>&#xA;  <p>Because nested documents are indexed as separate documents, they can only be accessed within the scope of the nested query,</p>&#xA;</blockquote>&#xA;&#xA;<p>I created index like this</p>&#xA;&#xA;<pre><code>POST employee&#xA;{&#xA;  "mappings": {&#xA;    "emp_map": {&#xA;      "properties": {&#xA;        "DaysOff": {&#xA;          "type": "nested",&#xA;          "properties": {&#xA;            "Date": {&#xA;              "type": "date",&#xA;              "format": "strict_date_optional_time||epoch_millis"&#xA;            },&#xA;            "Days": {&#xA;              "type": "double"&#xA;            },&#xA;            "ID": {&#xA;              "type": "long"&#xA;            }&#xA;          }&#xA;        },&#xA;        "name": {&#xA;          "type": "string"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;},&#xA;</code></pre>&#xA;&#xA;<p>Then I indexed few documents like this,</p>&#xA;&#xA;<pre><code>PUT employee/emp_map/1&#xA;{&#xA;  "name" : "messi",&#xA;  "DaysOff" : [&#xA;    {&#xA;     "Date" : "2015-11-01",&#xA;     "Days" : 1,&#xA;     "ID" : 11&#xA;    },&#xA;    {&#xA;     "Date" : "2014-11-01",&#xA;     "Days" : 2,&#xA;     "ID" : 11&#xA;    },&#xA;    {&#xA;     "Date" : "2015-12-01",&#xA;     "Days" : 0.5,&#xA;     "ID" : 11&#xA;    }&#xA;    ]&#xA;}&#xA;&#xA;PUT employee/emp_map/2&#xA;{&#xA;  "name" : "ronaldo",&#xA;  "DaysOff" : [&#xA;    {&#xA;     "Date" : "2015-10-01",&#xA;     "Days" : 3,&#xA;     "ID" : 12&#xA;    },&#xA;    {&#xA;     "Date" : "2014-11-01",&#xA;     "Days" : 2,&#xA;     "ID" : 12&#xA;    },&#xA;    {&#xA;     "Date" : "2015-12-01",&#xA;     "Days" : 0.5,&#xA;     "ID" : 12&#xA;    }&#xA;    ]&#xA;}&#xA;&#xA;PUT employee/emp_map/3&#xA;{&#xA;  "name" : "suarez",&#xA;  "DaysOff" : [&#xA;    {&#xA;     "Date" : "2015-11-01",&#xA;     "Days" : 4,&#xA;     "ID" : 13&#xA;    },&#xA;    {&#xA;     "Date" : "2015-11-09",&#xA;     "Days" : 2,&#xA;     "ID" : 13&#xA;    },&#xA;    {&#xA;     "Date" : "2015-12-01",&#xA;     "Days" : 1.5,&#xA;     "ID" : 13&#xA;    }&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>This is my query, notice the <code>filter aggregation</code> in <code>nested aggregation</code>, without that ES will give you sum of all the days taken off.</p>&#xA;&#xA;<pre><code>GET employee/_search&#xA;{&#xA;  "query": {&#xA;    "bool": {&#xA;      "filter": {&#xA;        "nested": {&#xA;          "path": "DaysOff",&#xA;          "query": {&#xA;            "range": {&#xA;              "DaysOff.Date": {&#xA;                "from": "now-2M",&#xA;                "to": "now"&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "emp_name": {&#xA;      "terms": {&#xA;        "field": "name",&#xA;        "size": 10&#xA;      },&#xA;      "aggs": {&#xA;        "nesting": {&#xA;          "nested": {&#xA;            "path": "DaysOff"&#xA;          },&#xA;          "aggs": {&#xA;            "filter_date": {&#xA;              "filter": {&#xA;                "range": {&#xA;                  "DaysOff.Date": {&#xA;                    "from": "now-2M",&#xA;                    "to": "now"&#xA;                  }&#xA;                }&#xA;              },&#xA;              "aggs": {&#xA;                "sum_taken_off_days": {&#xA;                  "sum": {&#xA;                    "field": "DaysOff.Days"&#xA;                  }&#xA;                }&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "size": 0&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>This is the result I get,</p>&#xA;&#xA;<pre><code>"aggregations": {&#xA;    "emp_name": {&#xA;      "doc_count_error_upper_bound": 0,&#xA;      "sum_other_doc_count": 0,&#xA;      "buckets": [&#xA;        {&#xA;          "key": "messi",&#xA;          "doc_count": 1,&#xA;          "nesting": {&#xA;            "doc_count": 3,&#xA;            "filter_date": {&#xA;              "doc_count": 2,&#xA;              "sum_taken_off_days": {&#xA;                "value": 1.5&#xA;              }&#xA;            }&#xA;          }&#xA;        },&#xA;        {&#xA;          "key": "ronaldo",&#xA;          "doc_count": 1,&#xA;          "nesting": {&#xA;            "doc_count": 3,&#xA;            "filter_date": {&#xA;              "doc_count": 1,&#xA;              "sum_taken_off_days": {&#xA;                "value": 0.5&#xA;              }&#xA;            }&#xA;          }&#xA;        },&#xA;        {&#xA;          "key": "suarez",&#xA;          "doc_count": 1,&#xA;          "nesting": {&#xA;            "doc_count": 3,&#xA;            "filter_date": {&#xA;              "doc_count": 3,&#xA;              "sum_taken_off_days": {&#xA;                "value": 7.5&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;</code></pre>&#xA;&#xA;<p>P.S : This is per employee, you can remove <code>emp_name terms aggregation</code> to get sum of all employees.</p>&#xA;