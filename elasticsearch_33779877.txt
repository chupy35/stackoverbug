33779877
Elastic Search design for nested of nested data
<p>I am intending to use Elastic Search as primary datastore and my documents are like this nested of nested data. Events has 3 levels of nested data.</p>&#xA;&#xA;<pre><code>{&#xA;"Date": "2015-10-21",&#xA;"Hour": "7",&#xA;"Minute": "15-29",&#xA;"Domain": "abc.com",&#xA;"Processed_at": "10/23/2015 9:47 UTC"&#xA;"Events": [&#xA;  {&#xA;    "Name": "visit",&#xA;    "Count": "188",&#xA;    "Attributes_Aggregations": [&#xA;      {&#xA;        "Name": "price",&#xA;        "Value_Aggregations": [&#xA;          {&#xA;            "Value": "$125",&#xA;            "Count": "188",&#xA;            "Unique_Users": [&#xA;              {&#xA;                "ID": "CL_2135514566_1427476812_392007750_2004930118",&#xA;                "Count": "38"&#xA;              },&#xA;              {&#xA;                "ID": "CL_2135514566_1427476812_392007750_2004930119",&#xA;                "Count": "32"&#xA;              },&#xA;              ....&#xA;            ]&#xA;          },&#xA;          ....&#xA;        ]&#xA;      },&#xA;      {&#xA;        "Name": "color",&#xA;        "Value_Aggregations": [&#xA;          {&#xA;            "Value": "red",&#xA;            "Count": "188",&#xA;            "Unique_Users": [&#xA;              {&#xA;                "ID": "CL_2135514566_1427476812_392007750_2004930118",&#xA;                "Count": "38"&#xA;              }&#xA;            ]&#xA;          }&#xA;        ]&#xA;      },&#xA;      ...&#xA;    ]&#xA;  },&#xA;  {&#xA;    "Name": "order_created",&#xA;    "Count": "159",&#xA;    "Attributes_Aggregations": [&#xA;      {&#xA;        "Name": "price",&#xA;        "Value_Aggregations": [&#xA;          {&#xA;            "Value": "$125",&#xA;            "Count": "159",&#xA;            "Unique_Users": [&#xA;              {&#xA;                "ID": "CL_2135514566_1427476812_392007750_2004930122",&#xA;                "Count": "32"&#xA;              },&#xA;              ....&#xA;            ]&#xA;          }&#xA;        ]&#xA;      },&#xA;    ]&#xA;  },&#xA; ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>If i consider to use parent/child relationship structure but as per the <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/parent-child-performance.html" rel="nofollow">Elastic document</a> this level of parent/child query will become slow.</p>&#xA;&#xA;<p>Is there any other idea to design the document to best fit in Elastic Search?</p>&#xA;&#xA;<p>My desired queries will be using all the keys of the document to filter. range and count also to be used.</p>&#xA;
<p>Elastic Search is a great tool, however there is a major downfall in nested data, the problem is that ES flatten the array of objects, so if you query the nested info it returns them all.</p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html</a></p>&#xA;&#xA;<p>for example if you query for <code>Unique_Users.Count=38</code> it will return you </p>&#xA;&#xA;<pre><code>          {&#xA;            "ID": "CL_2135514566_1427476812_392007750_2004930118",&#xA;            "Count": "38"&#xA;          },&#xA;          {&#xA;            "ID": "CL_2135514566_1427476812_392007750_2004930119",&#xA;            "Count": "32"&#xA;          }&#xA;</code></pre>&#xA;&#xA;<p>because this particular array (<code>Unique_Users</code>) has a field <code>Count</code> that matches <code>38</code></p>&#xA;
<p>You can use nested queries if you define the structure at mapping as <code>nested</code>, as explained <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html" rel="nofollow">here</a> and <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/nested-mapping.html" rel="nofollow">here</a>. I'm not sure why nafas didn't mention this. Queries will be quite nasty to write though.</p>&#xA;