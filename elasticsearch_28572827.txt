28572827
Do document field expression functions work in expression scripts?
<p>In elasticsearch (version 1.4.3), when using script_score via lucene expression lang, I always get a <code>QueryParsingException</code> when trying any of the expression field functions, such as: </p>&#xA;&#xA;<ul>&#xA;<li><code>doc['field_name'].distance(lat, lon),</code> </li>&#xA;<li><code>doc['field_name'].distanceWithDefault(lat, lon, default)</code>, and</li>&#xA;<li><code>doc['field_name'].geohashDistanceInKm(geohash)</code>.</li>&#xA;</ul>&#xA;&#xA;<p>see the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/modules-scripting.html#_document_fields" rel="nofollow">list of Expressions</a> that the docs say are supported.</p>&#xA;&#xA;<p>Notably, the value expressions are accepted (though I have not tested if their values are correct).  So scripts that make mention of <code>doc['field_name'].value</code> are accepted -- at least by the parser.</p>&#xA;&#xA;<p>Given the security vulnerability of Groovy, a lot of hosted elasticsearch providers (such as bonsai) have turned off support for the Groovy language feature.  My thinking is that none of the functions have been bound for the expression lang.</p>&#xA;&#xA;<p>Example:</p>&#xA;&#xA;<pre><code>"script_score" : {&#xA;    "lang" : "expression",&#xA;    "script": "exp(pow(doc['location'].geohashDistanceInKm(geohash), 2) / (pow(scale, 2) / ln(decay)))",&#xA;    "params": {&#xA;      "geohash" : "9q8yy",&#xA;      "scale" : "0.3",&#xA;      "decay" : "0.1"&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Gives me an unhappy: </p>&#xA;&#xA;<p><code>IllegalArgumentException[Unrecognized method call (doc['location'].geohashDistanceInKm).]</code></p>&#xA;&#xA;<p>Yes, <code>location</code> is a geo_point type:</p>&#xA;&#xA;<pre><code>"location": {&#xA;  "type": "geo_point"&#xA;},&#xA;</code></pre>&#xA;&#xA;<p>Would appreciate confirmation of this.  For now I'll code a client-side workaround.  </p>&#xA;