32931757
How to update multiple documents that match a query in elasticsearch
<p>I have documents which contains only "url"(analyzed) and "respsize"(not_analyzed) fields at first. I want to update documents that match the url and add new field "category"&#xA;I mean;&#xA;at first doc1:</p>&#xA;&#xA;<pre><code>{&#xA; "url":"http://stackoverflow.com/users/4005632/mehmet-yener-yilmaz",&#xA; "respsize":"500"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I have an external data and I know "stackoverflow.com" belongs to category 10,&#xA;And I need to update the doc, and make it like:</p>&#xA;&#xA;<pre><code>{&#xA; "url":"http://stackoverflow.com/users/4005632/mehmet-yener-yilmaz",&#xA; "respsize":"500",&#xA; "category":"10"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Of course I will do this all documents which url fields has "stackoverflow.com"&#xA;and I need the update each doc oly once.. Because category data of url is not changeable, no need to update again.&#xA;I need to use _update api with _version number to check it but cant compose the dsl query.&#xA;<strong>EDIT</strong>&#xA;I run this and looks works fine:&#xA;<a href="https://i.stack.imgur.com/R53Q7.png"><img src="https://i.stack.imgur.com/R53Q7.png" alt="enter image description here"></a>&#xA;But documents not changed..&#xA;<a href="https://i.stack.imgur.com/AFjSc.png"><img src="https://i.stack.imgur.com/AFjSc.png" alt="enter image description here"></a></p>&#xA;&#xA;<p>Although query result looks true, new field not added to docs, need refresh or etc?</p>&#xA;
<p>You could use the <a href="https://github.com/yakaz/elasticsearch-action-updatebyquery" rel="noreferrer">update by query plugin</a> in order to do just that. The idea is to select all document without a <code>category</code> and whose <code>url</code> matches a certain string and add the category you wish.</p>&#xA;&#xA;<pre><code>curl -XPOST 'localhost:9200/webproxylog/_update_by_query' -d '&#xA;{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "term": {&#xA;                "url": "stackoverflow.com"&#xA;              }&#xA;            },&#xA;            {&#xA;              "missing": {&#xA;                "field": "category"&#xA;              }&#xA;            }&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "script" : "ctx._source.category = \"10\";"&#xA;}'&#xA;</code></pre>&#xA;&#xA;<p>After running this, all your documents with <code>url: stackoverflow.com</code> that don't have a category, will get <code>category: 10</code>. You can run the same query again later to fix new <code>stackoverflow.com</code> documents that have been indexed in the meantime.</p>&#xA;&#xA;<p>Also make sure to enable scripting in <code>elasticsearch.yml</code> and restart ES: </p>&#xA;&#xA;<pre><code>script.inline: on &#xA;script.indexed: on&#xA;</code></pre>&#xA;&#xA;<p>In the script, you're free to add as many fields as you want, e.g.</p>&#xA;&#xA;<pre><code>  ...&#xA;  "script" : "ctx._source.category1 = \"10\"; ctx._source.category2 = \"20\";"&#xA;</code></pre>&#xA;&#xA;<p><strong>UPDATE</strong></p>&#xA;&#xA;<p>ES 2.3 now features the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update-by-query.html" rel="noreferrer">update by query</a> functionality. You can still use the above query exactly as is and it will work (except that <code>filtered</code> and <code>missing</code> are deprecated, but still working ;).</p>&#xA;
<p>That all sounds great but just to add to @Val answer, Update By Query is available form ElasticSearch 2.x but not for earlier versions. In our case we're using 1.4 for legacy reasons and there is no chance of upgrading in forseeable future so another solution is using the Update by query plugin provided here: <a href="https://github.com/yakaz/elasticsearch-action-updatebyquery" rel="nofollow">https://github.com/yakaz/elasticsearch-action-updatebyquery</a></p>&#xA;