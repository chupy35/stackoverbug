29025913
Elasticsearch: how to do filtered search and aggregation at the same time
<p>I need to do a filtered search plus aggregation the following way, conceptually.</p>&#xA;&#xA;<pre><code>{&#xA;    "filtered" : {&#xA;        "query": { &#xA;                "match_all" : {&#xA;                }&#xA;        },&#xA;        "aggregations": {&#xA;            "facets": {&#xA;                "terms": {&#xA;                    "field": "subject"&#xA;                }&#xA;            }&#xA;        },&#xA;        "filter" : {&#xA;            ...&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The above query is not working because I got the following error message:</p>&#xA;&#xA;<pre><code>[filtered] query does not support [aggregations]]&#xA;</code></pre>&#xA;&#xA;<p>I was trying to solve this problem. I found Filter Aggregation or Filters Aggregation online, but they do not seem to address my need.</p>&#xA;&#xA;<p>Could someone show me the structure of the correct query that can achieve my goal?</p>&#xA;&#xA;<p>Thanks and regards.</p>&#xA;
<p>The scope of aggregation is the query and all the filters in it. Which means if you give the aggregation along with the query in normal fashion , it should work.</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "match_all": {}&#xA;      },&#xA;      "filter": {}&#xA;    }&#xA;  },&#xA;  "aggregations": {&#xA;    "facets": {&#xA;      "terms": {&#xA;        "field": "subject"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;