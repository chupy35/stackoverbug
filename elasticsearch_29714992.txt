29714992
Elasticsearch: sort by field with null values last
<p>I want sort by <code>name</code>, but keep entries with null or missing <code>price</code> data at the end of the results.</p>&#xA;&#xA;<p>I have tried:</p>&#xA;&#xA;<pre><code>sort: {&#xA;    sorting.name: {&#xA;        order: "asc"&#xA;    },&#xA;    prices.minprice.price: {&#xA;        missing: "_last"&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>but this only sorts by name.</p>&#xA;
<p>To do this we can use a custom function score (<a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.5/search-request-sort.html#_script_based_sorting" rel="nofollow">which is faster than custom script based sorting according to elasticsearch documentation</a>). When price is missing, the numeric value will return 0.</p>&#xA;&#xA;<p>We then sort on score first to split into a section with missing price data, and a section without missing price data, and then sort each of these two sections based on name. </p>&#xA;&#xA;<pre><code>{&#xA;    "query": {&#xA;        "function_score": {&#xA;            "boost_mode": "replace",&#xA;            "query": {"match_all": {}},&#xA;            "script_score": {&#xA;                "script": "doc['price'].value == 0 ? 0 : 1"&#xA;            }   &#xA;        }&#xA;    },&#xA;    "sort": [&#xA;       "_score",&#xA;       "name"&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;
<p>This has worked for me,</p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-sort.html#_script_based_sorting" rel="nofollow noreferrer">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-sort.html#_script_based_sorting</a></p>&#xA;&#xA;<pre><code>"sort":[&#xA;      {&#xA;         "_script":{&#xA;            "type":"number",&#xA;            "script":{&#xA;               "lang":"painless",&#xA;               "source":"return params._source.store[0].sku_available_unit == 0 ? 0 : 1;"&#xA;            },&#xA;            "order":"desc"&#xA;         }&#xA;      }&#xA;    ]&#xA;</code></pre>&#xA;