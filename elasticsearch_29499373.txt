29499373
Elasticsearch - Find records that have at least x elements in common with a given array
<p>I have a mapping like this:</p>&#xA;&#xA;<pre><code>"properties": {&#xA;    "id": {"type": "long", "index": "not_analyzed"},&#xA;    "name": {"type": "string", "index": "not_analyzed"},&#xA;    "skills": {"type": "string", "index": "not_analyzed"}&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I wanna store students' profiles in elasticsearch using the given mapping. <code>skills</code> is a list of computer skills they specified on their profiles (python, javascript, ...).</p>&#xA;&#xA;<p>Given a skill set like <code>['html', 'css', 'sass', 'javascript', 'django', 'bootstrap', 'angularjs', 'backbone']</code>, I wanna find all profiles that have at least 3 of the skills in this skill set. I am not interested in knowing which skills they have in common with our desired list, just interested in the count. Is there a way to do this in elasticsearch?</p>&#xA;
<p>There might be a better way I'm not thinking of, but you can do it with a <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-script-filter.html" rel="nofollow">script filter</a>.</p>&#xA;&#xA;<p>I set up a simplified version of your index, with a few docs:</p>&#xA;&#xA;<pre><code>PUT /test_index&#xA;{&#xA;   "settings": {&#xA;      "number_of_shards": 1&#xA;   },&#xA;   "mappings": {&#xA;      "doc": {&#xA;         "properties": {&#xA;            "skills": {&#xA;               "type": "string",&#xA;               "index": "not_analyzed"&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;&#xA;POST /test_index/doc/_bulk&#xA;{"index":{"_id":1}}&#xA;{"skills":["html","css","javascript"]}&#xA;{"index":{"_id":2}}&#xA;{"skills":["bootstrap", "angularjs", "backbone"]}&#xA;{"index":{"_id":3}}&#xA;{"skills":["python", "javascript", "ruby","java"]}&#xA;</code></pre>&#xA;&#xA;<p>Then ran this query:</p>&#xA;&#xA;<pre><code>POST /test_index/_search&#xA;{&#xA;   "query": {&#xA;      "filtered": {&#xA;         "query": {&#xA;            "match_all": {}&#xA;         },&#xA;         "filter": {&#xA;            "script": {&#xA;               "script": "count=0; for(s: doc['skills'].values){ for(x: skills){ if(s == x){ count +=1 } } } count &gt;= 3",&#xA;               "params": {&#xA;                  "skills": ["html", "css", "sass", "javascript", "django", "bootstrap", "angularjs", "backbone"]&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>and got back what I expected:</p>&#xA;&#xA;<pre><code>{&#xA;   "took": 1,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 2,&#xA;      "max_score": 1,&#xA;      "hits": [&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "doc",&#xA;            "_id": "1",&#xA;            "_score": 1,&#xA;            "_source": {&#xA;               "skills": [&#xA;                  "html",&#xA;                  "css",&#xA;                  "javascript"&#xA;               ]&#xA;            }&#xA;         },&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "doc",&#xA;            "_id": "2",&#xA;            "_score": 1,&#xA;            "_source": {&#xA;               "skills": [&#xA;                  "bootstrap",&#xA;                  "angularjs",&#xA;                  "backbone"&#xA;               ]&#xA;            }&#xA;         }&#xA;      ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here's the code all together:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/1018a01f1df29cb793ea15661f22bc8b25ed3476" rel="nofollow">http://sense.qbox.io/gist/1018a01f1df29cb793ea15661f22bc8b25ed3476</a></p>&#xA;
<p>One could use the <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html" rel="nofollow">query string</a> with minimum_should_match option</p>&#xA;&#xA;<p>Example:</p>&#xA;&#xA;<pre><code>POST &lt;index&gt;/_search &#xA;{&#xA;        "query": {&#xA;            "filtered": {&#xA;               "filter": {&#xA;                   "query": { &#xA;                        "query_string": {&#xA;                            "default_field": "skills",&#xA;                            "query": "html css sass javascript django bootstrap angularjs backbone \"ruby on rails\" ",&#xA;                            "minimum_should_match" : "3"&#xA;                        }&#xA;                   }&#xA;               }&#xA;            }&#xA;        }  &#xA;}&#xA;</code></pre>&#xA;