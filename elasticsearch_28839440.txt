28839440
ElasticSearch - How to Retrieve Count of Filtered Records > 7 days Ago
<p>I have events/records stored in ElasticSearch.  They correspond to IIS logs.  One of the fields is "logtime" which is a string field with format YYYY-MM-dd HH:mm:ss (for example 2015-02-24 02:46:23).  Another field is "response" which is an integer field with format XXX (for example 404).  From the ElasticSearch documentation, I have been trying to construct a query through the HTTP API (mostly using Fiddler) to retrieve a count of all events such that the response code is greater than or equal to 300 for the past 7 days.  Here is a sample query:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": { "match_all": {} },&#xA;      "filter": {&#xA;        "range": {&#xA;          "response": {&#xA;            "gte": 300&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I try to slap in something like</p>&#xA;&#xA;<pre><code>"last_7_days": {&#xA;  "filter": {&#xA;    "range": {&#xA;      "logtime": {&#xA;        "gte": "now-7d",&#xA;        "lte": "now"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>but it errors out with no message.  Any help would be appreciated.  Also, I'm not interested in the records themselves, just the counts.  Thanks.</p>&#xA;
<p>you've named your filter "last_7_days", filters do not have names, only aggregations have names.  Here is the query to combine your two filters and only return the count:</p>&#xA;&#xA;<pre><code>GET index1/type1/_count&#xA;{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "and": {&#xA;          "filters": [&#xA;            {&#xA;              "range": {&#xA;                "logtime": {&#xA;                  "gte": "now-7d",&#xA;                  "lte": "now"&#xA;                }&#xA;              }&#xA;            },&#xA;            {&#xA;              "range": {&#xA;                "response": {&#xA;                  "gte": 300&#xA;                }&#xA;              }&#xA;            }&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;