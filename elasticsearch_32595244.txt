32595244
Elasticsearch cluster health vs cat allocation IP address
<p>When I do <code>_cluster/health</code> I get following (abbr. for clarity):</p>&#xA;&#xA;<pre><code>"nodes": {&#xA;   "0KSzdqFERwaOyuqZ4oJwMA": {&#xA;      "name": "Index3",&#xA;      "transport_address": "inet[/172.16.120.113:9300]",&#xA;      "attributes": {}&#xA;   },&#xA;   "IkaQ9UOXRpqnvdnkQLXVAA": {&#xA;      "name": "Index4",&#xA;      "transport_address": "inet[/172.16.120.114:9300]",&#xA;      "attributes": {}&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Now when I add third node, <code>_cluster/health</code> look like this:</p>&#xA;&#xA;<pre><code>"nodes": {&#xA;   "0KSzdqFERwaOyuqZ4oJwMA": {&#xA;      "name": "Index3",&#xA;      "transport_address": "inet[/172.16.120.113:9300]",&#xA;      "attributes": {}&#xA;   },&#xA;   "IkaQ9UOXRpqnvdnkQLXVAA": {&#xA;      "name": "Index4",&#xA;      "transport_address": "inet[/172.16.120.114:9300]",&#xA;      "attributes": {}&#xA;   },&#xA;   "U_XMvuwNTDqspzYAJlEm4w": {&#xA;      "name": "Index5",&#xA;      "transport_address": "inet[/172.16.120.115:9300]",&#xA;      "attributes": {}&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>But when I do <code>_cat/allocation</code> I see following:</p>&#xA;&#xA;<pre><code>27 42.3gb 17.6gb 59.9gb 70 INDEX3 172.16.120.113 Index3 &#xA;27 39.3gb 20.6gb 59.9gb 65 INDEX4 172.16.120.114 Index4&#xA;27 39.5gb 20.4gb 59.9gb 67 INDEX5 169.254.20.178 Index5&#xA;</code></pre>&#xA;&#xA;<p>And under <code>_cat/shards</code> Index3 is trying to move some shards to Index5 node on that <code>169.254.20.178</code> address and is stuck there. <code>_cluster/health</code> shows that cluster is green, but shard reallocation never completes.</p>&#xA;&#xA;<p>I tried setting network.host but issue persists:</p>&#xA;&#xA;<pre><code>network.host: 172.16.120.115&#xA;</code></pre>&#xA;&#xA;<p>Can someone explain where/why/how this is happening? How/why is <code>_cat\allocation</code> picking up <code>169.254.20.178</code>?</p>&#xA;&#xA;<p>Setup is running on Windows Server 2008R2 with elasticsearch 1.1.1.</p>&#xA;&#xA;<p><strong>UPDATE 1</strong></p>&#xA;&#xA;<p>Here is <code>ipconfig /all</code>:</p>&#xA;&#xA;<pre><code>Windows IP Configuration&#xA;&#xA;   Host Name . . . . . . . . . . . . : SOMEHOSTNAME&#xA;   Primary Dns Suffix  . . . . . . . : dfw.intensive.int&#xA;   Node Type . . . . . . . . . . . . : Hybrid&#xA;   IP Routing Enabled. . . . . . . . : No&#xA;   WINS Proxy Enabled. . . . . . . . : No&#xA;   DNS Suffix Search List. . . . . . : dfw.intensive.int&#xA;                                       intensive.int&#xA;                                       sat.intensive.int&#xA;                                       iad.intensive.int&#xA;                                       ord.intensive.int&#xA;                                       lon.intensive.int&#xA;                                       hkg.intensive.int&#xA;                                       syd.intensive.int&#xA;&#xA;Ethernet adapter Local Area Connection* 9:&#xA;&#xA;   Connection-specific DNS Suffix  . :&#xA;   Description . . . . . . . . . . . : Microsoft Failover Cluster Virtual Adapter&#xA;   Physical Address. . . . . . . . . : 7A-2B-CB-33-9B-BB&#xA;   DHCP Enabled. . . . . . . . . . . : No&#xA;   Autoconfiguration Enabled . . . . : Yes&#xA;   Link-local IPv6 Address . . . . . : fe80::782b:cbff:fe33:9bbb%16(Preferred)&#xA;   IPv4 Address. . . . . . . . . . . : 169.254.20.178(Preferred)&#xA;   Subnet Mask . . . . . . . . . . . : 255.255.0.0&#xA;   Default Gateway . . . . . . . . . :&#xA;   DHCPv6 IAID . . . . . . . . . . . : 460991435&#xA;   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-19-95-67-50-78-2B-CB-33-9B-BF&#xA;   DNS Servers . . . . . . . . . . . : fec0:0:0:ffff::1%1&#xA;                                       fec0:0:0:ffff::2%1&#xA;                                       fec0:0:0:ffff::3%1&#xA;   NetBIOS over Tcpip. . . . . . . . : Enabled&#xA;&#xA;Ethernet adapter PublicNetTeam:&#xA;&#xA;   Connection-specific DNS Suffix  . :&#xA;   Description . . . . . . . . . . . : BASP Virtual Adapter&#xA;   Physical Address. . . . . . . . . : 78-2B-CB-33-9B-BB&#xA;   DHCP Enabled. . . . . . . . . . . : No&#xA;   Autoconfiguration Enabled . . . . : Yes&#xA;   IPv4 Address. . . . . . . . . . . : 172.16.120.219(Preferred)&#xA;   Subnet Mask . . . . . . . . . . . : 255.255.255.0&#xA;   Default Gateway . . . . . . . . . : 172.16.120.1&#xA;   DNS Servers . . . . . . . . . . . : &gt;&gt;MASKED&lt;&lt;&#xA;                                       &gt;&gt;MASKED&lt;&lt;&#xA;   NetBIOS over Tcpip. . . . . . . . : Enabled&#xA;&#xA;Ethernet adapter BackupNet:&#xA;&#xA;   Connection-specific DNS Suffix  . :&#xA;   Description . . . . . . . . . . . : Broadcom BCM5709C NetXtreme II GigE (NDIS VBD Client) #33&#xA;   Physical Address. . . . . . . . . : 78-2B-CB-33-9B-BF&#xA;   DHCP Enabled. . . . . . . . . . . : No&#xA;   Autoconfiguration Enabled . . . . : Yes&#xA;   IPv4 Address. . . . . . . . . . . : 10.241.216.69(Preferred)&#xA;   Subnet Mask . . . . . . . . . . . : 255.255.255.224&#xA;   Default Gateway . . . . . . . . . :&#xA;   NetBIOS over Tcpip. . . . . . . . : Disabled&#xA;&#xA;Ethernet adapter Heartbeat2:&#xA;&#xA;   Connection-specific DNS Suffix  . :&#xA;   Description . . . . . . . . . . . : Broadcom BCM5709C NetXtreme II GigE (NDIS VBD Client) #34&#xA;   Physical Address. . . . . . . . . : 78-2B-CB-33-9B-C1&#xA;   DHCP Enabled. . . . . . . . . . . : No&#xA;   Autoconfiguration Enabled . . . . : Yes&#xA;   IPv4 Address. . . . . . . . . . . : 10.10.10.4(Preferred)&#xA;   Subnet Mask . . . . . . . . . . . : 255.255.255.0&#xA;   Default Gateway . . . . . . . . . :&#xA;   NetBIOS over Tcpip. . . . . . . . : Disabled&#xA;</code></pre>&#xA;&#xA;<p>And information from elasticsearch.log when node starts up. As you can see it is binding on <code>172.16.120.115</code>.</p>&#xA;&#xA;<pre><code>[2015-09-15 15:12:58,510][INFO ][node                     ] [Index5] version[1.1.1], pid[2436], build[f1585f0/2014-04-16T14:27:12Z]&#xA;[2015-09-15 15:12:58,510][INFO ][node                     ] [Index5] initializing ...&#xA;[2015-09-15 15:12:58,526][INFO ][plugins                  ] [Index5] loaded [], sites []&#xA;[2015-09-15 15:13:02,395][INFO ][node                     ] [Index5] initialized&#xA;[2015-09-15 15:13:02,395][INFO ][node                     ] [Index5] starting ...&#xA;[2015-09-15 15:13:03,362][INFO ][transport                ] [Index5] bound_address {inet[/172.16.120.115:9300]}, publish_address {inet[/172.16.120.115:9300]}&#xA;[2015-09-15 15:13:07,060][INFO ][cluster.service          ] [Index5] detected_master [Index4][IkaQ9UOXRpqnvdnkQLXVAA][647264-INDEX4][inet[/172.16.120.114:9300]], added {[Index3][0KSzdqFERwaOyuqZ4oJwMA][INDEX3][inet[/172.16.120.113:9300]],[Index4][IkaQ9UOXRpqnvdnkQLXVAA][INDEX4][inet[/172.16.120.114:9300]],}, reason: zen-disco-receive(from master [[Index4][IkaQ9UOXRpqnvdnkQLXVAA][INDEX4][inet[/172.16.120.114:9300]]])&#xA;[2015-09-15 15:13:07,278][INFO ][discovery                ] [Index5] elasticsearch/U_XMvuwNTDqspzYAJlEm4w&#xA;[2015-09-15 15:13:08,152][INFO ][http                     ] [Index5] bound_address {inet[/172.16.120.115:9200]}, publish_address {inet[/172.16.120.115:9200]}&#xA;[2015-09-15 15:13:08,152][INFO ][node                     ] [Index5] started&#xA;</code></pre>&#xA;&#xA;<p>What is boggling is that I can issue requests on <code>http://172.16.120.115:9200</code> and I get responses back, but the module that does shard reallocation seems to be getting <code>local link</code> IP.</p>&#xA;&#xA;<pre><code>curl http://172.16.120.115:9200/_cluster/health?pretty&#xA;{&#xA;   "cluster_name": "elasticsearch",&#xA;   "status": "green",&#xA;   "timed_out": false,&#xA;   "number_of_nodes": 3,&#xA;   "number_of_data_nodes": 3,&#xA;   "active_primary_shards": 27,&#xA;   "active_shards": 54,&#xA;   "relocating_shards": 2,&#xA;   "initializing_shards": 0,&#xA;   "unassigned_shards": 0&#xA;}&#xA;&#xA;curl http://172.16.120.115:9200/_cat/shards&#xA;logindex_r210        1 r RELOCATING  240670 104.2mb 172.16.120.114 Index4 -&gt; 169.254.20.178 Index5 &#xA;logindex_r210        1 p STARTED     240670 104.2mb 172.16.120.113 Index3                      &#xA;logindex_r210        2 p STARTED     240747 106.4mb 172.16.120.114 Index4                      &#xA;logindex_r210        2 r STARTED     240747 106.4mb 172.16.120.113 Index3                      &#xA;companyindex_r210    4 p STARTED     394869  52.6mb 172.16.120.114 Index4                      &#xA;companyindex_r210    4 r STARTED     394869  52.6mb 172.16.120.113 Index3                      &#xA;companyindex_r210    0 p STARTED     395000  62.6mb 172.16.120.114 Index4                      &#xA;companyindex_r210    0 r RELOCATING  395000  52.7mb 172.16.120.113 Index3 -&gt; 169.254.20.178 Index5 &#xA;</code></pre>&#xA;
<p>IP addresses in the 169.254.0.0 range are the standard "link local" block. As described in <a href="http://tools.ietf.org/html/rfc5735" rel="nofollow">RFC3927</a>, it is allocated for communication between hosts on a single link. Hosts obtain these addresses by auto-configuration, such as when a DHCP server cannot be found.</p>&#xA;&#xA;<p>So it looks like your node has 1) no static IP address configured and 2) couldn't get one from a DHCP server, so it makes up an IP address of its own in the 169.254 range so it can communicate on the network.</p>&#xA;&#xA;<p>You might want to fix this in order for your shard allocation to proceed. The fact that your node couldn't get an IP address is most probably the reason why the relocation is stuck.</p>&#xA;