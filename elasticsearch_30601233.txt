30601233
Which DSL is correct for performing a pre-filtered query?
<p>I've looked back at some queries I have saved, and it appears I've managed to achieve essentially the same query in three different ways. They all return the same data, but which one is 'correct'? I.e., which one contains no superfluous code and is most performant?</p>&#xA;&#xA;<p>Option 1</p>&#xA;&#xA;<pre><code>{&#xA;"query":{&#xA;   "bool":{&#xA;      "must":[&#xA;         {&#xA;            "match":{&#xA;               "event":"eventname"&#xA;            }&#xA;         },&#xA;         {&#xA;            "range":{&#xA;               "@timestamp":{&#xA;                  "gt":"now-70s"&#xA;               }&#xA;            }&#xA;         }&#xA;      ]&#xA;   }&#xA;},&#xA; "aggs":{&#xA;    "myterms":{&#xA;       "terms":{&#xA;          "field":"fieldname"&#xA;       }&#xA;    }&#xA; }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Option 2</p>&#xA;&#xA;<pre><code>{&#xA;   "query":{&#xA;      "filtered":{&#xA;         "filter":{&#xA;            "bool":{&#xA;               "must":[&#xA;                  {&#xA;                     "match":{&#xA;                        "event":"eventname"&#xA;                     }&#xA;                  },&#xA;                  {&#xA;                     "range":{&#xA;                        "@timestamp":{&#xA;                           "gt":"now-70s"&#xA;                        }&#xA;                     }&#xA;                  }&#xA;               ]&#xA;            }&#xA;         }&#xA;      }&#xA;   },&#xA;   "aggs":{&#xA;      "myterms":{&#xA;         "terms":{&#xA;            "field":"fieldname"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Option 3</p>&#xA;&#xA;<pre><code>{&#xA;   "query":{&#xA;      "filtered":{&#xA;         "query":{&#xA;            "bool":{&#xA;               "must":[&#xA;                  {&#xA;                     "match":{&#xA;                        "event":"eventname"&#xA;                     }&#xA;                  },&#xA;                  {&#xA;                     "range":{&#xA;                        "@timestamp":{&#xA;                           "gt":"now-70s"&#xA;                        }&#xA;                     }&#xA;                  }&#xA;               ]&#xA;            }&#xA;         }&#xA;      }&#xA;   },&#xA;   "aggs":{&#xA;      "myterms":{&#xA;         "terms":{&#xA;            "field":"fieldname"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>If I were to guess, I'd go for Option 2, as the others appear that they might be running match as query. But the documentation is pretty confusing regarding the correct form that DSL queries should take.</p>&#xA;
<p>Based on your comment, I'd go for option 2 but with a simple <code>term</code> filter for starters instead of <code>match</code> which isn't allowed in filters.</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "term": {&#xA;                "event": "eventname"&#xA;              }&#xA;            },&#xA;            {&#xA;              "range": {&#xA;                "@timestamp": {&#xA;                  "gt": "now-70s"&#xA;                }&#xA;              }&#xA;            }&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "myterms": {&#xA;      "terms": {&#xA;        "field": "event"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;