29251994
Inner hits not working with nested filter?
<p>I've just upgraded to Elastic Search 1.5.0 and so far I can't make <a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.x/search-request-inner-hits.html" rel="nofollow noreferrer">inner_hits</a> work with a nested filter, although it works fine with a nested query.</p>&#xA;&#xA;<p>Let's say I want to retrieve the inner nested object <strong>actors</strong> within a <strong>movie</strong> object.</p>&#xA;&#xA;<p>When I run the following <strong>nested query</strong> :</p>&#xA;&#xA;<p><strong>Syntax 1</strong></p>&#xA;&#xA;<pre><code>GET my_index/movie/_search&#xA;{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {"match_all": {}},&#xA;      "filter": {&#xA;        "nested": {&#xA;          "path": "actors",&#xA;          "query": {&#xA;            "match": {&#xA;              "actors.id": 12345&#xA;            }&#xA;          }, &#xA;          "inner_hits" : {}&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>=> I get the inner_hits as documented <a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.x/search-request-inner-hits.html" rel="nofollow noreferrer">here</a>, which is just fine.</p>&#xA;&#xA;<p>But when I try doing the equivalent query with a <strong>nested filter</strong> :</p>&#xA;&#xA;<p><strong>Syntax 2</strong></p>&#xA;&#xA;<pre><code>GET my_index/movie/_search&#xA;{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {"match_all": {}},&#xA;      "filter": {&#xA;        "nested": {&#xA;          "path": "actors",&#xA;          "filter": {&#xA;            "term": {&#xA;              "actors.id": 12345&#xA;            }&#xA;          }, &#xA;          "inner_hits" : {}&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>=> I get the following parse error</p>&#xA;&#xA;<blockquote>&#xA;  <p>QueryParsingException[[my_index] [nested] requires either 'query' or&#xA;  'filter' field]</p>&#xA;</blockquote>&#xA;&#xA;<p>(and this last query works fine when I remove inner_hits - except of course that I don't get the inner hits ...)</p>&#xA;&#xA;<p>Is there something wrong in the syntax I use or is the inner_hits not implemented yet with nested filter ?</p>&#xA;&#xA;<p>Thanks in advance</p>&#xA;&#xA;<p><strong>Edit 3-30-2015</strong></p>&#xA;&#xA;<p>It works with the syntax provided below by <a href="https://stackoverflow.com/users/4101876/mdewit">@mdewit</a> (thanks!)</p>&#xA;&#xA;<p><strong>Syntax 3</strong></p>&#xA;&#xA;<pre><code>GET my_index/movie/_search&#xA;{&#xA;    "query": {&#xA;        "nested": {&#xA;            "path": "actors",&#xA;            "query": {&#xA;                "filtered": {&#xA;                    "filter": {&#xA;                        "term": {"actors.id": 12345}&#xA;                    }&#xA;                }&#xA;            },&#xA;            "inner_hits" : {}&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>even though this syntax does not match the <a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.x/query-dsl-nested-filter.html" rel="nofollow noreferrer">Nested Filter doc</a></p>&#xA;&#xA;<p>=> I still do not understand what is wrong with Syntax 2. It seems like an ES bug to me.</p>&#xA;&#xA;<p><strong>Edit 04-22-2015 : bug fixed</strong> in ES 1.5.1, see my comment below</p>&#xA;
<p>The following seems to work:</p>&#xA;&#xA;<pre><code>GET my_index/movie/_search&#xA;{&#xA;    "query": {&#xA;        "nested": {&#xA;            "path": "actors",&#xA;            "query": {&#xA;                "filtered": {&#xA;                    "filter": {&#xA;                        "term": {"actors.id": 12345}&#xA;                    }&#xA;                }&#xA;            },&#xA;            "inner_hits" : {}&#xA;        }&#xA;    }&#xA;}'&#xA;</code></pre>&#xA;
<p>Bug fixed in ElasticSearch 1.5.1 as stated <a href="https://github.com/elastic/elasticsearch/pull/10309" rel="nofollow">here</a></p>&#xA;&#xA;<p>So this syntax works (and works fine)</p>&#xA;&#xA;<pre><code>GET my_index/movie/_search&#xA;{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {"match_all": {}},&#xA;      "filter": {&#xA;        "nested": {&#xA;          "path": "actors",&#xA;          "filter": {&#xA;            "term": {&#xA;              "actors.id": 12345&#xA;            }&#xA;          }, &#xA;          "inner_hits" : {}&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Thanks guys!</p>&#xA;