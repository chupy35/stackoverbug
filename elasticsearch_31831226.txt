31831226
elastic search shutting down throws TransportNodesShutdownAction$1$2 not found
<p>I'm using elastic search 1.1.0. </p>&#xA;&#xA;<p>While trying to shutdown the elastic search I'm getting NoClassDefFoundError. Code used to shutdown and stack trace is given below.</p>&#xA;&#xA;<p>Maven:</p>&#xA;&#xA;<pre><code> &lt;dependency&gt;&#xA;            &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;&#xA;            &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;&#xA;            &lt;version&gt;1.1.0&lt;/version&gt;&#xA;        &lt;/dependency&gt;&#xA;</code></pre>&#xA;&#xA;<p>Code: <code>node.client().admin().cluster().prepareNodesShutdown().execute().get();</code></p>&#xA;&#xA;<pre><code>2015-08-05 21:45:11,113 [Thread-15] INFO  org.elasticsearch.action.admin.cluster.node.shutdown internalInfo  - [Captain Ultra] [cluster_shutdown]: done shutting down all nodes except master, proceeding to master&#xA;&#xA;INFO: Illegal access: this web application instance has been stopped already.  Could not load org.elasticsearch.action.admin.cluster.node.shutdown.TransportNodesShutdownAction$1$2.  The eventual following stack trace is caused by an error thrown for debugging purposes as well as to attempt to terminate the thread which caused the illegal access, and has no functional impact.&#xA;java.lang.IllegalStateException&#xA;        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1600)&#xA;        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1559)&#xA;        at org.elasticsearch.action.admin.cluster.node.shutdown.TransportNodesShutdownAction$1.run(TransportNodesShutdownAction.java:153)&#xA;        at java.lang.Thread.run(Unknown Source)&#xA;Exception in thread "Thread-15" java.lang.NoClassDefFoundError: org/elasticsearch/action/admin/cluster/node/shutdown/TransportNodesShutdownAction$1$2&#xA;        at org.elasticsearch.action.admin.cluster.node.shutdown.TransportNodesShutdownAction$1.run(TransportNodesShutdownAction.java:153)&#xA;        at java.lang.Thread.run(Unknown Source)&#xA;Caused by: java.lang.ClassNotFoundException: org.elasticsearch.action.admin.cluster.node.shutdown.TransportNodesShutdownAction$1$2&#xA;        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1714)&#xA;        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1559)&#xA;        ... 2 more&#xA;</code></pre>&#xA;&#xA;<p>This issue is not allowing elastic search to shutdown gracefully. Tomcat is waiting for certain period(timeout) and then killing all those threads forcefully. &#xA;How to fix this issue?</p>&#xA;&#xA;<p>Same issue is coming with 1.0.0 also.</p>&#xA;
<p>Finally I got the solution. Elastic search is trying to shutdown in separate thread. By the time elastic search tries to access TransportNodesShutdownAction, tomcat will unload elastic jar from its class loader. So adding some sleep statement or adding elastic and its dependent jar to tomcat/lib will solve the problem.</p>&#xA;