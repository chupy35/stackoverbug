33365095
How to retrieve the latest event with a given field value?
<p>I index events similar to the ones below:</p>&#xA;&#xA;<pre><code>{&#xA;  "time": "2015-10-01",&#xA;  "kind": "A"&#xA;},&#xA;{&#xA;  "time": "2015-10-02",&#xA;  "kind": "B"&#xA;},&#xA;{&#xA;  "time": "2015-10-15",&#xA;  "kind": "A"&#xA;},&#xA;{&#xA;  "time": "2015-10-16",&#xA;  "kind": "B"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>In other words, these are timed events of several kinds (<code>A</code> and <code>B</code> in the example above). It is guaranteed that there cannot be two or more events of the same <code>kind</code> with the same <code>time</code>.</p>&#xA;&#xA;<p><strong>I am looking for a query which would retrieve the latest (<code>time</code> closest to "now") events for each kind.</strong> For the example above these would be the lat two ones.</p>&#xA;&#xA;<p>Up to now, I was forcing the <code>_id</code> to have the value of <code>kind</code>, which automatically kept a set of unique events (the events are indexed with time, so the one with the date of <code>2015-10-16</code> is guaranteed to be indexed after the one from an earlier <code>2015-10-02</code>). This of course does not keep the history of events, something I am now interested in.</p>&#xA;
<p>How about this query:</p>&#xA;&#xA;<pre><code>{&#xA;  "size": 0,&#xA;  "aggs": {&#xA;    "unique_kind": {&#xA;      "terms": {&#xA;        "field": "kind",&#xA;        "size": 10&#xA;      },&#xA;      "aggs": {&#xA;        "max_date": {&#xA;          "max": {&#xA;            "field": "time"&#xA;          }&#xA;        },&#xA;        "1st": {&#xA;          "top_hits": {&#xA;            "size": 1,&#xA;            "sort": [{"time":"desc"}]&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;