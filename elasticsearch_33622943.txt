33622943
How to calculate average X per Y in elastic search?
<p>Let's say I have a list of events, like 'pageview'. I want to calculate average pageviews per session.</p>&#xA;&#xA;<p>My document looks like this</p>&#xA;&#xA;<pre><code>{&#xA;  sessionID: 'xxx',&#xA;  action: 'pageview'&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>So what I'm tried to do is to first aggregate by sessionID and then apply avg. child aggregation, but it's not what I expected.</p>&#xA;&#xA;<p>I'm very new to ElasticSeach. What would be the logic to generate such aggregation in EC?</p>&#xA;&#xA;<p>Thanks</p>&#xA;
<p>You've started correctly by aggregating on the <code>sessionID</code> field. Then you need another <code>filter</code> sub-aggregation on the <code>action</code> field to match only <code>pageview</code>actions. Your aggregation query would look like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "size": 0,&#xA;  "aggs": {&#xA;    "sessions": {&#xA;      "terms": {&#xA;        "field": "sessionID"&#xA;      },&#xA;      "aggs": {&#xA;        "pageviews": {&#xA;          "filter": {&#xA;            "term": {&#xA;              "action": "pageview"&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>This is going to give you the total <code>doc_count</code> for each of your sessions and in each session bucket you'll get the total <code>doc_count</code> for <code>pageview</code> actions within that session.</p>&#xA;&#xA;<p>The average can then easily be calculated with </p>&#xA;&#xA;<pre><code>response.aggregations.sessions.forEach(function(session) {&#xA;    var actionsInSession = session.doc_count;&#xA;    var pageviewActions = session.pageviews.doc_count;&#xA;    var avg = pageviewActions / actionsInSession;&#xA;    // do something with the average value&#xA;});&#xA;</code></pre>&#xA;&#xA;<p><strong>UPDATE</strong></p>&#xA;&#xA;<p>If you're using (or willing to use) ES 2.0, you can get ES to calculate those averages for you using <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-pipeline.html" rel="nofollow">pipeline aggregations</a>.</p>&#xA;&#xA;<pre><code>{&#xA;   "size": 0,&#xA;   "aggs": {&#xA;      "sessions": {&#xA;         "terms": {&#xA;            "field": "sessionID"&#xA;         },&#xA;         "aggs": {&#xA;            "total": {&#xA;               "value_count": {&#xA;                  "field": "sessionID"&#xA;               }&#xA;            },&#xA;            "pageviews": {&#xA;               "filter": {&#xA;                  "term": {&#xA;                     "action": "pageview"&#xA;                  }&#xA;               },&#xA;               "aggs": {&#xA;                  "cnt": {&#xA;                     "value_count": {&#xA;                        "field": "action"&#xA;                     }&#xA;                  }&#xA;               }&#xA;            },&#xA;            "avg": {&#xA;               "bucket_script": {&#xA;                  "buckets_path": {&#xA;                     "total": "total",&#xA;                     "pageviews": "pageviews &gt; cnt"&#xA;                  },&#xA;                  "script": "pageviews / total"&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>In each <code>sessionID</code> bucket, you'll get an <code>avg</code> value for the number of <code>pageview</code> action vs the number of total actions for that session.</p>&#xA;