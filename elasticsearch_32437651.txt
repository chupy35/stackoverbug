32437651
Elasticsearch alter the score for a filtered query
<p>I have a mapping that looks something like:</p>&#xA;&#xA;<pre><code>"foo" : {&#xA;    "name" : {&#xA;        "type" : "string",&#xA;    },&#xA;&#xA;    "points": {&#xA;        "type" : "double"&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>What we are currently doing is to use filtered queries to search on names.&#xA;In addition to this we now want to alter the score for each result depending on what points contain.</p>&#xA;&#xA;<p>So, if points is 3.0, we wish to have _score + 3 and so on.</p>&#xA;&#xA;<p>The query can look something like:</p>&#xA;&#xA;<pre><code>{&#xA;    "from": 0,&#xA;    "size": 50,&#xA;    "query": {&#xA;        "filtered": {&#xA;            "query": {&#xA;                "match_all": {}&#xA;            },&#xA;            "filter": {&#xA;                //filters&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;
<p>You can use the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html" rel="nofollow"><code>function_score</code> query</a> to achieve this. It's pretty easy and goes like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {                                 &#xA;    "function_score": {&#xA;      "filter": {                            &lt;--- your filters go in here&#xA;         //your filters&#xA;      },&#xA;      "boost_mode": "sum",                   &lt;--- the script score will be summed with the query score&#xA;      "script_score": "doc.points.value"     &lt;--- script score returns the value of the points field&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Since you have a single function, it is also possible to use the default <code>boost_mode</code> (i.e. <code>multiply</code>) and have the script score return the summed score directly:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {                                 &#xA;    "function_score": {&#xA;      "filter": {                                     &lt;--- your filters go in here&#xA;         //your filters&#xA;      },&#xA;      "script_score": "_score + doc.points.value"     &lt;--- script score returns the value of the points field&#xA;    }&#xA;  }&#xA;} &#xA;</code></pre>&#xA;