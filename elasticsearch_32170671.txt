32170671
Aggregations for inner hits
<p>I have a parent-children mapping in ElasticSearch:</p>&#xA;&#xA;<p>parent: <em>user</em></p>&#xA;&#xA;<p>children: <em>privileges</em></p>&#xA;&#xA;<p>For <em>privileges</em> there are a few properties, and one is "<em>privilegeName</em>".</p>&#xA;&#xA;<p>The query returns users which have certain privileges, but I would like to return the aggregated <em>privilegeName</em>s for each user for the privileges that match the <code>has_child</code> query.&#xA;I can return all <em>privileges</em> with <code>inner_hits</code> and process them on the client side, but that may be cumbersome.&#xA;Is there a possibility to aggregate the <code>inner_hits</code>?</p>&#xA;&#xA;<p>Thanks</p>&#xA;
<p>I believe what you're looking for is the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-aggregations-bucket-children-aggregation.html" rel="nofollow">Children Aggregation</a>.</p>&#xA;&#xA;<p>For example, let's say I create the following index with the <em>user</em> as the parent, and <em>privilege</em> as the child:</p>&#xA;&#xA;<pre><code>PUT /my_index&#xA;{&#xA;  "mappings": {&#xA;    "user": {&#xA;      "properties": {&#xA;        "name": {&#xA;          "type": "string"&#xA;        },&#xA;        "age": {&#xA;          "type": "integer"&#xA;        }&#xA;      }&#xA;    },&#xA;    "privilege": {&#xA;      "properties": {&#xA;        "privilegeName": {&#xA;          "type": "string"&#xA;        }&#xA;      },&#xA;      "_parent": {&#xA;        "type": "user"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Then, I add the following users:</p>&#xA;&#xA;<pre><code>PUT /my_index/user/1&#xA;{&#xA;  "name": "sally",&#xA;  "age": 32&#xA;}&#xA;&#xA;PUT /my_index/user/2&#xA;{&#xA;  "name":"bob",&#xA;  "age": 41&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Then I give each user some privileges. Let's say I give Sally the privilege to 'add','update' and 'delete':</p>&#xA;&#xA;<pre><code>POST /my_index/privilege/?parent=1&#xA;{&#xA;  "privilegeName":"add"&#xA;}&#xA;&#xA;POST /my_index/privilege/?parent=1&#xA;{&#xA;  "privilegeName":"update"&#xA;}&#xA;&#xA;POST /my_index/privilege/?parent=1&#xA;{&#xA;  "privilegeName":"delete"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>But I only give Bob the privilege to 'add' and 'update':</p>&#xA;&#xA;<pre><code>POST /my_index/privilege/?parent=2&#xA;{&#xA;  "privilegeName":"add"&#xA;}&#xA;&#xA;POST /my_index/privilege/?parent=2&#xA;{&#xA;  "privilegeName":"update"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I can now search for all the users that have the 'add' privilege using the <code>has_child</code> query. But, in the <code>aggs</code>, I can also show a full list of all the privileges that each of the matching users has:</p>&#xA;&#xA;<pre><code>GET /my_index/user/_search&#xA;{&#xA;  "query": {&#xA;    "has_child": {&#xA;      "type": "privilege",&#xA;      "query": {&#xA;        "match": {&#xA;          "privilegeName": "add"&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "by_user": {&#xA;      "terms": {&#xA;        "field": "name"&#xA;      },&#xA;      "aggs": {&#xA;        "to_privs": {&#xA;          "children": {&#xA;            "type": "privilege"&#xA;          },&#xA;          "aggs": {&#xA;            "user_privs": {&#xA;              "terms": {&#xA;                "field": "privilegeName"&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;