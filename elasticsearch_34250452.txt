34250452
Optimizing Elasticsearch tag cloud query
<p>We are using the following query to generate a tag cloud from an index in Elasticsearch.</p>&#xA;&#xA;<pre><code>{&#xA;    "size": 0,&#xA;    "aggregations": {&#xA;        "tagcloud": {&#xA;            "terms": {&#xA;                "field": "body.body",&#xA;                "size": "20",&#xA;                "exclude": ["فى", "في", "كل", "لم", "لن", "له", "من", "هو", "هي", "قوة", "كما", "لها", "منذ", "وقد", "ولا", "لقاء", "مقابل", "هناك", "وقال", "وكان", "وقالت", "وكانت", "فيه", "لكن", "وفي", "ولم", "ومن", "وهو", "وهي", "يوم", "فيها", "منها", "يكون", "يمكن", "حيث", "االا", "اما", "االتى", "التي", "اكثر", "ايضا", "الذى", "الذي", "الان", "الذين", "ابين", "ذلك", "دون", "حول", "حين", "الى", "انه", "اول", "انها", "ف", "و", "و6", "قد", "لا", "ما", "مع", "هذا", "واحد", "واضاف", "واضافت", "فان", "قبل", "قال", "كان", "لدى", "نحو", "هذه", "وان", "واكد", "كانت", "واوضح", "ب", "ا", "أ", "،", "عن", "عند", "عندما", "على", "عليه", "عليها", "تم", "ضد", "بعد", "بعض", "حتى", "اذا", "احد", "بان", "اجل", "غير", "بن", "به", "ثم", "اف", "ان", "او", "اي", "بها", "rt", "http", "الله", "محمد", "إن", "t.co", "أن", "https", "الملك", "إلا", "السعودية", "عاجل", "إلى", "لك", "هل", "سلمان", "عين", "اللهم", "سبيل", "قل", "شيء", "العظيم", "سبحان", "الجنه", "لو", "وبحمده", "باتت", "وعين", "نخلة", "تغرس", "خشية", "بكت", "تحرس", "عينان", "لاتمسهما", "الحج", "أو", "بكل", "داعش", "الرحمن", "إنه", "بصير", "الطير", "أولم", "يروا", "فوقهم", "صافات", "يمسكهن", "ويقبضن", "وزير", "إله", "الحمد", "الأمير", "t", "الدارسين_على_حسابهم_يناشدون_بانضمامهم", "azzamaldakhil", "يارب", "هم", "نحن", "والله", "لنا", "يا", "عزام", "ربي", "ستكون", "انا", "وانا", "بأن", "ي", "بالله", "سوف", "لـ", "معنا", "اللي", "ولكن", "الي", "لهم", "عنا", "خلال", "حسبي", "شي", "بإذن", "الدارسين_على_حسابهم_ينا", "الدارسين_على_حسابهم_ي", "الدارسين_على_حسابهم_يناشد", "الدارسين_على_حسابهم_", "الدارسين_على_حسابهم_يناشدو", "الدخيل", "الدارسين_على_حسابهم_الخاص", "الدارسين_على_حسابهم_ين", "الوزارة", "وظيفتك_وبعثتك", "بين", "الوزير", "منك", "التعلم", "بدون", "نريد", "ونحن", "علي", "معا", "وزارة", "متى", "معالي", "التعليم", "غدا", "منهم", "الا", "فيكم", "اليوم", "يجب", "عدم", "نفس", "htt"]&#xA;            }&#xA;        }&#xA;    },&#xA;    "query": {&#xA;        "bool": {&#xA;            "must": [{&#xA;                "range": {&#xA;                    "body.postedTime": {&#xA;                        "gte": "2015-12-09T00:00:00Z",&#xA;                        "lte": "2015-12-09T09:01:38Z"&#xA;                    }&#xA;                }&#xA;            }, {&#xA;                "query_string": {&#xA;                    "fields": ["body.gnip.matching_rules.tag"],&#xA;                    "query": "King1 OR King2 OR King3 OR KingEng1 OR KingEng2 OR KingEng3 OR KingEng4 OR USAKSA2 OR USAKSA1 OR USAKSA3 OR USAKSA4 OR King4 OR KingEng5 OR USAKSA5 OR King6 OR King7 OR King8 OR BINNAIF1 OR BINNAIF2 OR BINNAIFENG OR BINNAIF3 OR BINSALMAN1 OR BINSALMAN2 OR BINSALMANENG"&#xA;                }&#xA;            }]&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>What are the types of optimization could be done on this query?</p>&#xA;
<p>I would look at moving to a filtered query. One optimization would be to move the date range query to a filtered query.</p>&#xA;&#xA;<p>So for example</p>&#xA;&#xA;<pre><code>{&#xA;    "size": 0,&#xA;    "aggregations": {&#xA;        ...&#xA;    },&#xA;    "query": {&#xA;        "filtered": {&#xA;           "query": {&#xA;             "bool": {&#xA;               "must": [&#xA;                   { "query_string": {&#xA;                        "fields": ["body.gnip.matching_rules.tag"],&#xA;                        "query": "..."&#xA;                    }&#xA;                }]}&#xA;           },&#xA;           "filter": {&#xA;               "bool": {&#xA;                    "must": [&#xA;                        { "range": {&#xA;                            "body.postedTime": {&#xA;                                "gte": "2015-12-09T00:00:00Z",&#xA;                                "lte": "2015-12-09T09:01:38Z"&#xA;                            }&#xA;                        }}&#xA;                    ]&#xA;               }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;