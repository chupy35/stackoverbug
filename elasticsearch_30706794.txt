30706794
How to use special document fields in scripts in elastic?
<p>I'm trying to write query with custom script in elasticsearch:</p>&#xA;&#xA;<ul>&#xA;<li><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-script-filter.html#query-dsl-script-filter" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-script-filter.html#query-dsl-script-filter</a></p></li>&#xA;<li><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting.html</a>.</p></li>&#xA;</ul>&#xA;&#xA;<p>This is useful when you need to compare two document fields.</p>&#xA;&#xA;<p>Everything worked fine, until I decide to use special document field (ex: _id, _uid, etc). The query always returns empty results and there is no errors if I use it like this: <code>doc['_id'].value</code>.</p>&#xA;&#xA;<p>So how to use, for example, "_id" field of a document in a custom script?</p>&#xA;
<p>The <code>_id</code> is indexed in the <code>uid</code> field, using this format: <code>type#id</code>.</p>&#xA;&#xA;<p>So, your script should look like this (for a type called <code>my_type</code> and an ID of <code>1</code>):</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "script" : {&#xA;            "script" : "doc['_uid'].value == 'my_type#1'"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>A more elaborate solution, to take out the <code>id</code> ES-way is like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "script": {&#xA;          "script": "org.elasticsearch.index.mapper.Uid.splitUidIntoTypeAndId(new org.apache.lucene.util.BytesRef(doc['_uid'].value))[1].utf8ToString() == '1'"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>where <code>org.elasticsearch.index.mapper.Uid.splitUidIntoTypeAndId(new org.apache.lucene.util.BytesRef(doc['_uid'].value))[1]</code> is the <code>id</code> and <code>org.elasticsearch.index.mapper.Uid.splitUidIntoTypeAndId(new org.apache.lucene.util.BytesRef(doc['_uid'].value))[0]</code> is the <code>type</code>.</p>&#xA;