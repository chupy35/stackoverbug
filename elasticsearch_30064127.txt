30064127
Not able to aggregate on nested fields in elasticsearch
<p>I have set a field to nested and now i am not able to aggregate on it.&#xA;Sample document - </p>&#xA;&#xA;<pre><code>{&#xA;"attributes" : [&#xA;{ "name" : "snake" , "type" : "reptile" },&#xA;{ "name" : "cow" , "type" : "mamal" }&#xA;]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>attributes field is nested.&#xA;Following terms query is not working on this</p>&#xA;&#xA;<pre><code>{ &#xA;"aggs" : {&#xA;"terms" : { "field" : "attributes.name" }&#xA;}&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>How can I do the aggregation in elasticsearch?</p>&#xA;
<p>Use a <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-nested-aggregation.html" rel="nofollow">nested aggregation</a>.</p>&#xA;&#xA;<p>As a simple example, I created an index with a nested property matching what you posted:</p>&#xA;&#xA;<pre><code>PUT /test_index&#xA;{&#xA;   "mappings": {&#xA;      "doc": {&#xA;         "properties": {&#xA;            "attributes": {&#xA;               "type": "nested",&#xA;               "properties": {&#xA;                  "name": {&#xA;                     "type": "string"&#xA;                  },&#xA;                  "type": {&#xA;                     "type": "string"&#xA;                  }&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Then added your document:</p>&#xA;&#xA;<pre><code>PUT /test_index/doc/1&#xA;{&#xA;   "attributes": [&#xA;      { "name": "snake", "type": "reptile" },&#xA;      { "name": "cow", "type": "mammal" }&#xA;   ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Now I can get <code>"attribute.name"</code> terms as follows:</p>&#xA;&#xA;<pre><code>POST /test_index/_search?search_type=count&#xA;{&#xA;   "aggs": {&#xA;      "nested_attributes": {&#xA;         "nested": {&#xA;            "path": "attributes"&#xA;         },&#xA;         "aggs": {&#xA;            "name_terms": {&#xA;               "terms": {&#xA;                  "field": "attributes.name"&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "took": 7,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 1,&#xA;      "max_score": 0,&#xA;      "hits": []&#xA;   },&#xA;   "aggregations": {&#xA;      "nested_attributes": {&#xA;         "doc_count": 2,&#xA;         "name_terms": {&#xA;            "doc_count_error_upper_bound": 0,&#xA;            "sum_other_doc_count": 0,&#xA;            "buckets": [&#xA;               {&#xA;                  "key": "cow",&#xA;                  "doc_count": 1&#xA;               },&#xA;               {&#xA;                  "key": "snake",&#xA;                  "doc_count": 1&#xA;               }&#xA;            ]&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here's the code I used:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/0e3ed9c700f240e523be08a27551707d4448a9df" rel="nofollow">http://sense.qbox.io/gist/0e3ed9c700f240e523be08a27551707d4448a9df</a></p>&#xA;