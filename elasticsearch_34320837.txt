34320837
Elastic search grouping by nested field and ordering by sum of _score of parent match
<pre><code>{&#xA;  "documents":{&#xA;    "mappings":{&#xA;        "document":{&#xA;            "dynamic":"strict",&#xA;            "_all":{&#xA;                "enabled":false&#xA;            },&#xA;            "properties":{&#xA;                "authors":{&#xA;                    "type":"nested",&#xA;                    "properties":{&#xA;&#xA;                        "authorId":{&#xA;                            "type":"long"&#xA;                        }&#xA;                    }&#xA;                },&#xA;                "docId":{&#xA;                    "type":"long"&#xA;                },&#xA;                "clusters":{&#xA;                    "type":"string",&#xA;                    "analyzer":"whitespace",&#xA;                    "similarity":"BM25"&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>A single author can write multiple documents.&#xA;I am trying to group by <code>authorId</code> and order by sum of the <code>_scores</code> of matching parent document i.e the  author ids should be in the descending order of the sums of the matching <code>_score</code> of the parent document of which this author was a nested field. The below query doesn't return the expected results. What am I doing wrong</p>&#xA;&#xA;<pre><code>"size":0&#xA;    "query": {&#xA;    "bool": {&#xA;        "should": [&#xA;&#xA;            { "match": { &#xA;&#xA;                "clusters":{&#xA;                    "query":  "sports"                    &#xA;               }&#xA;            }&#xA;           },&#xA;           { "match": { &#xA;&#xA;                "clusters":{&#xA;                    "query":  "politics"                   &#xA;               }&#xA;            }&#xA;           }&#xA;&#xA;&#xA;        ]&#xA;    }&#xA;},&#xA;"aggs": {&#xA;     "group_by_authorId": {&#xA;         "nested":{&#xA;          "path": "authors"&#xA;         },&#xA;         "aggs" :{&#xA;           "top_authors":{&#xA;               "terms":{&#xA;                 "field": "authors.authorId",&#xA;                 "order": {&#xA;                     "max_score": "desc"&#xA;                 }&#xA;               },&#xA;               "aggs":{&#xA;                   "max_score": {&#xA;                        "sum": {&#xA;                            "script":"_score"&#xA;                        }&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;&#xA;     }&#xA;}&#xA;</code></pre>&#xA;