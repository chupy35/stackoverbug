31918664
Filtering and selecting groups in Elasticsearch
<p>Long question short: How to select among groups that are formed as a result of aggregations? </p>&#xA;&#xA;<p><strong>Useful detail:</strong> I have indexed 1800 photos' EXIF data, and grouped them using geohash cell filter (i.e. location) and date-histogram aggregation (i.e. time). </p>&#xA;&#xA;<p>So I successfully grouped the photos that are close to each other within a certain distance and taken within a specific time. </p>&#xA;&#xA;<p>But now, I further want to select <em>among</em> the groups (<em>NOT</em> the individual documents) that contain the field/value pair "Image Software": "Instagram". If I use a filter, it will just return the specific documents, not the groups. What approach can I take? </p>&#xA;&#xA;<p>(It would even be better if I could add another condition to select among the groups, for instance another field/value pair). </p>&#xA;&#xA;<p>The POST below returns the aforementioned groups. I now want to select among the groups that contain the field/value pair "Image Software": "Instagram" and return these groups. </p>&#xA;&#xA;<pre><code>POST  account_index/_search?search_type=count&#xA;{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "geohash_cell": {&#xA;          "location": {&#xA;            "geohash": "swtcw"&#xA;          },&#xA;          "neighbors": true,&#xA;          "precision": 5&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "zamanlar": {&#xA;      "date_histogram": {&#xA;        "field": "EXIF DateTimeOriginal",&#xA;        "interval": "7d"&#xA;      },&#xA;      "aggs": {&#xA;        "grouped": {&#xA;          "top_hits": {&#xA;            "size": 10000&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Below is an example of the elements of one of many groups that are returned as a result of the POST above:</p>&#xA;&#xA;<pre><code>    {&#xA; "took": 3,&#xA; "timed_out": false,&#xA; "_shards": {&#xA;  "total": 5,&#xA;  "successful": 5,&#xA;   "failed": 0&#xA; },&#xA; "hits": {&#xA;  "total": 136,&#xA;  "max_score": 0,&#xA;  "hits": []&#xA;  },&#xA;  "aggregations": {&#xA;  "zamanlar": {&#xA;     "buckets": [&#xA;        {&#xA;           "key_as_string": "2015:06:11 00:00:00",&#xA;           "key": 1433980800000,&#xA;           "doc_count": 30,&#xA;           "ohy": {&#xA;              "hits": {&#xA;                 "total": 30,&#xA;                 "max_score": 1,&#xA;                 "hits": [&#xA;                    {&#xA;                       "_index": "account_index",&#xA;                       "_type": "image",&#xA;                       "_id": "1356",&#xA;                       "_score": 1,&#xA;                       "_source": {&#xA;                          "GPS GPSTimeStamp": "[16, 35, 697/20]",&#xA;                          "Thumbnail YResolution": "72",&#xA;                          "GPS GPSLongitudeRef": "E",&#xA;                          "GPS GPSLongitude": "[30, 52, 2249/50]",&#xA;                          "EXIF DateTimeOriginal": "2015:06:15 19:35:35",&#xA;                          "Image Model": "iPhone 5",&#xA;                          "EXIF LensModel": "iPhone 5 back camera 4.12mm f/2.4",&#xA;                          "GPS GPSLatitudeRef": "N",&#xA;                          "FileName": "IMG_0613.JPG",&#xA;                          "CalculatedLatitude": 36.85336388888889,&#xA;                          "CalculatedLongitude": 30.879161111111113,&#xA;                          "location": {&#xA;                             "lat": 36.85336388888889,&#xA;                             "lon": 30.879161111111113&#xA;                          },&#xA;                          "EXIF ExifImageLength": "2448",&#xA;                          "Image Make": "Apple",&#xA;                          "EXIF ExifImageWidth": "3264",&#xA;                          "GPS GPSLatitude": "[36, 51, 1211/100]",&#xA;                          "Image Software": "7.1.2",&#xA;                          "GPS GPSAltitude": "6217/1147",&#xA;                          "Thumbnail XResolution": "72"&#xA;                       }&#xA;                    },&#xA;                    {&#xA;                       "_index": "account_index",&#xA;                       "_type": "image",&#xA;                       "_id": "1363",&#xA;                       "_score": 1,&#xA;                       "_source": {&#xA;                          "GPS GPSTimeStamp": "[12, 28, 1356/25]",&#xA;                          "Thumbnail YResolution": "72",&#xA;                          "GPS GPSLongitudeRef": "E",&#xA;                          "GPS GPSLongitude": "[30, 52, 2193/50]",&#xA;                          "EXIF DateTimeOriginal": "2015:06:16 15:28:55",&#xA;                          "Image Model": "iPhone 5",&#xA;                          "EXIF LensModel": "iPhone 5 back camera 4.12mm f/2.4",&#xA;                          "GPS GPSLatitudeRef": "N",&#xA;                          "FileName": "IMG_0620.JPG",&#xA;                          "CalculatedLatitude": 36.85424166666667,&#xA;                          "CalculatedLongitude": 30.87885,&#xA;                          "location": {&#xA;                             "lat": 36.85424166666667,&#xA;                             "lon": 30.87885&#xA;                          },&#xA;                          "EXIF ExifImageLength": "2448",&#xA;                          "Image Make": "Apple",&#xA;                          "EXIF ExifImageWidth": "3264",&#xA;                          "GPS GPSLatitude": "[36, 51, 1527/100]",&#xA;                          "Image Software": "7.1.2",&#xA;                          "GPS GPSAltitude": "0",&#xA;                          "Thumbnail XResolution": "72"&#xA;                       }&#xA;                    },&#xA;                    {&#xA;                       "_index": "account_index",&#xA;                       "_type": "image",&#xA;                       "_id": "1368",&#xA;                       "_score": 1,&#xA;                       "_source": {&#xA;                          "GPS GPSTimeStamp": "[17, 28, 1767/50]",&#xA;                          "Thumbnail YResolution": "72",&#xA;                          "GPS GPSLongitudeRef": "E",&#xA;                          "GPS GPSLongitude": "[30, 52, 1097/25]",&#xA;                          "EXIF DateTimeOriginal": "2015:06:16 20:28:36",&#xA;                          "Image Model": "iPhone 5",&#xA;                          "EXIF LensModel": "iPhone 5 back camera 4.12mm f/2.4",&#xA;                          "GPS GPSLatitudeRef": "N",&#xA;                          "FileName": "IMG_0625.JPG",&#xA;                          "CalculatedLatitude": 36.85438888888889,&#xA;                          "CalculatedLongitude": 30.878855555555557,&#xA;                          "location": {&#xA;                             "lat": 36.85438888888889,&#xA;                             "lon": 30.878855555555557&#xA;                          },&#xA;                          "EXIF ExifImageLength": "2448",&#xA;                          "Image Make": "Apple",&#xA;                          "EXIF ExifImageWidth": "3264",&#xA;                          "GPS GPSLatitude": "[36, 51, 79/5]",&#xA;                          "Image Software": "7.1.2",&#xA;                          "GPS GPSAltitude": "0",&#xA;                          "Thumbnail XResolution": "72"&#xA;                       }&#xA;                    },&#xA;                    {&#xA;                       "_index": "account_index",&#xA;                       "_type": "image",&#xA;                       "_id": "1370",&#xA;                       "_score": 1,&#xA;                       "_source": {&#xA;                          "GPS GPSTimeStamp": "[17, 28, 749/20]",&#xA;                          "Thumbnail YResolution": "72",&#xA;                          "GPS GPSLongitudeRef": "E",&#xA;                          "GPS GPSLongitude": "[30, 52, 1097/25]",&#xA;                          "EXIF DateTimeOriginal": "2015:06:16 20:28:38",&#xA;                          "Image Model": "iPhone 5",&#xA;                          "EXIF LensModel": "iPhone 5 back camera 4.12mm f/2.4",&#xA;                          "GPS GPSLatitudeRef": "N",&#xA;                          "FileName": "IMG_0627.JPG",&#xA;                          "CalculatedLatitude": 36.85438888888889,&#xA;                          "CalculatedLongitude": 30.878855555555557,&#xA;                          "location": {&#xA;                             "lat": 36.85438888888889,&#xA;                             "lon": 30.878855555555557&#xA;                          },&#xA;                          "EXIF ExifImageLength": "2448",&#xA;                          "Image Make": "Apple",&#xA;                          "EXIF ExifImageWidth": "3264",&#xA;                          "GPS GPSLatitude": "[36, 51, 79/5]",&#xA;                          "Image Software": "7.1.2",&#xA;                          "GPS GPSAltitude": "0",&#xA;                          "Thumbnail XResolution": "72"&#xA;                       }&#xA;                    },&#xA;                    {&#xA;                       "_index": "account_index",&#xA;                       "_type": "image",&#xA;                       "_id": "1375",&#xA;                       "_score": 1,&#xA;                       "_source": {&#xA;                          "GPS GPSTimeStamp": "[19, 19, 112/5]",&#xA;                          "Thumbnail YResolution": "72",&#xA;                          "GPS GPSLongitudeRef": "E",&#xA;                          "GPS GPSLongitude": "[30, 52, 4469/100]",&#xA;                          "EXIF DateTimeOriginal": "2015:06:16 22:19:23",&#xA;                          "Image Model": "iPhone 5",&#xA;                          "EXIF LensModel": "iPhone 5 back camera 4.12mm f/2.4",&#xA;                          "GPS GPSLatitudeRef": "N",&#xA;                          "FileName": "IMG_0632.JPG",&#xA;                          "CalculatedLatitude": 36.85251944444445,&#xA;                          "CalculatedLongitude": 30.879080555555557,&#xA;                          "location": {&#xA;                             "lat": 36.85251944444445,&#xA;                             "lon": 30.879080555555557&#xA;                          },&#xA;                          "EXIF ExifImageLength": "2448",&#xA;                          "Image Make": "Apple",&#xA;                          "EXIF ExifImageWidth": "3264",&#xA;                          "GPS GPSLatitude": "[36, 51, 907/100]",&#xA;                          "Image Software": "7.1.2",&#xA;                          "GPS GPSAltitude": "8555/2048",&#xA;                          "Thumbnail XResolution": "72"&#xA;                       }&#xA;                    },&#xA;                    {&#xA;                       "_index": "account_index",&#xA;                       "_type": "image",&#xA;                       "_id": "1382",&#xA;                       "_score": 1,&#xA;                       "_source": {&#xA;                          "GPS GPSTimeStamp": "[19, 22, 119/5]",&#xA;                          "Thumbnail YResolution": "72",&#xA;                          "GPS GPSLongitudeRef": "E",&#xA;                          "GPS GPSLongitude": "[30, 52, 4487/100]",&#xA;                          "EXIF DateTimeOriginal": "2015:06:16 22:22:24",&#xA;                          "Image Model": "iPhone 5",&#xA;                          "EXIF LensModel": "iPhone 5 back camera 4.12mm f/2.4",&#xA;                          "GPS GPSLatitudeRef": "N",&#xA;                          "FileName": "IMG_0639.JPG",&#xA;                          "CalculatedLatitude": 36.852516666666666,&#xA;                          "CalculatedLongitude": 30.879130555555555,&#xA;                          "location": {&#xA;                             "lat": 36.852516666666666,&#xA;                             "lon": 30.879130555555555&#xA;                          },&#xA;                          "EXIF ExifImageLength": "2448",&#xA;                          "Image Make": "Apple",&#xA;                          "EXIF ExifImageWidth": "3264",&#xA;                          "GPS GPSLatitude": "[36, 51, 453/50]",&#xA;                          "Image Software": "7.1.2",&#xA;                          "GPS GPSAltitude": "0",&#xA;                          "Thumbnail XResolution": "72"&#xA;                       }&#xA;                    },&#xA;                    {&#xA;                       "_index": "account_index",&#xA;                       "_type": "image",&#xA;                       "_id": "1357",&#xA;                       "_score": 1,&#xA;                       "_source": {&#xA;                          "GPS GPSTimeStamp": "[16, 35, 921/25]",&#xA;                          "Thumbnail YResolution": "72",&#xA;                          "GPS GPSLongitudeRef": "E",&#xA;                          "GPS GPSLongitude": "[30, 52, 2249/50]",&#xA;                          "EXIF DateTimeOriginal": "2015:06:15 19:35:37",&#xA;                          "Image Model": "iPhone 5",&#xA;                          "EXIF LensModel": "iPhone 5 back camera 4.12mm f/2.4",&#xA;                          "GPS GPSLatitudeRef": "N",&#xA;                          "FileName": "IMG_0614.JPG",&#xA;                          "CalculatedLatitude": 36.85336388888889,&#xA;                          "CalculatedLongitude": 30.879161111111113,&#xA;                          "location": {&#xA;                             "lat": 36.85336388888889,&#xA;                             "lon": 30.879161111111113&#xA;                          },&#xA;                          "EXIF ExifImageLength": "2448",&#xA;                          "Image Make": "Apple",&#xA;                          "EXIF ExifImageWidth": "3264",&#xA;                          "GPS GPSLatitude": "[36, 51, 1211/100]",&#xA;                          "Image Software": "7.1.2",&#xA;                          "GPS GPSAltitude": "5153/1024",&#xA;                          "Thumbnail XResolution": "72"&#xA;                       }&#xA;                    },&#xA;                    {&#xA;                       "_index": "account_index",&#xA;                       "_type": "image",&#xA;                       "_id": "1364",&#xA;                       "_score": 1,&#xA;                       "_source": {&#xA;                          "GPS GPSTimeStamp": "[12, 29, 29/25]",&#xA;                          "Thumbnail YResolution": "72",&#xA;                          "GPS GPSLongitudeRef": "E",&#xA;                          "GPS GPSLongitude": "[30, 52, 877/20]",&#xA;                          "EXIF DateTimeOriginal": "2015:06:16 15:29:01",&#xA;                          "Image Model": "iPhone 5",&#xA;                          "EXIF LensModel": "iPhone 5 back camera 4.12mm f/2.4",&#xA;                          "GPS GPSLatitudeRef": "N",&#xA;                          "FileName": "IMG_0621.JPG",&#xA;                          "CalculatedLatitude": 36.85424722222222,&#xA;                          "CalculatedLongitude": 30.878847222222223,&#xA;                          "location": {&#xA;                             "lat": 36.85424722222222,&#xA;                             "lon": 30.878847222222223&#xA;                          },&#xA;                          "EXIF ExifImageLength": "2448",&#xA;                          "Image Make": "Apple",&#xA;                          "EXIF ExifImageWidth": "3264",&#xA;                          "GPS GPSLatitude": "[36, 51, 1529/100]",&#xA;                          "Image Software": "7.1.2",&#xA;                          "GPS GPSAltitude": "0",&#xA;                          "Thumbnail XResolution": "72"&#xA;                       }&#xA;                    },&#xA;                    {&#xA;                       "_index": "account_index",&#xA;                       "_type": "image",&#xA;                       "_id": "1369",&#xA;                       "_score": 1,&#xA;                       "_source": {&#xA;                          "GPS GPSTimeStamp": "[17, 28, 749/20]",&#xA;                          "Thumbnail YResolution": "72",&#xA;                          "GPS GPSLongitudeRef": "E",&#xA;                          "GPS GPSLongitude": "[30, 52, 1097/25]",&#xA;                          "EXIF DateTimeOriginal": "2015:06:16 20:28:38",&#xA;                          "Image Model": "iPhone 5",&#xA;                          "EXIF LensModel": "iPhone 5 back camera 4.12mm f/2.4",&#xA;                          "GPS GPSLatitudeRef": "N",&#xA;                          "FileName": "IMG_0626.JPG",&#xA;                          "CalculatedLatitude": 36.85438888888889,&#xA;                          "CalculatedLongitude": 30.878855555555557,&#xA;                          "location": {&#xA;                             "lat": 36.85438888888889,&#xA;                             "lon": 30.878855555555557&#xA;                          },&#xA;                          "EXIF ExifImageLength": "2448",&#xA;                          "Image Make": "Apple",&#xA;                          "EXIF ExifImageWidth": "3264",&#xA;                          "GPS GPSLatitude": "[36, 51, 79/5]",&#xA;                          "Image Software": "7.1.2",&#xA;                          "GPS GPSAltitude": "0",&#xA;                          "Thumbnail XResolution": "72"&#xA;                       }&#xA;                    }&#xA;</code></pre>&#xA;
<p>You should be able to make it work simply by wrapping your existing aggregation into a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-filter-aggregation.html" rel="nofollow"><code>filter</code> aggregation</a> like this:</p>&#xA;&#xA;<pre><code>POST  account_index/_search?search_type=count&#xA;{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "geohash_cell": {&#xA;          "location": {&#xA;            "geohash": "swtcw"&#xA;          },&#xA;          "neighbors": true,&#xA;          "precision": 5&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "zamanlar": {&#xA;      "filter": {               &lt;------ wrap your aggregation into this new filter aggregation&#xA;        "term": {&#xA;          "Image Software": "Instagram"&#xA;        }&#xA;      },&#xA;      "aggs": {&#xA;        "zamanlar": {&#xA;          "date_histogram": {&#xA;            "field": "EXIF DateTimeOriginal",&#xA;            "interval": "7d"&#xA;          },&#xA;          "aggs": {&#xA;            "grouped": {&#xA;              "top_hits": {&#xA;                "size": 10000&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;