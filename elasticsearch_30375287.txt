30375287
ElasticSearch Segments Per Index
<p>We have monthly indexes (currently 11 months) with 22 shards per index.  I am seeing what seems to be a lot of segments per index (roughly 1200 to 1380 segments).  The older indexes should have very little, if any updates occurring on them.  From everything I have read it sounds like ES should be automatically merging segments, but now I am a bit concerned that this is not occurring.  I know we can manually run an optimize, but will need to allocate another resource to do that work (as to not impact current system).  I am fairly new to ES (if that isn't obvious) and am really trying to understand if we have an issue or not. It could also be that we need to tweak index.merge.policy.segments_per_tier to be less than 10.  Really not sure. </p>&#xA;&#xA;<p>Rough index stats: </p>&#xA;&#xA;<p>11 indexes&#xA;22 shards per index&#xA;65 million docs per index&#xA;350 GB per index</p>&#xA;&#xA;<p>Any info, suggestions, etc. are greatly appreciated. </p>&#xA;&#xA;<p>Thanks,</p>&#xA;&#xA;<p>S</p>&#xA;
<p>The best step you can perform now, especially that you have time-based indices, is to manually optimize the indices that are not written to. You will see improvements in performance for sure. The more segments there are, the more heap memory is being used.</p>&#xA;&#xA;<p>ES does automatically merge segments, but there are certain conditions that should apply for Lucene to merge segments (size of the segments, number of deleted docs in them, number of segments of almost the same size etc). There were issues in the past versions related to merging, but not sure if you are hitting one or not.</p>&#xA;&#xA;<p>You could try to optimize a single index per day, when you believe the load on the cluster is not that high. You are probably aware of <a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/examples.html#_optimize_only_the_specified_indices" rel="nofollow">Curator</a> which can be used for this and other operations.</p>&#xA;