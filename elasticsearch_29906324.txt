29906324
Replacing OR/AND/NOT filters with bool filter creates a hard-to-understand query with too many levels?
<p>I have the following filter in a filtered query. As seen, it has many OR/AND/NOT filters at different levels. I was advised to replace them with bool filters for performance reasons, and I am going to do that.</p>&#xA;&#xA;<pre><code>"filter" : {&#xA;                "or" : [&#xA;&#xA;                    {&#xA;                        "and" : [&#xA;                            { "range" : { "start" : { "lte": 201407292300 } } },&#xA;                            { "range" : { "end" : { "gte": 201407292300 } } },&#xA;                            { "term" : { "condtion1" : false } },&#xA;                            {&#xA;                                "or" : [&#xA;                                    {&#xA;                                        "and" : [&#xA;                                            { "term" : { "condtion2" : false } },&#xA;                                            {&#xA;                                                "or": [&#xA;                                                    {&#xA;                                                        "and" : [&#xA;                                                            { "missing" : { "field" : "condtion6" } },&#xA;                                                            { "missing" : { "field" : "condtion7" } }&#xA;                                                        ]&#xA;                                                    },&#xA;                                                    { "term" : { "condtion6" : "nop" } }&#xA;                                                    { "term" : { "condtion7" : "rst" } }&#xA;                                                ]&#xA;                                            }&#xA;                                        ]&#xA;                                    },&#xA;                                    {&#xA;                                        "and" : [&#xA;                                            { "term" : { "condtion2" : true } },&#xA;                                            {&#xA;                                                "or": [&#xA;                                                    {&#xA;                                                        "and" : [&#xA;                                                            { "missing" : { "field" : "condtion3" } },&#xA;                                                            { "missing" : { "field" : "condtion4" } },&#xA;                                                            { "missing" : { "field" : "condtion5" } },&#xA;                                                            { "missing" : { "field" : "condtion6" } },&#xA;                                                            { "missing" : { "field" : "condtion7" } }&#xA;                                                        ]&#xA;                                                    },&#xA;                                                    { "term" : { "condtion3" : "abc" } },&#xA;                                                    { "term" : { "condtion4" : "def" } },&#xA;                                                    { "term" : { "condtion5" : "ghj" } },&#xA;                                                    { "term" : { "condtion6" : "nop" } },&#xA;                                                    { "term" : { "condtion7" : "rst" } }&#xA;                                                ]&#xA;                                            }                                       &#xA;                                        ]&#xA;                                    }&#xA;                                ]&#xA;                            }&#xA;&#xA;                        ]&#xA;                    },&#xA;&#xA;                    {&#xA;                        "and" : [&#xA;                            { &#xA;                                "term": { "condtion8" : "TIME_POINT_1" } &#xA;                            },&#xA;                            {  "range" : { "start" : { "lte": 201407302300 } } },&#xA;                            { &#xA;                                "or": [&#xA;                                    { "term" : { "condtion9" : "GROUP_B" } }, &#xA;                                    {&#xA;                                        "and" : [&#xA;                                            { "term" : { "condtion9" : "GROUP_A" } },&#xA;                                            { "ids" : { values: [100, 10] } }&#xA;                                        ] &#xA;                                    }&#xA;                                ]&#xA;                            }&#xA;                        ]&#xA;                    },&#xA;&#xA;                    {&#xA;                        "and" : [&#xA;                            { &#xA;                                "term": { "condtion8" : "TIME_POINT_2" } &#xA;                            },&#xA;                            { "ids" : { values: [100, 10] } }&#xA;                        ]&#xA;                    },                  &#xA;&#xA;                    {&#xA;                        "and" : [&#xA;                            { &#xA;                                "term": { "condtion8" : "TIME_POINT_3" } &#xA;                            },&#xA;                            { &#xA;                                "or": [&#xA;                                    { "term" : { "condtion1" : true } },&#xA;                                    { "range" : { "end" : { "lt": 201407302300 } } }&#xA;                                ]&#xA;                            },&#xA;                            { &#xA;                                "or": [&#xA;                                    { "term" : { "condtion9" : "GROUP_B" } }, &#xA;                                    {&#xA;                                        "and" : [&#xA;                                            { "term" : { "condtion9" : "GROUP_A" } },&#xA;                                            { "ids" : { values: [100, 10] } }&#xA;                                        ] &#xA;                                    }&#xA;                                ]&#xA;                            }&#xA;                        ]&#xA;                    }&#xA;&#xA;                ]&#xA;            }&#xA;</code></pre>&#xA;&#xA;<p>However, I feel replacing these OR/AND/NOT filters would create a query that has too many levels and is hard to understand. For example, replacing </p>&#xA;&#xA;<pre><code>"or": [&#xA;   ....&#xA;]&#xA;</code></pre>&#xA;&#xA;<p>I have to have:</p>&#xA;&#xA;<pre><code>"bool" {&#xA;   "should": [&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Am I right that replacing OR/AND/NOT with bool filter in my case is at the expense of sacrificing understandability?</p>&#xA;&#xA;<p><strong>A related question</strong></p>&#xA;&#xA;<p>If I have to replace OR/AND/NOT filters for performance, should I replace <strong>ALL</strong> of these OR/AND/NOT filters, or just some of them such as the one at the top for example?</p>&#xA;&#xA;<p>Thanks and regards.</p>&#xA;
<p>You should replace all of them except geo/script/range filters. Having said that understanding the possible impact of each filter can help you also. For example if one of the filter is going to filter out say 90% of the result then you may want to put that in an and filter at the starting. Since and/or filters are executed sequentially the rest of the filters will have lesser documents to process. In case of bool filters all the filters are combined in a single bitset operation. You might have already <a href="https://www.elastic.co/blog/all-about-elasticsearch-filter-bitsets" rel="nofollow">read about it.</a></p>&#xA;&#xA;<p>I don't think you will be sacrificing understability by replacing OR/AND/NOT with bool filter. As the example you have given, for a single or filter converting to should filter looks like an increase in the query structure but in an overall combination the structure would be almost similar.</p>&#xA;