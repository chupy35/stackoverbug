33619866
Finding docs that do not contain a given user in all nested fields
<p>I have the following mapping for a nested field called ratings:</p>&#xA;&#xA;<pre><code>"ratings" : {&#xA;  "type" : "nested",&#xA;  "properties" : {&#xA;    "rating" : {&#xA;      "type" : "double"&#xA;    },&#xA;    "user_id" : {&#xA;      "type" : "long"&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I'm attempting to find all records where a user_id does not exist in the nested field.</p>&#xA;&#xA;<p>Here's what I have, but it's failing when there are multiple nested docs and any of the docs are not user_id 1.</p>&#xA;&#xA;<pre><code>{&#xA;"nested": { &#xA;    "path": "ratings", &#xA;    "query": { &#xA;         "bool": { "must_not": [&#xA;             { "term": { "ratings.user_id": 1}}&#xA;]}}}}&#xA;</code></pre>&#xA;
<p>If I'm understanding you correctly, and what you are trying to do is find documents for which NONE of the nested documents have a specific <code>user_id</code>, then this query seems to do what you want (assuming you want docs that have not been rated by user <code>2</code>):</p>&#xA;&#xA;<pre><code>POST /test_index/_search&#xA;{&#xA;   "query": {&#xA;      "constant_score": {&#xA;         "filter": {&#xA;            "not": {&#xA;               "filter": {&#xA;                  "nested": {&#xA;                     "path": "ratings",&#xA;                     "filter": {&#xA;                        "term": {&#xA;                           "ratings.user_id": 2&#xA;                        }&#xA;                     }&#xA;                  }&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here's the code I used to test it:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/afd319e64403a7f995cbf1e9f40e5c5948729193" rel="nofollow">http://sense.qbox.io/gist/afd319e64403a7f995cbf1e9f40e5c5948729193</a></p>&#xA;