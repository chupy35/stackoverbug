32509097
Elasticsearch multiple range filters on same field
<p>I'm working on implementing elasticseach in a site I am working on and trying to build a multi-range filter. There are 2 fields that have ranges that I will need to filter by: price, and rating. Each one should be able to have multiple ranges selected at once. So for example, you should be able to filter by ratings of 80-85 <code>OR</code> 90-95 while also filtering by prices of 10-15 <code>OR</code> 20-25. I am using a <code>post_filter</code> for term and range filters, as I am building a faceted navigation for search results. Below you can see my structured json that I am sending.</p>&#xA;&#xA;<pre><code>{&#xA;  "from": 0,&#xA;  "size": 15,&#xA;  "query": {&#xA;    "multi_match": {&#xA;      "query": "taz 2003",&#xA;      "type": "most_fields",&#xA;      "operator": "or",&#xA;      "fields": [&#xA;        "name",&#xA;        "vintage",&#xA;        "brand^4",&#xA;        "review"&#xA;      ],&#xA;      "fuzziness": "1"&#xA;    }&#xA;  },&#xA;  "post_filter": {&#xA;    "bool": {&#xA;      "must": [&#xA;        {&#xA;          "term": {&#xA;            "vintage": "2009"&#xA;          }&#xA;        }&#xA;      ],&#xA;      "should": [&#xA;        {&#xA;          "range": {&#xA;            "price": {&#xA;              "gte": 10,&#xA;              "lt": 15&#xA;            }&#xA;          }&#xA;        },&#xA;        {&#xA;          "range": {&#xA;            "price": {&#xA;              "gte": 20,&#xA;              "lt": 25&#xA;            }&#xA;          }&#xA;        },&#xA;        {&#xA;          "range": {&#xA;            "rating": {&#xA;              "gte": 80,&#xA;              "lt": 85&#xA;            }&#xA;          }&#xA;        },&#xA;        {&#xA;          "range": {&#xA;            "rating": {&#xA;              "gte": 90,&#xA;              "lt": 95&#xA;            }&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>This almost works, however because all the ranges are within a <code>should</code> bool filter, it is using <code>OR</code> to combine them, so it's only matching on one of the filters. What I need is for it to do something like the following (in SQL):</p>&#xA;&#xA;<pre><code>SELECT * FROM `table` where &#xA;vintage = 2009 AND&#xA;(&#xA;    (&#xA;        price BETWEEN 10 AND 15 OR&#xA;        price BETWEEN 20 AND 25&#xA;    ) AND&#xA;    (&#xA;        rating BETWEEN 80 AND 85 OR&#xA;        rating BETWEEN 90 AND 85&#xA;    )&#xA;);&#xA;</code></pre>&#xA;&#xA;<p>I'm at a loss currently on how to accomplish this. Thanks in advance for help.</p>&#xA;
<p>One way would be to use <code>nested bool</code> query within the <code>must</code></p>&#xA;&#xA;<p>Example:</p>&#xA;&#xA;<pre><code>{&#xA;  "from": 0,&#xA;  "size": 15,&#xA;  "query": {&#xA;    "multi_match": {&#xA;      "query": "taz 2003",&#xA;      "type": "most_fields",&#xA;      "operator": "or",&#xA;      "fields": [&#xA;        "name",&#xA;        "vintage",&#xA;        "brand^4",&#xA;        "review"&#xA;      ],&#xA;      "fuzziness": "1"&#xA;    }&#xA;  },&#xA;  "post_filter": {&#xA;    "bool": {&#xA;      "must": [&#xA;        {&#xA;          "term": {&#xA;            "vintage": "2009"&#xA;          }&#xA;        },&#xA;        {&#xA;          "bool": {&#xA;            "should": [&#xA;              {&#xA;                "range": {&#xA;                  "price": {&#xA;                    "gte": 10,&#xA;                    "lt": 15&#xA;                  }&#xA;                }&#xA;              },&#xA;              {&#xA;                "range": {&#xA;                  "price": {&#xA;                    "gte": 20,&#xA;                    "lt": 25&#xA;                  }&#xA;                }&#xA;              }&#xA;            ]&#xA;          }&#xA;        },&#xA;        {&#xA;          "bool": {&#xA;            "should": [&#xA;              {&#xA;                "range": {&#xA;                  "rating": {&#xA;                    "gte": 80,&#xA;                    "lt": 85&#xA;                  }&#xA;                }&#xA;              },&#xA;              {&#xA;                "range": {&#xA;                  "rating": {&#xA;                    "gte": 90,&#xA;                    "lt": 95&#xA;                  }&#xA;                }&#xA;              }&#xA;            ]&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;