32184070
Why does Elastic Search return this record?
<p>Executive summary - why is this Elastic Search query...</p>&#xA;&#xA;<pre><code>{&#xA;    "query": {&#xA;        "filtered": {&#xA;            "filter": {&#xA;                "bool": {&#xA;                    "should": [&#xA;                        {&#xA;                            "term": {&#xA;                                "document.company_id": 197&#xA;                            }&#xA;                        },&#xA;                        {&#xA;                            "term": {&#xA;                                "change.company_id": 197&#xA;                            }&#xA;                        },&#xA;                        {&#xA;                            "bool": {&#xA;                                "must": [&#xA;                                    {&#xA;                                        "missing": {&#xA;                                            "field": "document.company_id"&#xA;                                        }&#xA;                                    },&#xA;                                    {&#xA;                                        "missing": {&#xA;                                            "field": "changes.company_id"&#xA;                                        }&#xA;                                    },&#xA;                                    {&#xA;                                        "terms": {&#xA;                                            "user.id": [&#xA;                                                2165, 2976, ...&#xA;                                            ]&#xA;                                        }&#xA;                                    }&#xA;                                ]&#xA;                                ... (closing braces here on)&#xA;</code></pre>&#xA;&#xA;<p>...returning this record?</p>&#xA;&#xA;<pre><code>"_source" : {&#xA;    "date" : "2015-03-27T09:36:41.716+00:00",&#xA;    "change" : {&#xA;       "company_id" : 12,&#xA;       "id" : "CC-12-51"&#xA;    },&#xA;    "action" : "change-control-approved",&#xA;    "description" : "blah blah",&#xA;    "user" : {&#xA;       "full_name" : "Martin Wtorkowski",&#xA;       "email" : "mwtorkowski@getzendoc.com",&#xA;       "id" : 40&#xA;    },&#xA;    "_date" : 1427445401,&#xA;    "id" : 57879,&#xA;    "invalid" : null&#xA; },&#xA;</code></pre>&#xA;&#xA;<p>Given the fact that <code>must</code> corresponds to <code>AND</code> and <code>should</code> corresponds to <code>OR</code>, ...</p>&#xA;&#xA;<ul>&#xA;<li>The record doesn't have a <code>document.company_id</code> of 197 (so the first OR term doesn't apply)</li>&#xA;<li>The record doesn't have a <code>change.company_id</code> of 197 (it has a <code>change.company_id</code> of 12 - so the second OR term doesn't apply either)</li>&#xA;<li>The third term says: <code>MUST</code> (therefore <code>AND</code>) for 3 conditions: (a) field <code>document.company_id</code> must be missing - and it is indeed missing (b) field <code>change.company_id</code> must be missing - <em>and IT IS NOT MISSING</em> (c) field <code>user.id</code> must have one of a set of values.</li>&#xA;</ul>&#xA;&#xA;<p>I am probably missing some intricate detail of the ES API - but since the 2nd of the 3 <code>must</code> conditions fails, this record should not have passed.</p>&#xA;&#xA;<p>what am I doing wrong?</p>&#xA;
<p>In your second <code>missing</code> filter, there's a typo.</p>&#xA;&#xA;<p>If you modify <code>changes.company_id</code> to <code>change.company_id</code>, it should work as expected.</p>&#xA;