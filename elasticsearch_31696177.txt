31696177
Elasticsearch aggregation from java scripted field
<p>For simplicity, let's say I have two fields: TRIP_START_DATE (in date format) and TRIP_NIGHTS.</p>&#xA;&#xA;<p>I can run a simple aggregation which will convert dates to date of the week:</p>&#xA;&#xA;<pre><code>aggs &lt;- '{&#xA;        "aggs": {&#xA;          "dept": {&#xA;            "filter": {&#xA;              "range": {&#xA;                "TRIP_START_DATE": {&#xA;                  "gte": "2014-01-01",&#xA;                  "lte": "2014-12-31"&#xA;                }&#xA;              }&#xA;            },&#xA;            "aggs": {&#xA;              "weekday": {&#xA;                "terms": {&#xA;                  "script": "Date date = new Date(doc[\'TRIP_START_DATE\'].value) ; java.text.SimpleDateFormat format = new java.text.SimpleDateFormat(\'EEE\');format.format(date)" &#xA;                }&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }'&#xA;</code></pre>&#xA;&#xA;<p>Is it possible to add another aggregation which returns the average TRIP_NIGHTS per weekday? </p>&#xA;&#xA;<p>Thanks for the help. </p>&#xA;&#xA;<p>Carlos</p>&#xA;
<p>I found the answer mostly by trial and error:</p>&#xA;&#xA;<pre><code>aggs &lt;- '{&#xA;        "aggs": {&#xA;          "dept": {&#xA;            "filter": {&#xA;              "range": {&#xA;                "TRIP_START_DATE": {&#xA;                  "gte": "2014-01-01",&#xA;                  "lte": "2014-12-31"&#xA;                }&#xA;              }&#xA;            },&#xA;            "aggs": {&#xA;              "weekday": {&#xA;                "terms": {&#xA;                  "script": "Date date = new Date(doc[\'TRIP_START_DATE\'].value) ; java.text.SimpleDateFormat format = new java.text.SimpleDateFormat(\'EEE\');format.format(date)" &#xA;                },&#xA;                "aggs": {&#xA;                  "stay": {&#xA;                    "percentiles": {&#xA;                      "script": "doc[\'TRIP_NIGHTS\'].value",&#xA;                        "percents": [&#xA;                          50&#xA;                      ]&#xA;                    }&#xA;                  }&#xA;                }&#xA;              }&#xA;            }  &#xA;          }&#xA;        }&#xA;      }'&#xA;</code></pre>&#xA;&#xA;<p>Carlos</p>&#xA;