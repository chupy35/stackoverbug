32314424
Exclude documents from aggregation
<p>I am trying to get a filtered result set from my index.</p>&#xA;&#xA;<pre><code>{"group_id": 123, "type" : 1},&#xA;{"group_id": 123, "type" : 3},&#xA;{"group_id": 123, "type" : 2},&#xA;{"group_id": 423, "type" : 3},&#xA;{"group_id": 423, "type" : 1},&#xA;{"group_id": 231, "type" : 1}&#xA;</code></pre>&#xA;&#xA;<p>Now I want to get all documents but exclude the ones with group_id that contains type = 2. So, in this case, I want to get all documents with group_id = 423 and group_id = 231, but exclude all documents with group_id = 123.</p>&#xA;&#xA;<p>I was experimenting with filtered bool query:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "bool": {&#xA;      "must_not": [&#xA;        {&#xA;          "term": {&#xA;            "type": 2&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>but that only excludes one document.</p>&#xA;&#xA;<p>Any hints are welcome!</p>&#xA;
<p>You can achieve this using two Elasticsearch search requests:</p>&#xA;&#xA;<p>First, get all values of "group_id" for which corresponding value of "type" is 2. You need to use <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html" rel="nofollow">Terms Aggregation</a> for this.</p>&#xA;&#xA;<pre><code>POST &lt;index name&gt;/&lt;type name&gt;/_search&#xA;{&#xA;  "size": 0,&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "term": {&#xA;          "type": 2&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "group_ids_type_2": {&#xA;      "terms": {&#xA;        "field": "group_id",&#xA;        "size": 0&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Save the list of values of "group_id" fields received from the above request.</p>&#xA;&#xA;<p>Now, use a query with <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html" rel="nofollow"><code>must_not</code></a> filter to get all documents such that the value of their "group_id" is not present in the list obtained above. You need to use <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-terms-filter.html" rel="nofollow">Terms Filter</a> here.</p>&#xA;&#xA;<pre><code>POST &lt;index name&gt;/&lt;type name&gt;/_search&#xA;{&#xA;  "query": {&#xA;    "bool": {&#xA;      "must_not": [&#xA;        {&#xA;          "terms": {&#xA;            "group_id": [&#xA;              "123"                 &lt;-- Replace this with a comma separated list of all group_id values received from first search request&#xA;            ]&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;