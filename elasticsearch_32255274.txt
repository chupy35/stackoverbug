32255274
How do I set a not filter on a nested object property?
<p>I have an index with car documents. A car can have an option. An option is a nested object that can contain an availability object. My mapping looks like this:</p>&#xA;&#xA;<pre><code>{&#xA;   "car": {&#xA;      "properties": {&#xA;         "carId": {&#xA;            "type": "long"&#xA;         },&#xA;         "carName": {&#xA;            "type": "string",&#xA;            "index": "not_analyzed"&#xA;         },&#xA;         "option": {&#xA;            "type": "nested",&#xA;            "properties": {&#xA;               "optionId": {&#xA;                  "type": "long"&#xA;               },&#xA;               "optionName": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed"&#xA;               },&#xA;               "availability": {&#xA;                  "type": "nested",&#xA;                  "properties": {&#xA;                     "from": {&#xA;                        "type": "long"&#xA;                     },&#xA;                     "to": {&#xA;                        "type": "long"&#xA;                     }&#xA;                  }&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I indexed the following 2 car documents.&#xA;One (cool car) with an AC option:</p>&#xA;&#xA;<pre><code>{&#xA;   "carId": 100,&#xA;   "carName": "cool car",&#xA;   "option": {&#xA;      "optionId": 10,&#xA;      "optionName": "AC",&#xA;      "availability": {&#xA;         "from": 12345,&#xA;         "to": 67890&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>And another one (uncool car) without an option:</p>&#xA;&#xA;<pre><code>{&#xA;   "carId": 200,&#xA;   "carName": "uncool car"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>When I search for a car with the AC option then I get "cool car" back as expected:</p>&#xA;&#xA;<pre><code>{&#xA;   "query": {&#xA;      "nested": {&#xA;         "filter": {&#xA;            "term": {&#xA;               "option.optionId": 10&#xA;            }&#xA;         },&#xA;         "path": "option"&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Now the big question is: how can I get a car that does not have the AC option? I added a not-filter to my query, but that didn't return anything:</p>&#xA;&#xA;<pre><code>{&#xA;   "query": {&#xA;      "nested": {&#xA;         "filter": {&#xA;            "not": {&#xA;               "filter": {&#xA;                  "term": {&#xA;                     "option.optionId": 10&#xA;                  }&#xA;               }&#xA;            }&#xA;         },&#xA;         "path": "option"&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Many thanks in advance!</p>&#xA;
<p>I think you were super close, but the placement of your nested filter messed it up. We want to negate the result of the nested filter, not find the nested documents from a negated filter.</p>&#xA;&#xA;<p>Here is my solution:</p>&#xA;&#xA;<pre><code>{&#xA;   "filter": {&#xA;      "not": {&#xA;         "filter": {&#xA;            "nested": {&#xA;               "path": "option",&#xA;               "query": {&#xA;                  "filtered": {&#xA;                     "filter": {&#xA;                        "term": {&#xA;                           "option.optionId": 10&#xA;                        }&#xA;                     }&#xA;                  }&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>From the docs: &#xA;<code>The query path points to the nested object path, and the query (or filter) includes the query that will run on the nested docs matching the direct path</code></p>&#xA;