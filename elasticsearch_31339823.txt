31339823
Concurrent events aggregation in ElasticSearch
<p>I have a number of documents representing events with <code>starts_at</code> and <code>ends_at</code> fields. At a given point in time, an event is considered active, if the point in question is after <code>starts_at</code> and before <code>ends_at</code>.</p>&#xA;&#xA;<p>I'm looking for an aggregation, which should result in a date histogram, where each bucket contains the number of active events in that interval.</p>&#xA;&#xA;<p>So far, the best approximation I have found is to create a set of buckets counting the number of starts in each interval, as well as a corresponding set of buckets counting the number of ends, and then postprocessing them by subtracting the number of starts from the number of ends for each interval:</p>&#xA;&#xA;<pre><code>{&#xA;  "size": "0",&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "match_all": {}&#xA;      },&#xA;      "filter": {&#xA;        "and": [&#xA;          {&#xA;            "term": {&#xA;              "_type": "event"&#xA;            }&#xA;          },&#xA;          {&#xA;            "range": {&#xA;              "starts_at": {&#xA;                "gte": "2015-06-14T05:25:03Z",&#xA;                "lte": "2015-06-21T05:25:03Z"&#xA;              }&#xA;            }&#xA;          }&#xA;        ]&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "starts": {&#xA;      "date_histogram": {&#xA;        "field": "starts_at",&#xA;        "interval": "15m",&#xA;        "extended_bounds": {&#xA;          "max": "2015-06-21T05:25:04Z",&#xA;          "min": "2015-06-14T05:25:04Z"&#xA;        },&#xA;        "min_doc_count": 0&#xA;      }&#xA;    },&#xA;    "ends": {&#xA;      "date_histogram": {&#xA;        "field": "ends_at",&#xA;        "interval": "15m",&#xA;        "extended_bounds": {&#xA;          "max": "2015-06-21T05:25:04Z",&#xA;          "min": "2015-06-14T05:25:04Z"&#xA;        },&#xA;        "min_doc_count": 0&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I'm looking for something like <a href="https://stackoverflow.com/questions/22407203/resampling-a-time-series-of-events-duration-into-concurrent-events">this solution</a>.</p>&#xA;&#xA;<p>Is there a way to achieve that with a single query?</p>&#xA;
<p>I'm not 100% sure but up-coming <a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.0/search-aggregations-pipeline.html" rel="nofollow">pipeline aggregations</a> might solve this problem in near-future in a more elegant way.</p>&#xA;&#xA;<p>Meanwhile you could choose the desired time resolution and at index time in addition to <code>starts_at</code> and <code>ends_at</code> fields you would also generate <code>active_at</code> field. It would be an array of time stamps and you could use either terms (if it is mapped as not_analyzed string) or date_histogram aggregation to get the correct "active events count" for each time-bucket.</p>&#xA;&#xA;<p>The down-side is inflated storage requirements and possibly worse performance since there are more field values to aggregate over. Anyway it shouldn't be too bad if you don't choose a too high time resolution like 1 minute.</p>&#xA;