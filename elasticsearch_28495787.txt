28495787
How do i find the the total items stored in an array variable in Elasticsearch
<p>I have a document let say</p>&#xA;&#xA;<pre><code>{ &#xA;    "id" : "someID", &#xA;    "name" : "someName", &#xA;    "states" : ["A", "B", "C"]  }&#xA;</code></pre>&#xA;&#xA;<p>Now i need to find the sum of the number of states in each document,&#xA;I used the following query,</p>&#xA;&#xA;<pre><code> {&#xA;          "aggs" : {&#xA;                  "value" : {&#xA;                                  "sum" : {&#xA;                                          "_script" : {&#xA;                                                  "script" : "doc[\"states\"].values.length"&#xA;                                          }&#xA;                                  }&#xA;                  }&#xA;          }&#xA;  }' &#xA;</code></pre>&#xA;&#xA;<p>But i am getting the following error,</p>&#xA;&#xA;<pre><code>{&#xA;  "error" : "SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures {[NeZRO8O8Rn2n7hH66anZTw][w3-commsvc][0]: SearchParseException[[w3-commsvc][0]: from[-1],size[-1]: Parse Failure [Failed to parse source [\n{\n\t\"aggs\" : {\n\t\t\"value\" : {\n\t\t\t\t\"sum\" : { \n\t\t\t\t\t\"_script\" : {\n\t\t\t\t\t\t\"script\" : \"doc[\\\"states\\\"].values.length\"\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\t}\n}]]]; nested: SearchParseException[[w3-commsvc][0]: from[-1],size[-1]: Parse Failure [Unexpected token START_OBJECT in [value].]]; }{[NeZRO8O8Rn2n7hH66anZTw][w3-commsvc][1]: SearchParseException[[w3-commsvc][1]: from[-1],size[-1]: Parse Failure [Failed to parse source [\n{\n\t\"aggs\" : {\n\t\t\"value\" : {\n\t\t\t\t\"sum\" : { \n\t\t\t\t\t\"_script\" : {\n\t\t\t\t\t\t\"script\" : \"doc[\\\"states\\\"].values.length\"\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\t}\n}]]]; nested: SearchParseException[[w3-commsvc][1]: from[-1],size[-1]: Parse Failure [Unexpected token START_OBJECT in [value].]]; }{[NeZRO8O8Rn2n7hH66anZTw][w3-commsvc][2]: SearchParseException[[w3-commsvc][2]: from[-1],size[-1]: Parse Failure [Failed to parse source [\n{\n\t\"aggs\" : {\n\t\t\"value\" : {\n\t\t\t\t\"sum\" : { \n\t\t\t\t\t\"_script\" : {\n\t\t\t\t\t\t\"script\" : \"doc[\\\"states\\\"].values.length\"\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\t}\n}]]]; nested: SearchParseException[[w3-commsvc][2]: from[-1],size[-1]: Parse Failure [Unexpected token START_OBJECT in [value].]]; }{[NeZRO8O8Rn2n7hH66anZTw][w3-commsvc][3]: SearchParseException[[w3-commsvc][3]: from[-1],size[-1]: Parse Failure [Failed to parse source [\n{\n\t\"aggs\" : {\n\t\t\"value\" : {\n\t\t\t\t\"sum\" : { \n\t\t\t\t\t\"_script\" : {\n\t\t\t\t\t\t\"script\" : \"doc[\\\"states\\\"].values.length\"\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\t}\n}]]]; nested: SearchParseException[[w3-commsvc][3]: from[-1],size[-1]: Parse Failure [Unexpected token START_OBJECT in [value].]]; }{[NeZRO8O8Rn2n7hH66anZTw][w3-commsvc][4]: SearchParseException[[w3-commsvc][4]: from[-1],size[-1]: Parse Failure [Failed to parse source [\n{\n\t\"aggs\" : {\n\t\t\"value\" : {\n\t\t\t\t\"sum\" : { \n\t\t\t\t\t\"_script\" : {\n\t\t\t\t\t\t\"script\" : \"doc[\\\"states\\\"].values.length\"\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\t}\n}]]]; nested: SearchParseException[[w3-commsvc][4]: from[-1],size[-1]: Parse Failure [Unexpected token START_OBJECT in [value].]]; }]",&#xA;  "status" : 400&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Can someone suggest the correct query??</p>&#xA;
<p>Since you need the number of elements in the "states" field then try this:</p>&#xA;&#xA;<pre><code>{&#xA;     "query": {&#xA;        "match": {&#xA;           "id": "someID"&#xA;        }&#xA;    },&#xA;    "aggs":{&#xA;        "value" :  {  &#xA;            "value_count" : { "field" : "states"} &#xA;        } &#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>you can refer here for more information: <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations-metrics-valuecount-aggregation.html" rel="nofollow">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations-metrics-valuecount-aggregation.html</a></p>&#xA;
<p>This should be the correct query:</p>&#xA;&#xA;<pre><code>{&#xA;  "aggs": {&#xA;    "value": {&#xA;      "sum": {"script": "doc['states'].size()"}&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;