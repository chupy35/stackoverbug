30164367
elasticsearch aggregation - why is a match all query not returning keys that a more specific query is?
<p>I am doing some aggregations. But the results are not at all what I expect, it seems that they are not aggregating over all the documents matching my query in the index, in which case - what good is it? </p>&#xA;&#xA;<p>As an example, First I do this query:</p>&#xA;&#xA;<pre><code>{"index":"datalayer","type":"analysis2","body":{"query":{&#xA;        "match_all" : {}&#xA;    },&#xA;    "aggs" : {&#xA;        "objects" : {&#xA;            "terms" : {&#xA;              "field" : "action"&#xA;            }&#xA;        }&#xA;    }&#xA;}}&#xA;</code></pre>&#xA;&#xA;<p>and the result is 500 hits with aggregations as follows:</p>&#xA;&#xA;<pre><code>"aggregations": {&#xA;    "objects": {&#xA;        "buckets": [&#xA;            {&#xA;                "key": "thing",&#xA;                "doc_count": 278&#xA;            },&#xA;            {&#xA;                "key": "hover",&#xA;                "doc_count": 273&#xA;            },&#xA;            {&#xA;                "key": "embedded",&#xA;                "doc_count": 57&#xA;            },&#xA;            {&#xA;                "key": "view",&#xA;                "doc_count": 50&#xA;            },&#xA;            {&#xA;                "key": "widgets",&#xA;                "doc_count": 49&#xA;            },&#xA;            {&#xA;                "key": "hovered",&#xA;                "doc_count": 20&#xA;            },&#xA;            {&#xA;                "key": "widgetembed",&#xA;                "doc_count": 20&#xA;            },&#xA;            {&#xA;                "key": "products",&#xA;                "doc_count": 19&#xA;            },&#xA;            {&#xA;                "key": "create",&#xA;                "doc_count": 15&#xA;            },&#xA;            {&#xA;                "key": "image",&#xA;                "doc_count": 13&#xA;            }&#xA;        ]&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>that's all well and good but I know I have some where the key should be activation. &#xA;So if I then do the query </p>&#xA;&#xA;<pre><code>{"index":"datalayer","type":"analysis2","body":{"query":{&#xA;        "bool": {&#xA;        "must" : [&#xA;            {"match": {"object": "Widget"}}&#xA;        ]&#xA;    }},&#xA;    "aggs" : {&#xA;        "objects" : {&#xA;            "terms" : {&#xA;              "field" : "action"&#xA;            }&#xA;        }&#xA;    }&#xA;}}&#xA;</code></pre>&#xA;&#xA;<p>then the result is 45 hits with aggregations</p>&#xA;&#xA;<pre><code>"aggregations": {&#xA;        "objects": {&#xA;            "buckets": [&#xA;                {&#xA;                    "key": "widgets",&#xA;                    "doc_count": 41&#xA;                },&#xA;                {&#xA;                    "key": "embedded",&#xA;                    "doc_count": 40&#xA;                },&#xA;                {&#xA;                    "key": "view",&#xA;                    "doc_count": 32&#xA;                },&#xA;                {&#xA;                    "key": "activation",&#xA;                    "doc_count": 9&#xA;                },&#xA;                {&#xA;                    "key": "image",&#xA;                    "doc_count": 4&#xA;                },&#xA;                {&#xA;                    "key": "create",&#xA;                    "doc_count": 3&#xA;                },&#xA;                {&#xA;                    "key": "mapping",&#xA;                    "doc_count": 3&#xA;                },&#xA;                {&#xA;                    "key": "widget",&#xA;                    "doc_count": 3&#xA;                },&#xA;                {&#xA;                    "key": "adding",&#xA;                    "doc_count": 2&#xA;                },&#xA;                {&#xA;                    "key": "edit",&#xA;                    "doc_count": 1&#xA;                }&#xA;            ]&#xA;        }&#xA;    }&#xA;</code></pre>&#xA;&#xA;<p>as can be seen in these aggregations I have a some keys that are not in my first aggregation of actions matching all documents. Why is that? And what do I have to do to get a bucket with all documents actions in it.</p>&#xA;&#xA;<p>I don't think it can just be that I need to do pagination or something because I have also tried to do </p>&#xA;&#xA;<pre><code>{"index":"datalayer","type":"analysis2","body":{"from":0,"size":500,"query":{&#xA;        "match_all" : {}&#xA;    },&#xA;    "aggs" : {&#xA;        "objects" : {&#xA;            "terms" : {&#xA;              "field" : "action"&#xA;            }&#xA;        }&#xA;    }&#xA;}}&#xA;</code></pre>&#xA;&#xA;<p>with the exact same aggregation result of </p>&#xA;&#xA;<pre><code>"aggregations": {&#xA;    "objects": {&#xA;        "buckets": [&#xA;            {&#xA;                "key": "thing",&#xA;                "doc_count": 278&#xA;            },&#xA;            {&#xA;                "key": "hover",&#xA;                "doc_count": 273&#xA;            },&#xA;            {&#xA;                "key": "embedded",&#xA;                "doc_count": 57&#xA;            },&#xA;            {&#xA;                "key": "view",&#xA;                "doc_count": 50&#xA;            },&#xA;            {&#xA;                "key": "widgets",&#xA;                "doc_count": 49&#xA;            },&#xA;            {&#xA;                "key": "hovered",&#xA;                "doc_count": 20&#xA;            },&#xA;            {&#xA;                "key": "widgetembed",&#xA;                "doc_count": 20&#xA;            },&#xA;            {&#xA;                "key": "products",&#xA;                "doc_count": 19&#xA;            },&#xA;            {&#xA;                "key": "create",&#xA;                "doc_count": 15&#xA;            },&#xA;            {&#xA;                "key": "image",&#xA;                "doc_count": 13&#xA;            }&#xA;        ]&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>So, I'm hoping someone can explain to me why the I am not seeing the keys in the buckets that I am expecting here? </p>&#xA;
<p>From <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#_size" rel="nofollow">the documentation</a>:</p>&#xA;&#xA;<blockquote>&#xA;  <p>By default, the terms aggregation will return the buckets for the top ten terms ordered by the doc_count. One can change this default behaviour by setting the size parameter.</p>&#xA;</blockquote>&#xA;&#xA;<p>So, you need to specify a <code>"size"</code> of a number larger than 10 to see more buckets. Or set to <code>0</code> to see all the buckets. From the same documentation:</p>&#xA;&#xA;<blockquote>&#xA;  <p>If set to 0, the size will be set to Integer.MAX_VALUE.</p>&#xA;</blockquote>&#xA;&#xA;&#xA;&#xA;<pre><code>   "aggs" : {&#xA;        "objects" : {&#xA;            "terms" : {&#xA;              "field" : "action",&#xA;              "size": 0&#xA;            }&#xA;        }&#xA;    }&#xA;</code></pre>&#xA;