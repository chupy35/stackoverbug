32286763
Elasticsearch: how to scope aggregations to your query and filter?
<p>I have been playing around with elasticsearch query and filter for some time now but never worked with aggregations before. The idea that we can scope the aggregations with our query seems quite amazing to me but I want to understand how to do it properly so that I do not make any mistakes. Currently all my search queries are designed this way:</p>&#xA;&#xA;<pre><code>{&#xA;    "query": {&#xA;&#xA;    },&#xA;    "filter": {&#xA;&#xA;    },&#xA;    "from": 0,&#xA;    "size": 60&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Now, when I added some aggregation buckets, the structure became this:</p>&#xA;&#xA;<pre><code>{&#xA;    "aggs": {&#xA;      "all_colors": {&#xA;        "terms": {&#xA;          "field": "color.name"&#xA;        }&#xA;      },&#xA;      "all_brands": {&#xA;        "terms": {&#xA;          "field": "brand_slug"&#xA;        }&#xA;      },&#xA;      "all_sizes": {&#xA;        "terms": {&#xA;          "field": "sizes"&#xA;        }&#xA;      }&#xA;    },&#xA;    "query": {&#xA;&#xA;    },&#xA;    "filter": {&#xA;&#xA;    },&#xA;    "from": 0,&#xA;    "size": 60&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>However, the results of the aggregation are always the same irrespective of what info I provide in filter. </p>&#xA;&#xA;<p>Now, when I changed the query structure to something like this, it started showing different results:</p>&#xA;&#xA;<pre><code>{&#xA;    "aggs": {&#xA;      "all_colors": {&#xA;        "terms": {&#xA;          "field": "color.name"&#xA;        }&#xA;      },&#xA;      "all_brands": {&#xA;        "terms": {&#xA;          "field": "brand_slug"&#xA;        }&#xA;      },&#xA;      "all_sizes": {&#xA;        "terms": {&#xA;          "field": "sizes"&#xA;        }&#xA;      }&#xA;    },&#xA;    "query": {&#xA;        "filtered": {&#xA;            "query": {&#xA;&#xA;            },&#xA;            "filter": {&#xA;&#xA;            }        &#xA;        }&#xA;    },&#xA;    "from": 0,&#xA;    "size": 60&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Does it mean I will have to change the structure of my search queries everywhere to this new filtered type of structure ? Is there any other workaround which allows me to achieve desired results without having to change that much of code ?</p>&#xA;&#xA;<p>Also, another thing I observed is that if my <code>brand_slug</code> field contains multiple keywords like "peter england", then both of these are returned in separate buckets like this:</p>&#xA;&#xA;<pre><code>{&#xA;    "buckets": [&#xA;        {&#xA;           "key": "england",&#xA;           "doc_count": 368&#xA;        },&#xA;        {&#xA;           "key": "peter",&#xA;           "doc_count": 368&#xA;        }&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>How can I ensure that both these end up in a same bucket like this:</p>&#xA;&#xA;<pre><code>{&#xA;    "buckets": [&#xA;        {&#xA;           "key": "peter england",&#xA;           "doc_count": 368&#xA;        }&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p><strong>UPDATE:</strong> This second part I have been able to accomplish by indexing brand, color and sizes differently like this:</p>&#xA;&#xA;<pre><code>"sizes": {&#xA;    "type": "string",&#xA;    "fields": {&#xA;        "raw": {&#xA;            "type": "string",&#xA;            "index": "not_analyzed"&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;
<p>What you've noticed is by design. Have a look at <a href="https://stackoverflow.com/a/28263684/1797393">my answer</a> to a similar question on SO. Basically, input to both aggregation and filter sections is the output of query section. <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-filtered-query.html" rel="nofollow noreferrer">Filtered Query</a> as you've suggested would be the best way to achieve the results you desire. There is another way too. You can use <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-filter-aggregation.html" rel="nofollow noreferrer">Filter Aggregation</a>. Then you would not need to change your query and filter sections but simply copy the filter section inside the aggregation sections but that in my opinion would be an overkill and a violation of the <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" rel="nofollow noreferrer">DRY principle</a> in general.</p>&#xA;