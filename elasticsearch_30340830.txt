30340830
Elasticsearch DSL: Aggregation
<p>Shown below is the structure of type (kind of a table) of my data.</p>&#xA;&#xA;<pre><code> Aircraft | Duration &#xA; A320     | 0.95&#xA; A320     | 0.55&#xA; A321     | 16.50&#xA; A321     | 3.9&#xA;</code></pre>&#xA;&#xA;<p>In this data, I want to perform a ceil() on duration, followed by a groupBy operation to get following output:</p>&#xA;&#xA;<pre><code> Aircraft | Duration | Count&#xA; A320     | 1        |  2&#xA; A321     | 17       |  1&#xA; A321     | 4        |  1&#xA;</code></pre>&#xA;
<p>I've based myself on the following mapping type (edited <code>Duration</code> as string):</p>&#xA;&#xA;<pre><code>curl -XPUT localhost:9200/tests -d '&#xA;{&#xA;  "mappings": {&#xA;    "test1": {&#xA;      "properties": {&#xA;        "Aircraft": {&#xA;          "type": "string"&#xA;        },&#xA;        "Duration": {&#xA;          "type": "string"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}'&#xA;</code></pre>&#xA;&#xA;<p>And created four documents that match your data table above.</p>&#xA;&#xA;<pre><code>curl -XPOST localhost:9200/tests/_bulk -d '&#xA;{"index": {"_type": "test1", "_id": 1}}&#xA;{"Aircraft": "A320", "Duration": "0.95"}&#xA;{"index": {"_type": "test1", "_id": 2}}&#xA;{"Aircraft": "A320", "Duration": "0.55"}&#xA;{"index": {"_type": "test1", "_id": 3}}&#xA;{"Aircraft": "A321", "Duration": "16.50"}&#xA;{"index": {"_type": "test1", "_id": 4}}&#xA;{"Aircraft": "A321", "Duration": "3.9"}&#xA;'&#xA;</code></pre>&#xA;&#xA;<p>The aggregation query that will return the results you expect would look like this:</p>&#xA;&#xA;<pre><code>curl -XPOST localhost:9200/tests/_search -d '&#xA;{&#xA;  "size": 0,&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "terms": {&#xA;          "Aircraft": [&#xA;            "a320",&#xA;            "b737"&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "aircrafts": {&#xA;      "terms": {&#xA;        "field": "Aircraft"&#xA;      },&#xA;      "aggs": {&#xA;        "duration": {&#xA;          "terms": {&#xA;            "script": "Math.ceil(doc['Duration'].value as double)"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}'&#xA;</code></pre>&#xA;&#xA;<p>The output of that query looks like this:</p>&#xA;&#xA;<p><img src="https://i.stack.imgur.com/zcXol.png" alt="enter image description here"></p>&#xA;&#xA;<p>Note: Make sure to enable scripting in your <code>elasticsearch.yml</code> file by adding</p>&#xA;&#xA;<pre><code>script.disable_dynamic: false&#xA;</code></pre>&#xA;