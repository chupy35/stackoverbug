32642842
How to narrow down the current aggregation context to a specific scope within set of documents returned from Filter Aggregation?
<p>I've nested object mapping. </p>&#xA;&#xA;<p>Here is sample data </p>&#xA;&#xA;<pre><code>         {&#xA;        "_index": "simpleindex",&#xA;        "_type": "games",&#xA;        "_id": "AU_eC-Uzt6KxlUliF68N",&#xA;        "_score": 1,&#xA;        "_source": {&#xA;           "continents": [&#xA;              {&#xA;                 "name": "Asia",&#xA;                 "countries": [&#xA;                    {&#xA;                       "name": "India",&#xA;                       "states": [&#xA;                          {&#xA;                             "name": "TN",&#xA;                             "game": "soccor",&#xA;                             "wins": 1&#xA;                          }&#xA;                       ]&#xA;                    },&#xA;                    {&#xA;                       "name": "India",&#xA;                       "states": [&#xA;                          {&#xA;                             "name": "KA",&#xA;                             "game": "soccor",&#xA;                             "wins": 1&#xA;                          }&#xA;                       ]&#xA;                    }&#xA;                 ]&#xA;              }&#xA;           ]&#xA;        }&#xA;     },&#xA;     {&#xA;        "_index": "simpleindex",&#xA;        "_type": "games",&#xA;        "_id": "AU_eCf5dt6KxlUliF637",&#xA;        "_score": 1,&#xA;        "_source": {&#xA;           "continents": [&#xA;              {&#xA;                 "name": "Asia",&#xA;                 "countries": [&#xA;                    {&#xA;                       "name": "India",&#xA;                       "states": [&#xA;                          {&#xA;                             "name": "TN",&#xA;                             "game": "soccor",&#xA;                             "wins": 1&#xA;                          }&#xA;                       ]&#xA;                    }&#xA;                 ]&#xA;              }&#xA;           ]&#xA;        }&#xA;     },&#xA;     {&#xA;        "_index": "simpleindex",&#xA;        "_type": "games",&#xA;        "_id": "AU_eDIdXt6KxlUliF69i",&#xA;        "_score": 1,&#xA;        "_source": {&#xA;           "continents": [&#xA;              {&#xA;                 "name": "Asia",&#xA;                 "countries": [&#xA;                    {&#xA;                       "name": "India",&#xA;                       "states": [&#xA;                          {&#xA;                             "name": "TN",&#xA;                             "game": "soccor",&#xA;                             "wins": 1&#xA;                          }&#xA;                       ]&#xA;                    },&#xA;                    {&#xA;                       "name": "India",&#xA;                       "states": [&#xA;                          {&#xA;                             "name": "KA",&#xA;                             "game": "soccor",&#xA;                             "wins": 1&#xA;                          }&#xA;                       ]&#xA;                    },&#xA;                    {&#xA;                       "name": "Pak",&#xA;                       "states": [&#xA;                          {&#xA;                             "name": "NA",&#xA;                             "game": "soccor",&#xA;                             "wins": 1&#xA;                          }&#xA;                       ]&#xA;                    }&#xA;                 ]&#xA;              }&#xA;           ]&#xA;        }&#xA;     }&#xA;</code></pre>&#xA;&#xA;<p>Here is my Filtered Aggregation that returns documents that matches the filter criteria (ie. continent should be 'Asia' AND country should be 'India')</p>&#xA;&#xA;<pre><code>{&#xA;"aggs": {&#xA;"DocumentSet": {&#xA;  "filter": {&#xA;    "and": {&#xA;      "filters": [&#xA;        {&#xA;          "nested": {&#xA;            "path": "continents",&#xA;            "query": {&#xA;              "match": {&#xA;                "continents.name": "asia"&#xA;              }&#xA;            }&#xA;          }&#xA;        },&#xA;        {&#xA;          "nested": {&#xA;            "path": "continents.countries",&#xA;            "query": {&#xA;              "match": {&#xA;                "continents.countries.name": "india"&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "continents": {&#xA;      "nested": {&#xA;        "path": "continents"&#xA;      },&#xA;      "aggs": {&#xA;        "countries": {&#xA;          "nested": {&#xA;            "path": "continents.countries"&#xA;          },&#xA;          "aggs": {&#xA;            "states": {&#xA;              "nested": {&#xA;                "path": "continents.countries.states"&#xA;              },&#xA;              "aggs": {&#xA;                "count": {&#xA;                  "value_count": {&#xA;                    "field": "continents.countries.states.wins"&#xA;                  }&#xA;                }&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}}}&#xA;</code></pre>&#xA;&#xA;<p>And here is the result (copy pasted only the aggreagation here)</p>&#xA;&#xA;<pre><code> "aggregations": {&#xA;  "DocumentSet": {&#xA;     "doc_count": 3,&#xA;     "continents": {&#xA;        "doc_count": 3,&#xA;        "countries": {&#xA;           "doc_count": 6,&#xA;           "states": {&#xA;              "doc_count": 6,&#xA;              "count": {&#xA;                 "value": 6&#xA;              }&#xA;           }&#xA;        }&#xA;     }&#xA;  }&#xA;</code></pre>&#xA;&#xA;<p>}</p>&#xA;&#xA;<p>My intention is to get "wins" only from "continets.name=asia AND countries.name=india". &#xA;Filter works as expected, not sure if its possible to narrow down the aggregation scope only to countries.name=india. Essentially another level of scope on the docs returned by Filter aggregation. When it works, leaf aggregation count should 5 instead of 6.</p>&#xA;&#xA;<p>Appreciate any help !!</p>&#xA;&#xA;<p>Thanks !</p>&#xA;
<p>Try this aggregation:</p>&#xA;&#xA;<pre><code>{&#xA;  "aggs": {&#xA;    "continents": {&#xA;      "nested": {&#xA;        "path": "continents"&#xA;      },&#xA;      "aggs": {&#xA;        "asia_continent": {&#xA;          "filter": {&#xA;            "query": {&#xA;              "match": {&#xA;                "continents.name": "asia"&#xA;              }&#xA;            }&#xA;          },&#xA;          "aggs": {&#xA;            "countries": {&#xA;              "nested": {&#xA;                "path": "continents.countries"&#xA;              },&#xA;              "aggs": {&#xA;                "india_country": {&#xA;                  "filter": {&#xA;                    "query": {&#xA;                      "match": {&#xA;                        "continents.countries.name": "india"&#xA;                      }&#xA;                    }&#xA;                  },&#xA;                  "aggs": {&#xA;                    "states": {&#xA;                      "nested": {&#xA;                        "path": "continents.countries.states"&#xA;                      },&#xA;                      "aggs": {&#xA;                        "count": {&#xA;                          "value_count": {&#xA;                            "field": "continents.countries.states.wins"&#xA;                          }&#xA;                        }&#xA;                      }&#xA;                    }&#xA;                  }&#xA;                }&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;