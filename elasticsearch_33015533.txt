33015533
elasticsearch "having not" query
<p>Some documents has category fields.. Some of these docs has category fields its value equals to "-1". I need a query return documents which have category fields and "not equal to -1".</p>&#xA;&#xA;<p>I tried this:</p>&#xA;&#xA;<pre><code>GET webproxylog/_search&#xA;{&#xA;  "query": {&#xA;    "filtered": {&#xA;&#xA;      "filter": {&#xA;        "not":{&#xA;          "filter": {"and": {&#xA;            "filters": [&#xA;              {"term": {&#xA;                "category": "-1"&#xA;              }&#xA;&#xA;              },&#xA;              {&#xA;                "missing": {&#xA;                "field": "category"&#xA;                }&#xA;              }&#xA;            ]&#xA;          }}&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>But not work.. returns docs not have "category field" </p>&#xA;&#xA;<p>EDIT</p>&#xA;&#xA;<p>Mapping:</p>&#xA;&#xA;<pre><code>    {&#xA;   "webproxylog": {&#xA;      "mappings": {&#xA;         "accesslog": {&#xA;            "properties": {&#xA;               "category": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed"&#xA;               },&#xA;               "clientip": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed"&#xA;               },&#xA;               "clientmac": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed"&#xA;               },&#xA;               "clientname": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed"&#xA;               },&#xA;               "duration": {&#xA;                  "type": "long"&#xA;               },&#xA;               "filetype": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed"&#xA;               },&#xA;               "hierarchycode": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed"&#xA;               },&#xA;               "loggingdate": {&#xA;                  "type": "date",&#xA;                  "format": "dateOptionalTime"&#xA;               },&#xA;               "reqmethod": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed"&#xA;               },&#xA;               "respsize": {&#xA;                  "type": "long"&#xA;               },&#xA;               "resultcode": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed"&#xA;               },&#xA;               "url": {&#xA;                  "type": "string",&#xA;                  "analyzer": "slash_analyzer"&#xA;               },&#xA;               "user": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed"&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;
<p>If your <code>category</code> field is <code>string</code> and is analyzed by default, then your <code>-1</code> will be indexed as <code>1</code> (stripping the <code>minus</code> sign).</p>&#xA;&#xA;<p>You will need that field to be <code>not_analyzed</code> or to add a sub-field which is not analyzed (as my solution below).</p>&#xA;&#xA;<p>Something like this:</p>&#xA;&#xA;<pre><code>DELETE test&#xA;&#xA;PUT /test&#xA;{&#xA;  "mappings": {&#xA;    "test": {&#xA;      "properties": {&#xA;        "category": {&#xA;          "type": "string",&#xA;          "fields": {&#xA;            "notAnalyzed": {&#xA;              "type": "string",&#xA;              "index": "not_analyzed"&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;&#xA;POST /test/test/1&#xA;{"category": "-1"}&#xA;POST /test/test/2&#xA;{"category": "2"}&#xA;POST /test/test/3&#xA;{"category": "3"}&#xA;POST /test/test/4&#xA;{"category": "4"}&#xA;POST /test/test/5&#xA;{"category2": "-1"}&#xA;&#xA;GET /test/test/_search&#xA;{&#xA;  "query": {&#xA;    "bool": {&#xA;      "must_not": [&#xA;        {&#xA;          "term": {&#xA;            "category.notAnalyzed": {&#xA;              "value": "-1"&#xA;            }&#xA;          }&#xA;        },&#xA;        {&#xA;          "filtered": {&#xA;            "filter": {&#xA;              "missing": {&#xA;                "field": "category"&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;