34506632
How to exclude documents using has_child filter
<p>I have following mapping in my elasticsearch:</p>&#xA;&#xA;<p><code>my_parent</code> - Parent type</p>&#xA;&#xA;<p><code>my_child</code> - Child type (has many-to-one relation with <code>my_parent</code>)</p>&#xA;&#xA;<p>Suppose <code>my_child</code> has field <code>name</code>.</p>&#xA;&#xA;<p>What I want to do is to get all <code>my_parent</code> documents that does not have any children documents with <code>name</code> equals to <code>test</code>.</p>&#xA;&#xA;<p>Here is an equivalent in SQL:</p>&#xA;&#xA;<p><code>SELECT * FROM my_parent WHERE id NOT IN (&#xA;    SELECT DISTINCT parent_id&#xA;    FROM my_child&#xA;    WHERE name = 'test'&#xA;)</code></p>&#xA;&#xA;<p>Can this be done in elasticsearch in a single query? Or I should use 2 queries?</p>&#xA;
<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/has-child.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/guide/current/has-child.html</a></p>&#xA;&#xA;<p>You can look into the above link, there they have mentioned how to get parent based on child...</p>&#xA;&#xA;<p>You take that query and put it inside a must_not clause of a bool filter/query..</p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/combining-filters.html#bool-filter?q=bool" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/guide/current/combining-filters.html#bool-filter?q=bool</a> filter</p>&#xA;&#xA;<p>Here is the link on how to use bool filter..</p>&#xA;&#xA;<p>Let me know if you need a more deeper explaination</p>&#xA;
<p>You can use <code>has_child</code> and <code>bool</code> <code>must_not</code> queries to achieve what you want.</p>&#xA;&#xA;<pre><code>POST &lt;indexname&gt;/my_parent/_search&#xA;{&#xA;   "query": {&#xA;      "bool": {&#xA;         "must_not": [&#xA;            {&#xA;               "has_child": {&#xA;                  "type": "my_child",&#xA;                  "query": {&#xA;                     "term": {&#xA;                        "name": {&#xA;                           "value": "test"&#xA;                        }&#xA;                     }&#xA;                  }&#xA;               }&#xA;            }&#xA;         ]&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;