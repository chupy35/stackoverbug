31159162
Query with terms does not work properly
<p>I have this document in Elasticsearch (1.6) </p>&#xA;&#xA;<pre><code>{&#xA;"_index": "onkopedia",&#xA;"_type": "document_",&#xA;"_id": "0afa26afc2d1440a8ed03dac0e8511fc",&#xA;"_version": 1,&#xA;"_score": null,&#xA;"_source": {&#xA;"description": "",&#xA;"contributors": [ ],&#xA;"metaTypeName": "Connector",&#xA;"sortableTitle": "mammakarzinom der frau",&#xA;"subject": [ ],&#xA;"authorizedUsers": [&#xA;"Anonymous"&#xA;],&#xA;"language": "",&#xA;"title": "Mammakarzinom der Frau",&#xA;"url": "http://dev1.veit-schiele.de:9080/onkopedia/de/onkopedia/guidelines/mammakarzinom-der-frau",&#xA;"author": "ajung",&#xA;"modified": "2015-05-11T05:21:14",&#xA;"metaType": "xmldirector.plonecore.connector",&#xA;"content": " Mammakarzinom der Frau Stand: Januar 2013 Autoren der aktuellen .....",&#xA;"authorName": "ajung",&#xA;"created": "2015-05-11T05:21:14",&#xA;"review_state": "published"&#xA;},&#xA;"sort": [&#xA;null&#xA;]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>containing a key</p>&#xA;&#xA;<pre><code>'authorizedUsers': ['Anonymous']&#xA;</code></pre>&#xA;&#xA;<p>The following query is supposed to return the document above however it does not:</p>&#xA;&#xA;<pre><code> {&#xA;  "sort": [&#xA;    "_score"&#xA;  ], &#xA;  "from": 0, &#xA;  "fields": [&#xA;    "url", &#xA;    "title", &#xA;    "description", &#xA;    "metaType", &#xA;    "metaTypeName", &#xA;    "author", &#xA;    "authorName", &#xA;    "contributors", &#xA;    "modified", &#xA;    "subject", &#xA;    "review_state", &#xA;    "language", &#xA;    "content"&#xA;  ], &#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "and": [&#xA;          {&#xA;            "terms": {&#xA;              "execution": "or", &#xA;              "metaType": [&#xA;                "Document", &#xA;                "FormFolder", &#xA;                "Collection", &#xA;                "Discussion Item", &#xA;                "News Item", &#xA;                "xmldirector.plonecore.connector", &#xA;                "CaptchaField"&#xA;              ]&#xA;            }&#xA;          }, &#xA;          {&#xA;            "terms": {&#xA;              "execution": "or", &#xA;              "authorizedUsers": [&#xA;                "Manager", &#xA;                "Authenticated", &#xA;                "Anonymous", &#xA;                "user:ajung"&#xA;              ]&#xA;            }&#xA;          }&#xA;        ]&#xA;      }, &#xA;      "query": {&#xA;        "query_string": {&#xA;          "query": "mammakarzinom", &#xA;          "default_operator": "AND", &#xA;          "fields": [&#xA;            "title^3", &#xA;            "contributors^2", &#xA;            "subject^2", &#xA;            "description", &#xA;            "content"&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  }, &#xA;  "highlight": {&#xA;    "fields": {&#xA;      "content": {&#xA;        "fragment_size": 250, &#xA;        "number_of_fragments": 3&#xA;      }, &#xA;      "description": {&#xA;        "fragment_size": 250, &#xA;        "number_of_fragments": 2&#xA;      }, &#xA;      "title": {&#xA;        "number_of_fragments": 0&#xA;      }&#xA;    }&#xA;  }, &#xA;  "size": 15&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The query without the filter for 'authorizedUsers' does return the document.&#xA;Why? 'Anonymous' as value for 'authorizedUsers' is available within the query, so I would expect that the document would be found by the first query, or?</p>&#xA;&#xA;<pre><code>{&#xA;  "sort": [&#xA;    "_score"&#xA;  ], &#xA;  "from": 0, &#xA;  "fields": [&#xA;    "url", &#xA;    "title", &#xA;    "description", &#xA;    "metaType", &#xA;    "metaTypeName", &#xA;    "author", &#xA;    "authorName", &#xA;    "contributors", &#xA;    "modified", &#xA;    "subject", &#xA;    "review_state", &#xA;    "language", &#xA;    "content"&#xA;  ], &#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "and": [&#xA;          {&#xA;            "terms": {&#xA;              "execution": "or", &#xA;              "metaType": [&#xA;                "Document", &#xA;                "FormFolder", &#xA;                "Collection", &#xA;                "Discussion Item", &#xA;                "News Item", &#xA;                "xmldirector.plonecore.connector", &#xA;                "CaptchaField"&#xA;              ]&#xA;            }&#xA;          }&#xA;&#xA;        ]&#xA;      }, &#xA;      "query": {&#xA;        "query_string": {&#xA;          "query": "mammakarzinom", &#xA;          "default_operator": "AND", &#xA;          "fields": [&#xA;            "title^3", &#xA;            "contributors^2", &#xA;            "subject^2", &#xA;            "description", &#xA;            "content"&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  }, &#xA;  "highlight": {&#xA;    "fields": {&#xA;      "content": {&#xA;        "fragment_size": 250, &#xA;        "number_of_fragments": 3&#xA;      }, &#xA;      "description": {&#xA;        "fragment_size": 250, &#xA;        "number_of_fragments": 2&#xA;      }, &#xA;      "title": {&#xA;        "number_of_fragments": 0&#xA;      }&#xA;    }&#xA;  }, &#xA;  "size": 15&#xA;}&#xA;</code></pre>&#xA;
<p>Probably your analyzer for <code>authorizedUsers</code> field is lowercasing the value itself. So, in your index the actual values is <code>anonymous</code> (lowercase <code>a</code>).</p>&#xA;&#xA;<p>Try this filter:</p>&#xA;&#xA;<pre><code>     {&#xA;        "terms": {&#xA;          "execution": "or", &#xA;          "authorizedUsers": [&#xA;            "manager", &#xA;            "authenticated", &#xA;            "anonymous", &#xA;            "user:ajung"&#xA;          ]&#xA;        }&#xA;      }&#xA;</code></pre>&#xA;&#xA;<p>meaning, search the index with the values that are actually there.&#xA;One more thing: <code>terms</code> is not analyzing the input text. This means that if you search for <code>Anonymous</code> then this is what it will look into the index. Since you have <code>anonymous</code> in the index, it will not match.</p>&#xA;