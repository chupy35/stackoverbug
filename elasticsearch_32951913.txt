32951913
Passing dynamic value to script query in Elastic Search
<p>I have two mappings in my index. One of them stores some amount in different currencies and other stores current conversion rate. Records in each look like this:</p>&#xA;&#xA;<pre><code>http://localhost:9200/transactions/amount&#xA;</code></pre>&#xA;&#xA;<pre class="lang-json prettyprint-override"><code>[{&#xA;    _index: "transactions",&#xA;    _type: "amount",&#xA;    _id: "AVA3fjawwMA2f8TzMTbM",&#xA;    _score: 1,&#xA;    _source: {&#xA;        balance: 1000,&#xA;        currency:"usd"&#xA;    }&#xA;},&#xA;{&#xA;    _index: "transactions",&#xA;    _type: "amount",&#xA;    _id: "AVA3flUWwMA2f8TzMTbN",&#xA;    _score: 1,&#xA;    _source: {&#xA;        balance: 2000,&#xA;        currency:"inr"&#xA;    }&#xA;}]&#xA;</code></pre>&#xA;&#xA;<p>and</p>&#xA;&#xA;<pre><code>http://localhost:9200/transactions/conversions&#xA;</code></pre>&#xA;&#xA;<pre class="lang-json prettyprint-override"><code>{&#xA;    _index: "transactions",&#xA;    _type: "conversions",&#xA;    _id: "rates",&#xA;    _score: 1,&#xA;    _source: {&#xA;        "usd": 1,&#xA;        "inr":62.6&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I want to query the data from <code>amount</code> and apply current conversion rates from <code>conversions</code> in a single query and get result. </p>&#xA;&#xA;<p>I tried using scripted query and was able to convert the data based on passed params like:</p>&#xA;&#xA;<pre><code>GET _search&#xA;</code></pre>&#xA;&#xA;<pre class="lang-json prettyprint-override"><code>{&#xA;   "query": {&#xA;      "match_all": {}&#xA;   },&#xA;   "script_fields" : {&#xA;        "test1" : {&#xA;            "script" : "_source.balance * factor",&#xA;            "params" : {&#xA;                "factor"  : 63.2&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>However in my case passed params are to be fetched from result of another query. </p>&#xA;&#xA;<p>I want to visualize my data in Kibana in common currency. Kibana supports scripted queries. As per my knowledge all visualizations in Kibana can correspond to a single elastic search query so I don't have an option to do multiple queries. </p>&#xA;&#xA;<p>I also tried exploring the possibility of using <a href="https://www.elastic.co/blog/terms-filter-lookup" rel="nofollow">https://www.elastic.co/blog/terms-filter-lookup</a> and adding some dynamic fields to each document in result set. However I don't think term filter allows that. </p>&#xA;
<p>Assuming, you're trying to always plot transactions in USD, you could try the approach described in <a href="https://stackoverflow.com/questions/21289149/trouble-with-has-parent-query-containing-scripted-function-score">the accepted answer here</a>:</p>&#xA;&#xA;<p>In essence:</p>&#xA;&#xA;<ol>&#xA;<li>Model your data parent-child with each <code>conversions</code> document being a parent of all child <code>transactions</code> document in the same foreign currency.  (And <code>conversions</code> having a standard fieldname like <code>"conversion_divisor": 62.6</code>)</li>&#xA;<li>Include a <code>has_parent</code> query clause for all relevant currency conversions.</li>&#xA;<li>Use a <code>function_score</code> (<code>script_score</code>) query to access the foreign currency multiple in each parent and generate a <code>_score</code> for each transaction by dividing the transaction amount by the foreign currency <code>conversion_divisor</code>.</li>&#xA;<li>Plot the <code>_score</code> in Kibana</li>&#xA;</ol>&#xA;