30681671
Elasticsearch unexpected results when deleting by filtered query
<p>I am trying to delete a set of documents that do not match a field with a certain value by sending the following data through a DELETE request to "localhost:9200/products/phone":</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "match_all": []&#xA;      },&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [],&#xA;          "should": [],&#xA;          "must_not": {&#xA;            "term": {&#xA;              "batch": 1433585920&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>But this query ends up deleting ALL documents of the /products/phone type, including the documents that have the 1433586041 value in 'batch'. What am I doing wrong?</p>&#xA;
<p>Deleting in the way that you are doing it is deleting the index's type, <code>phone</code>:</p>&#xA;&#xA;<pre><code>curl -XDELETE host:9200/products/phone -d '{ ... }'&#xA;</code></pre>&#xA;&#xA;<p>The request payload is ignored in this case. <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete-by-query.html" rel="nofollow">You need to use the <code>_query</code> endpoint</a>:</p>&#xA;&#xA;<pre><code>curl -XDELETE host:9200/products/phone/_query -d '{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must_not": {&#xA;            "term": {&#xA;              "batch": 1433585920&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}'&#xA;</code></pre>&#xA;&#xA;<p>All of that said, <a href="https://github.com/elastic/elasticsearch/issues/10067" rel="nofollow">Delete By Query is a little bit trappy and I suggest that you do <em>not</em> use it</a>. The <a href="https://github.com/elastic/elasticsearch/issues/7052" rel="nofollow">goal is to completely rewrite it</a>, but that has not happened yet -- the suggestion is therefore to use the Scan/Scroll API to find documents matching your filter, then delete them using the Bulk API by ID. It's more effort, but it will be a better solution for cluster stability until the Delete By Query endpoint is rewritten.</p>&#xA;