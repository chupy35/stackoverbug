31978202
Elasticsearch: has_child query with children aggregation - bucket counts are wrong
<p>I'm attempting to find parents based on matches in their children and retrieve children term aggregations for the matches.  For some reason, the bucket count for the children aggregation is showing a higher count than actual results (I would be happy if it showed the count of the parents - or the children - in the particular children bucket).</p>&#xA;&#xA;<p>The query is similar to the following (NOTE: I use the filtered query as I will later add a filter in addition to the query):</p>&#xA;&#xA;<pre><code>{&#xA;"query" : {&#xA;    "filtered" : {&#xA;        "query" : {&#xA;            "has_child" : {&#xA;            "type" : "blog_tag",&#xA;            "query" : {&#xA;                "filtered" : {&#xA;                    "query" : {&#xA;                        "term" : {&#xA;                            "tag" : "something"&#xA;                        }&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;},&#xA;"aggs" : {&#xA;    "my_children" : {&#xA;        "children" : {&#xA;            "type" : "my_child_type"&#xA;        },&#xA;        "aggs" : {&#xA;            "field_name" : {&#xA;                "terms" : {&#xA;                    "field" : { "blog.blog_tag.field_name" }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}     &#xA;</code></pre>&#xA;&#xA;<p>}</p>&#xA;&#xA;<p>What is the correct way to do this?</p>&#xA;
<p>The problem was as noted in the comments.  The solution was to filter the aggregation with the query,</p>&#xA;&#xA;<pre><code>"query" : {&#xA;    "filtered" : {&#xA;        "query" : {&#xA;            "has_child" : {&#xA;            "type" : "blog_tag",&#xA;            "query" : {&#xA;                "filtered" : {&#xA;                    "query" : {&#xA;                        "term" : {&#xA;                            "tag" : "something"&#xA;                        }&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;},&#xA;"aggs" : {&#xA;    "my_children" : {&#xA;        "children" : {&#xA;            "type" : "my_child_type"&#xA;        },&#xA;        "aggs" : {&#xA;            "results" : {&#xA;                "filter" : {&#xA;                    "query" : {&#xA;                        "filtered" : {&#xA;                            "query" : {&#xA;                                "term" : {&#xA;                                    "tag" : "something"&#xA;                                }&#xA;                            }&#xA;                        }&#xA;                    }&#xA;                },&#xA;                "aggs" : {&#xA;                    "field_name" : {&#xA;                        "terms" : {&#xA;                            "field" : { "blog.blog_tag.field_name" }&#xA;                       }&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;