30686667
Elasticsearch DELETE too fast after index?
<p>I use a simple script that exports data from a MySQL table to and ES type. The difference between the MySQL table and the ES type is that the MySQL table holds 100000 products of which only 500 are actually used and I need to keep the ES type clean so that it holds only the 500 products that are actually used.</p>&#xA;&#xA;<p>In order to this, every time I run the export script, I add a field named 'batch' with a unique value to every document I am indexing. Let's assume i ran an export yesterday with Batch=1 and an export today with Batch=2. The results in ES would now be:</p>&#xA;&#xA;<pre><code>Name             Batch&#xA;Document 1       2&#xA;Document 2       2&#xA;Document 3       1&#xA;Document 4       2&#xA;Document 5       2&#xA;</code></pre>&#xA;&#xA;<p>Now I will run an ES query to find all docs that do not have Batch=2 and then DELETE them.</p>&#xA;&#xA;<p>The problem is that it seems even though I am executing the DELETE's after the indexes, ES is deleting documents that should not be deleted. I get the feeling the delete actions are performed before the indexing actions are completed, even though I am sending the index actions before the delete actions. </p>&#xA;&#xA;<p>Perhaps that sounds stupid but I have no idea what else it could be..</p>&#xA;&#xA;<p><strong>UPDATE</strong> I can confirm this is indeed the case; adding a command to sleep for a few seconds after the indexing fixes the issue. But I wonder if there is a better way to handle this?</p>&#xA;
<p>Indeed, Elasticsearch indexes in what it is called near-real time. </p>&#xA;&#xA;<p>Take a look to this section of Elasticsearch The definitive guide</p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/near-real-time.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/guide/current/near-real-time.html</a></p>&#xA;&#xA;<p>If you need to "flush", you can use what it's called refresh API (in that same page) with something like:</p>&#xA;&#xA;<p><code>POST /_refresh</code></p>&#xA;&#xA;<p>But it has drawbacks.</p>&#xA;