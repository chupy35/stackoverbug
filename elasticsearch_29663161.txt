29663161
Elastic search aggregations buckets counting email format as two different bucket key .
<p>I have field stored as "user1@user.com " .</p>&#xA;&#xA;<p>Using aggregations json query :</p>&#xA;&#xA;<pre><code>"aggregations": {&#xA;                "email-terms": {&#xA;                    "terms": {&#xA;                        "field": "l_obj.email",&#xA;                        "size": 0,&#xA;                        "shard_size": 0,&#xA;                        "order": {&#xA;                            "_count": "desc"&#xA;                        }&#xA;                    }&#xA;                }&#xA;            }&#xA;&#xA;&#xA;I am getting response :&#xA;&#xA;"buckets" : [&#xA;{&#xA;"key" : "user.com",&#xA;"doc_count" : 1&#xA;},&#xA;{&#xA;"key" : "user1",&#xA;"doc_count" : 1&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>instead of </p>&#xA;&#xA;<pre><code>"buckets" : [&#xA;{&#xA;"key" : "user1@user.com",&#xA;"doc_count" : 1&#xA;}&#xA;]&#xA;</code></pre>&#xA;&#xA;<p>Same issue persists for string type likes : user1.user2.user.com ,I am doing terms aggregations .&#xA;Am i missing something here ?</p>&#xA;
<p>You need to set <a href="http://www.elastic.co/guide/en/elasticsearch/guide/current/mapping-intro.html#_index_2" rel="nofollow"><code>"index": "not_analyzed"</code></a> on the <code>"email"</code> field in your mapping.</p>&#xA;&#xA;<p>If I set up a toy index without specifying an analyzer (or to not use one), the <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-standard-analyzer.html" rel="nofollow">standard analyzer</a> will be used, which will split on whitespace and symbols like "@". So, with this index definition:</p>&#xA;&#xA;<pre><code>PUT /test_index&#xA;{&#xA;   "mappings": {&#xA;      "doc": {&#xA;         "properties": {&#xA;            "email": {&#xA;               "type": "string"&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>if I add a single doc:</p>&#xA;&#xA;<pre><code>PUT /test_index/doc/1&#xA;{&#xA;    "email": "user1@user.com"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>and then ask for a <code>terms</code> aggregation, I get back two terms:</p>&#xA;&#xA;<pre><code>POST /test_index/_search?search_type=count&#xA;{&#xA;   "aggregations": {&#xA;      "email-terms": {&#xA;         "terms": {&#xA;            "field": "email"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "took": 2,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 5,&#xA;      "successful": 5,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 1,&#xA;      "max_score": 0,&#xA;      "hits": []&#xA;   },&#xA;   "aggregations": {&#xA;      "email-terms": {&#xA;         "buckets": [&#xA;            {&#xA;               "key": "user.com",&#xA;               "doc_count": 1&#xA;            },&#xA;            {&#xA;               "key": "user1",&#xA;               "doc_count": 1&#xA;            }&#xA;         ]&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>But if I rebuild the index with <code>"index": "not_analyzed"</code> in that field, and again index the same document:</p>&#xA;&#xA;<pre><code>DELETE /test_index&#xA;&#xA;PUT /test_index&#xA;{&#xA;   "mappings": {&#xA;      "doc": {&#xA;         "properties": {&#xA;            "email": {&#xA;               "type": "string",&#xA;               "index": "not_analyzed"&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;&#xA;PUT /test_index/doc/1&#xA;{&#xA;    "email": "user1@user.com"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>and run the same terms aggregation, I only get back a single term for that email address:</p>&#xA;&#xA;<pre><code>POST /test_index/_search?search_type=count&#xA;{&#xA;   "aggregations": {&#xA;      "email-terms": {&#xA;         "terms": {&#xA;            "field": "email"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "took": 2,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 5,&#xA;      "successful": 5,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 1,&#xA;      "max_score": 0,&#xA;      "hits": []&#xA;   },&#xA;   "aggregations": {&#xA;      "email-terms": {&#xA;         "buckets": [&#xA;            {&#xA;               "key": "user1@user.com",&#xA;               "doc_count": 1&#xA;            }&#xA;         ]&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here is the code I used, altogether:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/a73a28bf7450b637138b02a371fb15cabf344ab6" rel="nofollow">http://sense.qbox.io/gist/a73a28bf7450b637138b02a371fb15cabf344ab6</a></p>&#xA;
<p>We can use index template to predefined field types ,<a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.3/indices-templates.html" rel="nofollow">http://www.elastic.co/guide/en/elasticsearch/reference/1.3/indices-templates.html</a>&#xA; ,ex :</p>&#xA;&#xA;<p>Use rest client or elastic search sense </p>&#xA;&#xA;<pre><code>PUT/POST http://escluster:port/_template&#xA;&#xA;{&#xA;  "testtemplate": {&#xA;    "aliases": {},&#xA;    "mappings": {&#xA;      "test1": {&#xA;        "_all": {&#xA;          "enabled": false&#xA;        },&#xA;        "_source": {&#xA;          "enabled": true&#xA;        },&#xA;        "properties": {&#xA;          "email": {&#xA;            "fielddata": {&#xA;              "format": "doc_values"&#xA;            },&#xA;            "index": "not_analyzed",&#xA;            "type": "string"&#xA;          }...&#xA;</code></pre>&#xA;