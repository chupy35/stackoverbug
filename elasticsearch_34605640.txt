34605640
Applying filters on results of aggregation in elastic search
<p>I am stuck with a problem where I need to apply some filters on results of an aggregation in elastic search. </p>&#xA;&#xA;<p>For example, assume that the following are the fields&#xA;event_name, location, time, user_id</p>&#xA;&#xA;<p>Now my requirement is to get the user ids who have performed a specific action (lets say "logged_in") in the last one month atleast 5 times. I am able to get the users who have logged_in in the last one month. But how do I filter the results further?</p>&#xA;&#xA;<p>The query I have written is:</p>&#xA;&#xA;<pre><code>{&#xA;   "query": {&#xA;      "filtered": {&#xA;         "filter": {&#xA;            "bool": {&#xA;                "must": [&#xA;                  {&#xA;                    "range":{&#xA;                       "time":{&#xA;                          "from": 1412312824,&#xA;                          "to": 1422142824&#xA;                        }&#xA;                     }&#xA;                  },&#xA;                  {&#xA;                     "term": {&#xA;                        "action": "logged_in"&#xA;                      }          &#xA;                  }&#xA;               ]&#xA;            }&#xA;         }&#xA;      }&#xA;   },&#xA;   "aggs": {&#xA;      "result": {&#xA;         "terms": {&#xA;            "field": "user_id"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Sample output:</p>&#xA;&#xA;<pre><code>user_id, doc_count&#xA;1          10&#xA;2          25&#xA;3           1&#xA;4           2&#xA;</code></pre>&#xA;&#xA;<p>I need to apply filter on the above result. How do I do it?</p>&#xA;
<p>I believe you can just add a <code>min_doc_count</code> key to your terms aggregation, like so:</p>&#xA;&#xA;<pre><code>...&#xA;"aggs": {&#xA;    "result": {&#xA;        "terms": {&#xA;            "field": "user_id",&#xA;            "min_doc_count": 5&#xA;        } &#xA;    }&#xA;}&#xA;...&#xA;</code></pre>&#xA;&#xA;<p>Source: <a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.6/search-aggregations-bucket-terms-aggregation.html#_minimum_document_count" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/1.6/search-aggregations-bucket-terms-aggregation.html#_minimum_document_count</a></p>&#xA;