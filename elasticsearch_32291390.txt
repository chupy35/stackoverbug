32291390
Elasticsearch script sort on nested field
<p>I have the following type in elasticsearch </p>&#xA;&#xA;<pre><code>"hotel" : {&#xA;   "magicScore" : 1&#xA;   "rooms" : [&#xA;        {&#xA;       "type" : "single",&#xA;       "magicScore" : 1&#xA;        }, &#xA;        {&#xA;        "type" : "double",&#xA;        "magicScore" : 2&#xA;        }&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>where rooms is of type nested. I would like to sort using a scripted sort, for example </p>&#xA;&#xA;<pre><code> "sort" : [ {&#xA;    "_script" : {&#xA;      "script" : "return doc['magicScore'].value + doc['rooms.magicScore'].value",&#xA;       "params" :  ,&#xA;      "type" : "number",&#xA;      "reverse" : true&#xA;    }&#xA;  } ]&#xA;</code></pre>&#xA;&#xA;<p>This does not work because rooms are nested objects, is there a way around this?</p>&#xA;
<p>As per the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html#_document_fields" rel="nofollow">documentation</a>:</p>&#xA;&#xA;<blockquote>&#xA;  <p>doc[...] notation only allows for simple valued fields (canâ€™t return&#xA;  a json object from it) and makes sense only on non-analyzed or single&#xA;  term based fields.</p>&#xA;</blockquote>&#xA;&#xA;<p>You would need to use access it via the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html#_source_field" rel="nofollow">_source</a> field  </p>&#xA;&#xA;<p>Something on these lines:</p>&#xA;&#xA;<pre><code>   "sort": [&#xA;      {&#xA;         "_script": {&#xA;            "script": "m=doc['magicScore'].value;for(obj in _source.rooms){ m += obj.magicScore;};return m;",&#xA;            "type": "number",&#xA;            "reverse": true&#xA;         }&#xA;      }&#xA;   ]&#xA;</code></pre>&#xA;