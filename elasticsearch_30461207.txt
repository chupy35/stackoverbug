30461207
Elasticsearch, combining nested filter with normal filter
<p>I figured out how to map and filter on nested queries in Elasticsearch. Yay! But what isn't working out yet is to filter on both a 'normal' filter and a nested filter. The example you see here doesnt give an error and the second (nested) filter seems to be working, but the first one isn't. In this example I want both filters to be included, not just one. What am I doing wrong?</p>&#xA;&#xA;<pre><code>{&#xA;  "size": 100,&#xA;  "sort": [],&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "match_all": []&#xA;      },&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "terms": {&#xA;                "category.untouched": [&#xA;                  "Chargers"&#xA;                ]&#xA;              }&#xA;            }&#xA;          ],&#xA;          "should": [],&#xA;          "must_not": {&#xA;            "missing": {&#xA;              "field": "model"&#xA;            }&#xA;          }&#xA;        }&#xA;      },&#xA;      "filter": {&#xA;        "nested": {&#xA;            "path":"phones",&#xA;            "filter":{&#xA;                "bool": {&#xA;                    "must": [&#xA;                        {&#xA;                            "term": {&#xA;                                "phones.name.untouched":"Galaxy S3 Neo I9301"&#xA;                            }&#xA;                        }&#xA;                    ]&#xA;                }&#xA;            }&#xA;        }&#xA;      },&#xA;      "strategy": "query_first"&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "category.untouched": {&#xA;      "terms": {&#xA;        "field": "category.untouched"&#xA;      }&#xA;    },&#xA;    "brand.untouched": {&#xA;      "terms": {&#xA;        "field": "brand.untouched"&#xA;      }&#xA;    },&#xA;    "price_seperate": {&#xA;      "histogram": {&#xA;        "field": "price_seperate",&#xA;        "interval": 10,&#xA;        "min_doc_count": 1&#xA;      }&#xA;    },&#xA;    "phones.name.untouched": {&#xA;      "nested": {&#xA;        "path": "phones"&#xA;      },&#xA;      "aggs": {&#xA;        "phones.name.untouched": {&#xA;          "terms": {&#xA;            "field": "phones.name.untouched"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;
<p>You have two keys with the name <code>"filter"</code> (in <code>"filtered"</code>), so one of them is going to get ignored. You probably just need to wrap your two filters in a <code>"bool"</code> (bools can be nested as needed).</p>&#xA;&#xA;<p>I can't test it without setting up some test data, but try this and see if it gets you closer:</p>&#xA;&#xA;<pre><code>{&#xA;   "size": 100,&#xA;   "sort": [],&#xA;   "query": {&#xA;      "filtered": {&#xA;         "query": {&#xA;            "match_all": []&#xA;         },&#xA;         "filter": {&#xA;            "bool": {&#xA;               "must": [&#xA;                  {&#xA;                     "terms": {&#xA;                        "category.untouched": [&#xA;                           "Chargers"&#xA;                        ]&#xA;                     }&#xA;                  },&#xA;                  {&#xA;                     "nested": {&#xA;                        "path": "phones",&#xA;                        "filter": {&#xA;                           "term": {&#xA;                              "phones.name.untouched": "Galaxy S3 Neo I9301"&#xA;                           }&#xA;                        }&#xA;                     }&#xA;                  }&#xA;               ],&#xA;               "should": [],&#xA;               "must_not": {&#xA;                  "missing": {&#xA;                     "field": "model"&#xA;                  }&#xA;               }&#xA;            }&#xA;         },&#xA;         "strategy": "query_first"&#xA;      }&#xA;   },&#xA;   "aggs": {&#xA;      "category.untouched": {&#xA;         "terms": {&#xA;            "field": "category.untouched"&#xA;         }&#xA;      },&#xA;      "brand.untouched": {&#xA;         "terms": {&#xA;            "field": "brand.untouched"&#xA;         }&#xA;      },&#xA;      "price_seperate": {&#xA;         "histogram": {&#xA;            "field": "price_seperate",&#xA;            "interval": 10,&#xA;            "min_doc_count": 1&#xA;         }&#xA;      },&#xA;      "phones.name.untouched": {&#xA;         "nested": {&#xA;            "path": "phones"&#xA;         },&#xA;         "aggs": {&#xA;            "phones.name.untouched": {&#xA;               "terms": {&#xA;                  "field": "phones.name.untouched"&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;