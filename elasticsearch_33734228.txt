33734228
elasticsearch nested functionScoreQuery cannot access parent properties
<p>I have a type in elasticsearch that looks like this: </p>&#xA;&#xA;<pre><code>    "hotel" : {    &#xA;         "field" : 1,    &#xA;         "rooms" : [&#xA;            {&#xA;           "type" : "single",&#xA;           "magicScore" : 1&#xA;            }, &#xA;            {&#xA;            "type" : "double",&#xA;            "magicScore" : 2&#xA;            }&#xA;        ] &#xA;  }&#xA;</code></pre>&#xA;&#xA;<p>where rooms is of type nested. I sort using a nested functionScoreQuery:  </p>&#xA;&#xA;<pre><code>{&#xA;  "query" : {&#xA;    "filtered" : {&#xA;      "query" : {&#xA;        "nested" : {&#xA;          "query" : {&#xA;            "function_score" : {&#xA;              "filter" : {&#xA;                "match_all" : { }&#xA;              },&#xA;              "functions" : [ {&#xA;                "script_score" : {&#xA;                  "script" : "return doc['hotel.field'].value"      &#xA;                }&#xA;              } ]&#xA;            }&#xA;          },&#xA;          "path" : "rooms",&#xA;          "score_mode" : "max"&#xA;        }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Problem is hotel.field returns 0 always. Is there a way to access the parent field inside a nested query? I know I can always pack the field inside the nested document but its a hack not a solution. Would using a dismax query help me? <a href="https://discuss.elastic.co/t/nested-value-on-function-score/29935" rel="nofollow">https://discuss.elastic.co/t/nested-value-on-function-score/29935</a></p>&#xA;&#xA;<p>The query I am actually using looks something like this: </p>&#xA;&#xA;<pre><code>{&#xA;  "query" : {&#xA;    "bool" : {&#xA;      "must" : {&#xA;        "nested" : {&#xA;          "query" : {&#xA;            "function_score" : {&#xA;              "query" : {&#xA;                "not" : {&#xA;                  "query" : {&#xA;                    "terms" : {&#xA;                      "rooms.type" : [ "single", "triple" ]&#xA;                    }&#xA;                  }&#xA;                }&#xA;              },&#xA;              "functions" : [ {&#xA;                "script_score" : {&#xA;                  "script" : {&#xA;                    "inline" : "return doc['rooms.magicScore'].value;",&#xA;                    "lang" : "groovy",&#xA;                    "params" : {&#xA;                      "ratings" : {&#xA;                        "sample" : 0.5&#xA;                      },&#xA;                      "variable" : [ 0.0, 0.0, 0.0, 0.0, -0.5, -2.5]&#xA;                    }&#xA;                  }&#xA;                }&#xA;              } ],&#xA;              "score_mode" : "max"&#xA;            }&#xA;          },&#xA;          "path" : "rooms"&#xA;        }&#xA;      },&#xA;      "filter" : {&#xA;        "bool" : {&#xA;          "filter" : [ {&#xA;            "bool" : {&#xA;              "should" : [ {&#xA;                "term" : {&#xA;                  "cityId" : "166"&#xA;                }&#xA;              }, {&#xA;                "term" : {&#xA;                  "cityId" : "165"&#xA;                }&#xA;              } ]&#xA;            }&#xA;          }, {&#xA;            "nested" : {&#xA;              "query" : {&#xA;                "not" : {&#xA;                  "query" : {&#xA;                    "terms" : {&#xA;                      "rooms.type" : [ "single", "triple" ]&#xA;                    }&#xA;                  }&#xA;                }&#xA;              },&#xA;              "path" : "rooms"&#xA;            }&#xA;          } ]&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>What I am trying to achieve is to access for example the cityId inside the function_score query which is nested. </p>&#xA;
<p>The question is why are you accessing the parent values in a <code>nested</code> query. Once you are in the <code>nested</code> context, you cannot access parent fields or other fields from other <code>nested</code> fields.</p>&#xA;&#xA;<p>From <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/nested-query.html" rel="nofollow">the documentation</a>:</p>&#xA;&#xA;<blockquote>&#xA;  <p>The nested clause “steps down” into the nested comments field. It no longer has access to fields in the root document, nor fields in any other nested document.</p>&#xA;</blockquote>&#xA;&#xA;<p>So, rewrite your queries so that the <code>nested</code> part touches the fields in that <code>nested</code> field and anything else is accessed <strong>outside</strong> the <code>nested</code> part.</p>&#xA;