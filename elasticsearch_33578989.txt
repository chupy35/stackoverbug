33578989
Filtering nested aggregations in ElasticSearch
<p>Given the following mapping from my index (Items):</p>&#xA;&#xA;<pre><code>{&#xA;  "title": {&#xA;    "type":"string"&#xA;  },&#xA;  "tag_groups": {&#xA;    "type":"nested",&#xA;    "include_in_parent":true,&#xA;    "properties": {&#xA;      "name":{&#xA;        "type":"string",&#xA;        "index":"not_analyzed"&#xA;      },&#xA;      "terms": {&#xA;        "type":"string",&#xA;        "index":"not_analyzed"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>And the following sample of data that each document in the index follows:</p>&#xA;&#xA;<pre><code>{&#xA;  "title":"Christian Louboutin Magenta Leather Lady Peep",&#xA;  "tag_groups": [&#xA;    {&#xA;      "name": "Color",&#xA;      "terms": ["pink"]&#xA;    },&#xA;    {&#xA;      "name":"Material/Fabric",&#xA;      "terms":["leather"]&#xA;    },&#xA;    {&#xA;      "name":"Season",&#xA;      "terms":["summer", "spring"]&#xA;    },&#xA;    {&#xA;      "name":"Occasion",&#xA;      "terms":["cocktail", "night out", "wedding: for the guests", "date night"]&#xA;    }&#xA;  ],&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>IMPORTANT: These tag_groups are variable from product to product and category to category. So pulling them out of the nested property would be tough since it would create index properties that don't apply to all documents in the index.</p>&#xA;&#xA;<p>Here is my query that is producing the correct aggregated results across each tag_groups.name and corresponding set of values. Counts are accurate too.</p>&#xA;&#xA;<pre><code>{&#xA;  "size":"40",&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {"match_all": {}}&#xA;    }&#xA;  },&#xA;  "aggs":{&#xA;    "tagGroupAgg": {&#xA;      "nested": {&#xA;        "path":"tag_groups"&#xA;      },&#xA;      "aggs":{&#xA;        "tagGroupNameAgg":{&#xA;          "terms":{&#xA;            "field":"tag_groups.name"&#xA;          },&#xA;          "aggs":{&#xA;            "tagGroupTermsAgg":{&#xA;              "terms": {&#xA;                "field":"tag_groups.terms"&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>NOW FOR THE QUESTION...</p>&#xA;&#xA;<p>In order for the aggregation counts on the left to reflect accurately, when I apply a TermsFilter to the aggregation (tag_groups.Color = ['pink']), how do I make sure that aggregation filter isn't applied to the tag_groups.Color result?</p>&#xA;&#xA;<p>Currently, when I apply that filter I am losing all of my tag_groups.Colors (except for pink) preventing the user from search other colors...</p>&#xA;&#xA;<p>I'm hitting a wall on this one. Any help would be much appreciated!</p>&#xA;&#xA;<pre><code>{&#xA;   "size":"40",&#xA;   "query":{&#xA;      "filtered":{&#xA;         "query":{&#xA;            "match_all":{&#xA;&#xA;            }&#xA;         }&#xA;      }&#xA;   },&#xA;   "aggs":{&#xA;      "tagGroupAgg":{&#xA;         "nested":{&#xA;            "path":"tag_groups"&#xA;         },&#xA;         "aggs":{&#xA;            "tagGroupNameAgg":{&#xA;               "terms":{&#xA;                  "field":"tag_groups.name"&#xA;               },&#xA;               "aggs":{&#xA;                  "tagGroupTermsAgg":{&#xA;                     "terms":{&#xA;                        "field":"tag_groups.terms"&#xA;                     },&#xA;                     "aggs":{&#xA;                        "tagGroupTermsReverseAgg":{&#xA;                           "reverse_nested":{&#xA;&#xA;                           },&#xA;                           "aggs":{&#xA;                              "testingReverseFilter":{&#xA;                                 "filter":{&#xA;                                    "bool":{&#xA;                                       "must":[&#xA;                                          {&#xA;                                             "terms":{&#xA;                                                "tag_groups.name":[&#xA;                                                   "Color"&#xA;                                                ]&#xA;                                             }&#xA;                                          },&#xA;                                          {&#xA;                                             "terms":{&#xA;                                                "brand_name.raw":[&#xA;                                                   "Chanel"&#xA;                                                ]&#xA;                                             }&#xA;                                          }&#xA;                                     ]&#xA;                                    }&#xA;                                 },&#xA;                                 "aggs":{&#xA;                                    "tagGroupTermsAgg2":{&#xA;                                       "terms":{&#xA;                                          "field":"tag_groups.terms"&#xA;                                       }&#xA;                                    }&#xA;                                 }&#xA;                              }&#xA;                           }&#xA;                        }&#xA;                     }&#xA;                  }&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;