30785754
Using geo_shape filter inside bool filter
<p>I'm trying to combine a <code>geo_shape</code> Elasticsearch filter with a basic <code>term</code> filter within a <code>bool</code> filter, so I can attempt to improve performance of our elasticsearch query, with little success.</p>&#xA;&#xA;<p>This query is used over a set of polygons in Elasticsearch, to determine which shapes the specified point is in.</p>&#xA;&#xA;<p>It seems as though, unless I have the wrong end of the stick, <code>geo_shape</code> filters can't be included inside a <code>bool</code> filter collection like this:</p>&#xA;&#xA;<pre><code>{&#xA;"size": 1000,&#xA;"fields": [],&#xA;"query": {&#xA;"filtered": {&#xA;  "query": {&#xA;    "match_all": {}&#xA;  },&#xA;  "filter": {&#xA;    "bool": {&#xA;      "must": [&#xA;        {&#xA;          "geo_shape": {&#xA;            "deliveryAreas.area": {&#xA;              "shape": {&#xA;                "coordinates": [&#xA;                  -0.126208,&#xA;                  51.430874&#xA;                ],&#xA;                "type": "point"&#xA;              }&#xA;            }&#xA;          }&#xA;          },&#xA;          {&#xA;           "term": {&#xA;            "restaurantState": 3&#xA;           }&#xA;          }&#xA;         ]&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The query above runs, but returns 0 results. Using the <code>geo_shape</code> query outside the <code>bool</code> works fine, but the combination of the two seems to fail. I assume it must be a syntax error, as the ElasticSearch docs recommend this approach to make the expensive geo calls cheaper, but no luck so far.</p>&#xA;