32342511
Get document with sorted nested objects
<p>I have the following mapping: <a href="http://pastebin.com/FgtC5aaw" rel="nofollow">http://pastebin.com/FgtC5aaw</a> (includes sample data)</p>&#xA;&#xA;<blockquote>&#xA;  <p><a href="http://localhost:9200/databases/database/1" rel="nofollow">http://localhost:9200/databases/database/1</a></p>&#xA;</blockquote>&#xA;&#xA;<pre><code>{&#xA; "columns": [&#xA;   {&#xA;     "name": "First column",&#xA;     "position": 1&#xA;   },&#xA;   {&#xA;     "name": "Second column",&#xA;     "position": 2&#xA;   },&#xA;   {&#xA;     "name": "Third column",&#xA;     "position": 3&#xA;   }&#xA; ],&#xA; "name": "Database name"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>What I would like to get is the "database" document(s), but each one with columns sorted in descending order by columns.position field, so:</p>&#xA;&#xA;<pre><code>{&#xA;    "name": "Database name",&#xA;    "columns": [&#xA;        {&#xA;            "name": "Third column",&#xA;            "position": 3&#xA;        },&#xA;        {&#xA;            "name": "Second column",&#xA;            "position": 2&#xA;        },&#xA;        {&#xA;            "name": "First column",&#xA;            "position": 1&#xA;        }&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I tried using "sort" on "columns.position", but I think it would just sort all "database" documents on it's nested columns.</p>&#xA;&#xA;<p>Is such a result possible in Elasticsearch?</p>&#xA;
<p>If you know in advance you'll always need to retrieve the columns <code>nested</code> object in decreasing order of <code>columns.position</code>, you can simply index your database documents with the <code>columns</code> list already properly sorted. </p>&#xA;&#xA;<p>If that's not the case, there is a way to sort the nested <code>columns</code> list using <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-inner-hits.html#nested-inner-hits" rel="nofollow"><code>inner_hits</code></a> like this:</p>&#xA;&#xA;<pre><code>curl -XPOST localhost:9200/databases/database/_search -d '{&#xA;  "_source": false,            &lt;---- set this to true to get database fields too&#xA;  "query": {&#xA;    "nested": {&#xA;      "path": "columns",&#xA;      "query": {&#xA;        "match_all": {}&#xA;      },&#xA;      "inner_hits": {&#xA;        "sort": {&#xA;          "columns.position": "desc"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}'&#xA;</code></pre>&#xA;&#xA;<p>Which will yield:</p>&#xA;&#xA;<pre><code>{&#xA;  ...&#xA;  "hits" : {&#xA;    "total" : 1,&#xA;    "max_score" : 1.0,&#xA;    "hits" : [ {&#xA;      "_index" : "databases",&#xA;      "_type" : "database",&#xA;      "_id" : "1",&#xA;      "_score" : 1.0,&#xA;      "inner_hits" : {&#xA;        "columns" : {&#xA;          "hits" : {&#xA;            "total" : 3,&#xA;            "max_score" : null,&#xA;            "hits" : [ {&#xA;              "_index" : "databases",&#xA;              "_type" : "database",&#xA;              "_id" : "1",&#xA;              "_nested" : {&#xA;                "field" : "columns",&#xA;                "offset" : 2&#xA;              },&#xA;              "_score" : null,&#xA;              "_source":{"name":"Third column","position":3},&#xA;              "sort" : [ 3 ]&#xA;            }, {&#xA;              "_index" : "databases",&#xA;              "_type" : "database",&#xA;              "_id" : "1",&#xA;              "_nested" : {&#xA;                "field" : "columns",&#xA;                "offset" : 1&#xA;              },&#xA;              "_score" : null,&#xA;              "_source":{"name":"Second column","position":2},&#xA;              "sort" : [ 2 ]&#xA;            }, {&#xA;              "_index" : "databases",&#xA;              "_type" : "database",&#xA;              "_id" : "1",&#xA;              "_nested" : {&#xA;                "field" : "columns",&#xA;                "offset" : 0&#xA;              },&#xA;              "_score" : null,&#xA;              "_source":{"name":"First column","position":1},&#xA;              "sort" : [ 1 ]&#xA;            } ]&#xA;          }&#xA;        }&#xA;      }&#xA;    } ]&#xA;  }&#xA;}&#xA;</code></pre>&#xA;