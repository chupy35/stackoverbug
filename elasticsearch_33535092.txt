33535092
ElasticSearch: How to query a date field using an hours-range filter
<p>Currently, I already know how to filter a days range from a (timestamp) date field. That's an easy one:</p>&#xA;&#xA;<pre><code>"range": {&#xA;    "date": {&#xA;        "gte": "2015-11-01",&#xA;        "lte": "2015-11-30"&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>But how to filter dates when you are interested in ranges based on hours like gte:"8:00:00" and lte:"10:00:00"? Is this possible? </p>&#xA;&#xA;<p>My requirement in other words:&#xA;How to get all the events happening this month (15-11-01/15-11-30) but only between 8:00:00 am and 10:00:00?</p>&#xA;
<p>If I understood your question correctly then I think you have to add new field which indexes only time like</p>&#xA;&#xA;<pre><code>PUT your_index&#xA;{&#xA;  "mappings": {&#xA;    "your_type": {&#xA;      "properties": {&#xA;        "time": {&#xA;          "type":   "date",&#xA;          "format": "HH:mm:ss"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Then you can query like this</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "bool": {&#xA;      "must": [&#xA;        {&#xA;          "range": {&#xA;            "date": {&#xA;              "gte": "2015-11-01",&#xA;              "lte": "2015-11-30"&#xA;            }&#xA;          }&#xA;        },&#xA;        {&#xA;          "range": {&#xA;            "time": {&#xA;              "gte": "08:00:00",&#xA;              "lte": "10:00:00"&#xA;            }&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Does this help?</p>&#xA;
<p>You can do it with your <code>range</code> filter to filter the correct days and then with a <code>script</code> filter to filter the desired hours, like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "range": {&#xA;                "date": {&#xA;                  "gte": "2015-11-01",&#xA;                  "lte": "2015-11-30"&#xA;                }&#xA;              }&#xA;            },&#xA;            {&#xA;              "script": {&#xA;                "script": "doc.date.date.getHourOfDay() &gt;= min &amp;&amp; doc.date.date.getHourOfDay() &lt;= max",&#xA;                "params": {&#xA;                  "min": 8,&#xA;                  "max": 10&#xA;                }&#xA;              }&#xA;            }&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Note that you need to make sure to <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html#enable-dynamic-scripting" rel="noreferrer">enable dynamic scripting</a> in order for this query to work.</p>&#xA;
<p>Here's what I once used to only get results from start of current day to 6pm:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "bool": {&#xA;      "must": [&#xA;        {&#xA;          "query_string": {&#xA;            "query": "(log_message:\"My Search String\")"&#xA;          }&#xA;        },&#xA;        {&#xA;          "range": {&#xA;            "@timestamp": {&#xA;              "time_zone": "CET",&#xA;              "gt": "now-24h/d",&#xA;              "lte": "now-24h/d+18h"&#xA;            }&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>the important part is "now-24h/d" which will round to midnight / begin of current day, although it is a bit tricky as it depends on whether you use gt/lt(e), see <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html#_date_math_and_rounding" rel="nofollow noreferrer">reference doc</a> for details.</p>&#xA;