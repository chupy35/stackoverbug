28811744
How to get max _id from elastic search
<p>I have created a river which will run every hour to fetch data from DB(Using jdbc river plugin). </p>&#xA;&#xA;<pre><code>select * from orders&#xA;</code></pre>&#xA;&#xA;<p>Instead of selecting all records i want to select data which are appended based on primary key.Query would be :</p>&#xA;&#xA;<pre><code>select * from orders where deviceid &gt; '(Max Id in Elastic search)'&#xA;</code></pre>&#xA;&#xA;<p>How can i get max _id from elastic search?</p>&#xA;
<p>There doesn't seem to be a way to do it directly, using the <code>"_id"</code> field, since ES insists on converting <code>"_id"</code> values to strings. But there is a way to work around it.</p>&#xA;&#xA;<p>First I set up a simple index with a few docs as follows:</p>&#xA;&#xA;<pre><code>PUT /test_index&#xA;{&#xA;   "settings": {&#xA;      "number_of_shards": 1&#xA;   }&#xA;}&#xA;&#xA;POST /test_index/_bulk&#xA;{"index":{"_index":"test_index","_type":"doc","_id":1}}&#xA;{"title":"first doc"}&#xA;{"index":{"_index":"test_index","_type":"doc","_id":2}}&#xA;{"title":"second doc"}&#xA;{"index":{"_index":"test_index","_type":"doc","_id":3}}&#xA;{"title":"third doc"}&#xA;</code></pre>&#xA;&#xA;<p>Then I tried using a <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations-metrics-max-aggregation.html" rel="nofollow">max aggregation</a>, but got an error, because the <code>"_id"</code>s are strings:</p>&#xA;&#xA;<pre><code>POST /test_index/_search?search_type=count&#xA;{&#xA;   "aggs": {&#xA;      "max_id": {&#xA;         "max": {&#xA;            "field": "_id"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "error": "SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures {[bQS7TqO9SfKSPQZYVXQBag][test_index][0]: ClassCastException[org.elasticsearch.index.fielddata.plain.PagedBytesIndexFieldData cannot be cast to org.elasticsearch.index.fielddata.IndexNumericFieldData]}]",&#xA;   "status": 500&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>So that doesn't work. But a slight modification does, using the <code>"path"</code> parameter in the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-id-field.html" rel="nofollow"><code>"_id"</code> field</a>. </p>&#xA;&#xA;<p>So I redefine the index as</p>&#xA;&#xA;<pre><code>DELETE /test_index&#xA;&#xA;PUT /test_index&#xA;{&#xA;   "settings": {&#xA;      "number_of_shards": 1&#xA;   },&#xA;   "mappings": {&#xA;      "doc": {&#xA;         "_id": {&#xA;            "path": "doc_id"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>and then index the docs using the <code>"doc_id"</code> path:</p>&#xA;&#xA;<pre><code>POST /test_index/_bulk&#xA;{"index":{"_index":"test_index","_type":"doc"}}&#xA;{"title":"first doc","doc_id":1}&#xA;{"index":{"_index":"test_index","_type":"doc"}}&#xA;{"title":"second doc","doc_id":2}&#xA;{"index":{"_index":"test_index","_type":"doc"}}&#xA;{"title":"third doc","doc_id":3}&#xA;</code></pre>&#xA;&#xA;<p>Now if I search, I can see that <code>"_id"</code> is still a string, but <code>"doc_id"</code> is an integer:</p>&#xA;&#xA;<pre><code>POST /test_index/_search&#xA;...&#xA;{&#xA;   "took": 1,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 3,&#xA;      "max_score": 1,&#xA;      "hits": [&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "doc",&#xA;            "_id": "1",&#xA;            "_score": 1,&#xA;            "_source": {&#xA;               "title": "first doc",&#xA;               "doc_id": 1&#xA;            }&#xA;         },&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "doc",&#xA;            "_id": "2",&#xA;            "_score": 1,&#xA;            "_source": {&#xA;               "title": "second doc",&#xA;               "doc_id": 2&#xA;            }&#xA;         },&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "doc",&#xA;            "_id": "3",&#xA;            "_score": 1,&#xA;            "_source": {&#xA;               "title": "third doc",&#xA;               "doc_id": 3&#xA;            }&#xA;         }&#xA;      ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>So now I can easily use the max aggregation to find the maximum id value:</p>&#xA;&#xA;<pre><code>POST /test_index/_search?search_type=count&#xA;{&#xA;   "aggs": {&#xA;      "max_id": {&#xA;         "max": {&#xA;            "field": "doc_id"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "took": 1,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 3,&#xA;      "max_score": 0,&#xA;      "hits": []&#xA;   },&#xA;   "aggregations": {&#xA;      "max_id": {&#xA;         "value": 3&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;