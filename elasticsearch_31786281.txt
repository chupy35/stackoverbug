31786281
Why isn't my elastic search query returning the text analyzed by english analyzer?
<p>I have an index named <code>test_blocks</code></p>&#xA;&#xA;<pre><code>{&#xA;  "test_blocks" : {&#xA;    "aliases" : { },&#xA;    "mappings" : {&#xA;      "block" : {&#xA;        "dynamic" : "false",&#xA;        "properties" : {&#xA;          "content" : {&#xA;            "type" : "string",&#xA;            "fields" : {&#xA;              "content_en" : {&#xA;                "type" : "string",&#xA;                "analyzer" : "english"&#xA;              }&#xA;            }&#xA;          },&#xA;          "id" : {&#xA;            "type" : "long"&#xA;          },&#xA;          "title" : {&#xA;            "type" : "string",&#xA;            "fields" : {&#xA;              "title_en" : {&#xA;                "type" : "string",&#xA;                "analyzer" : "english"&#xA;              }&#xA;            }&#xA;          },&#xA;          "user_id" : {&#xA;            "type" : "long"&#xA;          }&#xA;        }&#xA;      }&#xA;    },&#xA;    "settings" : {&#xA;      "index" : {&#xA;        "creation_date" : "1438642440687",&#xA;        "number_of_shards" : "5",&#xA;        "number_of_replicas" : "1",&#xA;        "version" : {&#xA;          "created" : "1070099"&#xA;        },&#xA;        "uuid" : "45vkIigXSCyvHN6g-w5kkg"&#xA;      }&#xA;    },&#xA;    "warmers" : { }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>When I do a search for <code>killing</code>, a word in the content, the search results return as expected.</p>&#xA;&#xA;<pre><code>http://localhost:9200/test_blocks/_search?q=killing&amp;pretty=1&#xA;&#xA;&#xA;{&#xA;  "took" : 1,&#xA;  "timed_out" : false,&#xA;  "_shards" : {&#xA;    "total" : 5,&#xA;    "successful" : 5,&#xA;    "failed" : 0&#xA;  },&#xA;  "hits" : {&#xA;    "total" : 2,&#xA;    "max_score" : 0.07431685,&#xA;    "hits" : [ {&#xA;      "_index" : "test_blocks",&#xA;      "_type" : "block",&#xA;      "_id" : "218",&#xA;      "_score" : 0.07431685,&#xA;      "_source":{"block":{"id":218,"title":"The \u003ci\u003eparticle\u003c/i\u003e streak","content":"Barry Allen is a Central City police forensic scientist\n                        with a reasonably happy life, despite the childhood\n                        trauma of a mysterious red and yellow being killing his\n                        mother and framing his father. All that changes when a\n                        massive \u003cb\u003eparticle\u003c/b\u003e accelerator accident leads to Barry\n                        being struck by lightning in his lab.","user_id":82}}&#xA;    }, {&#xA;      "_index" : "test_blocks",&#xA;      "_type" : "block",&#xA;      "_id" : "219",&#xA;      "_score" : 0.07431685,&#xA;      "_source":{"block":{"id":219,"title":"The \u003ci\u003eparticle\u003c/i\u003e streak","content":"Barry Allen is a Central City police forensic scientist\n                        with a reasonably happy life, despite the childhood\n                        trauma of a mysterious red and yellow being killing his\n                        mother and framing his father. All that changes when a\n                        massive \u003cb\u003eparticle\u003c/b\u003e accelerator accident leads to Barry\n                        being struck by lightning in his lab.","user_id":83}}&#xA;    } ]&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>However given that I have an <code>english</code> analyzer for the content field <strong>(content_en)</strong>, I would have expected it to return me the same document for the query <code>kill</code>. But it doesn't. I get 0 hits.</p>&#xA;&#xA;<pre><code>http://localhost:9200/test_blocks/_search?q=kill&amp;pretty=1&#xA;&#xA;{&#xA;  "took" : 1,&#xA;  "timed_out" : false,&#xA;  "_shards" : {&#xA;    "total" : 5,&#xA;    "successful" : 5,&#xA;    "failed" : 0&#xA;  },&#xA;  "hits" : {&#xA;    "total" : 0,&#xA;    "max_score" : null,&#xA;    "hits" : [ ]&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>My understanding through this analyze query is that "killing" would have got broken down in to "kill"</p>&#xA;&#xA;<pre><code>http://localhost:9200/_analyze?analyzer=english&amp;text=killing&#xA;&#xA;{&#xA;  "tokens" : [ {&#xA;    "token" : "kill",&#xA;    "start_offset" : 0,&#xA;    "end_offset" : 7,&#xA;    "type" : "&lt;ALPHANUM&gt;",&#xA;    "position" : 1&#xA;  } ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>So why isn't the query "kill" match that document ? Are my mappings incorrect or is it my search that is incorrect?</p>&#xA;&#xA;<p>I am using elasticsearch v1.7.0</p>&#xA;
<p>You need to use <code>fuzzysearch</code> (some introduction available <a href="https://www.found.no/foundation/fuzzy-search/" rel="nofollow">here</a>):</p>&#xA;&#xA;<pre><code>curl -XPOST 'http://localhost:9200/test_blocks/_search' -d '&#xA;{&#xA;  "query": {&#xA;    "match": {&#xA;      "title": {&#xA;        "query": "kill",&#xA;        "fuzziness": 2,&#xA;        "prefix_length": 1&#xA;      }&#xA;    }&#xA;  }&#xA;}'&#xA;</code></pre>&#xA;&#xA;<p><strong>UPD</strong>. Having <code>content_en</code> field with content which was given by stemmer, it makes sense to actually query that field:</p>&#xA;&#xA;<pre><code>curl -XPOST 'http://localhost:9200/test_blocks/_search' -d '&#xA;{&#xA;  "query": {&#xA;    "multi_match": {&#xA;      "type": "most_fields",&#xA;      "query": "kill",&#xA;      "fields": ["block.title", "block.title.title_en"]&#xA;    }&#xA;  }&#xA;}'&#xA;</code></pre>&#xA;
<p>The following queries <code>http://localhost:9200/_search?q=kill.</code> ,<code>http://localhost:9200/_search?q=kill.</code> end up searching across &#xA;_all field . </p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.7/mapping-all-field.html" rel="nofollow">_all</a> field uses the default analyzer which unless overridden happens to be <em>standard analyzer</em> and not <em>english analyzer</em> .</p>&#xA;&#xA;<p>For making the above query work you would need to add english analyzer to <em>_all</em> field and re-index &#xA;Example:</p>&#xA;&#xA;<pre><code>    {&#xA;      "mappings": {&#xA;        "block": {&#xA;            "_all" : {"analyzer" : "english"}&#xA;       }&#xA;   }&#xA;</code></pre>&#xA;&#xA;<p>Also would point out the mapping in OP doesn't seem consistent with the document structure. As @EugZol pointed our the content is within <em>block object</em> so the mapping should be something on these lines :</p>&#xA;&#xA;<pre><code>{&#xA;  "mappings": {&#xA;    "block": {&#xA;      "properties": {&#xA;        "block": {&#xA;          "properties": {&#xA;            "content": {&#xA;              "type": "string",&#xA;              "analyzer": "standard",&#xA;              "fields": {&#xA;                "content_en": {&#xA;                  "type": "string",&#xA;                  "analyzer": "english"&#xA;                }&#xA;              }&#xA;            },&#xA;            "id": {&#xA;              "type": "long"&#xA;            },&#xA;            "title": {&#xA;              "type": "string",&#xA;              "analyzer": "standard",&#xA;              "fields": {&#xA;                "title_en": {&#xA;                  "type": "string",&#xA;                  "analyzer": "english"&#xA;                }&#xA;              }&#xA;            },&#xA;            "user_id": {&#xA;              "type": "long"&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;