34433412
analyze text with leading hyphens _analyze endpoint
<p>Playing with elasticsearch to analyze some text (using the _analyze endpoint).</p>&#xA;&#xA;<p>I see that when there are leading hyphens it does not return json, but some other format. </p>&#xA;&#xA;<p>Try to search the docs about this but found nothing.&#xA;Can someone point me to the reason? Is there a way to force the json output? Examples below.</p>&#xA;&#xA;<p>Thanks. </p>&#xA;&#xA;<hr>&#xA;&#xA;<p>Short examples, one text is 'this is', other is '---------this is'.</p>&#xA;&#xA;<p>This works fine:</p>&#xA;&#xA;<pre><code>% curl -XGET 'localhost:9200/_analyze?analyzer=standard' -d 'this is'&#xA;&#xA;{"tokens":[{"token":"this","start_offset":0,"end_offset":4,"type":"&lt;ALPHANUM&gt;","position":1},{"token":"is","start_offset":5,"end_offset":7,"type":"&lt;ALPHANUM&gt;","position":2}]}&#xA;</code></pre>&#xA;&#xA;<p>but with leading --- it returns other format</p>&#xA;&#xA;<pre><code>% curl -XGET 'localhost:9200/_analyze?analyzer=standard' -d '---------this is'&#xA;&#xA;---&#xA;tokens:&#xA;- token: "this"&#xA;  start_offset: 9&#xA;  end_offset: 13&#xA;  type: "&lt;ALPHANUM&gt;"&#xA;  position: 1&#xA;- token: "is"&#xA;  start_offset: 14&#xA;  end_offset: 16&#xA;  type: "&lt;ALPHANUM&gt;"&#xA;  position: 2&#xA;</code></pre>&#xA;
<p>when i tried the same in sense plugin, I'm getting following results</p>&#xA;&#xA;<pre><code>GET /_analyze?analyzer=standard&amp;text=-this is&#xA;&#xA;{&#xA;   "tokens": [&#xA;      {&#xA;         "token": "this",&#xA;         "start_offset": 1,&#xA;         "end_offset": 5,&#xA;         "type": "&lt;ALPHANUM&gt;",&#xA;         "position": 1&#xA;      },&#xA;      {&#xA;         "token": "is",&#xA;         "start_offset": 6,&#xA;         "end_offset": 8,&#xA;         "type": "&lt;ALPHANUM&gt;",&#xA;         "position": 2&#xA;      }&#xA;   ]&#xA;}&#xA;&#xA;GET /_analyze?analyzer=standard&amp;text=---------this is&#xA;&#xA;{&#xA;   "tokens": [&#xA;      {&#xA;         "token": "this",&#xA;         "start_offset": 9,&#xA;         "end_offset": 13,&#xA;         "type": "&lt;ALPHANUM&gt;",&#xA;         "position": 1&#xA;      },&#xA;      {&#xA;         "token": "is",&#xA;         "start_offset": 14,&#xA;         "end_offset": 16,&#xA;         "type": "&lt;ALPHANUM&gt;",&#xA;         "position": 2&#xA;      }&#xA;   ]&#xA;}&#xA;</code></pre>&#xA;
<p>When the documentation doesn't tell, you should turn towards the ultimate "documentation" resource, which is the code.</p>&#xA;&#xA;<p>Starting on the main <a href="https://github.com/elastic/elasticsearch/blob/fab44398d9d48f12319bc018d4b436f723b6508e/core/src/main/java/org/elasticsearch/rest/action/admin/indices/analyze/RestAnalyzeAction.java#L87" rel="nofollow"><code>RestAnalyzeAction</code></a> REST endpoint that will handle the <code>_analyze</code> call, we can see that on line 87, it will try to guess the content type of the request body by calling <a href="https://github.com/elastic/elasticsearch/blob/fab44398d9d48f12319bc018d4b436f723b6508e/core/src/main/java/org/elasticsearch/rest/action/support/RestActions.java#L154" rel="nofollow"><code>RestActions.guessBodyContentType</code></a>. That method in turn will resort to  calling <a href="https://github.com/elastic/elasticsearch/blob/fab44398d9d48f12319bc018d4b436f723b6508e/core/src/main/java/org/elasticsearch/common/xcontent/XContentFactory.java#L143" rel="nofollow"><code>XContentFactory.xContentType</code></a> and in the latter we can find the reason on line 156, i.e. if the body starts with two hyphens, then the request is interpreted as YAML and the response will be formatted to YAML accordingly.</p>&#xA;&#xA;<p>You can confirm this fact by adding the <code>-v</code> (for verbose) switch to your curl command:</p>&#xA;&#xA;<pre><code>curl -v -XGET 'localhost:9200/_analyze?analyzer=standard' -d '---------this is'&#xA;</code></pre>&#xA;&#xA;<p>And the response you'll get will show you that the content type of the response is <code>application/yaml</code></p>&#xA;&#xA;<pre><code>* Connected to localhost (::1) port 9200 (#0)&#xA;&gt; GET /_analyze?analyzer=standard HTTP/1.1&#xA;&gt; User-Agent: curl/7.37.1&#xA;&gt; Host: localhost:9200&#xA;&gt; Accept: */*&#xA;&gt; Content-Length: 16&#xA;&gt; Content-Type: application/x-www-form-urlencoded&#xA;&gt; &#xA;* upload completely sent off: 16 out of 16 bytes&#xA;&lt; HTTP/1.1 200 OK&#xA;&lt; Content-Type: application/yaml                   &lt;---- HERE&#xA;&lt; Content-Length: 183&#xA;&lt; &#xA;---&#xA;tokens:&#xA;- token: "this"&#xA;  start_offset: 9&#xA;  end_offset: 13&#xA;  type: "&lt;ALPHANUM&gt;"&#xA;  position: 1&#xA;- token: "is"&#xA;  start_offset: 14&#xA;  end_offset: 16&#xA;  type: "&lt;ALPHANUM&gt;"&#xA;  position: 2&#xA;</code></pre>&#xA;