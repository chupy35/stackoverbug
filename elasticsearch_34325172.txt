34325172
Aggregration of nested objects with filter
<p>I'm not sure what is wrong with this query, but I can't figure out the solution, and would appreciate your insight. I am trying to do aggregration of nested object with filter query. I want to get count of field objects where <code>fields.name</code> is <code>AMORTIZED_COST</code>. Somehow aggregration doesn't return any count. I do get actual document in main search query - which returns 4 document but there are total 6 field rows which matches <code>AMORTIZED_COST</code> criteria, so in aggregation I was expecting it will show me 6 rows. Thanks in advance for your help. </p>&#xA;&#xA;<p>FYI - I am using ES 1.5 </p>&#xA;&#xA;<p>I am sharing partial type mapping</p>&#xA;&#xA;<pre><code>   "templ01": {&#xA;      "mappings": {&#xA;         "tempobjects": {&#xA;            "properties": {&#xA;               "description": {&#xA;                  "type": "string"&#xA;               },&#xA;               "fields": {&#xA;                  "type": "nested",&#xA;                  "properties": {&#xA;                     "id": {&#xA;                        "type": "string"&#xA;                     },&#xA;                     "name": {&#xA;                        "type": "string"&#xA;                     },&#xA;                     "objid": {&#xA;                        "type": "string"&#xA;                     }&#xA;                  }&#xA;               },&#xA;               "formulas": {&#xA;                  "type": "nested",&#xA;                  "properties": {&#xA;                     "formula": {&#xA;                        "type": "string"&#xA;                     },&#xA;                     "id": {&#xA;                        "type": "string"&#xA;                     },&#xA;                     "name": {&#xA;                        "type": "string"&#xA;                     },&#xA;                     "objid": {&#xA;                        "type": "string"&#xA;                     }&#xA;                  }&#xA;               },&#xA;</code></pre>&#xA;&#xA;<p>Here is the search query </p>&#xA;&#xA;<pre><code>{&#xA;  "query" : {&#xA;    "filtered" : {&#xA;      "query" : {&#xA;        "match_all" : { }&#xA;      },&#xA;      "filter" : {&#xA;        "query" : {&#xA;          "nested" : {&#xA;            "query" : {&#xA;              "match" : {&#xA;                "fields.name" : {&#xA;                  "query" : "AMORTIZED_COST",&#xA;                  "type" : "boolean"&#xA;                }&#xA;              }&#xA;            },&#xA;            "path" : "fields",&#xA;            "inner_hits" : {&#xA;              "name" : "fields"&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "fields" : "_sourceall",&#xA;  "aggregations" : {&#xA;    "3ztDl2iVtc" : {&#xA;      "nested" : {&#xA;        "path" : "fields"&#xA;      },&#xA;      "aggregations" : {&#xA;        "filter6yXyIpHISm" : {&#xA;          "filters" : {&#xA;            "filters" : [ {&#xA;              "query" : {&#xA;                "match" : {&#xA;                  "name" : {&#xA;                    "query" : "AMORTIZED_COST",&#xA;                    "type" : "boolean"&#xA;                  }&#xA;                }&#xA;              }&#xA;            } ]&#xA;          },&#xA;          "aggregations" : {&#xA;            "groupIBa1xQNOuK" : {&#xA;              "terms" : {&#xA;                "field" : "fields.name"&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The below is the output. </p>&#xA;&#xA;<pre><code>"aggregations": {&#xA;      "3ztDl2iVtc": {&#xA;         "doc_count": 282,&#xA;         "filter6yXyIpHISm": {&#xA;            "buckets": [&#xA;               {&#xA;                  "doc_count": 0,&#xA;                  "groupIBa1xQNOuK": {&#xA;                     "doc_count_error_upper_bound": 0,&#xA;                     "sum_other_doc_count": 0,&#xA;                     "buckets": []&#xA;                  }&#xA;               }&#xA;            ]&#xA;</code></pre>&#xA;
<p>In your aggregation filter you need to match on <code>fields.name</code> and not only on <code>name</code> since the filter is inside a <code>nested</code> aggregation:</p>&#xA;&#xA;<pre><code>  ...&#xA;  "aggregations" : {&#xA;    "3ztDl2iVtc" : {&#xA;      "nested" : {&#xA;        "path" : "fields"&#xA;      },&#xA;      "aggregations" : {&#xA;        "filter6yXyIpHISm" : {&#xA;          "filters" : {&#xA;            "filters" : [ {&#xA;              "query" : {&#xA;                "match" : {&#xA;                  "fields.name" : {              &lt;--- change this&#xA;                    "query" : "AMORTIZED_COST",&#xA;                    "type" : "boolean"&#xA;                  }&#xA;                }&#xA;              }&#xA;            } ]&#xA;          },&#xA;          "aggregations" : {&#xA;            "groupIBa1xQNOuK" : {&#xA;              "terms" : {&#xA;                "field" : "fields.name"&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;</code></pre>&#xA;