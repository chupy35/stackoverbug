31612921
how to build a range aggregation on parent by minimum value in children docs
<p>I have a parent/child relationship created between <code>Product</code> and <code>Pricing</code> documents. A <code>Product</code> has many <code>Pricing</code>, each with it's own <code>subtotal</code> field, and I'd simply like to create a range aggregation that only considers the minimum subtotal for each product and filters out the others. </p>&#xA;&#xA;<p>I think this is possible using nested aggregations and filters, but this is the closest I've gotten:</p>&#xA;&#xA;<pre><code> POST /test_index/Product/_search&#xA; {&#xA;   "aggs": {&#xA;     "offered-at": {&#xA;       "children": {&#xA;         "type": "Pricing"&#xA;       },&#xA;       "aggs": {&#xA;         "prices": {&#xA;           "aggs": {&#xA;             "min_price": {&#xA;               "min": {&#xA;                 "field": "subtotal"&#xA;               },&#xA;               "aggs": {&#xA;                 "min_price_buckets": {&#xA;                   "range": {&#xA;                     "field": "subtotal",&#xA;                     "ranges": [&#xA;                       {&#xA;                         "to": 100&#xA;                       },&#xA;                       {&#xA;                         "from": 100,&#xA;                         "to": 200&#xA;                       },&#xA;                       {&#xA;                         "from": 200&#xA;                       }&#xA;                     ]&#xA;                   }&#xA;                 }&#xA;               }&#xA;             }&#xA;           }&#xA;         }&#xA;       }&#xA;     }&#xA;   }&#xA; }&#xA;</code></pre>&#xA;&#xA;<p>However this results in the error <code>nested: AggregationInitializationException[Aggregator [min_price] of type [min] cannot accept sub-aggregations]; }]</code>, which sort of makes sense because once you reduce to a single value there is nothing left to aggregate.</p>&#xA;&#xA;<p>But how can I structure this so that the range aggregation is only pulling the minimum value from each set of children?</p>&#xA;&#xA;<p>(here is a sense with mappings and test data : <a href="http://sense.qbox.io/gist/01b072b4566ef6885113dc94a796f3bdc56f19a9" rel="nofollow">http://sense.qbox.io/gist/01b072b4566ef6885113dc94a796f3bdc56f19a9</a>)</p>&#xA;