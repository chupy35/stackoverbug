32306290
Elasticsearch getting the last nested or most recent nested element
<p>We have this mapping:</p>&#xA;&#xA;<pre><code>{&#xA;    "product_achievement": {&#xA;        "type": "nested",&#xA;        "properties": {&#xA;            "id": {&#xA;                "type": "long"&#xA;            },&#xA;            "last_purchase": {&#xA;                "type": "long"&#xA;            },&#xA;            "products": {&#xA;                "type": "long"&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>As you see this is nested, and the <code>last_purchase</code> field is a <code>unixtimestamp</code> value. We would like to query from all nested elements the most recent entry defined by the <code>last_purchase</code> field AND see if in the last entry there is some product id is in products. </p>&#xA;
<p>You can achieve this using a <code>nested</code> query with <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-inner-hits.html#nested-inner-hits" rel="nofollow"><code>inner_hits</code></a>. In the query part, you can specify the product id you want to match and then using <code>inner_hits</code> you can sort by decreasing <code>last_purchase</code> timestamp and only take the first one using <code>size: 1</code></p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "nested": {&#xA;      "path": "product_achievement",&#xA;      "query": {&#xA;        "term": {&#xA;          "product_achievement.products": 1&#xA;        }&#xA;      },&#xA;      "inner_hits": {&#xA;        "size": 1,&#xA;        "sort": {&#xA;          "product_achievement.last_purchase": "desc"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;