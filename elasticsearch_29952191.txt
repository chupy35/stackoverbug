29952191
Geo distance filter
<p>I am receiving a 400 bad request error from elasticsearch. The error is a big block response but I believe this is the key part.</p>&#xA;&#xA;<pre><code>failed to find mapper for [location] for geo distance based sort&#xA;</code></pre>&#xA;&#xA;<p>I am using ES 1.5.1 to query to. My query is:</p>&#xA;&#xA;<pre><code>{&#xA;  query: {&#xA;    filtered: {&#xA;      query: {&#xA;        match: {&#xA;          title:"amsterdam*"&#xA;        }&#xA;      }&#xA;    }&#xA;  }, sort: [&#xA;       {&#xA;         _geo_distance: {&#xA;           location: {lat:0, lon:0}, order:"asc", unit:"miles"&#xA;         }&#xA;       }&#xA;     ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I have formatted the query just like the documentation <a href="http://www.elastic.co/guide/en/elasticsearch/guide/current/sorting-by-distance.html" rel="nofollow">here</a>. Am I missing a step?</p>&#xA;&#xA;<p>This is my current mapping:</p>&#xA;&#xA;<pre><code>{&#xA;  "gb": {&#xA;    "mappings": {&#xA;      "store": {&#xA;        "dynamic":"false",&#xA;        "properties": {&#xA;          "active": {&#xA;            "type": "b‌​oolean"&#xA;          },&#xA;          "deleted": {&#xA;            "type": "boolean"&#xA;          },&#xA;          "location": {&#xA;            "type":"geo_point"&#xA;          },&#xA;          "open": {&#xA;            "ty‌​pe": "boolean"&#xA;          },&#xA;          "suspended": {&#xA;            "type": "boolean"&#xA;          },&#xA;          "title": {&#xA;            "type":"string"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;
<p>Your query is fine. The field <code>location</code> must have the mapping type <code>geo_point</code>, which it seems it has.</p>&#xA;&#xA;<p>Try this Marvel Sense script:</p>&#xA;&#xA;<p>(install Marvel by running <code>bin/plugin -i elasticsearch/marvel/latest</code>)</p>&#xA;&#xA;<pre><code>put geo&#xA;put geo/geo/_mapping&#xA;{&#xA;  "properties": {&#xA;    "location": {&#xA;          "type": "geo_point",&#xA;          "geohash" : true&#xA;    }&#xA;  }&#xA;}&#xA;put geo/geo/1&#xA;{&#xA;  "location": {&#xA;    "lat": 0.1,&#xA;    "lon": 0.1&#xA;  }&#xA;}&#xA;put geo/geo/2&#xA;{&#xA;  "location": {&#xA;    "lat": 50.1,&#xA;    "lon": 7.1&#xA;  }&#xA;}&#xA;put geo/geo/3&#xA;{&#xA;  "location": {&#xA;    "lat": 5.1,&#xA;    "lon": 3.1&#xA;  }&#xA;}&#xA;get geo/geo/_search&#xA;{&#xA;  "query": {&#xA;        "match_all": {&#xA;        }&#xA;    }, &#xA;  "sort": [&#xA;       {&#xA;         "_geo_distance": {&#xA;           "location": {"lat":0, "lon":0}, &#xA;           "order":"asc", &#xA;           "unit":"km"&#xA;         }&#xA;       }&#xA;     ]&#xA;}&#xA;get geo/_mapping&#xA;</code></pre>&#xA;&#xA;<p>For some reason, the search query doesn't work for me from Sense. Via curl it works without problems though: </p>&#xA;&#xA;<p><code>curl -XGET '0:9200/geo/geo/_search?pretty' -d@query.json</code></p>&#xA;
<p>I ran into this error using the elasticsearch npm - I don't think the mapping was getting created correctly.  I had to format my geopoint type as an array to get everything working.</p>&#xA;&#xA;<p>Using an object type did not work</p>&#xA;&#xA;<pre><code>"location": { &#xA;    "lat": 41.12,&#xA;    "lon": -71.34&#xA; }&#xA;</code></pre>&#xA;&#xA;<p>Format your field as an array instead</p>&#xA;&#xA;<pre><code>"location": [ -71.34, 41.12 ]&#xA;</code></pre>&#xA;