32006610
Unable to find a field mapper for field in nested query using field_value_factor
<p>Here's the mapping:</p>&#xA;&#xA;<pre><code>PUT books-index&#xA;{&#xA;  "mappings": {&#xA;    "books": {&#xA;      "properties": {&#xA;        "tags": {&#xA;          "type": "nested",&#xA;          "fields": {&#xA;            "name": {&#xA;              "type": "string"&#xA;            },&#xA;            "weight": {&#xA;              "type": "float"&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Then doing a nested query using a field_value_factor fails with an error</p>&#xA;&#xA;<pre><code>GET books-index/books/_search&#xA;{&#xA;  "query": {&#xA;    "nested": {&#xA;      "path": "tags",&#xA;      "score_mode": "sum",&#xA;      "query": {&#xA;        "function_score": {&#xA;          "query": {&#xA;            "match": {&#xA;              "tags.name": "world"&#xA;            }&#xA;          },&#xA;        "field_value_factor": {&#xA;            "field": "weight"&#xA;         }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The error: <strong>"nested: ElasticsearchException[Unable to find a field mapper for field [weight]]"</strong></p>&#xA;&#xA;<p>Interestingly, if there's one book in the index with tags - there's no error and the query works well.</p>&#xA;&#xA;<p><strong>Why is this happening? how can I prevent the error when there are no books with tags in the index?</strong></p>&#xA;&#xA;<p>Any ideas? </p>&#xA;&#xA;<p>Thank you!</p>&#xA;&#xA;<p>P.S. There's also an issue on github for this: <a href="https://github.com/elastic/elasticsearch/issues/12871" rel="nofollow">https://github.com/elastic/elasticsearch/issues/12871</a></p>&#xA;
<p>it looks like your mapping is incorrect.</p>&#xA;&#xA;<p>After <code>PUT</code>ing the mapping you provided, try executing <code>GET books-index/_mapping</code>, It will show these results:</p>&#xA;&#xA;<pre><code>"books-index": {&#xA;  "mappings": {&#xA;     "books": {&#xA;        "properties": {&#xA;           "tags": {&#xA;              "type": "nested"&#xA;           }&#xA;        }&#xA;     }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>It's missing name and weight! The problem with the mapping is that you used either you used <code>fields</code> instead of <code>properties</code>, or you forget to put in a second <code>properties</code> key.</p>&#xA;&#xA;<p>I modified your mapping to reflect that you were looking for a nested name and type within tags, as it looks like that is what your query wants.</p>&#xA;&#xA;<pre><code>PUT books-index&#xA;{&#xA;  "mappings": {&#xA;    "books": {&#xA;      "properties": {&#xA;        "tags": {&#xA;          "type": "nested",&#xA;          "properties": {               // &lt;--- HERE!&#xA;            "name": {&#xA;              "type": "string"&#xA;            },&#xA;            "weight": {&#xA;              "type": "float"&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;