30063221
For each country/colour/brand combination , find sum of number of items in elasticsearch
<p>This is a portion of the data I have indexed in elasticsearch:</p>&#xA;&#xA;<pre><code>{&#xA;  "country" : "India",&#xA;  "colour" : "white",&#xA;  "brand" : "sony"&#xA;  "numberOfItems" : 3&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I want to get the total sum of <code>numberOfItems</code> on a per country basis, per colour basis and per brand basis. Is there any way to do this in elasticsearch?</p>&#xA;
<p>To get a single result you may use <a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.5/search-aggregations-metrics-sum-aggregation.html" rel="nofollow">sum aggregation</a> applied to a filtered query with term (terms) filter, e.g.:</p>&#xA;&#xA;<pre><code>{&#xA;    "query": {&#xA;        "filtered": {&#xA;            "filter": {&#xA;                "term": {&#xA;                    "country": "India"&#xA;                } &#xA;            }&#xA;        }&#xA;    },&#xA;    "aggs": {&#xA;        "total_sum": {&#xA;            "sum": {&#xA;                "field": "numberOfItems"&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>To get statistics for all countries/colours/brands in a single pass over the data you may use the following query with 3 multi-bucket aggregations, each of them containing a single-bucket sum <a href="http://www.elastic.co/guide/en/elasticsearch/guide/master/_buckets_inside_buckets.html" rel="nofollow">sub-aggregation</a>:</p>&#xA;&#xA;<pre><code>{&#xA;    "query": {&#xA;        "match_all": {}&#xA;    },&#xA;    "aggs": {&#xA;        "countries": {&#xA;            "terms": {&#xA;                "field": "country"&#xA;            },&#xA;            "aggs": {&#xA;                "country_sum": {&#xA;                    "sum": {&#xA;                        "field": "numberOfItems"&#xA;                    }&#xA;                }&#xA;            }&#xA;        },&#xA;        "colours": {&#xA;            "terms": {&#xA;                "field": "colour"&#xA;            },&#xA;            "aggs": {&#xA;                "colour_sum": {&#xA;                    "sum": {&#xA;                        "field": "numberOfItems"&#xA;                    }&#xA;                }&#xA;            }&#xA;        },&#xA;        "brands": {&#xA;            "terms": {&#xA;                "field": "brand"&#xA;            },&#xA;            "aggs": {&#xA;                "brand_sum": {&#xA;                    "sum": {&#xA;                        "field": "numberOfItems"&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;
<p>The following should land you straight to the answer.&#xA;Make sure you enable scripting before using it.</p>&#xA;&#xA;<pre><code>{&#xA;  "aggs": {&#xA;    "keys": {&#xA;      "terms": {&#xA;        "script": "doc['country'].value + doc['color'].value + doc['brand'].value"&#xA;      },&#xA;      "aggs": {&#xA;        "keySum": {&#xA;          "sum": {&#xA;            "field": "numberOfItems"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;