30991248
Elasticsearch: Filter (or Query) by Term Frequency
<p>How do I run an elasticsearch query that only returns results with the term X mentioned at least Y times in a document? </p>&#xA;&#xA;<p>For example, suppose you had a footer in all of your indexed documents that say something like <code>copyright 2013</code>.  Suppose when the user runs a search for the term <code>copyright</code>, you want to be smart and only show those documents that say the word <code>copyright</code> twice (otherwise you'll return all documents). I know there are multiple ways of accomplishing this, but one way, would be to run a filter that returns only those documents that use the term copyright twice. Does such a filter exist?</p>&#xA;&#xA;<p>I could envision something like this, but I don't see anything comparable in the docs:</p>&#xA;&#xA;<pre><code>"filter" : {&#xA;            "term" : { "user" : "copyright"},&#xA;            "frequency" : { "gt" : 1 }&#xA;        }&#xA;</code></pre>&#xA;&#xA;<p>Considering that Elasticsearch stores term frequencies, I would expect that this would be possible to implement.</p>&#xA;
<p>Use a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-script-filter.html" rel="nofollow">script filter</a> in which you access the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-advanced-scripting.html#_term_statistics_2" rel="nofollow">term frequency</a> of <code>copyright</code> in field <code>user</code> using something like <code>_index['user']['copyright'].tf()</code>:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;        "script": {&#xA;          "script": "_index['name'][term_to_lookup].tf() &gt; occurrences",&#xA;          "params": {&#xA;            "term_to_lookup": "copyright",&#xA;            "occurrences": 1&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;