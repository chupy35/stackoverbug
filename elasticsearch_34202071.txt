34202071
Elastic Search 1.7.3 Nested filter: matching terms in an array of objects
<p>I am trying to query for the following document in my elasticsearch: </p>&#xA;&#xA;<pre><code>"amenity": [&#xA;        "Free Wifi",&#xA;        "Free Breakfast",&#xA;        "Veg Only",&#xA;        "Swimming Pool",&#xA;        "Newspaper",&#xA;        "Bar",&#xA;        "Credit Card",&#xA;        "Pickup &amp; Drop",&#xA;        "Gym",&#xA;        "Elevator",&#xA;        "Valet Parking"&#xA;      ],&#xA;      "dodont": [&#xA;        {&#xA;          "do_or_dont": "Do",&#xA;          "what": "Vegetarians"&#xA;        },&#xA;        {&#xA;          "do_or_dont": "Do",&#xA;          "what": "Family"&#xA;        },&#xA;        {&#xA;          "do_or_dont": "Dont",&#xA;          "what": "Loud Music"&#xA;        },&#xA;        {&#xA;          "do_or_dont": "Dont",&#xA;          "what": "Booze"&#xA;        }&#xA;      ]&#xA;</code></pre>&#xA;&#xA;<p>and here is the query I have written: </p>&#xA;&#xA;<pre><code>"filter": {&#xA;    "and": {&#xA;      "filters": [&#xA;        {&#xA;          "nested" : {&#xA;            "path" : "dodont",&#xA;            "filter" : {&#xA;              "bool" : {&#xA;                "must": [{"and" : [&#xA;                        {&#xA;                            "term" : {"dodont.do_or_dont" : "Do"}&#xA;                        },&#xA;                        {&#xA;                            "term" : {"dodont.what" : "Vegetarians"}&#xA;                        }&#xA;                    ]},&#xA;                    {"and" : [&#xA;                        {&#xA;                            "term" : {"dodont.do_or_dont" : "Do"}&#xA;                        },&#xA;                        {&#xA;                            "term" : {"dodont.what" : "Family"}&#xA;                        }&#xA;                    ]}]  &#xA;              }&#xA;&#xA;            }&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;</code></pre>&#xA;&#xA;<p>Now this query returns empty result, but when I change the "must" to "should" in the bool in above code, it returns the above document as the result (there is only 1 document matching this filter the one shown above), but ideally, the "must" condition should return the above document, I want to pass multiple objects for Do's and donts and I only want the results which match all of them, but I am not able to do so. How should I go about it?</p>&#xA;
<p>You need to split out the two conditions on your nested document, since each element of the <code>dodont</code> nested array is conceptually a separate document:</p>&#xA;&#xA;<pre><code>{&#xA;  "filter": {&#xA;    "and": {&#xA;      "filters": [&#xA;        {&#xA;          "nested": {&#xA;            "path": "dodont",&#xA;            "filter": {&#xA;              "and": [&#xA;                {&#xA;                  "term": {&#xA;                    "dodont.do_or_dont": "Do"&#xA;                  }&#xA;                },&#xA;                {&#xA;                  "term": {&#xA;                    "dodont.what": "Vegetarians"&#xA;                  }&#xA;                }&#xA;              ]&#xA;            }&#xA;          }&#xA;        },&#xA;        {&#xA;          "nested": {&#xA;            "path": "dodont",&#xA;            "filter": {&#xA;              "and": [&#xA;                {&#xA;                  "term": {&#xA;                    "dodont.do_or_dont": "Do"&#xA;                  }&#xA;                },&#xA;                {&#xA;                  "term": {&#xA;                    "dodont.what": "Family"&#xA;                  }&#xA;                }&#xA;              ]&#xA;            }&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;