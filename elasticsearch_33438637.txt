33438637
Building backend for reporting using elasticsearch: Is this query possible?
<p>Is it possible to query elasticsearch to sum the number of minutes an entry is in a given status based on the datetimes for a month?</p>&#xA;&#xA;<p>For example, entries would be of the form:</p>&#xA;&#xA;<pre><code>Datetime        Cluster     Hosts_on    Hosts_off   Hosts_on_percentage&#xA;Oct 10 12:01    c101        10          2           .8333&#xA;Oct 10 12:02    c101        10          2           .8333&#xA;Oct 10 12:03    c101        10          2           .8333&#xA;</code></pre>&#xA;&#xA;<p>Is it possible to sum the number of minutes c101 has had greater than 60% hosts based on the datetime?</p>&#xA;
<p>Not exactly, but you can get pretty close with something like this:</p>&#xA;&#xA;<pre><code>POST /test_index/_search?search_type=count&#xA;{&#xA;   "query": {&#xA;      "filtered": {&#xA;         "filter": {&#xA;            "bool": {&#xA;               "must": [&#xA;                  {&#xA;                     "term": {&#xA;                        "Cluster": "c101"&#xA;                     }&#xA;                  },&#xA;                  {&#xA;                     "range": {&#xA;                        "Hosts_on_percentage": {&#xA;                           "gt": 0.6&#xA;                        }&#xA;                     }&#xA;                  }&#xA;               ]&#xA;            }&#xA;         }&#xA;      }&#xA;   },&#xA;   "aggs": {&#xA;      "min_datetime": {&#xA;         "min": {&#xA;            "field": "Datetime"&#xA;         }&#xA;      },&#xA;      "max_datetime": {&#xA;         "max": {&#xA;            "field": "Datetime"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>With the data you posted, this query returns:</p>&#xA;&#xA;<pre><code>{&#xA;   "took": 4,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 3,&#xA;      "max_score": 0,&#xA;      "hits": []&#xA;   },&#xA;   "aggregations": {&#xA;      "max_datetime": {&#xA;         "value": 820980000,&#xA;         "value_as_string": "Jan 10 12:03"&#xA;      },&#xA;      "min_datetime": {&#xA;         "value": 820860000,&#xA;         "value_as_string": "Jan 10 12:01"&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>So then you could calculate the difference in the min and max time client-side.</p>&#xA;&#xA;<p>Or, if you just want a count of the documents returned, you can get it from:</p>&#xA;&#xA;<pre><code>"hits": {&#xA;   "total": 3,&#xA;   "max_score": 0,&#xA;   "hits": []&#xA;},&#xA;</code></pre>&#xA;&#xA;<p>Here is some code I used to test it (getting the date mapping right is important here):</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/c62289926a18e34b1b1b31e3643f36cbe5a7b4cf" rel="nofollow">http://sense.qbox.io/gist/c62289926a18e34b1b1b31e3643f36cbe5a7b4cf</a></p>&#xA;
<p>You can definitive sum up minutes if they are in a field for each cluster and datetime. You have to use bucket and metrics aggregation. The condition could be made by a range aggregation.</p>&#xA;&#xA;<p>Links i putted below; i hope i could give you an idea how to solve this task:-)</p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html</a> </p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics.html</a></p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html</a></p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-range-aggregation.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-range-aggregation.html</a></p>&#xA;