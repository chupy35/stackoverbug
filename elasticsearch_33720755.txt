33720755
How to explain the query in elasticsearch
<p>I have a complex query in elasticsearch. it's slow. I want to optimize it.&#xA;but i can't know how to work .&#xA;how to explain the query , like Sql explain.</p>&#xA;&#xA;<p>i see elastichsearch _valite/query?explain . it can explain score.&#xA;but I need to view detailed execution plan. </p>&#xA;&#xA;<pre><code>{&#xA;  "post_filter": {&#xA;    "bool": {&#xA;      "should": [&#xA;        {&#xA;          "bool": {&#xA;            "must": [&#xA;              {&#xA;                "term": {&#xA;                  "base.sysCode": "2801"&#xA;                }&#xA;              },&#xA;              {&#xA;                "term": {&#xA;                  "base.status": [&#xA;                    12,&#xA;                    0&#xA;                  ]&#xA;                }&#xA;              }&#xA;            ]&#xA;          }&#xA;        }&#xA;      ]&#xA;    }&#xA;  },&#xA;  "fields": [&#xA;    "base.sysCode",&#xA;    "base.orderNo"&#xA;  ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>result</p>&#xA;&#xA;<pre><code>{&#xA;"valid": true,&#xA;"_shards": {&#xA;"total": 1,&#xA;"successful": 1,&#xA;"failed": 0&#xA;},&#xA;"explanations": [&#xA;{&#xA;"index": "odi_bus_betad_2013",&#xA;"valid": true,&#xA;"explanation": "ConstantScore(*:*)"&#xA;}&#xA;]&#xA;}&#xA;</code></pre>&#xA;
<p>The usage for the Explain API is <a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.4/search-explain.html" rel="nofollow">here</a></p>&#xA;&#xA;<blockquote>&#xA;  <p>The explain api computes a score explanation for a query and a&#xA;  specific document. This can give useful feedback whether a document&#xA;  matches or didnâ€™t match a specific query.</p>&#xA;</blockquote>&#xA;
<p>Add <code>"explain": true</code></p>&#xA;&#xA;<pre><code>GET /_search&#xA;{&#xA;    "explain": true,&#xA;    "query" : {&#xA;        "term" : { "user" : "kimchy" }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-explain.html" rel="noreferrer"><strong>Documentation</strong></a></p>&#xA;
<p>You did everything right. You ran your query with <code>explain</code> and Elasticsearch did show you the detailed execution plan, under <code>explanations</code>.</p>&#xA;&#xA;<p>However, the detailed execution plan here apparently has no details at all; this is because you actually did not run a query at all. You ran just a <code>post_filter</code> (the very first keyword in your example.)</p>&#xA;&#xA;<p>Because you didn't specify a query at all, Elasticsearch matches every single document in your index and applies a constant score to all of them. This is why, under <code>explanations</code>, you see: <code>"explanation": "ConstantScore(*:*)"</code></p>&#xA;&#xA;<p>Because every single document in your index was matched, the <code>post_filter</code> you specified is applied against each one of them. This in itself is already slow; to make it even worse, post filters are never cached. (<a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_post_filter.html" rel="nofollow noreferrer">https://www.elastic.co/guide/en/elasticsearch/guide/current/_post_filter.html</a>) So <code>explain</code> would never tell you any filter or cache information for your example, even if it could.</p>&#xA;&#xA;<p>So, to answer your question: <code>explain</code> already returned the best detailed execution plan Elasticsearch could offer given your specific example. You can try a regular <code>filter</code> instead of a <code>post_filter</code> to give Elasticsearch a chance to build caches and increase performance.</p>&#xA;
<p>Stick the profile keyword into your query if you're running a recent version:</p>&#xA;&#xA;<pre><code>GET binary/_search&#xA;{&#xA;   "profile": true,&#xA;    "query": {&#xA;     ...&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>If you had X-Pack, you could use the GUI based profiler to see where it's sluggish. Sadly not available in the open-source version, but it's just a prettier version of the output from the above - <a href="https://www.elastic.co/guide/en/kibana/5.6/xpack-profiler.html" rel="nofollow noreferrer">https://www.elastic.co/guide/en/kibana/5.6/xpack-profiler.html</a> </p>&#xA;&#xA;<p>You might be able to do a 30 day trial, or if you are lucky, maybe you already have the X-Pack licence. </p>&#xA;