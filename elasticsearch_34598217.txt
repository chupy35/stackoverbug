34598217
Deserialize source in native elasticsearch script plugin
<p>I am using a native sort script &amp; want to deserialize the source doc inside it (to access multi level nested objects). I can get the SourceLookup object using </p>&#xA;&#xA;<pre><code>SourceLookup source = source(); &#xA;</code></pre>&#xA;&#xA;<p>which gives me the bytes </p>&#xA;&#xA;<pre><code>byte[] bytes = source.internalSourceRef().toBytes()&#xA;</code></pre>&#xA;&#xA;<p>What is the serialization format of these bytes and how can I deserialize it? Also what are the performance considerations of doing this operation? &#xA;Does it require a disk access for each document?</p>&#xA;
<p>Having a look at the source code of <a href="https://github.com/elastic/elasticsearch/blob/e95af69fb71d67c3fb2a2806da24214dc4805140/core/src/main/java/org/elasticsearch/search/lookup/SourceLookup.java" rel="nofollow"><code>SourceLookup</code></a> tells you a bit more about what you can find in there. That byte array is basically a serialized <code>Map</code> (possibly compressed) symbolizing the document source.</p>&#xA;&#xA;<p>The way to use it is to call <code>source()</code> again on the <code>source</code> reference you get in order to retrieve the underlying <code>Map</code>:</p>&#xA;&#xA;<pre><code>SourceLookup source = source();&#xA;// number of keys in the map&#xA;int size = source.size();&#xA;// retrieve the content of the source&#xA;Map&lt;String, Object&gt; map = source.source();&#xA;// use the source map&#xA;</code></pre>&#xA;