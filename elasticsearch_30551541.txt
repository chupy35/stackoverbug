30551541
Using minimum_should_match in filtered elasticSearch query
<p>I have a filtered elasticsearch query that works, but I want to use minimum_should_match to instruct ES to return only results that have at least 3 should matches. But I can't seem to figure out where to put minimum_should_match. Where should I put it?</p>&#xA;&#xA;<pre><code>{&#xA;  "size": 100,&#xA;  "sort": {&#xA;    "price_monthly": "asc"&#xA;  },&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "match_all": []&#xA;      },&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [],&#xA;          "should": [&#xA;            [&#xA;              {&#xA;                "range": {&#xA;                  "mb.untouched": {&#xA;                    "gte": "0",&#xA;                    "lt": "500"&#xA;                  }&#xA;                }&#xA;              },&#xA;              {&#xA;                "range": {&#xA;                  "mb.untouched": {&#xA;                    "gte": "500",&#xA;                    "lt": "1000"&#xA;                  }&#xA;                }&#xA;              }&#xA;            ],&#xA;            [&#xA;              {&#xA;                "range": {&#xA;                  "minutes.untouched": {&#xA;                    "gte": "0",&#xA;                    "lt": "100"&#xA;                  }&#xA;                }&#xA;              },&#xA;              {&#xA;                "range": {&#xA;                  "minutes.untouched": {&#xA;                    "gte": "200",&#xA;                    "lt": "300"&#xA;                  }&#xA;                }&#xA;              }&#xA;            ],&#xA;            [&#xA;              {&#xA;                "range": {&#xA;                  "sms.untouched": {&#xA;                    "gte": "750",&#xA;                    "lt": "1000"&#xA;                  }&#xA;                }&#xA;              }&#xA;            ]&#xA;          ],&#xA;          "must_not": {&#xA;            "missing": {&#xA;              "field": "provider.untouched"&#xA;            }&#xA;          }&#xA;        }&#xA;      },&#xA;      "strategy": "query_first"&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "provider.untouched": {&#xA;      "terms": {&#xA;        "field": "provider.untouched"&#xA;      }&#xA;    },&#xA;    "prolong.untouched": {&#xA;      "terms": {&#xA;        "field": "prolong.untouched"&#xA;      }&#xA;    },&#xA;    "duration.untouched": {&#xA;      "terms": {&#xA;        "field": "duration.untouched"&#xA;      }&#xA;    },&#xA;    "mb.untouched": {&#xA;      "histogram": {&#xA;        "field": "mb.untouched",&#xA;        "interval": 500,&#xA;        "min_doc_count": 1&#xA;      }&#xA;    },&#xA;    "sms.untouched": {&#xA;      "histogram": {&#xA;        "field": "sms.untouched",&#xA;        "interval": 250,&#xA;        "min_doc_count": 1&#xA;      }&#xA;    },&#xA;    "minutes.untouched": {&#xA;      "histogram": {&#xA;        "field": "minutes.untouched",&#xA;        "interval": 100,&#xA;        "min_doc_count": 1&#xA;      }&#xA;    },&#xA;    "price_monthly.untouched": {&#xA;      "histogram": {&#xA;        "field": "price_monthly.untouched",&#xA;        "interval": 5,&#xA;        "min_doc_count": 1&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;
<p>In order to use <code>minimum_should_match</code>, you need to rewrite your filtered query a little bit, i.e. you need to move your <code>should</code> clause to the <code>query</code> part of the filtered query and just keep <code>must_not</code> in the <code>filter</code> part (because <code>missing</code> is a filter). Then you can add <code>minimum_should_match: 3</code> in the <code>bool</code> query part as shown below:</p>&#xA;&#xA;<pre><code>{&#xA;  "size": 100,&#xA;  "sort": {&#xA;    "price_monthly": "asc"&#xA;  },&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "bool": {&#xA;          "minimum_should_match": 3,&#xA;          "must": [],&#xA;          "should": [&#xA;            [&#xA;              {&#xA;                "range": {&#xA;                  "mb.untouched": {&#xA;                    "gte": "0",&#xA;                    "lt": "500"&#xA;                  }&#xA;                }&#xA;              },&#xA;              {&#xA;                "range": {&#xA;                  "mb.untouched": {&#xA;                    "gte": "500",&#xA;                    "lt": "1000"&#xA;                  }&#xA;                }&#xA;              }&#xA;            ],&#xA;            [&#xA;              {&#xA;                "range": {&#xA;                  "minutes.untouched": {&#xA;                    "gte": "0",&#xA;                    "lt": "100"&#xA;                  }&#xA;                }&#xA;              },&#xA;              {&#xA;                "range": {&#xA;                  "minutes.untouched": {&#xA;                    "gte": "200",&#xA;                    "lt": "300"&#xA;                  }&#xA;                }&#xA;              }&#xA;            ],&#xA;            [&#xA;              {&#xA;                "range": {&#xA;                  "sms.untouched": {&#xA;                    "gte": "750",&#xA;                    "lt": "1000"&#xA;                  }&#xA;                }&#xA;              }&#xA;            ]&#xA;          ]&#xA;        }&#xA;      },&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must_not": {&#xA;            "missing": {&#xA;              "field": "provider.untouched"&#xA;            }&#xA;          }&#xA;        }&#xA;      },&#xA;      "strategy": "query_first"&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "provider.untouched": {&#xA;      "terms": {&#xA;        "field": "provider.untouched"&#xA;      }&#xA;    },&#xA;    "prolong.untouched": {&#xA;      "terms": {&#xA;        "field": "prolong.untouched"&#xA;      }&#xA;    },&#xA;    "duration.untouched": {&#xA;      "terms": {&#xA;        "field": "duration.untouched"&#xA;      }&#xA;    },&#xA;    "mb.untouched": {&#xA;      "histogram": {&#xA;        "field": "mb.untouched",&#xA;        "interval": 500,&#xA;        "min_doc_count": 1&#xA;      }&#xA;    },&#xA;    "sms.untouched": {&#xA;      "histogram": {&#xA;        "field": "sms.untouched",&#xA;        "interval": 250,&#xA;        "min_doc_count": 1&#xA;      }&#xA;    },&#xA;    "minutes.untouched": {&#xA;      "histogram": {&#xA;        "field": "minutes.untouched",&#xA;        "interval": 100,&#xA;        "min_doc_count": 1&#xA;      }&#xA;    },&#xA;    "price_monthly.untouched": {&#xA;      "histogram": {&#xA;        "field": "price_monthly.untouched",&#xA;        "interval": 5,&#xA;        "min_doc_count": 1&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;