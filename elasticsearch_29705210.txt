29705210
what is this elastic search query called?
<p>My team has been struggling with figuring out a rather gnarly elastic search query for a little while now. Making it worse is we can't find any answers on the internet and we don't really know what to call what we're searching for. The use case is as follows: </p>&#xA;&#xA;<p>Given a month or so of social data we would like to search some timespan for the most recent interaction from each user and then aggregate one of the values of these interactions. The search result for 3/20/15 would return one and only one interaction for each username that interacted on that day. The timestamp of the interaction returned would be the closest one to 12AM 3/21/15. Seems easy enough, no?</p>&#xA;&#xA;<p>We've tried the top_hits aggregation but we cannot aggregate that result. We're willing to reindex the data in a format that will support this query if need be. Any help on researching or solving this issue would be greatly appreciated. </p>&#xA;&#xA;<p>BTW: For those that don't know what social data is... Public social interactions for users on all of the relevant social networking websites. Each post contains some piece of content, timestamp and author. </p>&#xA;
<p>Sounds like you need a Date Histogram Aggregation <a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.5/search-aggregations-bucket-datehistogram-aggregation.html" rel="nofollow">See Date Histogram Docs</a></p>&#xA;&#xA;<p>You can then apply a filter on the Date Histogram Aggregation to filter the documents returned by the aggregation as you need, remember the order of the filters you apply matters.</p>&#xA;&#xA;<p>Hope this helps you a little</p>&#xA;&#xA;<p>Lee</p>&#xA;
<p>Lets assume we have the document as below - </p>&#xA;&#xA;<pre><code>{&#xA;  "user": "qbox",&#xA;  "timestamp": "2015-01-01 01:01:01"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>In mapping you need to mark timestamp as date type.&#xA;Now the following query should get things running for you - </p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "range": {&#xA;      "timestamp": {&#xA;        "gte": "2015-01-01 00:00:00",&#xA;        "lt": "2015-01-02 00:00:00"&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "perUser": {&#xA;      "terms": {&#xA;        "field": "user"&#xA;      },&#xA;      "aggs": {&#xA;        "maxDate": {&#xA;          "max": {&#xA;            "field": "timestamp"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here you are first filtering one day worth data in the query.&#xA;Now for each user , you are finding the maximum date value.&#xA;This value would be the last interaction of that user for that day. This value would be epoch , you will need to format the timestamp value to make sense out of it.</p>&#xA;