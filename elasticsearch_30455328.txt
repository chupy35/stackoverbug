30455328
Do aggregation from values based in 2 different fields in elasticsearch
<p>I have indexed documents like the following</p>&#xA;&#xA;<pre><code>{&#xA;"category" : "student",&#xA;"name" : "John",&#xA;"state" : "Florida",&#xA;"grade": "A"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>What i need to do is a double layered aggregation on the fields "state" and "grade". That is ,basically I want to know the grade distribution per state. So the normal way to do this is to apply aggregation on the field "state" and nest one inside that aggregation on the field "grade". But can I do the same in just one step?</p>&#xA;
<p>What do you mean by: </p>&#xA;&#xA;<blockquote>&#xA;  <p>'But can I do the same in just one step?'</p>&#xA;</blockquote>&#xA;&#xA;<p>The following request would create a bucket for each state, then create a bucket for each grade of each state. You'll get grade distribution per state, in one request</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {},&#xA;  "aggs": {&#xA;    "grouped_by_state": {&#xA;      "terms": {&#xA;        "field": "state"&#xA;      },&#xA;      "aggs": {&#xA;        "grades_distribution": {&#xA;          "terms": {&#xA;            "field": "grade"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;
<p>We can achieve this using script support - </p>&#xA;&#xA;<pre><code>{&#xA;  "aggs": {&#xA;    "terms": {&#xA;      "terms": {&#xA;"script" : "doc['state'].value + doc['grade'].value"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here we are appending value of these fields to get a permutation of both.</p>&#xA;