30455937
elasticsearch geo distance query failure
<p>I have a little question about elasticsearch.</p>&#xA;&#xA;<p>I use the next mapping inside my table. (geonames table)</p>&#xA;&#xA;<pre><code>{&#xA; "zoek": {&#xA;      "mappings": {&#xA;         "geo": {&#xA;            "properties": {&#xA;               "country": {&#xA;                  "type": "string"&#xA;               },&#xA;               "geonameid": {&#xA;                  "type": "string"&#xA;               },&#xA;               "locatie": {&#xA;                  "type": "geo_point"&#xA;               },&#xA;               "name": {&#xA;                  "type": "string"&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>"locatie" is a geo_point mapping from array of double.</p>&#xA;&#xA;<p>So searching for our local village "rhee" works fine:</p>&#xA;&#xA;<pre><code>GET /zoek/geo/_search&#xA;{&#xA;    "query": {&#xA;        "match": { "name": "rhee" }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Answer:</p>&#xA;&#xA;<pre><code>{&#xA;   "took": 3,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 5,&#xA;      "successful": 5,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 1,&#xA;      "max_score": 8.156567,&#xA;      "hits": [&#xA;         {&#xA;            "_index": "zoek",&#xA;            "_type": "geo",&#xA;            "_id": "4533",&#xA;            "_score": 8.156567,&#xA;            "_source": {&#xA;               "geonameid": "2748193",&#xA;               "name": "Rhee",&#xA;               "locatie": [&#xA;                  53.0325,&#xA;                  6.56667&#xA;               ],&#xA;               "country": "NL"&#xA;            }&#xA;         }&#xA;      ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>-> now i want to query all places in a radius of 15 KM from "rhee"&#xA;( for instance )</p>&#xA;&#xA;<pre><code>GET /zoek/geo/_search&#xA;{&#xA;    "filtered" : {&#xA;        "query" : {&#xA;            "match": { "name": "rhee" }&#xA;        },&#xA;        "filter" : {&#xA;            "geo_distance" : {&#xA;                "distance" : "15km",&#xA;                "locatie" : [ 53.0325, 6.56667 ]&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The following exception is raised:</p>&#xA;&#xA;<p>SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures</p>&#xA;&#xA;<p>Parse Failure [No parser for element [filtered]]]</p>&#xA;&#xA;<p>Also, this query:</p>&#xA;&#xA;<pre><code>get /zoek/geo/_search&#xA;{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "filter": {&#xA;              "geo_distance": {&#xA;                "distance": "5km",&#xA;                "locatie": [ 53.0325, 6.56667 ]&#xA;                }&#xA;              }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>returns all fields instead of 5 km distance records.</p>&#xA;&#xA;<p>Any suggestions?</p>&#xA;&#xA;<p>Peace, </p>&#xA;&#xA;<p>Digi</p>&#xA;
<p>Change this query </p>&#xA;&#xA;<pre><code>{&#xA;    "filtered" : {&#xA;        "query" : {&#xA;            "match" : {&#xA;                "name" : "rhee"&#xA;            }&#xA;        },&#xA;        "filter" : {&#xA;            "geo_distance" : {&#xA;                "distance" : "15km",&#xA;                "locatie" : [53.0325, 6.56667]&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>to</p>&#xA;&#xA;<pre><code>{&#xA;    "query" : {&#xA;        "filtered" : {&#xA;            "query" : {&#xA;                "match" : {&#xA;                    "name" : "rhee"&#xA;                }&#xA;            },&#xA;            "filter" : {&#xA;                "geo_distance" : {&#xA;                    "distance" : "15km",&#xA;                    "locatie" : [53.0325, 6.56667]&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Outer <code>query</code> was missing.</p>&#xA;