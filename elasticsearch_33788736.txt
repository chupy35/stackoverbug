33788736
ElasticSearch agg on substring of data
<p>I need to do avg() on a substring of data. Is it possible in ES?&#xA;Here is my script</p>&#xA;&#xA;<pre><code>{    &#xA;  "size": 0&#xA;   ,"query": {&#xA;      "bool": {&#xA;        "must": [&#xA;          { "term": {"app": "att"} }&#xA;        ]&#xA;      }&#xA;    }&#xA;   ,"aggs": {&#xA;    "clients": {&#xA;      "terms": {"field": "client"}&#xA;        ,"aggs" : {&#xA;                "_avg_" : { "avg" : { "field" : "ms" } }&#xA;            }      &#xA;      }      &#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The problem is that field "_ms" looks like:</p>&#xA;&#xA;<pre><code>It took: 100 ms ......&#xA;It took: 104 ms ......&#xA;It took: 102 ms ......&#xA;</code></pre>&#xA;&#xA;<p>So, I'd have to pull 100, 104, 102 and so on before I do "avg"</p>&#xA;
<p>If you cannot re-index your data and absolutely "have to" work with that data, you can use a <code>script</code> in your <code>avg</code> aggregation. Since you don't have that much data, the performance will not suffer too much.</p>&#xA;&#xA;<p>The Groovy script you can use would be simply <code>doc['ms'].value as Integer</code> which would coerce the string into an integer and use the integer value to perform the average.</p>&#xA;&#xA;<pre><code>{&#xA;   "size": 0,&#xA;   "query": {&#xA;      "bool": {&#xA;         "must": [&#xA;            {&#xA;               "term": {&#xA;                  "app": "att"&#xA;               }&#xA;            }&#xA;         ]&#xA;      }&#xA;   },&#xA;   "aggs": {&#xA;      "clients": {&#xA;         "terms": {&#xA;            "field": "client"&#xA;         },&#xA;         "aggs": {&#xA;            "_avg_": {&#xA;               "avg": {&#xA;                  "script": "doc['ms'].value as Integer"&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Note that in order to perform this query you need to <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html#enable-dynamic-scripting" rel="nofollow">enable dynamic scripting</a></p>&#xA;