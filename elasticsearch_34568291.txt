34568291
How to obtain the number of documents greater than a percentile aggregation?
<p>Here an ElasticSearch DSL query to return the value of the 90th percentile of a field named duration (duration is a webservice time response duration in milisecond but we do not care ...)</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "match_all": {}&#xA;  },&#xA;  "aggs": {&#xA;    "percentile90": {&#xA;      "percentiles": {&#xA;        "field": "duration",&#xA;        "percents": [&#xA;          90&#xA;        ]&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I need to calculate the number of documents for which the duration value is greater than the 90th percentile duration value.</p>&#xA;
<p>What you are asking for is something similar to HAVING clause in SQL. This is not supported by ElasticSearch (2.X AFAIK). You have to do it with two requests.</p>&#xA;
<blockquote>&#xA;  <p>I need to calculate the number of documents for which the duration&#xA;  value is greater than the 90th percentile duration value.</p>&#xA;</blockquote>&#xA;&#xA;<p>Isn't this 10% of the total number of documents, just based on the definition of percentiles? This is, assuming that durations are floats and thus could be expected to be unique.</p>&#xA;&#xA;<p>On the other hand if you want to calculate for example average duration of those which took longer than 90th percentile you'd indeed need to use two queries.</p>&#xA;