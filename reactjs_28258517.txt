28258517
React js: Input element renders differently compared to other elements
<p>I made a simple application (in react js) that has two lists and you can add elements to that list. One is a list of input elements and other is list of spans.</p>&#xA;&#xA;<p>Upon adding new element, the list of span renders perfectly but the list of inputs renders differently.</p>&#xA;&#xA;<p>This is how my react class looks like</p>&#xA;&#xA;<pre><code>var App = React.createClass({&#xA;  getInitialState: function(){&#xA;    return {&#xA;      'app': {&#xA;        'data': this.props.data,&#xA;        'data2': this.props.data2&#xA;      }&#xA;    };&#xA;  },&#xA;  onclick: function(){&#xA;    var dat = this.state.app.data;&#xA;    var val = this.refs.input.getDOMNode().value;&#xA;&#xA;    dat.splice(0, 0, val);&#xA;&#xA;    var dat2 = this.state.app.data2;&#xA;    dat2.splice(0, 0, val);&#xA;&#xA;    this.setState({'app': {&#xA;      'data': dat,&#xA;      'data2': dat2&#xA;    }});&#xA;&#xA;  },&#xA;  renderElement: function(i){&#xA;    return(&#xA;      &lt;input defaultValue={i} /&gt;&#xA;    );&#xA;  },&#xA;  renderElement2: function(i){&#xA;    return(&#xA;      &lt;span&gt;{i}&lt;/span&gt;&#xA;    );&#xA;  },&#xA;  render: function(){&#xA;    var self = this;&#xA;    return(&#xA;      &lt;div&gt;&#xA;        &lt;input type="text" ref="input" placeholder="Enter a value"/&gt;&#xA;        &lt;input type="button" value="Add value" onClick={this.onclick} /&gt;&#xA;        &lt;div className="col2"&gt;&#xA;          {this.state.app.data.map(function(page, i){&#xA;              return(&#xA;                &lt;div key={i}&gt;{self.renderElement(page)}&lt;/div&gt;&#xA;              );&#xA;          })}&#xA;        &lt;/div&gt;&#xA;        &lt;div className="col2"&gt;&#xA;          {this.state.app.data2.map(function(page, i){&#xA;              return(&#xA;                &lt;div key={i}&gt;{self.renderElement2(page)}&lt;/div&gt;&#xA;              );&#xA;          })}&#xA;        &lt;/div&gt;&#xA;      &lt;/div&gt;&#xA;    );&#xA;  }&#xA;});&#xA;</code></pre>&#xA;&#xA;<p>This is how the App is rendered</p>&#xA;&#xA;<pre><code>var data =  [1,2,3];&#xA;var data2 =  [1,2,3];&#xA;&#xA;React.render(&lt;App data={data} data2={data2}/&gt;, document.getElementById("main"));&#xA;</code></pre>&#xA;&#xA;<p>Here is the <a href="http://jsfiddle.net/gz8omn7y/1/" rel="nofollow">DEMO</a></p>&#xA;&#xA;<pre><code>My test case:&#xA;I add 55 and expect the results to look like this &#xA;55&#xA;1&#xA;2&#xA;3&#xA;55&#xA;1&#xA;2&#xA;3&#xA;&#xA;But I get&#xA;1&#xA;2&#xA;3&#xA;3&#xA;55&#xA;1&#xA;2&#xA;3&#xA;</code></pre>&#xA;&#xA;<p>Am I missing something basic here ? </p>&#xA;
<p>Sorry, I don't know the exact reason why this is happening, but if you include a value for the key attribute on your inputs, it resolves the issue:</p>&#xA;&#xA;<pre><code>  renderElement: function(i){&#xA;    return(&#xA;      &lt;input key={i} defaultValue={i} /&gt;&#xA;    );&#xA;  },&#xA;</code></pre>&#xA;&#xA;<p>My guess is that the lack of 'key' and use of 'defaultValue', instead of 'value', makes it difficult for React to correctly diff the change.</p>&#xA;
<p>First render looks (roughly) like this:</p>&#xA;&#xA;<pre class="lang-xml prettyprint-override"><code>&lt;div&gt;&#xA; &lt;div key={0}&gt;&lt;input defaultValue="1" /&gt;&lt;/div&gt;&#xA; &lt;div key={1}&gt;&lt;input defaultValue="2" /&gt;&lt;/div&gt;&#xA; &lt;div key={2}&gt;&lt;input defaultValue="3" /&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;div&gt;&#xA; &lt;div key={0}&gt;&lt;span&gt;1&lt;/span&gt;&lt;/div&gt;&#xA; &lt;div key={1}&gt;&lt;span&gt;2&lt;/span&gt;&lt;/div&gt;&#xA; &lt;div key={2}&gt;&lt;span&gt;3&lt;/span&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;</code></pre>&#xA;&#xA;<p>Cool, no problems.  Then let's say I put 'foo' in the box and click Add Value.  The state updates by inserting it before the first item (side note: splice(0,0,x) is unshift(x)), you then render this:</p>&#xA;&#xA;<pre class="lang-xml prettyprint-override"><code>&lt;div&gt;&#xA; &lt;div key={0}&gt;&lt;input defaultValue="foo" /&gt;&lt;/div&gt;&#xA; &lt;div key={1}&gt;&lt;input defaultValue="1" /&gt;&lt;/div&gt;&#xA; &lt;div key={2}&gt;&lt;input defaultValue="2" /&gt;&lt;/div&gt;&#xA; &lt;div key={3}&gt;&lt;input defaultValue="3" /&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;div&gt;&#xA; &lt;div key={0}&gt;&lt;span&gt;foo&lt;/span&gt;&lt;/div&gt;&#xA; &lt;div key={1}&gt;&lt;span&gt;1&lt;/span&gt;&lt;/div&gt;&#xA; &lt;div key={2}&gt;&lt;span&gt;2&lt;/span&gt;&lt;/div&gt;&#xA; &lt;div key={3}&gt;&lt;span&gt;3&lt;/span&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;</code></pre>&#xA;&#xA;<p>Now it's time for React to take these two, and figure out what changed.  To do this it compares the component (div, span, or input here), and the keys.</p>&#xA;&#xA;<p>Starting with the span section, it sees that all the tags are the same, but there's a new key it hasn't seen before at the <strong>end</strong>.  It also sees that the value of <code>div[0] span</code>, <code>div[1] span</code>, and <code>div[2] span</code> have all changed.  It inserts the <strong>new</strong> elements with the text 3 at the end, and updates the other spans.  Inefficient, but it works.</p>&#xA;&#xA;<p>Now for the inputs... it does roughly the same thing.  The keys and tags for the first three inputs are the same, it tells each of the inputs that they're updating, they check if they have a value prop, and if not, kindly deny to do anything.</p>&#xA;&#xA;<p>It sees that there's a <strong>new</strong> input at the end.  It is at <code>div[3] input</code> and has a defaultValue of "3".  React inserts the new input, sets the value to 3, and the update is complete.</p>&#xA;&#xA;<p>As you continue, the above procedure is the same, and it continues updating the spans, and inserting a new <code>div span</code> and <code>div input</code> each time.</p>&#xA;&#xA;<p>The main problem here, aside from defaultValue which I don't think should ever be used, is the keys are upside down!  Items are being inserted at the beginning, so keys should descend, not ascend.  This can be fixed by using the length of the items and subtracting the index from that.  If length is 4, the keys will be 4, 3, 2, 1.</p>&#xA;&#xA;<pre class="lang-js prettyprint-override"><code>this.state.app.data.map(function(page, i, items){&#xA;  return(&#xA;    &lt;div key={items.length - i}&gt;{self.renderElement(page)}&lt;/div&gt;&#xA;  );&#xA;})&#xA;</code></pre>&#xA;&#xA;<p>React then says 'oh, there's a new item at the <em>beginning</em>, I should just insert a node there', and everyone's happy.  The end.</p>&#xA;