33973478
aggregation query and return all fields in elasticsearch
<p>I  have an large(20GB) csv  file  by flowing format. </p>&#xA;&#xA;<pre><code>date,ip,dev_type,env,time,cpu_usage &#xA;2015-11-09,10.241.121.172,M2,production,11:01,8 &#xA;2015-11-09,10.241.121.172,M2,production,11:02,9 &#xA;2015-11-09,10.241.121.243,C1,preproduction,11:01,4 &#xA;2015-11-09,10.241.121.243,C1,preproduction,11:02,8&#xA;2015-11-10,10.241.121.172,M2,production,11:01,3 &#xA;2015-11-10,10.241.121.172,M2,production,11:02,9 &#xA;2015-11-10,10.241.121.243,C1,preproduction,11:01,4 &#xA;2015-11-10,10.241.121.243,C1,preproduction,11:02,8&#xA;</code></pre>&#xA;&#xA;<p>and import into elasticheaseh as flowing format</p>&#xA;&#xA;<pre><code>{&#xA;  "_index": "cpuusage",&#xA;  "_type": "logs",&#xA;  "_id": "AVFOkMS7Q4jUWMFNfSrZ",&#xA;  "_score": 1,&#xA;  "_source": {&#xA;    "date": "2015-11-10",&#xA;    "ip": "10.241.121.172",&#xA;    "dev_type": "M2",&#xA;    "env": "production",&#xA;    "time": "11:02",&#xA;    "cpu_usage": "9"&#xA;  },&#xA;  "fields": {&#xA;    "date": [&#xA;      1447113600000&#xA;    ]&#xA;  }&#xA;}&#xA;...&#xA;</code></pre>&#xA;&#xA;<p>so how could i output all field (date, ip, dev_type, env, cpu_usage)  when i find out the maximum value of cpu_usage for each ip in each day</p>&#xA;&#xA;<pre><code>curl -XGET localhost:9200/cpuusage/_search?pretty -d '{&#xA;    "size": 0,&#xA;        "aggs": {&#xA;                 "by_date": {&#xA;                    "date_histogram": {&#xA;                       "field": "date",&#xA;                       "interval": "day"&#xA;                    },&#xA;                   "aggs" : {&#xA;                           "genders" : {&#xA;                               "terms" : {&#xA;                                   "field" : "ip",&#xA;                                   "size": 100000,&#xA;                                    "order" : { "_count" : "asc" }&#xA;                               },&#xA;&#xA;                               "aggs" : {&#xA;                                   "cpu_usage" : { "max" : { "field" : "cpu_usage" } }&#xA;                               }&#xA;                           }&#xA;                       }&#xA;                    }&#xA;              } &#xA;&#xA;}'&#xA;</code></pre>&#xA;&#xA;<p>---cut---</p>&#xA;&#xA;<pre><code> ----output ----   &#xA; "aggregations" : {&#xA;        "events_by_date" : {&#xA;          "buckets" : [ {&#xA;            "key_as_string" : "2015-11-09T00:00:00.000Z",&#xA;            "key" : 1447027200000,&#xA;            "doc_count" : 4,&#xA;            "genders" : {&#xA;              "doc_count_error_upper_bound" : 0,&#xA;              "sum_other_doc_count" : 0,&#xA;              "buckets" : [ {&#xA;                "key" : "10.241.121.172",&#xA;                "doc_count" : 2,&#xA;                "cpu_usage" : {&#xA;                  "value" : 9.0&#xA;                }&#xA;              }, {&#xA;                "key" : "10.241.121.243",&#xA;                "doc_count" : 2,&#xA;                "cpu_usage" : {&#xA;                  "value" : 8.0&#xA;                }&#xA;              } ]&#xA;            }&#xA;          },&#xA;</code></pre>&#xA;
<p>You can do that with <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-top-hits-aggregation.html" rel="nofollow">top hits aggregation</a> </p>&#xA;&#xA;<p>Try this</p>&#xA;&#xA;<pre><code>{&#xA;  "size": 0,&#xA;  "aggs": {&#xA;    "by_date": {&#xA;      "date_histogram": {&#xA;        "field": "date",&#xA;        "interval": "day"&#xA;      },&#xA;      "aggs": {&#xA;        "genders": {&#xA;          "terms": {&#xA;            "field": "ip",&#xA;            "size": 100000,&#xA;            "order": {&#xA;              "_count": "asc"&#xA;            }&#xA;          },&#xA;          "aggs": {&#xA;            "cpu_usage": {&#xA;              "max": {&#xA;                "field": "cpu_usage"&#xA;              }&#xA;            },&#xA;            "include_source": {&#xA;              "top_hits": {&#xA;                "size": 1,&#xA;                "_source": {&#xA;                  "include": [&#xA;                    "date", "ip", "dev_type", "env", "cpu_usage"&#xA;                  ]&#xA;                }&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Does this help?</p>&#xA;