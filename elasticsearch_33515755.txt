33515755
ElasticSearch Order after 2 term aggregation
<p>Suppose that I have the following documents in ES, each has 3 fields: f1, f2 and score.&#xA;I want to find all documents, group by f1, f2 and order by the group max score, in SQL I can simply do like this:</p>&#xA;&#xA;<p><code>select f1,f2,score from table group by f1,f2 order by max(score)</code></p>&#xA;&#xA;<p>What is the equivalent in elasticsearch? Nested term aggregation doesn't give correct order as the returned buckets of f2 terms are all nested in the same bucket of f1 terms.</p>&#xA;
<p>The following aggregation should work</p>&#xA;&#xA;<pre><code>{&#xA;  "aggs": {&#xA;    "fileCombo": {&#xA;      "terms": {&#xA;        "script": "doc['field1'].value + doc['field2'].value",&#xA;        "order": {&#xA;          "maxScore": "desc"&#xA;        }&#xA;      },&#xA;      "aggs": {&#xA;        "maxScore": {&#xA;          "max": {&#xA;            "field": "score"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>First aggregate based on field1 and field2.&#xA;Next order by the max field.</p>&#xA;