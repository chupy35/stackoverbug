30054960
How to get exact value and also those with null values using Elasticsearch
<p>the title may sound a bit contradictory of some sort but will explain further below..</p>&#xA;&#xA;<p>Here are the sample data</p>&#xA;&#xA;<pre><code>"_index": "sample.document",&#xA;"_type": "document",&#xA;"_id": "54eecc5b8014c225ec734259",&#xA;"_score": 2.1047661,&#xA;"_source": {&#xA;    "systemHeader": {&#xA;        "summaryName": "New Big Dropdown - Template",&#xA;        "keyID": [&#xA;            "542dda8d6803fa98058b4568",&#xA;            "543c99dd2dafa7c211b38546"&#xA;        ],&#xA;        "systemType": "template",&#xA;        "summaryDescriptionRule": "This is a Case for works",&#xA;        "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;        "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;        "date": "1970-01-01T00:00:00"&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<hr>&#xA;&#xA;<pre><code>"_index": "sample.document2",&#xA;"_type": "document",&#xA;"_id": "54eecc5b8014c225ec734260",&#xA;"_score": 2.1047661,&#xA;"_source": {&#xA;    "systemHeader": {&#xA;        "summaryName": "New Big Dropdown - Template",&#xA;        "keyID": [],&#xA;        "systemType": "template",&#xA;        "summaryDescriptionRule": "This is a Case for works",&#xA;        "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;        "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;        "date": "1970-01-01T00:00:00"&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<hr>&#xA;&#xA;<pre><code>"_index": "sample.document3",&#xA;"_type": "document",&#xA;"_id": "54eecc5b8014c225ec734261",&#xA;"_score": 2.1047661,&#xA;"_source": {&#xA;    "systemHeader": {&#xA;        "summaryName": "New Big Dropdown - Template",&#xA;        "keyID": [&#xA;            "542dda8d6803fa98058b4570",&#xA;            "543c99dd2dafa7c211b38571"&#xA;        ],&#xA;        "systemType": "template",&#xA;        "summaryDescriptionRule": "This is a Case for works",&#xA;        "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;        "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;        "date": "1970-01-01T00:00:00"&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<hr>&#xA;&#xA;<pre><code>"_index": "sample.document4",&#xA;"_type": "document",&#xA;"_id": "54eecc5b8014c225ec734262",&#xA;"_score": 2.1047661,&#xA;"_source": {&#xA;    "systemHeader": {&#xA;        "summaryName": "New Big Dropdown - Template",&#xA;        "systemType": "template",&#xA;        "summaryDescriptionRule": "This is a Case for works",&#xA;        "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;        "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;        "date": "1970-01-01T00:00:00"&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>What I want to happen is that I could query using the systemHeader.keyID but I want to get the one which has the value "542dda8d6803fa98058b4568" and also the one which has <b>no value</b> so let's say for example when I run a query, the ones which should be returned are sample data 1, 2 and 4. The goal is that keyIDs are the user's specific access to the data. If the user has the keyID/s that match a particular data, it returns the data. If the data has no accessKey it means it's instantly accessible by any user regardless if the user has an access key or not. And finally, if the user has no keyID in relation to the result, it shouldn't return that data with a different keyID. I hope I'm making sense.</p>&#xA;&#xA;<p>But I couldn't seem to get the desired result. This is my elastic code:</p>&#xA;&#xA;<pre><code>{&#xA;    "query" : {&#xA;        "filtered" : {&#xA;            "filter" : {&#xA;                "or": [{&#xA;                    "missing" : {&#xA;                        "field" : "systemHeader.keyID"&#xA;                }},{&#xA;                "term": {&#xA;                    "systemHeader.keyID": ["542dda8d6803fa98058b4568"]&#xA;                }}]&#xA;            },&#xA;            "query" : {&#xA;                "match" : {&#xA;                    "systemHeader.systemType" : "template"&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>When I run this code, what happens is it only returns sample data 4. It doesn't even return sample data 2, worst is that it doesn't return sample data 1. What can I change in my query so that it can return sample 1, 2 and 4. I need your help on this. Thanks.</p>&#xA;&#xA;<p>Edit: Sample 4 is weird that it doesn't have a keyID under systemHeader because I'm assuming that I have multiple records. KeyID is recently implemented, so I have multiple records that are similar to sample 4 which is why I want to include sample 4 as the returned result.</p>&#xA;
<p>When I ran what you posted here in a simple test, it returned the documents that you want it to, so your problem seems to be somewhere else. </p>&#xA;&#xA;<p>The only issue I noticed as that your <code>"term"</code> filter should be a <code>"terms"</code> filter, but I doubt that is causing your problem (depending on your ES version, maybe).</p>&#xA;&#xA;<p>Is there anything non-default in your mapping that might explain it? Maybe if you post your mapping it will help. Also, what version of ES are you using? I used ES 1.5.1 for what's below.</p>&#xA;&#xA;<p>I just created a simple index:</p>&#xA;&#xA;<pre><code>DELETE /test_index&#xA;&#xA;PUT /test_index&#xA;{&#xA;   "settings": {&#xA;      "number_of_shards": 1&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>then indexed your four documents:</p>&#xA;&#xA;<pre><code>PUT /test_index/doc/54eecc5b8014c225ec734259&#xA;{&#xA;   "systemHeader": {&#xA;      "summaryName": "New Big Dropdown - Template",&#xA;      "keyID": [&#xA;         "542dda8d6803fa98058b4568",&#xA;         "543c99dd2dafa7c211b38546"&#xA;      ],&#xA;      "systemType": "template",&#xA;      "summaryDescriptionRule": "This is a Case for works",&#xA;      "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;      "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;      "date": "1970-01-01T00:00:00"&#xA;   }&#xA;}&#xA;&#xA;PUT /test_index/doc/54eecc5b8014c225ec734260&#xA;{&#xA;   "systemHeader": {&#xA;      "summaryName": "New Big Dropdown - Template",&#xA;      "keyID": [],&#xA;      "systemType": "template",&#xA;      "summaryDescriptionRule": "This is a Case for works",&#xA;      "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;      "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;      "date": "1970-01-01T00:00:00"&#xA;   }&#xA;}&#xA;&#xA;PUT /test_index/doc/54eecc5b8014c225ec734261&#xA;{&#xA;   "systemHeader": {&#xA;      "summaryName": "New Big Dropdown - Template",&#xA;      "keyID": [&#xA;         "542dda8d6803fa98058b4570",&#xA;         "543c99dd2dafa7c211b38571"&#xA;      ],&#xA;      "systemType": "template",&#xA;      "summaryDescriptionRule": "This is a Case for works",&#xA;      "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;      "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;      "date": "1970-01-01T00:00:00"&#xA;   }&#xA;}&#xA;&#xA;PUT /test_index/doc/54eecc5b8014c225ec734262&#xA;{&#xA;   "systemHeader": {&#xA;      "summaryName": "New Big Dropdown - Template",&#xA;      "systemType": "template",&#xA;      "summaryDescriptionRule": "This is a Case for works",&#xA;      "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;      "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;      "date": "1970-01-01T00:00:00"&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Then ran your search query and got back the three documents you wanted:</p>&#xA;&#xA;<pre><code>POST /test_index/_search&#xA;{&#xA;   "query": {&#xA;      "filtered": {&#xA;         "filter": {&#xA;            "or": [&#xA;               {&#xA;                  "missing": {&#xA;                     "field": "systemHeader.keyID"&#xA;                  }&#xA;               },&#xA;               {&#xA;                  "term": {&#xA;                     "systemHeader.keyID": [&#xA;                        "542dda8d6803fa98058b4568"&#xA;                     ]&#xA;                  }&#xA;               }&#xA;            ]&#xA;         },&#xA;         "query": {&#xA;            "match": {&#xA;               "systemHeader.systemType": "template"&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "took": 2,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 3,&#xA;      "max_score": 0.7768564,&#xA;      "hits": [&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "doc",&#xA;            "_id": "54eecc5b8014c225ec734259",&#xA;            "_score": 0.7768564,&#xA;            "_source": {&#xA;               "systemHeader": {&#xA;                  "summaryName": "New Big Dropdown - Template",&#xA;                  "keyID": [&#xA;                     "542dda8d6803fa98058b4568",&#xA;                     "543c99dd2dafa7c211b38546"&#xA;                  ],&#xA;                  "systemType": "template",&#xA;                  "summaryDescriptionRule": "This is a Case for works",&#xA;                  "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;                  "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;                  "date": "1970-01-01T00:00:00"&#xA;               }&#xA;            }&#xA;         },&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "doc",&#xA;            "_id": "54eecc5b8014c225ec734260",&#xA;            "_score": 0.7768564,&#xA;            "_source": {&#xA;               "systemHeader": {&#xA;                  "summaryName": "New Big Dropdown - Template",&#xA;                  "keyID": [],&#xA;                  "systemType": "template",&#xA;                  "summaryDescriptionRule": "This is a Case for works",&#xA;                  "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;                  "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;                  "date": "1970-01-01T00:00:00"&#xA;               }&#xA;            }&#xA;         },&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "doc",&#xA;            "_id": "54eecc5b8014c225ec734262",&#xA;            "_score": 0.7768564,&#xA;            "_source": {&#xA;               "systemHeader": {&#xA;                  "summaryName": "New Big Dropdown - Template",&#xA;                  "systemType": "template",&#xA;                  "summaryDescriptionRule": "This is a Case for works",&#xA;                  "summaryNameRule": "Case - {{CaseID}} {{Description}}",&#xA;                  "summaryDescription": "This is the template to demonstrate a big dropdown",&#xA;                  "date": "1970-01-01T00:00:00"&#xA;               }&#xA;            }&#xA;         }&#xA;      ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here is the code I used all together:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/120d1809768204fff2ce17134ffd81a766ed9056" rel="nofollow">http://sense.qbox.io/gist/120d1809768204fff2ce17134ffd81a766ed9056</a></p>&#xA;