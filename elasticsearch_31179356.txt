31179356
Elastic Search Aggregation with scripting giving exception
<p><strong>Query Failed [Failed to execute main query]]; nested: GroovyScriptExecutionException[ArrayIndexOutOfBoundsException[-1]];</strong> </p>&#xA;&#xA;<p>I am using the following aggs query </p>&#xA;&#xA;<pre><code>{&#xA;  "aggs": {&#xA;    "hscodes_eval": {&#xA;      "terms": {&#xA;        "field": "fscode"&#xA;        },&#xA;        "aggs": {&#xA;                "top_6_fscodes": {&#xA;                  "terms": {&#xA;                    "field": "fscode",&#xA;                     "script": "doc[\"fscode\"].value[0..6]"&#xA;                  }&#xA;                }&#xA;              }&#xA;      }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I want to get the count of documents matching the first 6 characters of field fscode. &#xA;But I am getting above exception.Please help.</p>&#xA;
<p>Try this:</p>&#xA;&#xA;<pre><code>{&#xA;  "aggs": {&#xA;    "hscodes_eval": {&#xA;      "terms": {&#xA;        "field": "fscode"&#xA;      },&#xA;      "aggs": {&#xA;        "top_6_fscodes": {&#xA;          "terms": {&#xA;            "script": "fieldValue=doc['fscode'].value;if(fieldValue.length()&gt;=7) fieldValue[0..6] else ''"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>But I wouldn't do it like this, meaning using a <code>script</code>. Scripts are usually slow and if you have many documents, it can add up pretty quickly.</p>&#xA;&#xA;<p>Haven't thought much about this, but my gut feeling says I would try, <strong>at indexing time</strong>, to put in a <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/most-fields.html#_multifield_mapping" rel="nofollow">sub-field of <code>fscode</code></a> the first 6 characters of the initial <code>fscode</code>, maybe using a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-truncate-tokenfilter.html" rel="nofollow">truncate filter</a>. Then, at search time, I would use a <code>terms</code> aggregation not on <code>fscode</code>, but on the subfield already defined.</p>&#xA;