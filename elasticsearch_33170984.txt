33170984
Elastic Search- Distinct elements from multiple nested fields
<p>I have created mapping using elasticsearch. Here is the mapping properties</p>&#xA;&#xA;<pre><code>"properties": {&#xA;         "userPermissions": {&#xA;            "type": "nested",&#xA;            "properties": {&#xA;                "prm": {&#xA;                    "type": "string"&#xA;                },&#xA;                "id": {&#xA;                    "type": "string"&#xA;                }&#xA;            }&#xA;           },&#xA;         "pSPermissions": {&#xA;            "type": "nested",&#xA;            "properties": {&#xA;                "prm": {&#xA;                "type": "string"&#xA;                },&#xA;                "id": {&#xA;                "type": "string"&#xA;                }&#xA;            }&#xA;         }&#xA;      }&#xA;</code></pre>&#xA;&#xA;<p>I want to retrieve overall distinct items from these fields: <code>userPermissions.id</code>, <code>pSPermissions.id</code>.</p>&#xA;&#xA;<p>I can achieve distinct values of multiple fields under a single <code>path</code>. We need to use a script to retrieve terms from multiple fields.</p>&#xA;&#xA;<p>GET /permissions/perm/_search?pretty=true&amp;search_type=count</p>&#xA;&#xA;<pre><code>    {&#xA;      "aggs": {&#xA;        "Parents": {&#xA;          "nested": {&#xA;            "path": "userPermissions"&#xA;          },&#xA;          "aggs": {&#xA;            "permCount": {&#xA;              "terms": {&#xA;                "script": "[doc['userPermissions.id'].value,doc['userPermissions.prm'].value]",&#xA;                "size": 5000&#xA;              }&#xA;            }&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;</code></pre>&#xA;&#xA;<p>But I have no idea how to achieve across different paths <code>userPermissions</code> and <code>pSPermissions</code>. Is it achievable?</p>&#xA;
<p>You can achieve it using the following script:</p>&#xA;&#xA;<pre><code>"script": "doc['userPermissions.id'].values + doc['userPermissions.prm'].values",&#xA;</code></pre>&#xA;&#xA;<p>What it does is retrieve all the <code>userPermissions.id</code> values and all the <code>userPermissions.prm</code> values and then concatenate them into a single array using groovy's <code>+</code> operator.</p>&#xA;&#xA;<p><strong>UPDATE</strong></p>&#xA;&#xA;<p>Following up on your comment, you can achieve what you want with this script in a similar way as you're already doing for fields under the same path: </p>&#xA;&#xA;<pre><code>"script": "doc['userPermissions.id'].values + doc['pSPermissions.id'].values",&#xA;</code></pre>&#xA;