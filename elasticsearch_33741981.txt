33741981
elasticsearch: monitor fielddata - what should the alert threshold be? And monitoring ES in general
<p>Elasticsearch 1.7.2 on CentOS</p>&#xA;&#xA;<p>We understand that elasticsearch suggests a config that is %50 RAM to OS and %50 to elasticsearch.</p>&#xA;&#xA;<p>So on a 16GB system, elastic has 8GB.</p>&#xA;&#xA;<p>Fine so far.</p>&#xA;&#xA;<p>We also understand that the ES workingset can be drastically reduced by using the doc_values tag in our mapping. We are now doing this.</p>&#xA;&#xA;<p>We also understand that we should monitor the size of the fielddata element from elasticsearch (because we suffered from a catastrophic data loss when we maxed out memory on our system).</p>&#xA;&#xA;<p>Also fine.</p>&#xA;&#xA;<p>But what are we looking for?</p>&#xA;&#xA;<p>1) Is fielddata the only thing we need to monitor (other than cluster health) ?</p>&#xA;&#xA;<p>2) What should we monitor to make sure we do not run out of hardware head room?</p>&#xA;&#xA;<p>3) And RE fielddata: Are we looking for fielddata = 7.5GB (e.g. that we are about to max out avail RAM) ?</p>&#xA;&#xA;<p>Or ____ ?</p>&#xA;
<p>Why don't you consider using <code>doc_values</code> instead? ES 2.0 has moved a step forward with switching fielddata to doc_values <a href="https://github.com/elastic/elasticsearch/issues/8312" rel="nofollow">as default for not_analyzed string fields, dates, numbers</a>.</p>&#xA;&#xA;<p>Regarding your specific question, I'd start with putting a limit on the fielddata. Fielddata is unbounded, by default. This means it can grow until the fielddata circuit breaker will prevent any query that uses more than the limit to run. This means that, as soon as your node hits the circuit breaker limit, no other fielddata will be placed in the memory and queries that will need <strong>new</strong> fielddata will be rejected. To prevent this, you need to set <code>indices.fielddata.cache.size</code> which should be a value <strong>smaller</strong> than the circuit breaker limit.</p>&#xA;&#xA;<p>Setting this will allow fielddata to be evicted. <strong>This is not an ideal situation</strong> because fielddata is expensive to load. <strong>Ideally</strong>, you'd want enough memory to hold your necessary fielddata without evictions.</p>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_limiting_memory_usage.html#circuit-breaker" rel="nofollow">The circuit breaker limit has a value of 60% of the heap as the default value</a>. Set <code>indices.fielddata.cache.size</code> to, for example, <code>50%</code>, see how the cluster is behaving and re-adjust if needed. But, if you set using <code>doc_values</code> properly I don't think you should worry too much about fielddata for the moment.</p>&#xA;&#xA;<p>What else to monitor:</p>&#xA;&#xA;<ul>&#xA;<li>CPU</li>&#xA;<li>disk space</li>&#xA;<li>system load</li>&#xA;<li>JVM heap usage which should show a <a href="https://www.elastic.co/blog/found-understanding-memory-pressure-indicator" rel="nofollow">saw-tooth pattern</a></li>&#xA;<li>fielddata evictions</li>&#xA;<li>filter cache evictions</li>&#xA;<li>JVM old GC time</li>&#xA;</ul>&#xA;&#xA;<p>Also, a good read about what to monitor you can find <a href="http://radar.oreilly.com/2015/04/10-elasticsearch-metrics-to-watch.html" rel="nofollow">here</a>.</p>&#xA;