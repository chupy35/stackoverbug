30894527
script scope in elasticsearch aggregation
<p>In Elasticsearch, I would like to know what variables are available in the scope of a script used in a (sub)aggregation.</p>&#xA;&#xA;<p>I already read resources on <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html" rel="noreferrer">scripting</a> and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-advanced-scripting.html" rel="noreferrer">text scoring in scripts</a> as well as the documentation of most aggregation types but could not find a comprehensive reference of what can be used depending on the situation.</p>&#xA;&#xA;<p>From what I could gather, most scripts in aggregations are run <strong>per-hit</strong> and have access to the following scope:</p>&#xA;&#xA;<ul>&#xA;<li>document fields, through <code>doc['field_name'].*</code></li>&#xA;<li>document as parsed from index, through <code>_source</code></li>&#xA;<li>stored fields, through <code>_fields['field_name']</code></li>&#xA;<li>document score, through <code>_score</code></li>&#xA;<li>shard statistics, through <code>_index.*</code></li>&#xA;<li>per-shard field statistics, through <code>_index['field_name'].*</code></li>&#xA;<li>per-shard term statistics, through <code>_index['field_name']['term'].*</code></li>&#xA;</ul>&#xA;&#xA;<p>The <em>Scripted Metric</em> aggregation also exposes an <code>_agg</code> variable in <strong>per-shard</strong> &amp; <strong>per-hit</strong> scripts (init, map &amp; combine scripts) and an <code>_aggs</code> variable at the <strong>coordinating node level</strong> (reduce script).&#xA;Of course, the map script can also access every other per-hit variable as defined above.&#xA;I could not find documentation indicating whether <code>_index*</code> was available in per-shard scripts but it would seem logic.&#xA;Also, scripted_metric is the only case of scripts at the shard or coordinating node level that I could find.</p>&#xA;&#xA;<p>The <em>Signicant Terms</em> aggregation has a special case of running a scoring script <strong>per-bucket</strong>, with the following variables in scope:</p>&#xA;&#xA;<ul>&#xA;<li><code>_subset_freq</code>,</li>&#xA;<li><code>_superset_freq</code>,</li>&#xA;<li><code>_subset_size</code>,</li>&#xA;<li><code>_superset_size</code></li>&#xA;</ul>&#xA;&#xA;<p>However it does not seem to have access to other bucket-dependent stuff, like bucket key (term) or single-value metric sub-aggregations, which is a pitty because it would be super-useful (at least, I could not find any documentation on how to access such bucket-dependent information).</p>&#xA;&#xA;<p>The <em>Terms</em> aggregation also has a special case of a value script (when both parameters <code>field</code> and <code>script</code> are defined), which can only access a <code>_value</code> variable.</p>&#xA;&#xA;<p>Is the information summed up here accurate/complete?</p>&#xA;