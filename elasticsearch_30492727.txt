30492727
Elasticsearch nested filter without results for specific attributed
<p>I'm trying to apply a nested filter on a document but, for when I filter specifically by one of the nested attributes, I always get 0 results. For example, with a mapping like: </p>&#xA;&#xA;<pre><code>"PARTNER": {&#xA;   "properties": {&#xA;        "Addresses": {&#xA;             "properties": {&#xA;                    "CountyCode": {&#xA;                             "type": "string"&#xA;                    },&#xA;                    "EntityCode": {&#xA;                        "type": "string"&#xA;                    }, [...]&#xA;               }&#xA;        }, "type": "nested"&#xA;     }, [...]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I'm able to perform a filter on the CountyCode attribute, but if I filter on the EntityCode, i always get zero results:</p>&#xA;&#xA;<pre><code>{&#xA;  "from": 0,&#xA;  "size": 10,&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "bool": {&#xA;          "must": {&#xA;            "match_all": {}&#xA;          }&#xA;        }&#xA;      },&#xA;      "filter": {&#xA;        "nested": {&#xA;          "filter": {&#xA;            "term": {&#xA;              "EntityCode": "201"&#xA;            }&#xA;          },&#xA;          "path": "Addresses"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>That query gets zero results, if I replace the field with CountyCode, it gives me proper results. &#xA;I'm performing the queries on the web-based console, on ES 1.4.2,.</p>&#xA;&#xA;<p>The nested documents have the format: </p>&#xA;&#xA;<pre><code>{&#xA;    "CountyCode": "516",&#xA;    "EntityCode": "203",&#xA;    [...]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Any idea on why that one field returns nothing ? </p>&#xA;&#xA;<p>Thanks!</p>&#xA;
<p>It looks like your <code>"type": "nested"</code> declaration is in the wrong place. It should be inside the <code>"Addresses"</code> block. You probably also need to specify the full path in your <code>"nested"</code> filter (though sometimes ES is smart enough to work without doing that, if there aren't too many nested fields).</p>&#xA;&#xA;<p>So to test, I created an index like this:</p>&#xA;&#xA;<pre><code>PUT /test_index&#xA;{&#xA;   "settings": {&#xA;      "number_of_shards": 1&#xA;   },&#xA;   "mappings": {&#xA;      "PARTNER": {&#xA;         "properties": {&#xA;            "Addresses": {&#xA;               "type": "nested",&#xA;               "properties": {&#xA;                  "CountyCode": {&#xA;                     "type": "string"&#xA;                  },&#xA;                  "EntityCode": {&#xA;                     "type": "string"&#xA;                  }&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Then added a couple docs:</p>&#xA;&#xA;<pre><code>POST /test_index/PARTNER/_bulk&#xA;{"index":{"_id":1}}&#xA;{"Addresses":[{"CountyCode": "516","EntityCode": "203"}, {"CountyCode": "516","EntityCode": "201"}]}&#xA;{"index":{"_id":2}}&#xA;{"Addresses":[{"CountyCode": "517","EntityCode": "204"}]}&#xA;</code></pre>&#xA;&#xA;<p>And now the following query returns what I expect:</p>&#xA;&#xA;<pre><code>POST /test_index/_search&#xA;{&#xA;   "from": 0,&#xA;   "size": 10,&#xA;   "query": {&#xA;      "filtered": {&#xA;         "query": {&#xA;            "match_all": {}&#xA;         },&#xA;         "filter": {&#xA;            "nested": {&#xA;               "path": "Addresses",&#xA;               "filter": {&#xA;                  "term": {&#xA;                     "Addresses.EntityCode": "201"&#xA;                  }&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "took": 1,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 1,&#xA;      "max_score": 1,&#xA;      "hits": [&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "PARTNER",&#xA;            "_id": "1",&#xA;            "_score": 1,&#xA;            "_source": {&#xA;               "Addresses": [&#xA;                  {&#xA;                     "CountyCode": "516",&#xA;                     "EntityCode": "203"&#xA;                  },&#xA;                  {&#xA;                     "CountyCode": "516",&#xA;                     "EntityCode": "201"&#xA;                  }&#xA;               ]&#xA;            }&#xA;         }&#xA;      ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here is all the code I used to test:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/d677144a58b168d46c5d7e9cc516013b20613013" rel="nofollow">http://sense.qbox.io/gist/d677144a58b168d46c5d7e9cc516013b20613013</a></p>&#xA;