33764914
Select TOP + GROUP BY + SHORT in Elasticsearch?
<p>Assume the following <code>stockInWarehouse</code> schema:</p>&#xA;&#xA;<pre><code>{&#xA;  product_db: {&#xA;    mappings: {&#xA;      stockInWarehouse: {&#xA;        properties: {&#xA;          sku: {&#xA;            type: "string"&#xA;          },&#xA;          arrivalTime: {&#xA;            type: "date",&#xA;            format: "dateOptionalTime"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The data in <code>stockInWarehouse</code> look like:</p>&#xA;&#xA;<pre><code>{&#xA;  "hits": {&#xA;    "total": 5,&#xA;    "hits": [&#xA;      {&#xA;        "_index": "product_db",&#xA;        "_type": "stockInWarehouse",&#xA;        "_id": "1",&#xA;        "_source": {&#xA;          "sku": "item 1",&#xA;          "arrivalTime": "2015-11-11T19:00:10.231Z"&#xA;        }&#xA;      },&#xA;      {&#xA;        "_index": "product_db",&#xA;        "_type": "stockInWarehouse",&#xA;        "_id": "2",&#xA;        "_source": {&#xA;          "sku": "item 2",&#xA;          "arrivalTime": "2015-11-12T19:00:10.231Z"&#xA;        }&#xA;      },&#xA;      {&#xA;        "_index": "product_db",&#xA;        "_type": "stockInWarehouse",&#xA;        "_id": "3",&#xA;        "_source": {&#xA;          "sku": "item 1",&#xA;          "arrivalTime": "2015-11-12T19:35:10.231Z"&#xA;        }&#xA;      },&#xA;      {&#xA;        "_index": "product_db",&#xA;        "_type": "stockInWarehouse",&#xA;        "_id": "4",&#xA;        "_source": {&#xA;          "sku": "item 1",&#xA;          "arrivalTime": "2015-11-13T19:56:10.231Z"&#xA;        }&#xA;      },&#xA;      {&#xA;        "_index": "product_db",&#xA;        "_type": "stockInWarehouse",&#xA;        "_id": "5",&#xA;        "_source": {&#xA;          "sku": "item 3",&#xA;          "arrivalTime": "2015-11-15T19:56:10.231Z"&#xA;        }&#xA;      }&#xA;    ]&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>What i am trying to do is to <strong>fetch TOP documents by arrivalTime</strong> (aka most recent documents) however i want them to be <strong>sorted by another field (sku)</strong> and <strong>limit to available sku</strong>. The expected result would look like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "hits": {&#xA;    "total": 3,&#xA;    "hits": [&#xA;      {&#xA;        "_index": "product_db",&#xA;        "_type": "stockInWarehouse",&#xA;        "_id": "5",&#xA;        "_source": {&#xA;          "sku": "item 3",&#xA;          "arrivalTime": "2015-11-15T19:56:10.231Z"&#xA;        }&#xA;      },&#xA;      {&#xA;        "_index": "product_db",&#xA;        "_type": "stockInWarehouse",&#xA;        "_id": "4",&#xA;        "_source": {&#xA;          "sku": "item 1",&#xA;          "arrivalTime": "2015-11-13T19:56:10.231Z"&#xA;        }&#xA;      },&#xA;      {&#xA;        "_index": "product_db",&#xA;        "_type": "stockInWarehouse",&#xA;        "_id": "2",&#xA;        "_source": {&#xA;          "sku": "item 2",&#xA;          "arrivalTime": "2015-11-12T19:00:10.231Z"&#xA;        }&#xA;      }&#xA;    ]&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>If I sort by <code>arrivalTime</code>, the result sku list will contains <code>item 3, item 1, item 1, item 2, item 1</code> (duplicate). If I sort by <code>sku</code>, result list will not reflect correct arrivalTime order.</p>&#xA;&#xA;<p>Is this type of query possible in Elasticsearch? How can I archive this?</p>&#xA;
<p>How about this one?</p>&#xA;&#xA;<pre><code>{&#xA;  "size": 0,&#xA;  "aggs": {&#xA;    "terms_agg": {&#xA;      "terms": {&#xA;        "field": "sku",&#xA;        "size": 100,&#xA;        "order": {&#xA;          "max_date_agg": "desc"&#xA;        }&#xA;&#xA;      },&#xA;      "aggs": {&#xA;        "max_date_agg": {&#xA;          "max": {&#xA;            "field": "arrivalTime"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I have made <code>size : 100</code> assuming you have lot of products.</p>&#xA;&#xA;<p><strong>Note</strong> You need to add <code>index : not_analyzed</code> to your <code>mapping</code> of sku&#xA;This is the result of the query</p>&#xA;&#xA;<pre><code>"aggregations": {&#xA;      "terms_agg": {&#xA;         "doc_count_error_upper_bound": 0,&#xA;         "sum_other_doc_count": 0,&#xA;         "buckets": [&#xA;            {&#xA;               "key": "item 3",&#xA;               "doc_count": 1,&#xA;               "max_date_agg": {&#xA;                  "value": 1447617370231,&#xA;                  "value_as_string": "2015-11-15T19:56:10.231Z"&#xA;               }&#xA;            },&#xA;            {&#xA;               "key": "item 1",&#xA;               "doc_count": 3,&#xA;               "max_date_agg": {&#xA;                  "value": 1447444570231,&#xA;                  "value_as_string": "2015-11-13T19:56:10.231Z"&#xA;               }&#xA;            },&#xA;            {&#xA;               "key": "item 2",&#xA;               "doc_count": 1,&#xA;               "max_date_agg": {&#xA;                  "value": 1447354810231,&#xA;                  "value_as_string": "2015-11-12T19:00:10.231Z"&#xA;               }&#xA;            }&#xA;         ]&#xA;      }&#xA;   }&#xA;</code></pre>&#xA;&#xA;<p>I hope it helps!!</p>&#xA;