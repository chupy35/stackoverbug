32589876
Querying a string consisting exactly a part of a query
<p>I have a field named "lang" which consists values "en_US","en_GB","ru_RU", e.t.c. with this mapping</p>&#xA;&#xA;<pre><code>"lang": {&#xA;    "type": "string",&#xA;        "index": "not_analyzed",&#xA;            "fields": {&#xA;               "raw": {&#xA;                  "type": "string",&#xA;                  "index": "not_analyzed",&#xA;                  "ignore_above": 256&#xA;               }&#xA;            }&#xA;</code></pre>&#xA;&#xA;<p>How to filter for documents, e.g. from "US"?</p>&#xA;
<p>One way you can do it is change <code>"index": "not_analyzed"</code> on the upper-level field, and set up a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-pattern-analyzer.html" rel="nofollow">pattern analyzer</a> for that field. Since you already have the <code>"lang.raw"</code> field set up, you'll still be able to get the untouched version for faceting or whatever.</p>&#xA;&#xA;<p>So, to test it I set up an index like this:</p>&#xA;&#xA;<pre><code>PUT /test_index&#xA;{&#xA;   "settings": {&#xA;      "number_of_shards": 1,&#xA;      "analysis": {&#xA;         "analyzer": {&#xA;            "whitespace_underscore": {&#xA;               "type": "pattern",&#xA;               "pattern": "[\\s_]+",&#xA;               "lowercase": false&#xA;            }&#xA;         }&#xA;      }&#xA;   },&#xA;   "mappings": {&#xA;      "doc": {&#xA;         "properties": {&#xA;            "name": {&#xA;               "type": "string"&#xA;            },&#xA;            "lang": {&#xA;               "type": "string",&#xA;               "index_analyzer": "whitespace_underscore", &#xA;               "search_analyzer": "standard", &#xA;               "fields": {&#xA;                  "raw": {&#xA;                     "type": "string",&#xA;                     "index": "not_analyzed",&#xA;                     "ignore_above": 256&#xA;                  }&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>And added a few docs:</p>&#xA;&#xA;<pre><code>POST /test_index/doc/_bulk&#xA;{"index":{"_id":1}}&#xA;{"name":"doc1","lang":"en_US"}&#xA;{"index":{"_id":2}}&#xA;{"name":"doc2","lang":"en_GB"}&#xA;{"index":{"_id":3}}&#xA;{"name":"doc3","lang":"ru_RU"}&#xA;</code></pre>&#xA;&#xA;<p>Now I can filter by <code>"US"</code> like this:</p>&#xA;&#xA;<pre><code>POST /test_index/_search&#xA;{&#xA;   "query": {&#xA;      "filtered": {&#xA;         "filter": {&#xA;            "term": {&#xA;               "lang": "US"&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "took": 1,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 1,&#xA;      "max_score": 1,&#xA;      "hits": [&#xA;         {&#xA;            "_index": "test_index",&#xA;            "_type": "doc",&#xA;            "_id": "1",&#xA;            "_score": 1,&#xA;            "_source": {&#xA;               "name": "doc1",&#xA;               "lang": "en_US"&#xA;            }&#xA;         }&#xA;      ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>And I can still get a list of values with a terms aggregation on <code>"lang.raw"</code>:</p>&#xA;&#xA;<pre><code>POST /test_index/_search?search_type=count&#xA;{&#xA;   "aggs": {&#xA;      "lang_terms": {&#xA;         "terms": {&#xA;            "field": "lang.raw"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "took": 2,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 3,&#xA;      "max_score": 0,&#xA;      "hits": []&#xA;   },&#xA;   "aggregations": {&#xA;      "lang_terms": {&#xA;         "doc_count_error_upper_bound": 0,&#xA;         "sum_other_doc_count": 0,&#xA;         "buckets": [&#xA;            {&#xA;               "key": "en_GB",&#xA;               "doc_count": 1&#xA;            },&#xA;            {&#xA;               "key": "en_US",&#xA;               "doc_count": 1&#xA;            },&#xA;            {&#xA;               "key": "ru_RU",&#xA;               "doc_count": 1&#xA;            }&#xA;         ]&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here is the code I used to test it:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/ac3f3fd66ea649c0c3a8010241d1f6981a7e012c" rel="nofollow">http://sense.qbox.io/gist/ac3f3fd66ea649c0c3a8010241d1f6981a7e012c</a></p>&#xA;