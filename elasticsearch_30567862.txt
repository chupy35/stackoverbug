30567862
Elasticsearch - Aggregate a script field
<p>I'm trying to create a script field that will calculate a time difference between two timestamps and then aggregate an <code>avg</code> on that script field.</p>&#xA;&#xA;<p>I first tried:</p>&#xA;&#xA;<pre><code>{&#xA;   "query": {&#xA;      "filtered": {&#xA;         "query": {&#xA;            "match_all": {}&#xA;         },&#xA;         "filter": {&#xA;            "and": [&#xA;               {&#xA;                  "exists": {&#xA;                     "field": "time.new_time"&#xA;                  }&#xA;               },&#xA;               {&#xA;                  "exists": {&#xA;                     "field": "time.first_alert_time"&#xA;                  }&#xA;               }&#xA;            ]&#xA;         }&#xA;      }&#xA;   },&#xA;   "script_fields": {&#xA;      "timedifference": {&#xA;         "script": "doc['time.new_time'].value - doc['time.first_alert_time'].value"&#xA;      }&#xA;   },&#xA;   "aggs": {&#xA;      "avg_timedifference": {&#xA;         "avg": {&#xA;            "field" : "timedifference"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Which resulted in <code>null</code> value under the aggregated avg <code>avg_timedifference</code>.</p>&#xA;&#xA;<p>Then I tried:</p>&#xA;&#xA;<pre><code>{&#xA;   "query": {&#xA;      "filtered": {&#xA;         "query": {&#xA;            "match_all": {}&#xA;         },&#xA;         "filter": {&#xA;            "and": [&#xA;               {&#xA;                  "exists": {&#xA;                     "field": "time.new_time"&#xA;                  }&#xA;               },&#xA;               {&#xA;                  "exists": {&#xA;                     "field": "time.first_alert_time"&#xA;                  }&#xA;               }&#xA;            ]&#xA;         }&#xA;      }&#xA;   },&#xA;   "script_fields": {&#xA;      "timedifference": {&#xA;         "script": "doc['time.new_time'].value - doc['time.first_alert_time'].value"&#xA;      }&#xA;   },&#xA;   "aggs": {&#xA;      "avg_timedifference": {&#xA;         "avg": {&#xA;            "script" : "doc['timedifference'].value"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Which generated an error message saying: "No field found for [timedifference] in mapping"</p>&#xA;
<p>How about simply moving the script to the aggregation?</p>&#xA;&#xA;<pre><code>{&#xA;   "query": {&#xA;      "filtered": {&#xA;         "query": {&#xA;            "match_all": {}&#xA;         },&#xA;         "filter": {&#xA;            "and": [&#xA;               {&#xA;                  "exists": {&#xA;                     "field": "time.new_time"&#xA;                  }&#xA;               },&#xA;               {&#xA;                  "exists": {&#xA;                     "field": "time.first_alert_time"&#xA;                  }&#xA;               }&#xA;            ]&#xA;         }&#xA;      }&#xA;   },&#xA;   "aggs": {&#xA;      "avg_timedifference": {&#xA;         "avg": {&#xA;            "script" : "Math.ceil(doc['time.new_time'].value - doc['time.first_alert_time'].value)"&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;