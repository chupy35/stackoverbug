30289024
High disk watermark exceeded even when there is not much data in my index
<p>I'm using elasticsearch on my local machine. The data directory is only 37MB in size but when I check logs, I can see:</p>&#xA;&#xA;<blockquote>&#xA;  <p>[2015-05-17 21:31:12,905][WARN ][cluster.routing.allocation.decider] [Chrome] high disk watermark [10%] exceeded on [h9P4UqnCR5SrXxwZKpQ2LQ][Chrome] free: 5.7gb[6.1%], shards will be relocated away from this node</p>&#xA;</blockquote>&#xA;&#xA;<p>Quite confused about what might be going wrong. Any help?</p>&#xA;
<p>From <a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.5/index-modules-allocation.html">Index Shard Allocation</a>:</p>&#xA;&#xA;<blockquote>&#xA;  <p>... watermark.high controls the high watermark. It defaults to 90%, meaning ES will attempt to relocate shards to another node if the node disk usage rises above 90%.</p>&#xA;</blockquote>&#xA;&#xA;<p>The size of your actual index doesn't matter; it's the free space left on the device which matters.</p>&#xA;&#xA;<p>If the defaults are not appropriate for you, you've to change them.</p>&#xA;
<p>Its a warning and won't affect anything. The storage processors (SPs) use high and low watermarks to determine when to flush their write caches. &#xA;The possible solution can be to free some memory </p>&#xA;&#xA;<p>And the warning will disappear. Even with it showing, the replicas will not be assigned to the node which is okay. The elasticsearch will work fine.</p>&#xA;
<p>To resolve the issue in which, the log is recorded as: </p>&#xA;&#xA;<blockquote>&#xA;  <p>high disk watermark [90%] exceeded on&#xA;  [ytI5oTyYSsCVfrB6CWFL1g][ytI5oTy][/var/lib/elasticsearch/nodes/0]&#xA;  free: 552.2mb[4.3%], shards will be relocated away from this node</p>&#xA;</blockquote>&#xA;&#xA;<p>You can update the threshold limit by executing following curl request:</p>&#xA;&#xA;<pre><code>curl -XPUT "http://localhost:9200/_cluster/settings" -d'&#xA;{&#xA;  "persistent": {&#xA;    "cluster": {&#xA;      "routing": {&#xA;        "allocation.disk.threshold_enabled": false&#xA;      }&#xA;    }&#xA;  }&#xA;}'&#xA;</code></pre>&#xA;
<p>Instead of percentage I use absolute values and rise values for better space use (in pre-prod):</p>&#xA;&#xA;<pre><code>PUT _cluster/settings&#xA;{&#xA;  "persistent": {&#xA;    "cluster.routing.allocation.disk.threshold_enabled": true,&#xA;    "cluster.routing.allocation.disk.watermark.low": "1g",&#xA;    "cluster.routing.allocation.disk.watermark.high": "500m",&#xA;    "cluster.info.update.interval": "5m" &#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Also I reduce pooling interval to make ES logs shorter ))</p>&#xA;
<p>this slightly modified curl command from the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/disk-allocator.html" rel="nofollow noreferrer">Elasticsearch 6.4 docs</a>  worked for me:  </p>&#xA;&#xA;<pre><code>curl -X PUT "localhost:9200/_cluster/settings" -H 'Content-Type: application/json' -d'&#xA;{&#xA;  "transient": {&#xA;    "cluster.routing.allocation.disk.watermark.low": "2gb",&#xA;    "cluster.routing.allocation.disk.watermark.high": "1gb",&#xA;    "cluster.routing.allocation.disk.watermark.flood_stage": "500mb",&#xA;    "cluster.info.update.interval": "1m"&#xA;  }&#xA;}&#xA;'&#xA;</code></pre>&#xA;&#xA;<p>if the curl -XPUT command succeeds, you should see logs like this in the Elasticsearch terminal window:</p>&#xA;&#xA;<pre><code>[2018-08-24T07:16:05,584][INFO ][o.e.c.s.ClusterSettings  ] [bhjM1bz] updating [cluster.routing.allocation.disk.watermark.low] from [85%] to [2gb]&#xA;[2018-08-24T07:16:05,585][INFO ][o.e.c.s.ClusterSettings  ] [bhjM1bz] updating [cluster.routing.allocation.disk.watermark.high] from [90%] to [1gb]&#xA;[2018-08-24T07:16:05,585][INFO ][o.e.c.s.ClusterSettings  ] [bhjM1bz] updating [cluster.routing.allocation.disk.watermark.flood_stage] from [95%] to [500mb]&#xA;[2018-08-24T07:16:05,585][INFO ][o.e.c.s.ClusterSettings  ] [bhjM1bz] updating [cluster.info.update.interval] from [30s] to [1m]&#xA;</code></pre>&#xA;&#xA;<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/disk-allocator.html" rel="nofollow noreferrer">https://www.elastic.co/guide/en/elasticsearch/reference/current/disk-allocator.html</a></p>&#xA;