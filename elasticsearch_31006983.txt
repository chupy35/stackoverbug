31006983
Migration from terms facet to terms aggregation
<p>I have to migrate terms facet</p>&#xA;&#xA;<pre><code>{&#xA;  "facets" : {&#xA;    "facet_name" : {&#xA;      "terms" : {&#xA;        "field" : "location",&#xA;          "script" : "return doc['location'].value == \"UA\""&#xA;        }&#xA;      }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>to terms aggregation</p>&#xA;&#xA;<pre><code>{&#xA;  "aggs" : {&#xA;    "agg_name" : {&#xA;      "terms" : {&#xA;        "field" : "location",&#xA;          "script" : "return doc['location'].value == \"UA\""&#xA;        }&#xA;      }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Facet works fine on elastic (I've tested on 1.1.2 and 1.5.2)</p>&#xA;&#xA;<p>But aggregation throws an exception &#xA;org.elasticsearch.script.groovy.GroovyScriptExecutionException: ArrayIndexOutOfBoundsException[-1]</p>&#xA;&#xA;<p>According to issue description <a href="https://github.com/elastic/elasticsearch/issues/11728" rel="nofollow">https://github.com/elastic/elasticsearch/issues/11728</a> such behaviour appears because of "value" script is used by aggregation when explicit "field" found. </p>&#xA;&#xA;<p>For facets scripts are traditional.</p>&#xA;&#xA;<p>How to disable "value" nature of this script and make it works like in facet?</p>&#xA;&#xA;<p>Thanks in advance!</p>&#xA;&#xA;<hr>&#xA;&#xA;<p>PS: I can not use filtering (include / exclude), exclusion rules should be declared in script, same as for facet.</p>&#xA;
<p>I've found workaround by modifying script and removing "field" from agg:</p>&#xA;&#xA;<pre><code>{&#xA;    "aggs" : {&#xA;        "agg_name" : {&#xA;            "terms" : {&#xA;                "script" : "if (_source.location == \"UA\") {return _source.location} else {return null}"&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</code></pre>&#xA;