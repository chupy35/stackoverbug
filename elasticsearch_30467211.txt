30467211
Elastic Search Sum aggregation with group by and where condition
<p>I am newbie in ElasticSearch.</p>&#xA;&#xA;<p>We are currently moving our code from relational DB to ElasticSearch. So we are converting our queries in ElasticSearch query format.</p>&#xA;&#xA;<p>I am looking for ElasticSearch equivalent of below query - </p>&#xA;&#xA;<pre><code>SELECT Color, SUM(ListPrice), SUM(StandardCost)&#xA;FROM Production.Product&#xA;WHERE Color IS NOT NULL &#xA;    AND ListPrice != 0.00 &#xA;    AND Name LIKE 'Mountain%'&#xA;GROUP BY Color&#xA;</code></pre>&#xA;&#xA;<p>Can someone provide me the example of ElasticSearch query for above?</p>&#xA;
<p>You'd have a <code>products</code> index with a <code>product</code> type documents whose mapping could look like this based on your query above:</p>&#xA;&#xA;<pre><code>curl -XPUT localhost:9200/products -d '&#xA;{&#xA;  "mappings": {&#xA;    "product": {&#xA;      "properties": {&#xA;        "Color": {&#xA;          "type": "string"&#xA;        },&#xA;        "Name": {&#xA;          "type": "string"&#xA;        },&#xA;        "ListPrice": {&#xA;          "type": "double"&#xA;        },&#xA;        "StandardCost": {&#xA;          "type": "double"&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}'&#xA;</code></pre>&#xA;&#xA;<p>Then the ES query equivalent to the SQL one you gave above would look like this:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "filtered": {&#xA;      "query": {&#xA;        "query_string": {&#xA;          "default_field": "Name",&#xA;          "query": "Mountain*"&#xA;        }&#xA;      },&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must_not": [&#xA;            {&#xA;              "missing": {&#xA;                "field": "Color"&#xA;              }&#xA;            },&#xA;            {&#xA;              "term": {&#xA;                "ListPrice": 0&#xA;              }&#xA;            }&#xA;          ]&#xA;        }&#xA;      }&#xA;    }&#xA;  },&#xA;  "aggs": {&#xA;    "by_color": {&#xA;      "terms": {&#xA;        "field": "Color"&#xA;      },&#xA;      "aggs": {&#xA;        "total_price": {&#xA;          "sum": {&#xA;            "field": "ListPrice"&#xA;          }&#xA;        },&#xA;        "total_cost": {&#xA;          "sum": {&#xA;            "field": "StandardCost"&#xA;          }&#xA;        }&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;