29040405
Elasticsearch: how to make an aggregation field not change the case of values
<p>I have the following mapping for an aggregation field:</p>&#xA;&#xA;<pre><code>"language" : {&#xA;    "type" : "string",&#xA;    "index": "analyzed",&#xA;    "analyzer" : "standard"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The value of a sample document in this property may look like: "en zh_CN"</p>&#xA;&#xA;<p>This property has no other use except aggregation. I notice that when I get aggregation results on this property:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;        "filtered" : {&#xA;            "query": { &#xA;                    "match_all": {}&#xA;            },&#xA;            "filter" : {&#xA;                 ...&#xA;            }&#xA;        }&#xA;    },&#xA;    "aggregations": {&#xA;        "facets": {&#xA;            "terms": {&#xA;                "field": "language"&#xA;            }&#xA;        }&#xA;    }   &#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The bucket key values are in lower case. </p>&#xA;&#xA;<pre><code>  "aggregations" : {&#xA;    "facets" : {&#xA;      "doc_count_error_upper_bound" : 0,&#xA;      "sum_other_doc_count" : 0,&#xA;      "buckets" : [ {&#xA;        "key" : "zh_cn",&#xA;        "doc_count" : 2&#xA;      }, {&#xA;        "key" : "en",&#xA;        "doc_count" : 1&#xA;      } ]&#xA;    }&#xA;  }&#xA;</code></pre>&#xA;&#xA;<p>How can I achieve my aggregation goal without letting ES to lowers the case of its values. I feel that I may need to change the mapping for this property, but not sure how.</p>&#xA;&#xA;<p>Thanks and regards.</p>&#xA;
<p>Try this in your mapping instead:</p>&#xA;&#xA;<pre><code>"language" : {&#xA;    "type" : "string",&#xA;    "index": "not_analyzed"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The text in that field of each document will be used, unmodified, to create tokens, and those tokens will be returned by your terms aggregation. For the example value you provided, the aggregation will return it verbatim:</p>&#xA;&#xA;<pre><code>"aggregations": {&#xA;   "facets": {&#xA;      "buckets": [&#xA;         {&#xA;            "key": "en zh_CN",&#xA;            "doc_count": 1&#xA;         }&#xA;      ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>If you still want the text to be tokenized on whitespace, you can try using the <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-whitespace-analyzer.html" rel="noreferrer">whitespace analyzer</a> in your mapping:</p>&#xA;&#xA;<pre><code>"language": {&#xA;   "type": "string",&#xA;   "analyzer": "whitespace"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Then your aggregation will return:</p>&#xA;&#xA;<pre><code>"aggregations": {&#xA;   "facets": {&#xA;      "buckets": [&#xA;         {&#xA;            "key": "en",&#xA;            "doc_count": 1&#xA;         },&#xA;         {&#xA;            "key": "zh_CN",&#xA;            "doc_count": 1&#xA;         }&#xA;      ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here is the code I used to test both examples:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/a7b3c7d50c7012537c50d576d03940b28b5f8793" rel="noreferrer">http://sense.qbox.io/gist/a7b3c7d50c7012537c50d576d03940b28b5f8793</a></p>&#xA;