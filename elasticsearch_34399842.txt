34399842
ElasticSearch aggregations using filter and without it
<p>I`m building product list page with filters. There a lot of filters, and data for them are counting in ES with aggregation functions.&#xA;Simplest example if min/max price:</p>&#xA;&#xA;<p><div class="snippet" data-lang="js" data-hide="false">&#xD;&#xA;<div class="snippet-code">&#xD;&#xA;<pre class="snippet-code-html lang-html prettyprint-override"><code>{&#xD;&#xA;  "size": 0,&#xD;&#xA;  "query": {&#xD;&#xA;    "filtered": {&#xD;&#xA;      "query": {&#xD;&#xA;        "match_all": {}&#xD;&#xA;      },&#xD;&#xA;      "filter": {&#xD;&#xA;        "bool": {&#xD;&#xA;          "must": [&#xD;&#xA;            {&#xD;&#xA;              "term": {&#xD;&#xA;                "shop_id": 44&#xD;&#xA;              }&#xD;&#xA;            },&#xD;&#xA;            {&#xD;&#xA;              "term": {&#xD;&#xA;                "CategoryId": 36898&#xD;&#xA;              }&#xD;&#xA;            },&#xD;&#xA;            {&#xD;&#xA;              "term": {&#xD;&#xA;                "products_status": 1&#xD;&#xA;              }&#xD;&#xA;            },&#xD;&#xA;            {&#xD;&#xA;              "term": {&#xD;&#xA;                "availability": 3&#xD;&#xA;              }&#xD;&#xA;            }&#xD;&#xA;          ]&#xD;&#xA;        }&#xD;&#xA;      }&#xD;&#xA;    }&#xD;&#xA;  },&#xD;&#xA;  "aggs": {&#xD;&#xA;    "min_price": {&#xD;&#xA;      "min": {&#xD;&#xA;        "field": "products_price"&#xD;&#xA;      }&#xD;&#xA;    },&#xD;&#xA;    "max_price": {&#xD;&#xA;      "max": {&#xD;&#xA;        "field": "products_price"&#xD;&#xA;      }&#xD;&#xA;    }&#xD;&#xA;  }&#xD;&#xA;}</code></pre>&#xD;&#xA;</div>&#xD;&#xA;</div>&#xD;&#xA;</p>&#xA;&#xA;<p>So, this request in ES return me minimal and maximal price according rules installed in filter (category_id 36898, shop_id 44 etc). &#xA;It is working perfect.</p>&#xA;&#xA;<p>The question is: does it possible to update this request and get aggregations without filters? Or maybe it possible to return aggregation data with another filter in one request?</p>&#xA;&#xA;<p>I mean it is return me data:</p>&#xA;&#xA;<p>min_price and max_price for filtered data (query1)</p>&#xA;&#xA;<p>and mix_price and max_price for unfiltered data (or filtered data with query 2)?</p>&#xA;
<p>You can use <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-global-aggregation.html" rel="nofollow">global</a> option for the aggregations to not applying any filters provided in query block.</p>&#xA;&#xA;<p>For example, for your query use the following json input.</p>&#xA;&#xA;<pre>&#xA;{&#xA;    "size": 0,&#xA;    "query": {&#xA;        "filtered": {&#xA;            "query": {&#xA;                "match_all": {}&#xA;            },&#xA;            "filter": {&#xA;                "bool": {&#xA;                    "must": [&#xA;                    {&#xA;                        "term": {&#xA;                            "shop_id": 44&#xA;                        }&#xA;                    },&#xA;                    {&#xA;                        "term": {&#xA;                            "CategoryId": 36898&#xA;                        }&#xA;                    },&#xA;                    {&#xA;                        "term": {&#xA;                            "products_status": 1&#xA;                        }&#xA;                    },&#xA;                    {&#xA;                        "term": {&#xA;                            "availability": 3&#xA;                        }&#xA;                    }&#xA;                    ]&#xA;                }&#xA;            }&#xA;        }&#xA;    },&#xA;    "aggs": {&#xA;        "min_price": {&#xA;            "min": {&#xA;                "field": "products_price"&#xA;            }&#xA;        },&#xA;        "max_price": {&#xA;            "max": {&#xA;                "field": "products_price"&#xA;            }&#xA;        },&#xA;        "without_filter_min": {&#xA;            "global": {},&#xA;            "aggs": {&#xA;                "price_value": {&#xA;                    "min": {&#xA;                        "field": "products_price"&#xA;                    }&#xA;                }&#xA;            }&#xA;        },&#xA;        "without_filter_max": {&#xA;            "global": {},&#xA;            "aggs": {&#xA;                "price_value": {&#xA;                    "max": {&#xA;                        "field": "products_price"&#xA;                    }&#xA;                }&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;</pre>&#xA;