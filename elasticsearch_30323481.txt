30323481
May Elasticsearch nested query return only matched nested documents for nested fields?
<p>I'm new to Elasticsearch, and come up with a question that whether Elasticsearch nested query may return only matched nested documents for nested fields or not.</p>&#xA;&#xA;<p>For Example I have a type named <code>blog</code> with a nested field named <code>comments</code></p>&#xA;&#xA;<pre><code>{&#xA;  "id": 1,&#xA;  ...&#xA;  "comments":[&#xA;    {"content":"Michael is a basketball player"},&#xA;    {"content":"David is a soccer player"}&#xA;  ]&#xA;}&#xA;{&#xA;  "id": 2,&#xA;  ...&#xA;  "comments":[&#xA;    {"content":"Wayne is a soccer player"},&#xA;    {"content":"Steven is also a soccer player"},&#xA;  ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>and the nested query</p>&#xA;&#xA;<pre><code>{"query":{&#xA;  "nested":{&#xA;    "path":"comments",&#xA;    "query":{"match":{"comments.content":"soccer"}}&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>What I need is to search blog posts with comments which mentioned "soccer", with the count of comments that matched "soccer" (in the example it counts 1, since another comment just mentioned "basketball") for each blog post.</p>&#xA;&#xA;<pre><code>{"hits":[&#xA;  {&#xA;    "id":1,&#xA;    ...&#xA;    "count_for_comments_that_matches_query":1,&#xA;  },&#xA;  {&#xA;    "id":2,&#xA;    ...&#xA;    "count_for_comments_that_matches_query":2,&#xA;  }&#xA;]}&#xA;</code></pre>&#xA;&#xA;<p>However it seems Elasticsearch always return the full document, so how could I achieve it, or I couldn't?</p>&#xA;
<p>The answer is here.   </p>&#xA;&#xA;<pre><code>https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-inner-hits.html#nested-inner-hits&#xA;</code></pre>&#xA;&#xA;<p>You need to use the <code>nested inner hits</code> feature of the Elastic search.   </p>&#xA;&#xA;<pre><code>{&#xA;   "_source": [&#xA;      "id"&#xA;   ],&#xA;   "query": {&#xA;      "bool": {&#xA;         "must": [&#xA;            {&#xA;               "match": {&#xA;                  "id": "1"&#xA;               }&#xA;            },&#xA;            {&#xA;               "nested": {&#xA;                  "path": "comments",&#xA;                  "query": {&#xA;                     "match": {&#xA;                        "comments.content": "soccer"&#xA;                     }&#xA;                  },&#xA;                  "inner_hits": {}&#xA;               }&#xA;            }&#xA;         ]&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>I think it will solve the problem</p>&#xA;