34199459
Custom sorting using script in Elasticsearch
<p>I want to make use of the scripting to sort the results in the elasticsearch with custom logic. I have read the docs from the elasticsearch and could not make it up. After seeing some links on the internet, I tried a bit and below is the source code for the same. I am using native (Java) for it. I am not sure whether this is the correct approach. </p>&#xA;&#xA;<pre><code>import org.elasticsearch.script.ExecutableScript;&#xA;import org.elasticsearch.script.NativeScriptFactory;&#xA;import customSortProject.Sorted;&#xA;&#xA;import java.util.Map;&#xA;&#xA;public class CustomScriptFactory implements NativeScriptFactory {&#xA;&#xA;    public ExecutableScript newScript(Map&lt;String, Object&gt; params) {&#xA;        return new Sorted(params);&#xA;    }&#xA;&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>And the class where i am implementing the logic for the sore. Currently I am just getting the future dates. </p>&#xA;&#xA;<pre><code>import java.util.ArrayList;&#xA;import java.util.Collections;&#xA;import java.util.Date;&#xA;import java.util.List;&#xA;import java.util.Map;&#xA;&#xA;import org.elasticsearch.common.Nullable;&#xA;import org.elasticsearch.script.AbstractSearchScript;&#xA;&#xA;&#xA;public class Sorted extends AbstractSearchScript {&#xA;      String fieldParam;&#xA;      int lengthParam;&#xA;&#xA;      public Sorted(@Nullable Map&lt;String,Object&gt; params){&#xA;          fieldParam = (String)params.get("field");&#xA;        lengthParam = new Integer(params.get("length").toString()).intValue();&#xA;      }&#xA;    public Object run() {&#xA;        if(source().containsKey(fieldParam) &amp;&amp; source().get(fieldParam)!= null &amp;&amp; source().get(fieldParam).toString() != null) { &#xA;&#xA;&#xA;            String field = doc().get(fieldParam).toString();&#xA;            field = field.replaceAll("\\[", "").replaceAll("\\]","");&#xA;            long fieldLong = 0;&#xA;            Date today = new Date();&#xA;            fieldLong = Long.parseLong(field);          &#xA;            Date date = new Date(fieldLong);&#xA;            List&lt;Date&gt; futureList = new ArrayList&lt;Date&gt;();&#xA;            if (date.after(today))&#xA;                futureList.add(date);&#xA;&#xA;            Collections.sort(futureList);&#xA;&#xA;            return futureList;&#xA;&#xA;          }&#xA;          else {           &#xA;            return "";&#xA;          }&#xA;    }&#xA;&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>With this logic and using the query_dsl where I am trying to call this script which is register in .yml file. </p>&#xA;&#xA;<p>Query : </p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;    "match": {&#xA;      "title": "cancer"&#xA;    }&#xA;  },&#xA;  "sort": {&#xA;    "_script": {&#xA;      "script": "sorted",&#xA;      "lang": "native",&#xA;      "type": "string",&#xA;      "ignore_unmapped": true,&#xA;      "params": {&#xA;        "field": "startdate",&#xA;        "length": 6&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Please let me know is this correct approach to custom sorting. I want to call it from the query dsl, as our application is in PHP and we are using PHP's es-client to search.  </p>&#xA;