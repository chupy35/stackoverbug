29212674
Group by term and get list of array keys and their count
<p>in elasticsearch i got several hundred thousand documents with roughly this kind of structure:</p>&#xA;&#xA;<pre><code>{&#xA;  "script": "/index.html",&#xA;  "query": {&#xA;    "ab": "hello",&#xA;    "cd": "world",&#xA;    "ef": "123"&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>The url "<a href="http://localhost/index.html?ab=hello&amp;cd=world&amp;ef=123" rel="nofollow">http://localhost/index.html?ab=hello&amp;cd=world&amp;ef=123</a>" is parsed into it. "script" only contains the path and the target script - no query at all.&#xA;The query array does not contain the same list of keys and of course different values, which doesn't matter at the moment at all.</p>&#xA;&#xA;<p>I know, i am able to get a distinct list of "script" with:</p>&#xA;&#xA;<pre><code>{&#xA;  "aggregations": {&#xA;    "my_agg": {&#xA;      "terms": {&#xA;        "field": "script.raw"&#xA;      }&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>which results into multiple buckets like</p>&#xA;&#xA;<pre><code>"buckets": [&#xA;{&#xA;    "key": "/index.html",&#xA;    "doc_count": 123456&#xA;},&#xA;{&#xA;    "key": "/hello.html",&#xA;    "doc_count": 1456&#xA;},&#xA;...&#xA;</code></pre>&#xA;&#xA;<p>My question: Is there a way to get additionally a list and count of all query <strong>keys</strong>, which are occurring in the different urls?</p>&#xA;&#xA;<p>Something like:</p>&#xA;&#xA;<pre><code>"buckets": [&#xA;{&#xA;    "key": "/index.html",&#xA;    "doc_count": 123456,&#xA;    "query_key_count": {&#xA;      "ab": 33456,&#xA;      "cd": 3456,&#xA;      "ef": 456,&#xA;      "gh": 56,&#xA;      "ij": 6&#xA;    }&#xA;},&#xA;{&#xA;    "key": "/hello.html",&#xA;    "doc_count": 1456,&#xA;    "query_key_count": {&#xA;      "zy": 156,&#xA;      "gh": 6&#xA;    }&#xA;},&#xA;...&#xA;</code></pre>&#xA;&#xA;<p>Thanks alot!!</p>&#xA;
<p>To leverage Elasticsearch's strengths, you really need your documents to be structured something like this:</p>&#xA;&#xA;<pre><code>{&#xA;   "script": "/index.html",&#xA;   "query": [&#xA;      {&#xA;         "query_key": "ab",&#xA;         "query_val": "hello"&#xA;      },&#xA;      {&#xA;         "query_key": "cd",&#xA;         "query_val": "world"&#xA;      },&#xA;      {&#xA;         "query_key": "ef",&#xA;         "query_val": "123"&#xA;      }&#xA;   ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>If I set up a mapping with a <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-nested-type.html" rel="nofollow">nested type</a>:</p>&#xA;&#xA;<pre><code>PUT /test_index&#xA;{&#xA;   "mappings": {&#xA;      "doc": {&#xA;         "properties": {&#xA;            "query": {&#xA;               "type": "nested",&#xA;               "properties": {&#xA;                  "query_key": {&#xA;                     "type": "string",&#xA;                     "index": "not_analyzed"&#xA;                  },&#xA;                  "query_val": {&#xA;                     "type": "string",&#xA;                     "index": "not_analyzed"&#xA;                  }&#xA;               }&#xA;            },&#xA;            "script": {&#xA;               "type": "string",&#xA;               "index": "not_analyzed"&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>and add a couple of docs:</p>&#xA;&#xA;<pre><code>POST /test_index/_bulk&#xA;{"index":{"_index":"test_index","_type":"doc","_id":1}}&#xA;{"script": "/index.html","query": [{"query_key":"ab", "query_val":"hello"},{"query_key":"cd", "query_val":"world"}, {"query_key":"ef", "query_val":"123"}]}&#xA;{"index":{"_index":"test_index","_type":"doc","_id":2}}&#xA;{"script": "/index.html","query": [{"query_key":"ab", "query_val":"foo"},{"query_key":"cd", "query_val":"bar"}, {"query_key":"gh", "query_val":"456"}]}&#xA;</code></pre>&#xA;&#xA;<p>I can get back query keys in a <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-nested-aggregation.html" rel="nofollow">nested</a> terms aggregation:</p>&#xA;&#xA;<pre><code>POST /test_index/_search?search_type=count&#xA;{&#xA;   "aggs": {&#xA;      "resellers": {&#xA;         "nested": {&#xA;            "path": "query"&#xA;         },&#xA;         "aggs": {&#xA;            "query_keys": {&#xA;               "terms": {&#xA;                  "field": "query.query_key"&#xA;               }&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;...&#xA;{&#xA;   "took": 1,&#xA;   "timed_out": false,&#xA;   "_shards": {&#xA;      "total": 1,&#xA;      "successful": 1,&#xA;      "failed": 0&#xA;   },&#xA;   "hits": {&#xA;      "total": 2,&#xA;      "max_score": 0,&#xA;      "hits": []&#xA;   },&#xA;   "aggregations": {&#xA;      "resellers": {&#xA;         "doc_count": 6,&#xA;         "query_keys": {&#xA;            "buckets": [&#xA;               {&#xA;                  "key": "ab",&#xA;                  "doc_count": 2&#xA;               },&#xA;               {&#xA;                  "key": "cd",&#xA;                  "doc_count": 2&#xA;               },&#xA;               {&#xA;                  "key": "ef",&#xA;                  "doc_count": 1&#xA;               },&#xA;               {&#xA;                  "key": "gh",&#xA;                  "doc_count": 1&#xA;               }&#xA;            ]&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Here's the code I used:</p>&#xA;&#xA;<p><a href="http://sense.qbox.io/gist/aecd92e5903f644e28c802860a90a86bdd7f97ee" rel="nofollow">http://sense.qbox.io/gist/aecd92e5903f644e28c802860a90a86bdd7f97ee</a></p>&#xA;