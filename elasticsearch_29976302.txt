29976302
ElasticSearch nested _count query gets "request does not support [filter]"
<p>I have a query that works fine when I run it using <code>_search</code>, but it fails when using <code>_count</code>.  Can someone tell me why?  I'd rather not have to run the complete query just to get a count. </p>&#xA;&#xA;<p>This is the query. </p>&#xA;&#xA;<pre><code>{&#xA;  "filter": {&#xA;    "nested": {&#xA;      "filter": {&#xA;        "bool": {&#xA;          "must": [&#xA;            {&#xA;              "term": {&#xA;                "user_id": 5&#xA;              }&#xA;            }&#xA;          ]&#xA;        }&#xA;      }, &#xA;      "path": "participants"&#xA;    }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>This is the failure: </p>&#xA;&#xA;<pre><code>{&#xA;    "count": 0,&#xA;    "_shards": {&#xA;        "total": 5,&#xA;        "successful": 0,&#xA;        "failed": 5,&#xA;        "failures": [&#xA;            {&#xA;                "index": "messages_20150428_000025",&#xA;                "shard": 0,&#xA;                "reason": "BroadcastShardOperationFailedException[[messages_20150428_000025][0] ]; nested: QueryParsingException[[messages_20150428_000025] request does not support [filter]]; "&#xA;            },&#xA;            {&#xA;                "index": "messages_20150428_000025",&#xA;                "shard": 1,&#xA;                "reason": "BroadcastShardOperationFailedException[[messages_20150428_000025][1] ]; nested: QueryParsingException[[messages_20150428_000025] request does not support [filter]]; "&#xA;            },&#xA;            {&#xA;                "index": "messages_20150428_000025",&#xA;                "shard": 2,&#xA;                "reason": "BroadcastShardOperationFailedException[[messages_20150428_000025][2] ]; nested: QueryParsingException[[messages_20150428_000025] request does not support [filter]]; "&#xA;            },&#xA;            {&#xA;                "index": "messages_20150428_000025",&#xA;                "shard": 3,&#xA;                "reason": "BroadcastShardOperationFailedException[[messages_20150428_000025][3] ]; nested: QueryParsingException[[messages_20150428_000025] request does not support [filter]]; "&#xA;            },&#xA;            {&#xA;                "index": "messages_20150428_000025",&#xA;                "shard": 4,&#xA;                "reason": "BroadcastShardOperationFailedException[[messages_20150428_000025][4] ]; nested: QueryParsingException[[messages_20150428_000025] request does not support [filter]]; "&#xA;            }&#xA;        ]&#xA;    }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Given this the mapping for this nested field:</p>&#xA;&#xA;<pre><code>"participants": {&#xA;    "type": "nested",&#xA;    "properties": {&#xA;        "archived": {&#xA;            "type": "boolean"&#xA;        },&#xA;        "has_unread": {&#xA;            "type": "boolean"&#xA;        },&#xA;        "name": {&#xA;            "type": "string"&#xA;        },&#xA;        "pk": {&#xA;            "type": "long"&#xA;        },&#xA;        "user_id": {&#xA;            "type": "long"&#xA;        }&#xA;    }&#xA;},&#xA;</code></pre>&#xA;&#xA;<p>and these data (for this nested field only):</p>&#xA;&#xA;<pre><code>"participants": [&#xA;    {&#xA;        "archived": false,&#xA;        "user_id": 5,&#xA;        "name": "Person A",&#xA;        "has_unread": false,&#xA;        "pk": 1&#xA;    },&#xA;    {&#xA;        "archived": false,&#xA;        "user_id": 7,&#xA;        "name": "Person B",&#xA;        "has_unread": false,&#xA;        "pk": 2&#xA;    }&#xA;],&#xA;</code></pre>&#xA;
<p>As per the <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/search-count.html" rel="nofollow">documentation</a> <strong><em>count</em></strong> can accept only query hence you would need to rewrite it as </p>&#xA;&#xA;<pre><code>{&#xA;   "query": {&#xA;      "filtered": {&#xA;         "filter": {&#xA;            "nested": {&#xA;               "filter": {&#xA;                  "bool": {&#xA;                     "must": [&#xA;                        {&#xA;                           "term": {&#xA;                              "user_id": 5&#xA;                           }&#xA;                        }&#xA;                     ]&#xA;                  }&#xA;               },&#xA;               "path": "participants"&#xA;            }&#xA;         }&#xA;      }&#xA;   }&#xA;}&#xA;</code></pre>&#xA;
<p>While that does answer the question, it doesn't help me with how to get what I want, so, I'll upvote it, but here's the solution to my question:</p>&#xA;&#xA;<pre><code>/_search?search_type=count&#xA;</code></pre>&#xA;&#xA;<p>simple as that. </p>&#xA;