33350940
Elasticsearch Partial Fields With Inner Hits
<p>Is it possible to use the <code>partial_fields</code> parameter when performing a <code>nested</code> filter/query ? </p>&#xA;&#xA;<p>For example this query will return just the fields I am looking for from the <code>hits</code>:</p>&#xA;&#xA;<pre><code>{&#xA;  "query": {&#xA;      "filtered": {&#xA;          "query": {&#xA;              "ids": {&#xA;                  "type": "users",&#xA;                  "values": [&#xA;                      "111"&#xA;                  ]&#xA;              }&#xA;          },&#xA;          "filter": {&#xA;              "nested": {&#xA;                  "path": "entitlements",&#xA;                  "filter": {&#xA;                      "bool": {&#xA;                          "must": [&#xA;                              {&#xA;                                  "term": {&#xA;                                    "program": "program-a"&#xA;                                  }&#xA;                              }&#xA;                         ]&#xA;                      }&#xA;                  },&#xA;                  "inner_hits": {&#xA;                      "size": 999&#xA;                  }&#xA;              }&#xA;          }&#xA;      }&#xA;  },&#xA;  "partial_fields": {&#xA;      "partial": {&#xA;          "include": [&#xA;              "entitlements.accountNumber",&#xA;              "entitlements.name",&#xA;              "entitlments.numbers"&#xA;          ]&#xA;      }&#xA;  }&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>However the <code>inner_hits</code> section, no fields are returned.</p>&#xA;&#xA;<pre><code>   "inner_hits": {&#xA;           "entitlements": {&#xA;              "hits": {&#xA;                 "total": 1,&#xA;                 "max_score": 1,&#xA;                 "hits": [&#xA;                    {&#xA;                       "_index": "myGreatIndex",&#xA;                       "_type": "users",&#xA;                       "_id": "111",&#xA;                       "_nested": {&#xA;                          "field": "entitlements",&#xA;                          "offset": 0&#xA;                       },&#xA;                       "_score": 1,&#xA;                       "fields": {&#xA;                          "partial": [&#xA;                             {}&#xA;                          ]&#xA;                       }&#xA;                    }&#xA;                 ]&#xA;              }&#xA;           }&#xA;        }&#xA;</code></pre>&#xA;&#xA;<p>Is there a way to apply this for <code>inner_hits</code> ?</p>&#xA;
<p>Inside the <code>inner_hits</code> section, you may use <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-source-filtering.html" rel="noreferrer">source filtering</a> instead. <code>partial_fields</code> will work for outer hits and <code>_source</code> for <code>inner_hits</code>.</p>&#xA;&#xA;<p>So you can specify your <code>inner_hits</code> like this:</p>&#xA;&#xA;<pre><code>"inner_hits": {&#xA;    "size": 999,&#xA;    "_source": [&#xA;          "accountNumber",&#xA;          "name",&#xA;          "numbers"&#xA;    ]&#xA;}&#xA;</code></pre>&#xA;&#xA;<p>Note, though, that within your <code>inner_hits</code> results, you'll still get an empty <code>partial</code> array, but the fields you need will show up within the <code>_source</code> section.</p>&#xA;&#xA;<p>Also worth noting that if you specify your <code>partial_fields</code> with unqualified names (see below), then partial fields will show up in your <code>inner_hits</code> results, but <strong>not</strong> in the outer hits anymore. So you need to figure out which works best for you.</p>&#xA;&#xA;<pre><code>"partial_fields": {&#xA;   "partial": {&#xA;     "include": [&#xA;        "accountNumber",&#xA;        "name",&#xA;        "numbers"&#xA;     ]&#xA;   }&#xA;}&#xA;</code></pre>&#xA;