33419549
elasticsearch faking index per user - how are routing values inferred when updating?
<p>Using the <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/faking-it.html" rel="nofollow">fake index per user</a> as suggested by docs. ES version 1.6.0  sometimes fails to behave as expected.</p>&#xA;&#xA;<p>Checking the alias:</p>&#xA;&#xA;<pre><code>curl localhost:9200/testbig/_alias/&lt;userId&gt;&#xA;{"&lt;indexname&gt;":{"aliases":{"&lt;userId&gt;":{"filter":{"term":  &#xA;{"userId":"&lt;userId&gt;"}},"index_routing":"&lt;userId&gt;","search_routing":"&lt;userId&gt;"}}&#xA;}}&#xA;</code></pre>&#xA;&#xA;<p>But trying to update a document:</p>&#xA;&#xA;<pre><code>curl -XPOST localhost:9200/&lt;userId&gt;/&lt;type&gt;/&lt;id&gt;/_update -d &#xA;'{"doc":{"userId":"&lt;userId&gt;","field1":"val1"}}'&#xA;</code></pre>&#xA;&#xA;<p>I get </p>&#xA;&#xA;<pre><code>{ "error": "ElasticsearchIllegalArgumentException[Alias [&lt;userId&gt;] has &#xA;index routing associated with it [&lt;userId&gt;], and was provided with &#xA;routing value [&lt;DIFFERENTuserId&gt;], rejecting operation]",&#xA;"status": 400 }&#xA;</code></pre>&#xA;
<p>In case anyone else suffers a similar issue, what causes is this:</p>&#xA;&#xA;<p>If you start by using actual separate indexes for each user, it's OK to have records with the same id, i.e. paths like</p>&#xA;&#xA;<pre><code>localhost:9200/userid1/type/id1&#xA;localhost:9200/userid2/type/id1&#xA;</code></pre>&#xA;&#xA;<p>but when the <code>userids</code> are just aliases, these correspond, of course, to the same document. Hence the routing clash on subsequent updates.</p>&#xA;